<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
  <title>Whistle — P2P encrypted tips + Solana memo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' https: http: data: blob:; connect-src 'self' https: wss: ws: http://localhost:* ws://localhost:*; script-src 'self' 'unsafe-inline' 'unsafe-eval' https: http:; style-src 'self' 'unsafe-inline' https:; img-src 'self' data: https: http:;">
  <link rel="manifest" href="/manifest.webmanifest">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0b0f14">
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Ensure Buffer exists before Solana Web3 (fixes Buffer issues in browser) -->
  <script>window.global = window.global || window;</script>
  <script type="module">import { Buffer } from 'https://esm.sh/buffer@6.0.3'; window.Buffer = Buffer;</script>
  <script crossorigin src="https://unpkg.com/@solana/web3.js@1.95.3/lib/index.iife.min.js"></script>
  <script src="https://unpkg.com/bs58@5.0.0/dist/bs58.min.js"></script>
  <!-- Solana Wallet Adapter & SPL Token -->
  <script src="https://unpkg.com/@solana/spl-token@0.3.8/lib/index.iife.min.js"></script>
  <script src="https://unpkg.com/@coral-xyz/anchor@0.29.0/dist/browser.js"></script>
  <script src="https://unpkg.com/bn.js@5.2.1/lib/bn.js"></script>
  <!-- Leaflet for Interactive World Map -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Optional: Solana Mobile Wallet Adapter (deep link-friendly) -->
  <script type="module">
    // Simple feature flag for Solana Mobile deep link environments
    window.isSolanaMobile = /SolanaMobile/i.test(navigator.userAgent);
  </script>
<style>
    html,body{height:100%}
    body{background:#0b0f14}
    /* Premium dynamic visuals */
    @keyframes gradientMove{0%{transform:translate3d(-6%, -4%, 0) scale(1)}100%{transform:translate3d(6%, 4%, 0) scale(1.08)}}
    @keyframes floatSlow{0%{transform:translateY(0)}50%{transform:translateY(-4px)}100%{transform:translateY(0)}}
    @keyframes ripple{0%{transform:scale(0);opacity:.5}100%{transform:scale(4);opacity:0}}
    @keyframes toastIn{0%{transform:translateY(8px);opacity:0}100%{transform:translateY(0);opacity:1}}
    .bg-anim{animation:gradientMove 14s ease-in-out infinite alternate}
    .float-slow{animation:floatSlow 6s ease-in-out infinite}
    .glass-hover{transition:transform .3s ease, box-shadow .3s ease}
    .glass-hover:hover{transform:translateY(-2px);box-shadow:0 20px 40px rgba(0,0,0,.35)}
    .btn-ripple{position:relative;overflow:hidden}
    .btn-ripple span.ripple{position:absolute;border-radius:9999px;background:rgba(255,255,255,.35);transform:scale(0);animation:ripple .6s linear;pointer-events:none}
    .toast-enter{animation:toastIn .4s cubic-bezier(0.68, -0.55, 0.265, 1.55)}
    @keyframes toastIn{
      0%{transform:translateX(400px) scale(0.8);opacity:0}
      100%{transform:translateX(0) scale(1);opacity:1}
    }
    
    /* Custom Leaflet Map Styles */
    .leaflet-container {
      background: #0f1419 !important;
      border-radius: 12px;
      z-index: 1;
    }
    .leaflet-tile-pane {
      opacity: 0.6 !important;
    }
    .leaflet-popup-content-wrapper {
      background: rgba(15, 23, 42, 0.95) !important;
      backdrop-filter: blur(12px);
      border-radius: 12px !important;
      color: white !important;
      border: 1px solid rgba(59, 130, 246, 0.3) !important;
    }
    .leaflet-popup-tip {
      background: rgba(15, 23, 42, 0.95) !important;
    }
    
    /* Make markers HIGHLY visible */
    .leaflet-marker-pane {
      z-index: 1000 !important;
    }
    
    /* Pulsing marker animation for all circle markers */
    @keyframes markerPulse {
      0%, 100% { 
        transform: scale(1); 
        opacity: 1;
        box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
      }
      50% { 
        transform: scale(1.3); 
        opacity: 0.9;
        box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
      }
    }
    
    /* Glow effect for markers */
    @keyframes markerGlow {
      0%, 100% { 
        filter: brightness(1) drop-shadow(0 0 8px rgba(59, 130, 246, 0.8));
      }
      50% { 
        filter: brightness(1.2) drop-shadow(0 0 16px rgba(59, 130, 246, 1));
      }
    }
    
    /* Ensure markers are visible on dark background */
    .leaflet-overlay-pane svg {
      z-index: 100 !important;
    }
    
    .leaflet-overlay-pane svg path {
      stroke-width: 4px !important;
      stroke: #ffffff !important;
      stroke-opacity: 1 !important;
      fill-opacity: 1 !important;
      filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.5));
    }
    
    /* Pulsing marker class */
    .pulsing-marker path {
      animation: markerPulse 2s ease-in-out infinite, markerGlow 2s ease-in-out infinite;
    }
    
    /* YOUR node - extra special animation */
    .user-node path {
      animation: userNodePulse 1.5s ease-in-out infinite, userNodeGlow 1.5s ease-in-out infinite !important;
    }
    
    @keyframes userNodePulse {
      0%, 100% { 
        transform: scale(1); 
        opacity: 1;
      }
      50% { 
        transform: scale(1.4); 
        opacity: 0.85;
      }
    }
    
    @keyframes userNodeGlow {
      0%, 100% { 
        filter: brightness(1.2) drop-shadow(0 0 12px rgba(16, 185, 129, 1));
      }
      50% { 
        filter: brightness(1.5) drop-shadow(0 0 20px rgba(16, 185, 129, 1));
      }
    }
    
    /* Outer ring pulse */
    .marker-ring path {
      animation: ringPulse 2s ease-in-out infinite;
    }
    
    @keyframes ringPulse {
      0%, 100% { 
        transform: scale(1);
        opacity: 0.6;
      }
      50% { 
        transform: scale(1.2);
        opacity: 0.3;
      }
    }
    
    /* Custom Terminal Scrollbar */
    .custom-scrollbar::-webkit-scrollbar {
      width: 8px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: rgba(16, 185, 129, 0.5);
      border-radius: 10px;
      border: 2px solid rgba(0, 0, 0, 0.3);
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: rgba(16, 185, 129, 0.7);
    }

    /* Animated sky with clouds */
     .sky{position:fixed;inset:0;pointer-events:none;z-index:-9;background:linear-gradient(180deg,#7ec8ff 0%, #bfe4ff 45%, #e8f4ff 100%)}
     .cloud{position:absolute;filter:blur(0px);opacity:.95}
    .cloud::before{content:"";position:absolute;inset:0; background:
      radial-gradient(120px 70px at 60px 60px, rgba(255,255,255,.95) 40%, rgba(255,255,255,0) 60%),
      radial-gradient(100px 60px at 120px 60px, rgba(255,255,255,.95) 40%, rgba(255,255,255,0) 60%),
      radial-gradient(140px 80px at 180px 70px, rgba(255,255,255,.95) 40%, rgba(255,255,255,0) 60%),
      radial-gradient(110px 65px at 110px 90px, rgba(255,255,255,.95) 40%, rgba(255,255,255,0) 60%);
    }
    @keyframes cloudDrift{from{transform:translateX(-35%)}to{transform:translateX(135%)}}
    .c1{top:12%;left:-30%;width:420px;height:160px;animation:cloudDrift 55s linear infinite}
    .c2{top:28%;left:-40%;width:520px;height:190px;animation:cloudDrift 85s linear infinite}
    .c3{top:42%;left:-35%;width:360px;height:140px;animation:cloudDrift 60s linear infinite}
    .c4{top:58%;left:-45%;width:620px;height:200px;animation:cloudDrift 95s linear infinite}
    .c5{top:70%;left:-38%;width:380px;height:140px;animation:cloudDrift 70s linear infinite}
    .c6{top:18%;left:-48%;width:300px;height:120px;animation:cloudDrift 72s linear infinite}
    .c7{top:35%;left:-52%;width:260px;height:110px;animation:cloudDrift 66s linear infinite}
    .c8{top:64%;left:-50%;width:440px;height:170px;animation:cloudDrift 88s linear infinite}
    .c9{top:78%;left:-46%;width:300px;height:120px;animation:cloudDrift 76s linear infinite}

    /* Dim overlay to ensure text contrast */
    .sky-dim{position:fixed;inset:0;pointer-events:none;z-index:-8;background:linear-gradient(180deg,rgba(0,0,0,.38) 0%, rgba(0,0,0,.32) 35%, rgba(0,0,0,.28) 65%, rgba(0,0,0,.36) 100%)}

    /* Stronger glass panels for readability */
    .glass-strong{background:rgba(10,14,20,.58)!important;border-color:rgba(255,255,255,.12)!important;box-shadow:0 24px 60px rgba(0,0,0,.45)!important}
    .panel-strong{background:rgba(10,14,20,.58)!important;border-color:rgba(255,255,255,.12)!important}

    /* Home: premium animations */
    @keyframes fadeUp{0%{opacity:0;transform:translateY(12px)}100%{opacity:1;transform:translateY(0)}}
    @keyframes slideInLeft{0%{opacity:0;transform:translateX(-20px)}100%{opacity:1;transform:translateX(0)}}
    @keyframes slideInRight{0%{opacity:0;transform:translateX(20px)}100%{opacity:1;transform:translateX(0)}}
    @keyframes scaleIn{0%{opacity:0;transform:scale(.94)}100%{opacity:1;transform:scale(1)}}
    @keyframes shimmer{0%{background-position:200% center}100%{background-position:-200% center}}
    @keyframes shimmer-slide{0%{transform:translateX(-100%)}100%{transform:translateX(200%)}}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}
    @keyframes pulseSlow{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.85;transform:scale(1.05)}}
    @keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
    @keyframes rotate{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
    @keyframes glow{0%,100%{box-shadow:0 0 20px rgba(103,232,249,.3)}50%{box-shadow:0 0 40px rgba(103,232,249,.6),0 0 60px rgba(167,139,250,.4)}}
    
    .fade-up{animation:fadeUp .5s ease-out both}
    .fade-up-2{animation:fadeUp .6s ease-out .05s both}
    .fade-up-3{animation:fadeUp .6s ease-out .1s both}
    .slide-in-left{animation:slideInLeft .5s ease-out both}
    .slide-in-right{animation:slideInRight .5s ease-out both}
    .scale-in{animation:scaleIn .4s cubic-bezier(.34,1.56,.64,1) both}
    
    .hover-lift{transition:transform .25s ease, box-shadow .25s ease}
    .hover-lift:hover{transform:translateY(-3px) scale(1.01);box-shadow:0 18px 40px rgba(0,0,0,.45)}
    
    .badge-step{display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:9999px;background:linear-gradient(135deg,#67e8f9,#a78bfa);color:#0b0f14;font-weight:700;font-size:12px;margin-right:8px;animation:glow 3s ease-in-out infinite}
    
    .step-card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.10);border-radius:16px;padding:10px;transition:all .3s ease}
    .step-card:hover{background:rgba(255,255,255,.06);border-color:rgba(103,232,249,.2)}
    
    .mini-code{background:rgba(0,0,0,.45);border:1px solid rgba(255,255,255,.12);border-radius:8px;padding:8px;transition:all .3s ease}
    .mini-code:hover{border-color:rgba(103,232,249,.3);box-shadow:0 0 20px rgba(103,232,249,.15)}
    
    .shimmer-bg{background:linear-gradient(90deg,rgba(255,255,255,0) 0%,rgba(255,255,255,.08) 50%,rgba(255,255,255,0) 100%);background-size:200% 100%;animation:shimmer 3s linear infinite}
    .animate-shimmer{animation:shimmer 3s infinite}
    .animate-shimmer-slide{animation:shimmer-slide 3s linear infinite}
    
    .pulse-glow{animation:pulse 2s ease-in-out infinite}
    
    .bounce-slow{animation:bounce 3s ease-in-out infinite}
    .animate-pulse-slow{animation:pulseSlow 3s ease-in-out infinite}
    
    .rotate-slow{animation:rotate 20s linear infinite}
    
    /* Progress bar animations */
    @keyframes progressShine{0%{background-position:-100% 0}100%{background-position:200% 0}}
    .progress-shine{background:linear-gradient(90deg,#67e8f9 0%,#a78bfa 50%,#67e8f9 100%);background-size:200% 100%;animation:progressShine 2s linear infinite}
    
    /* Coin Flip Animations */
    .coin {
      width: 120px;
      height: 120px;
      position: relative;
      transform-style: preserve-3d;
      transition: transform 0.6s;
    }
    .coin-side {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 16px;
      border: 4px solid;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4), inset 0 2px 8px rgba(255,255,255,0.3);
    }
    .heads {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 50%, #d97706 100%);
      border-color: #f59e0b;
      color: #78350f;
      transform: rotateY(0deg);
    }
    .tails {
      background: linear-gradient(135deg, #d1d5db 0%, #9ca3af 50%, #6b7280 100%);
      border-color: #9ca3af;
      color: #1f2937;
      transform: rotateY(180deg);
    }
    @keyframes coinFlip {
      0% { transform: rotateY(0deg) rotateX(0deg); }
      25% { transform: rotateY(450deg) rotateX(180deg); }
      50% { transform: rotateY(900deg) rotateX(360deg); }
      75% { transform: rotateY(1350deg) rotateX(540deg); }
      100% { transform: rotateY(1800deg) rotateX(720deg); }
    }
    @keyframes coinBounce {
      0%, 100% { transform: translateY(0) scale(1); }
      50% { transform: translateY(-20px) scale(1.1); }
    }
    .coin-flip-ready .coin {
      animation: coinBounce 2s ease-in-out infinite;
    }
    .coin-flipping .coin {
      animation: coinFlip 1.5s ease-in-out infinite;
    }
    .coin-result.show-heads .coin {
      transform: rotateY(0deg);
      animation: coinBounce 1s ease-in-out 3;
    }
    .coin-result.show-tails .coin {
      transform: rotateY(180deg);
      animation: coinBounce 1s ease-in-out 3;
    }
    
    /* Button press effect */
    .btn-press{transition:all .15s ease}
    .btn-press:active{transform:scale(.96)}
    
    /* Card entrance stagger */
    .stagger-1{animation-delay:.05s}
    .stagger-2{animation-delay:.1s}
    .stagger-3{animation-delay:.15s}
    .stagger-4{animation-delay:.2s}
    
    /* ===== MOBILE OPTIMIZATION ===== */
    @media (max-width: 768px) {
      /* Reduce cloud sizes on mobile */
      .c1,.c2,.c3,.c4,.c5,.c6,.c7,.c8,.c9{
        width:250px!important;
        height:100px!important;
      }
      
      /* Optimize toast for mobile */
      .toast-enter{
        min-width:280px!important;
        max-width:calc(100vw - 32px)!important;
        font-size:14px!important;
        padding:12px 16px!important;
      }
      
      /* Smaller glass cards on mobile */
      .glass-strong{
        padding:16px!important;
      }
      
      /* Adjust animations for mobile */
      .hover-lift:active{
        transform:translateY(-2px) scale(1.005);
      }
      
      /* Better button sizing for touch */
      button{
        min-height:44px;
        min-width:44px;
      }
      
      /* Optimize text sizing */
      .text-base{font-size:15px!important}
      .text-sm{font-size:13px!important}
      .text-xs{font-size:11px!important}
    }
    
    @media (max-width: 640px) {
      /* Even smaller on phones */
      body{
        font-size:14px;
      }
      
      /* Reduce header size */
      h1,h2,h3{
        font-size:1.25rem!important;
      }
      
      /* Stack buttons vertically on small screens */
      .flex-wrap{
        flex-direction:column!important;
        width:100%;
      }
      .flex-wrap > button{
        width:100%;
      }
      
      /* Full width inputs */
      input[type="file"],
      textarea,
      select{
        font-size:16px!important; /* Prevents zoom on iOS */
      }
      
      /* Adjust toast position for mobile */
      .fixed.top-20{
        top:70px!important;
        right:8px!important;
        left:8px!important;
      }
    }
    
    /* Landscape phone optimization */
    @media (max-width: 896px) and (orientation: landscape) {
      .sky,.sky-dim,.cloud{
        display:none; /* Hide animations in landscape for better performance */
      }
      body{
        background:#0b0f14;
      }
    }
    
    /* Touch-friendly improvements */
    @media (hover: none) and (pointer: coarse) {
      /* Better tap targets */
      button, a, input[type="button"]{
        min-height:48px;
        padding:12px 20px;
      }
      
      /* Remove glass hover effect on touch */
      .glass-hover:hover{
        transform:none;
        box-shadow:0 10px 30px rgba(0,0,0,.3);
      }
      
      /* Disable hover scale on touch devices */
      *:hover{
        transform:none!important;
      }
    }
    
    /* Mobile-specific improvements for all sections */
    @media (max-width: 768px) {
      /* Make hero text responsive */
      .text-5xl {
        font-size: 1.75rem !important;
        line-height: 1.2 !important;
      }
      
      .text-xl {
        font-size: 0.95rem !important;
      }
      
      /* Reduce all icon sizes on mobile */
      i[data-lucide], svg.lucide {
        width: 1rem !important;
        height: 1rem !important;
      }
      
      /* Reduce button icon sizes on mobile */
      button svg.w-5,
      button svg.w-7 {
        width: 1rem !important;
        height: 1rem !important;
      }
      
      /* Reduce large icon container sizes in Ghost Whistle */
      .w-14.h-14 {
        width: 2rem !important;
        height: 2rem !important;
      }
      
      .w-16.h-16 {
        width: 2.5rem !important;
        height: 2.5rem !important;
      }
      
      /* Make emoji in headings smaller on mobile */
      h1 {
        font-size: 1.5rem !important;
        line-height: 1.3 !important;
      }
      
      .text-3xl {
        font-size: 1.5rem !important;
      }
      
      .text-4xl {
        font-size: 1.75rem !important;
      }
      
      /* Reduce padding on large visual buttons (Explore Services, Connect Wallet) */
      .p-12 {
        padding: 1.5rem !important;
      }
      
      .py-8 {
        padding-top: 1.5rem !important;
        padding-bottom: 1.5rem !important;
      }
      
      /* Smaller buttons on tablet */
      .px-6.py-3 {
        padding: 0.625rem 1.25rem !important;
        font-size: 0.875rem !important;
      }
      
      /* Reduce spacing in button content on tablet */
      .gap-3 {
        gap: 0.625rem !important;
      }
      
      .gap-2 {
        gap: 0.5rem !important;
      }
      
      /* Exception: Keep header button icons larger */
      header i[data-lucide], header svg {
        width: 1.5rem !important;
        height: 1.5rem !important;
      }
      
      /* Exception: Keep whitepaper icon larger on mobile */
      header a svg {
        width: 1.75rem !important;
        height: 1.75rem !important;
      }
      
      /* Exception: Keep censorship map SVG full size */
      svg[viewBox="0 0 1000 500"] {
        width: 100% !important;
        height: auto !important;
        min-height: 300px !important;
      }
      
      /* Reduce icon container sizes */
      .w-14 {
        width: 2.5rem !important;
        height: 2.5rem !important;
      }
      
      .w-12 {
        width: 2.25rem !important;
        height: 2.25rem !important;
      }
      
      .w-10 {
        width: 2rem !important;
        height: 2rem !important;
      }
      
      /* Reduce padding on cards */
      .p-6 {
        padding: 1rem !important;
      }
      
      .p-4 {
        padding: 0.75rem !important;
      }
      
      /* Smaller card titles */
      .text-xl {
        font-size: 1rem !important;
      }
      
      .text-2xl {
        font-size: 1.25rem !important;
      }
      
      /* Responsive hero buttons */
      .px-8 {
        padding-left: 1.25rem !important;
        padding-right: 1.25rem !important;
      }
      
      .py-4 {
        padding-top: 0.65rem !important;
        padding-bottom: 0.65rem !important;
      }
      
      .text-lg {
        font-size: 0.9rem !important;
      }
      
      /* Card grid responsive */
      .grid {
        gap: 0.5rem !important;
      }
      
      /* Reduce section spacing */
      .space-y-6 > * + * {
        margin-top: 1rem !important;
      }
      
      .space-y-4 > * + * {
        margin-top: 0.75rem !important;
      }
      
      .py-8 {
        padding-top: 1.5rem !important;
        padding-bottom: 1.5rem !important;
      }
      
      /* SVG maps - ensure they scale properly */
      svg {
        width: 100% !important;
        height: auto !important;
      }
      
      /* Censorship map dots - maintain visibility on mobile */
      svg circle {
        r: 6 !important;
      }
      
      svg text {
        font-size: 10px !important;
      }
      
      /* Ensure iframes are responsive */
      iframe {
        max-width: 100% !important;
        height: 700px !important;
      }
      
      /* Steganography tabs */
      .gap-2 {
        gap: 0.25rem !important;
      }
      
      /* Form inputs */
      textarea, input[type="text"], input[type="file"] {
        font-size: 16px !important; /* Prevents zoom on iOS */
      }
      
      /* Compact section headers */
      .mb-4 {
        margin-bottom: 0.75rem !important;
      }
      
      .mb-8 {
        margin-bottom: 1.5rem !important;
      }
    }
    
    @media (max-width: 640px) {
      /* Extra small screens */
      .text-5xl {
        font-size: 1.5rem !important;
      }
      
      .text-2xl {
        font-size: 1.1rem !important;
      }
      
      .text-xl {
        font-size: 0.875rem !important;
      }
      
      /* Make emoji in headings even smaller on phones */
      h1 {
        font-size: 1.25rem !important;
      }
      
      .text-3xl {
        font-size: 1.25rem !important;
      }
      
      .text-4xl {
        font-size: 1.5rem !important;
      }
      
      /* Even smaller icons on phones */
      i[data-lucide], svg.lucide {
        width: 0.875rem !important;
        height: 0.875rem !important;
      }
      
      /* Even smaller button icons on phones */
      button svg.w-5,
      button svg.w-7 {
        width: 0.875rem !important;
        height: 0.875rem !important;
      }
      
      /* Even smaller icon containers */
      .w-14.h-14 {
        width: 1.75rem !important;
        height: 1.75rem !important;
      }
      
      .w-16.h-16 {
        width: 2rem !important;
        height: 2rem !important;
      }
      
      /* Even tighter padding on large visual buttons */
      .p-12 {
        padding: 1rem !important;
      }
      
      .py-8 {
        padding-top: 1rem !important;
        padding-bottom: 1rem !important;
      }
      
      /* Force smaller text on large buttons */
      .px-6.py-3 {
        padding: 0.5rem 1rem !important;
        font-size: 0.75rem !important;
      }
      
      /* Reduce spacing in button content */
      .gap-3 {
        gap: 0.5rem !important;
      }
      
      .gap-2 {
        gap: 0.375rem !important;
      }
      
      /* Exception: Keep header button icons larger on phones */
      header i[data-lucide], header svg {
        width: 1.5rem !important;
        height: 1.5rem !important;
      }
      
      /* Exception: Keep whitepaper icon larger on phones */
      header a svg {
        width: 1.75rem !important;
        height: 1.75rem !important;
      }
      
      /* Exception: Keep censorship map SVG full size on phones */
      svg[viewBox="0 0 1000 500"] {
        width: 100% !important;
        height: auto !important;
        min-height: 250px !important;
      }
      
      /* Smaller icon containers */
      .w-14 {
        width: 2rem !important;
        height: 2rem !important;
      }
      
      .w-12 {
        width: 1.875rem !important;
        height: 1.875rem !important;
      }
      
      .w-10 {
        width: 1.75rem !important;
        height: 1.75rem !important;
      }
      
      /* Tighter padding */
      .p-6 {
        padding: 0.75rem !important;
      }
      
      .p-4 {
        padding: 0.5rem !important;
      }
      
      /* Hero section padding */
      .py-8 {
        padding-top: 1.25rem !important;
        padding-bottom: 1.25rem !important;
      }
      
      /* Tighter spacing */
      .space-y-6 > * + * {
        margin-top: 0.75rem !important;
      }
      
      .mb-8 {
        margin-bottom: 1rem !important;
      }
      
      .mb-4 {
        margin-bottom: 0.5rem !important;
      }
      
      /* Button stacking on very small screens */
      .flex.gap-4 {
        flex-direction: column !important;
        gap: 0.5rem !important;
      }
      
      .flex.gap-4 button {
        width: 100% !important;
      }
      
      /* Censorship map - smaller dots for small screens */
      svg circle {
        r: 5 !important;
      }
      
      svg text {
        font-size: 9px !important;
      }
      
      /* Privacy Swap iframe */
      iframe {
        height: 600px !important;
      }
    }
</style>
  <link rel="preconnect" href="https://unpkg.com">
  <link rel="preconnect" href="https://cdn.tailwindcss.com">
  <link rel="icon" type="image/png" href="whistel_logo_top_right_2048.png">
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <!-- EXIF Reader for metadata scrubbing -->
  <script src="https://cdn.jsdelivr.net/npm/exifreader@4.14.1/dist/exif-reader.js"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useEffect, useMemo, useRef, useState } = React;
    
    // Error Boundary Component
    class ErrorBoundary extends React.Component {
      constructor(props) {
        super(props);
        this.state = { hasError: false, error: null };
      }
      
      static getDerivedStateFromError(error) {
        return { hasError: true, error };
      }
      
      componentDidCatch(error, errorInfo) {
        console.error('Component Error:', error, errorInfo);
      }
      
      render() {
        if (this.state.hasError) {
          return (
            <div className="bg-red-500/10 border border-red-500/30 rounded-xl p-6 m-4">
              <h2 className="text-white text-xl font-bold mb-2">⚠️ Something went wrong</h2>
              <p className="text-white/70 text-sm mb-3">This component encountered an error. Please refresh the page or try another section.</p>
              <details className="text-white/50 text-xs">
                <summary className="cursor-pointer hover:text-white/70">Error Details</summary>
                <pre className="mt-2 p-2 bg-black/30 rounded overflow-auto">{this.state.error?.toString()}</pre>
              </details>
            </div>
          );
        }
        return this.props.children;
      }
    }
    
    // Loading Wrapper Component
    function ComponentLoader({ children, name }) {
      const [isLoading, setIsLoading] = React.useState(true);
      
      React.useEffect(() => {
        console.log(`Loading component: ${name}`);
        setIsLoading(false);
      }, [name]);
      
      if (isLoading) {
        return (
          <div className="flex items-center justify-center p-12">
            <div className="text-white/70">
              <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-cyan-400 mx-auto mb-4"></div>
              <p>Loading {name}...</p>
            </div>
          </div>
        );
      }
      
      return children;
    }
    
    // Project constants
    const CONTRACT_ADDRESS = '6Hb2xgEhyN9iVVH3cgSxYjfN774ExzgiCftwiWdjpump';

    // ---------- small helpers ----------
    const enc = new TextEncoder();
    const dec = new TextDecoder();
    const hex = (b) => Array.from(b).map((x) => x.toString(16).padStart(2, "0")).join("");
    // robust base64 helpers (URL-safe tolerant + large arrays)
    function safeAtob(str){
      let s = String(str||'');
      s = s.replace(/\s+/g,'').replace(/-/g,'+').replace(/_/g,'/');
      while (s.length % 4) s += '=';
      return atob(s);
    }
    function b64(u8){
      let binary = '';
      const CHUNK = 0x8000;
      for (let i=0;i<u8.length;i+=CHUNK){
        const sub = u8.subarray(i, i+CHUNK);
        binary += String.fromCharCode.apply(null, sub);
      }
      return btoa(binary);
    }
    function ub64(s){
      const bin = safeAtob(s);
      const out = new Uint8Array(bin.length);
      for (let i=0;i<bin.length;i++) out[i] = bin.charCodeAt(i);
      return out;
    }
    function textToB64(str){ return b64(new TextEncoder().encode(str)); }
    function b64ToText(s){ return new TextDecoder().decode(ub64(s)); }

    // Ensure Buffer polyfill for web3 internals in browser
    async function ensureBuffer(){
      if (!window.Buffer){
        try{
          const m = await import('https://esm.sh/buffer@6.0.3?bundle');
          window.Buffer = m.Buffer;
        }catch(e){ /* ignore; some environments already polyfill */ }
      }
    }

    // RPC defaults (hidden in UI; configurable via localStorage keys rpcHttpUrl / rpcWsUrl)
    const DEFAULT_RPC_HTTP = 'https://rpc-mainnet.solanatracker.io/?api_key=3f5cbb18-8d2f-4a87-ae09-8555c243c705';
    const DEFAULT_RPC_WS   = 'wss://rpc-mainnet.solanatracker.io/?api_key=3f5cbb18-8d2f-4a87-ae09-8555c243c705';
    function getRpcUrls(){
      try{
        const http = (localStorage.getItem('rpcHttpUrl') || DEFAULT_RPC_HTTP).trim();
        const ws = (localStorage.getItem('rpcWsUrl') || '').trim();
        return { http, ws };
      }catch{ return { http: DEFAULT_RPC_HTTP, ws: '' }; }
    }

    // Short, domain-like code for hashes (Base32 RFC4648, lowercase, dotted groups)
    function toBase32(u8){
      const alphabet = 'abcdefghijklmnopqrstuvwxyz234567';
      let out = '';
      let bits = 0, value = 0;
      for (let i=0;i<u8.length;i++){
        value = (value << 8) | u8[i];
        bits += 8;
        while (bits >= 5){
          out += alphabet[(value >>> (bits - 5)) & 31];
          bits -= 5;
        }
      }
      if (bits > 0){ out += alphabet[(value << (5 - bits)) & 31]; }
      return out;
    }
    function fromBase32(str){
      const alphabet = 'abcdefghijklmnopqrstuvwxyz234567';
      const map = Object.create(null);
      for (let i=0;i<alphabet.length;i++){ map[alphabet[i]] = i; }
      let bits = 0, value = 0, out = [];
      for (const ch of str.toLowerCase()){
        if (!(ch in map)) throw new Error('invalid base32');
        value = (value << 5) | map[ch];
        bits += 5;
        if (bits >= 8){
          out.push((value >>> (bits - 8)) & 255);
          bits -= 8;
        }
      }
      return new Uint8Array(out);
    }
    function formatShortCode(bytes){
      const b32 = toBase32(bytes).toLowerCase();
      return 'whis.' + b32.match(/.{1,4}/g).join('.');
    }
    function parseHashOrCode(input){
      const t = (input||'').trim().toLowerCase();
      if (/^[0-9a-f]{64}$/.test(t)) return t; // hex
      const clean = t.replace(/^whis\./,'').replace(/\./g,'');
      if (/^[a-z2-7]+$/.test(clean)){
        const bytes = fromBase32(clean);
        return hex(bytes);
      }
      throw new Error('Enter 64-hex or a whis.xxxx short code');
    }

    async function sha256(bytes) {
      const h = await crypto.subtle.digest("SHA-256", bytes);
      return new Uint8Array(h);
    }

    async function sha256Hash(str) {
      const enc = new TextEncoder();
      const bytes = enc.encode(str);
      const hashBuffer = await crypto.subtle.digest("SHA-256", bytes);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // ===== Self-contained Encryption (embeds key+iv in blob) =====
    async function encryptSelfContained(plainText){
      const enc = new TextEncoder();
      const keyBytes = crypto.getRandomValues(new Uint8Array(32));
      const key = await crypto.subtle.importKey('raw', keyBytes, 'AES-GCM', false, ['encrypt']);
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const ct = new Uint8Array(await crypto.subtle.encrypt({ name:'AES-GCM', iv }, key, enc.encode(plainText)));
      // bundle = key(32) | iv(12) | ct
      const bundle = new Uint8Array(32 + 12 + ct.length);
      bundle.set(keyBytes, 0); bundle.set(iv, 32); bundle.set(ct, 44);
      return btoa(String.fromCharCode(...bundle));
    }

    async function decryptSelfContained(b64){
      const raw = Uint8Array.from(atob(b64), c=>c.charCodeAt(0));
      const keyBytes = raw.slice(0,32);
      const iv = raw.slice(32,44);
      const ct = raw.slice(44);
      const key = await crypto.subtle.importKey('raw', keyBytes, 'AES-GCM', false, ['decrypt']);
      const pt = await crypto.subtle.decrypt({ name:'AES-GCM', iv }, key, ct);
      return new TextDecoder().decode(pt);
    }

    // ---------- persistence helpers ----------
    function usePersistentState(key, defaultValue){
      const [value, setValue] = React.useState(() => {
        try{
          const raw = localStorage.getItem(key);
          const parsed = raw != null ? JSON.parse(raw) : defaultValue;
          // Ensure we always have a valid value
          return parsed || defaultValue;
        }catch{ return defaultValue; }
      });
      React.useEffect(()=>{
        try{ localStorage.setItem(key, JSON.stringify(value)); }catch{}
      }, [key, value]);
      return [value, setValue];
    }

    const HISTORY_KEY = 'whistleHistory';
    const HISTORY_MAX = 50;
    function storageGetHistory(){
      try{ return JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]'); }catch{ return []; }
    }
    function storageSetHistory(list){
      try{ localStorage.setItem(HISTORY_KEY, JSON.stringify(list)); }catch{}
    }
    function storagePushHistory(entry){
      const list = storageGetHistory();
      list.unshift({ id: Math.random().toString(36).slice(2), ...entry });
      while (list.length > HISTORY_MAX) list.pop();
      storageSetHistory(list);
      try{ window.dispatchEvent(new CustomEvent('whHistory')); }catch{}
    }

    async function packBundle(text, files) {
      const pkg = { v: 1, createdAt: new Date().toISOString(), text, files: [] };
      let total = 0;
      for (const f of files) {
        const buf = new Uint8Array(await f.arrayBuffer());
        total += buf.length;
        if (total > 5 * 1024 * 1024 * 1024) throw new Error("Total evidence > 5 GB");
        pkg.files.push({ name: f.name, type: f.type, size: f.size, b64: b64(buf) });
      }
      const payload = enc.encode(JSON.stringify(pkg));
      const aesKeyRaw = crypto.getRandomValues(new Uint8Array(32));
      const aesKey = await crypto.subtle.importKey("raw", aesKeyRaw, "AES-GCM", false, ["encrypt", "decrypt"]);
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const ct = new Uint8Array(await crypto.subtle.encrypt({ name: "AES-GCM", iv }, aesKey, payload));
      return { pkgBytes: payload, aesKeyRaw, iv, ct };
    }

    async function unpackBundle(aesKeyRaw, iv, ct) {
      const aesKey = await crypto.subtle.importKey("raw", aesKeyRaw, "AES-GCM", false, ["decrypt"]);
      const plain = new Uint8Array(await crypto.subtle.decrypt({ name: "AES-GCM", iv }, aesKey, ct));
      return JSON.parse(dec.decode(plain));
    }

    function useToasts() {
      const [toasts, setToasts] = useState([]);
      
      // Icon initialization removed - using inline SVGs now to prevent DOM conflicts
      
      function push(msg, tone = "default") {
        const id = Math.random().toString(36).slice(2);
        setToasts((t) => [...t, { id, msg, tone }]);
        setTimeout(() => setToasts((t) => t.filter((x) => x.id !== id)), 3500);
      }
      return { toasts, push };
    }

    // micro interaction: ripple on buttons
    function ripple(e){
      try{
        const btn = e.currentTarget;
        const rect = btn.getBoundingClientRect();
        const size = Math.max(rect.width, rect.height);
        const x = e.clientX - rect.left - size/2;
        const y = e.clientY - rect.top - size/2;
        const circle = document.createElement('span');
        circle.className = 'ripple';
        circle.style.width = circle.style.height = size + 'px';
        circle.style.left = x + 'px';
        circle.style.top = y + 'px';
        btn.appendChild(circle);
        setTimeout(()=>{ try{ circle.remove(); }catch{} }, 650);
      }catch{}
    }

    // ============ PRIVACY FEATURES ============
    
    // ===== STEGANOGRAPHY MODE =====
    // Hide encrypted data inside an innocent-looking image
    async function hideDataInImage(imageFile, secretText) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        const reader = new FileReader();
        
        reader.onload = (e) => {
          img.onload = () => {
            const canvas = document.createElement('canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            // Add magic header for validation (WHIS = 01010111 01001000 01001001 01010011)
            const MAGIC = 'WHIS';
            const magicBinary = MAGIC.split('').map(c => 
              c.charCodeAt(0).toString(2).padStart(8, '0')
            ).join('');
            
            // Convert secret to binary
            const secretBinary = secretText.split('').map(c => 
              c.charCodeAt(0).toString(2).padStart(8, '0')
            ).join('');
            
            // Add length prefix (32 bits) and magic header
            const lengthBinary = secretBinary.length.toString(2).padStart(32, '0');
            const fullBinary = magicBinary + lengthBinary + secretBinary;
            
            // Check if image has enough capacity (use multiple channels for redundancy)
            const capacity = (data.length / 4) * 2; // Use 2 LSBs per pixel for better resilience
            if (fullBinary.length > capacity) {
              reject(new Error('Image too small for this message (need ~' + Math.ceil(fullBinary.length / capacity * img.width * img.height / 1000) + 'K pixels)'));
              return;
            }
            
            // Hide data in LSB of both RED and GREEN channels for redundancy
            for (let i = 0; i < fullBinary.length; i++) {
              const bit = parseInt(fullBinary[i]);
              const pixelIndex = Math.floor(i / 2);
              const channel = (i % 2 === 0) ? 0 : 1; // Alternate between red(0) and green(1)
              data[pixelIndex * 4 + channel] = (data[pixelIndex * 4 + channel] & 0xFE) | bit;
            }
            
            ctx.putImageData(imageData, 0, 0);
            // Use maximum quality PNG to prevent data loss
            canvas.toBlob((blob) => {
              resolve(new File([blob], 'photo.png', { type: 'image/png' }));
            }, 'image/png', 1.0);
          };
          img.src = e.target.result;
        };
        
        reader.onerror = reject;
        reader.readAsDataURL(imageFile);
      });
    }
    
    async function extractDataFromImage(imageFile) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        const reader = new FileReader();
        
        reader.onload = (e) => {
          img.onload = () => {
            const canvas = document.createElement('canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            // Extract magic header (first 32 bits from RED and GREEN channels)
            let magicBinary = '';
            for (let i = 0; i < 32; i++) {
              const pixelIndex = Math.floor(i / 2);
              const channel = (i % 2 === 0) ? 0 : 1;
              magicBinary += (data[pixelIndex * 4 + channel] & 1).toString();
            }
            
            // Verify magic header
            let magic = '';
            for (let i = 0; i < magicBinary.length; i += 8) {
              magic += String.fromCharCode(parseInt(magicBinary.substr(i, 8), 2));
            }
            
            if (magic !== 'WHIS') {
              reject(new Error('No Whistle hidden data found in this image. Make sure this image was created by Whistle Steganography.'));
              return;
            }
            
            // Extract length (next 32 bits)
            let lengthBinary = '';
            for (let i = 32; i < 64; i++) {
              const pixelIndex = Math.floor(i / 2);
              const channel = (i % 2 === 0) ? 0 : 1;
              lengthBinary += (data[pixelIndex * 4 + channel] & 1).toString();
            }
            const length = parseInt(lengthBinary, 2);
            
            if (length <= 0 || length > (data.length / 2) * 8) {
              reject(new Error('Data corrupted or invalid length'));
              return;
            }
            
            // Extract secret data
            let secretBinary = '';
            for (let i = 64; i < 64 + length; i++) {
              const pixelIndex = Math.floor(i / 2);
              const channel = (i % 2 === 0) ? 0 : 1;
              secretBinary += (data[pixelIndex * 4 + channel] & 1).toString();
            }
            
            // Convert binary back to text
            let secret = '';
            for (let i = 0; i < secretBinary.length; i += 8) {
              const byte = secretBinary.substr(i, 8);
              secret += String.fromCharCode(parseInt(byte, 2));
            }
            
            resolve(secret);
          };
          img.src = e.target.result;
        };
        
        reader.onerror = reject;
        reader.readAsDataURL(imageFile);
      });
    }

    // ===== SPREAD SPECTRUM STEGANOGRAPHY =====
    // Compression-resistant encoding using spread spectrum techniques
    
    // Helper: Simple hash function for seeding
    function simpleHash(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // Convert to 32-bit integer
      }
      return Math.abs(hash);
    }
    
    // Helper: Seeded pseudo-random number generator (LCG)
    function createSeededRandom(seed) {
      let state = seed;
      return function() {
        state = (state * 1664525 + 1013904223) >>> 0; // LCG algorithm
        return state / 4294967296; // Normalize to 0-1
      };
    }
    
    // Helper: Generate pseudo-random spreading sequence
    function generatePNSequence(password, bitIndex, length) {
      const seed = simpleHash(password + '|' + bitIndex);
      const rng = createSeededRandom(seed);
      const sequence = [];
      for (let i = 0; i < length; i++) {
        sequence.push(rng() > 0.5 ? 1 : -1);
      }
      return sequence;
    }
    
    // Helper: Select pixel indices for spreading
    function selectPixelIndices(bitIndex, spreadFactor, totalPixels, password) {
      const seed = simpleHash(password + '|idx|' + bitIndex);
      const rng = createSeededRandom(seed);
      const indices = [];
      const used = new Set();
      
      while (indices.length < spreadFactor) {
        const idx = Math.floor(rng() * totalPixels);
        if (!used.has(idx)) {
          used.add(idx);
          indices.push(idx);
        }
      }
      return indices;
    }
    
    // Spread Spectrum Encoder
    async function spreadSpectrumEncode(imageFile, secretText, password) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        const reader = new FileReader();
        
        reader.onload = (e) => {
          img.onload = () => {
            const canvas = document.createElement('canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            // Parameters
            const SPREAD_FACTOR = 128; // Each bit spread across 128 pixels
            const STRENGTH = 3; // Signal strength (+/- 3)
            
            // Add header
            const MAGIC = 'WHSS'; // Spread Spectrum magic
            const fullMessage = MAGIC + secretText;
            
            // Convert to binary
            const messageBits = fullMessage.split('').map(c => 
              c.charCodeAt(0).toString(2).padStart(8, '0')
            ).join('');
            
            // Check capacity
            const totalPixels = data.length / 4;
            const requiredPixels = messageBits.length * SPREAD_FACTOR;
            if (requiredPixels > totalPixels) {
              reject(new Error(`Image too small. Need ${Math.ceil(requiredPixels/totalPixels)}x larger image or shorter message.`));
              return;
            }
            
            // Encode each bit
            for (let i = 0; i < messageBits.length; i++) {
              const bit = parseInt(messageBits[i]);
              const sequence = generatePNSequence(password, i, SPREAD_FACTOR);
              const pixelIndices = selectPixelIndices(i, SPREAD_FACTOR, totalPixels, password);
              
              for (let j = 0; j < SPREAD_FACTOR; j++) {
                const pixelIdx = pixelIndices[j];
                const dataIdx = pixelIdx * 4; // RGBA
                const seqVal = sequence[j];
                
                // Apply to red channel with spreading
                if (bit === 1) {
                  data[dataIdx] = Math.max(0, Math.min(255, data[dataIdx] + STRENGTH * seqVal));
                } else {
                  data[dataIdx] = Math.max(0, Math.min(255, data[dataIdx] - STRENGTH * seqVal));
                }
              }
            }
            
            ctx.putImageData(imageData, 0, 0);
            canvas.toBlob((blob) => {
              resolve(new File([blob], 'photo-ss.png', { type: 'image/png' }));
            }, 'image/png', 1.0);
          };
          img.src = e.target.result;
        };
        
        reader.onerror = reject;
        reader.readAsDataURL(imageFile);
      });
    }
    
    // Spread Spectrum Decoder
    async function spreadSpectrumDecode(imageFile, password) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        const reader = new FileReader();
        
        reader.onload = (e) => {
          img.onload = () => {
            const canvas = document.createElement('canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            // Parameters (must match encoder)
            const SPREAD_FACTOR = 128;
            const totalPixels = data.length / 4;
            const MAX_MESSAGE_CHARS = 500; // Max chars to try
            const maxBits = MAX_MESSAGE_CHARS * 8;
            
            // Extract bits using correlation
            const extractedBits = [];
            for (let i = 0; i < maxBits; i++) {
              const sequence = generatePNSequence(password, i, SPREAD_FACTOR);
              const pixelIndices = selectPixelIndices(i, SPREAD_FACTOR, totalPixels, password);
              
              let correlation = 0;
              for (let j = 0; j < SPREAD_FACTOR; j++) {
                const pixelIdx = pixelIndices[j];
                const dataIdx = pixelIdx * 4;
                correlation += data[dataIdx] * sequence[j];
              }
              
              extractedBits.push(correlation > 0 ? '1' : '0');
            }
            
            // Convert bits to text
            let message = '';
            for (let i = 0; i < extractedBits.length; i += 8) {
              const byte = extractedBits.slice(i, i + 8).join('');
              const charCode = parseInt(byte, 2);
              if (charCode === 0) break; // Null terminator
              message += String.fromCharCode(charCode);
            }
            
            // Verify magic header
            if (!message.startsWith('WHSS')) {
              reject(new Error('No Spread Spectrum data found. The image may be corrupted or not encoded with Whistle.'));
              return;
            }
            
            // Remove magic header
            message = message.substring(4);
            
            // Clean up any trailing nulls or garbage
            const nullIndex = message.indexOf('\0');
            if (nullIndex > 0) {
              message = message.substring(0, nullIndex);
            }
            
            resolve(message);
          };
          img.src = e.target.result;
        };
        
        reader.onerror = reject;
        reader.readAsDataURL(imageFile);
      });
    }

    // ===== AUDIO STEGANOGRAPHY =====
    
    // Encode message into WAV audio file using LSB in audio samples
    async function hideDataInAudio(audioFile, secretText) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        
        reader.onload = async (e) => {
          try {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const arrayBuffer = e.target.result;
            const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
            
            // Get audio samples (use first channel)
            const channelData = audioBuffer.getChannelData(0);
            const samples = new Float32Array(channelData);
            
            // Add magic header
            const MAGIC = 'WHAU'; // Whistle Audio
            const fullMessage = MAGIC + secretText + '\0';
            
            // Convert message to binary
            const messageBits = fullMessage.split('').map(c => 
              c.charCodeAt(0).toString(2).padStart(8, '0')
            ).join('');
            
            // Check capacity (we can hide 1 bit per sample)
            if (messageBits.length > samples.length) {
              reject(new Error('Audio file too short for message. Need longer audio or shorter message.'));
              return;
            }
            
            // Encode bits into LSB of audio samples
            for (let i = 0; i < messageBits.length; i++) {
              const bit = parseInt(messageBits[i]);
              // Convert float to 16-bit integer, modify LSB, convert back
              let sample16 = Math.floor(samples[i] * 32768);
              sample16 = (sample16 & ~1) | bit; // Clear LSB and set new bit
              samples[i] = sample16 / 32768;
            }
            
            // Create new audio buffer with modified samples
            const newBuffer = audioContext.createBuffer(
              audioBuffer.numberOfChannels,
              audioBuffer.length,
              audioBuffer.sampleRate
            );
            newBuffer.copyToChannel(samples, 0);
            
            // Convert to WAV blob
            const wavBlob = audioBufferToWav(newBuffer);
            resolve(wavBlob);
          } catch (e) {
            reject(e);
          }
        };
        
        reader.onerror = reject;
        reader.readAsArrayBuffer(audioFile);
      });
    }
    // Extract hidden message from audio file
    async function extractDataFromAudio(audioFile) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        
        reader.onload = async (e) => {
          try {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const arrayBuffer = e.target.result;
            const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
            
            const channelData = audioBuffer.getChannelData(0);
            const samples = new Float32Array(channelData);
            
            // Extract bits from LSB
            let messageBits = '';
            for (let i = 0; i < Math.min(samples.length, 100000); i++) {
              const sample16 = Math.floor(samples[i] * 32768);
              const bit = sample16 & 1;
              messageBits += bit;
              
              // Try to decode every 8 bits
              if (messageBits.length % 8 === 0) {
                const chars = messageBits.match(/.{8}/g).map(b => String.fromCharCode(parseInt(b, 2)));
                const text = chars.join('');
                if (text.startsWith('WHAU')) {
                  // Found magic header, continue until null terminator
                  const nullIndex = text.indexOf('\0');
                  if (nullIndex > 0) {
                    resolve(text.substring(4, nullIndex));
                    return;
                  }
                }
              }
            }
            
            reject(new Error('No hidden message found in audio file.'));
          } catch (e) {
            reject(e);
          }
        };
        
        reader.onerror = reject;
        reader.readAsArrayBuffer(audioFile);
      });
    }
    
    // Helper: Convert AudioBuffer to WAV Blob
    function audioBufferToWav(buffer) {
      const length = buffer.length * buffer.numberOfChannels * 2;
      const arrayBuffer = new ArrayBuffer(44 + length);
      const view = new DataView(arrayBuffer);
      const channels = [];
      let offset = 0;
      let pos = 0;
      
      // Write WAV header
      const setUint16 = (data) => { view.setUint16(pos, data, true); pos += 2; };
      const setUint32 = (data) => { view.setUint32(pos, data, true); pos += 4; };
      
      setUint32(0x46464952); // "RIFF"
      setUint32(36 + length); // file length - 8
      setUint32(0x45564157); // "WAVE"
      setUint32(0x20746d66); // "fmt " chunk
      setUint32(16); // length = 16
      setUint16(1); // PCM
      setUint16(buffer.numberOfChannels);
      setUint32(buffer.sampleRate);
      setUint32(buffer.sampleRate * 2 * buffer.numberOfChannels);
      setUint16(buffer.numberOfChannels * 2);
      setUint16(16); // bits per sample
      setUint32(0x61746164); // "data" chunk
      setUint32(length);
      
      // Write interleaved audio data
      for (let i = 0; i < buffer.numberOfChannels; i++) {
        channels.push(buffer.getChannelData(i));
      }
      
      while (pos < arrayBuffer.byteLength) {
        for (let i = 0; i < buffer.numberOfChannels; i++) {
          let sample = Math.max(-1, Math.min(1, channels[i][offset]));
          sample = sample < 0 ? sample * 0x8000 : sample * 0x7FFF;
          view.setInt16(pos, sample, true);
          pos += 2;
        }
        offset++;
      }
      
      return new Blob([arrayBuffer], { type: 'audio/wav' });
    }
    
    // ===== VIDEO STEGANOGRAPHY =====
    
    // Encode message into video by hiding in frames
    async function hideDataInVideo(videoFile, secretText) {
      return new Promise((resolve, reject) => {
        const video = document.createElement('video');
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        video.onloadedmetadata = async () => {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          
          const MAGIC = 'WHVI'; // Whistle Video
          const fullMessage = MAGIC + secretText + '\0';
          
          // Convert to binary
          const messageBits = fullMessage.split('').map(c => 
            c.charCodeAt(0).toString(2).padStart(8, '0')
          ).join('');
          
          const duration = video.duration;
          const fps = 30; // Assume 30 FPS
          const totalFrames = Math.floor(duration * fps);
          const bitsPerFrame = 100; // Hide 100 bits per frame
          const requiredFrames = Math.ceil(messageBits.length / bitsPerFrame);
          
          if (requiredFrames > totalFrames) {
            reject(new Error('Video too short for message. Need longer video or shorter message.'));
            return;
          }
          
          // Use MediaRecorder to create new video
          const stream = canvas.captureStream(fps);
          const mediaRecorder = new MediaRecorder(stream, { 
            mimeType: 'video/webm;codecs=vp9',
            videoBitsPerSecond: 5000000
          });
          
          const chunks = [];
          mediaRecorder.ondataavailable = (e) => chunks.push(e.data);
          mediaRecorder.onstop = () => {
            const blob = new Blob(chunks, { type: 'video/webm' });
            resolve(blob);
          };
          
          mediaRecorder.start();
          
          let frameIndex = 0;
          let bitIndex = 0;
          
          const processFrame = () => {
            if (frameIndex >= totalFrames || bitIndex >= messageBits.length) {
              mediaRecorder.stop();
              return;
            }
            
            // Seek to frame
            video.currentTime = frameIndex / fps;
            
            video.onseeked = () => {
              ctx.drawImage(video, 0, 0);
              const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
              const data = imageData.data;
              
              // Hide bits in this frame
              let hiddenBits = 0;
              for (let i = 0; i < data.length && bitIndex < messageBits.length && hiddenBits < bitsPerFrame; i += 4) {
                const bit = parseInt(messageBits[bitIndex]);
                data[i] = (data[i] & ~1) | bit; // LSB of red channel
                bitIndex++;
                hiddenBits++;
              }
              
              ctx.putImageData(imageData, 0, 0);
              frameIndex++;
              
              setTimeout(processFrame, 1000 / fps);
            };
          };
          
          processFrame();
        };
        
        video.onerror = reject;
        video.src = URL.createObjectURL(videoFile);
        video.load();
      });
    }
    
    // Extract hidden message from video
    async function extractDataFromVideo(videoFile) {
      return new Promise((resolve, reject) => {
        const video = document.createElement('video');
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        video.onloadedmetadata = () => {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          
          const duration = video.duration;
          const fps = 30;
          const totalFrames = Math.floor(duration * fps);
          const bitsPerFrame = 100;
          
          let messageBits = '';
          let frameIndex = 0;
          
          const processFrame = () => {
            if (frameIndex >= totalFrames) {
              reject(new Error('No hidden message found in video.'));
              return;
            }
            
            video.currentTime = frameIndex / fps;
            
            video.onseeked = () => {
              ctx.drawImage(video, 0, 0);
              const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
              const data = imageData.data;
              
              // Extract bits from this frame
              let extractedBits = 0;
              for (let i = 0; i < data.length && extractedBits < bitsPerFrame; i += 4) {
                const bit = data[i] & 1;
                messageBits += bit;
                extractedBits++;
                
                // Try to decode
                if (messageBits.length % 8 === 0) {
                  const chars = messageBits.match(/.{8}/g).map(b => String.fromCharCode(parseInt(b, 2)));
                  const text = chars.join('');
                  if (text.startsWith('WHVI')) {
                    const nullIndex = text.indexOf('\0');
                    if (nullIndex > 0) {
                      resolve(text.substring(4, nullIndex));
                      return;
                    }
                  }
                }
              }
              
              frameIndex++;
              processFrame();
            };
          };
          
          processFrame();
        };
        
        video.onerror = reject;
        video.src = URL.createObjectURL(videoFile);
        video.load();
      });
    }

    // 1. Metadata Scrubber - Remove EXIF and metadata from files
    async function scrubMetadata(file) {
      try {
        // For images - remove EXIF data
        if (file.type.startsWith('image/')) {
          const arrayBuffer = await file.arrayBuffer();
          const uint8Array = new Uint8Array(arrayBuffer);
          
          // Create a canvas to re-encode without metadata
          const img = new Image();
          const blob = new Blob([uint8Array], { type: file.type });
          const url = URL.createObjectURL(blob);
          
          return new Promise((resolve) => {
            img.onload = () => {
              const canvas = document.createElement('canvas');
              canvas.width = img.width;
              canvas.height = img.height;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0);
              
              canvas.toBlob((cleanBlob) => {
                URL.revokeObjectURL(url);
                resolve(new File([cleanBlob], file.name, { type: file.type }));
              }, file.type, 0.95);
            };
            img.src = url;
          });
        }
        
        // For PDFs and other files - strip metadata headers
        if (file.type === 'application/pdf') {
          // Basic PDF metadata removal (simplified)
          const arrayBuffer = await file.arrayBuffer();
          const uint8Array = new Uint8Array(arrayBuffer);
          // Return as-is with warning (full PDF scrubbing requires pdf-lib)
          return file;
        }
        
        // For other files, return as-is
        return file;
      } catch (e) {
        console.error('Metadata scrub failed:', e);
        return file; // Return original if scrubbing fails
      }
    }


    function GlassCard({ title, subtitle, children, className = "" }) {
      const ref = useRef(null);
      const [tilt, setTilt] = useState('');
      function onMove(e){
        const el = ref.current; if(!el) return;
        const r = el.getBoundingClientRect();
        const px = (e.clientX - r.left) / r.width; // 0..1
        const py = (e.clientY - r.top) / r.height; // 0..1
        const rx = (py - .5) * 6; // tilt X
        const ry = (px - .5) * -6; // tilt Y
        setTilt(`perspective(900px) rotateX(${rx}deg) rotateY(${ry}deg)`);
      }
      function onLeave(){ setTilt(''); }
      return (
        <section ref={ref} onMouseMove={onMove} onMouseLeave={onLeave}
          className={`relative rounded-2xl border border-white/10 backdrop-blur-xl p-5 shadow-xl shadow-black/30 glass-hover will-change-transform ${className} glass-strong`}
          style={{ transform: tilt }}>
          <div className="mb-3">
            <h3 className="text-lg font-semibold text-white/90">{title}</h3>
            {subtitle && <p className="text-xs text-white/50">{subtitle}</p>}
  </div>
          {children}
        </section>
      );
    }

    function SectionHeader() {
      useEffect(()=>{
        if(window.lucide) window.lucide.createIcons();
      },[]);
      
      return (
        <header className="flex items-center justify-between border-b border-white/10 pb-3 fade-up gap-2 relative z-[10000]">
          <div className="flex items-center gap-2 min-w-0 flex-1">
            <div className="relative h-9 w-9 shrink-0 rounded-xl overflow-hidden border border-white/20 float-slow bg-white/5 hover:scale-110 transition-transform">
              <img src="whistel_logo_top_right_2048.png" alt="Whistle" className="absolute inset-0 h-full w-full object-contain"/>
               {!walletStore.pubkey && <span className="absolute inset-0 rounded-xl bg-cyan-400/20 animate-ping pulse-glow" />}
    </div>
      <div className="min-w-0 flex-1">
              <div className="text-white font-semibold text-sm sm:text-base md:text-lg">Whistle</div>
              <div className="text-[10px] sm:text-xs text-white/50 hidden sm:block">P2P encrypted tips • Solana proof</div>
              <div className="flex items-center gap-1 sm:gap-2 text-[9px] sm:text-[11px] text-white/60">
                <span className="font-mono truncate max-w-[18ch] sm:max-w-[28ch] md:max-w-[42ch]" title={CONTRACT_ADDRESS}>{CONTRACT_ADDRESS}</span>
                <button onClick={async()=>{ try{ await navigator.clipboard.writeText(CONTRACT_ADDRESS); alert('CA copied'); }catch{} }} className="rounded-md bg-white/10 hover:bg-white/20 border border-white/10 px-1 sm:px-2 py-[2px] text-white/80 btn-press shrink-0 text-[9px] sm:text-[11px]">Copy</button>
      </div>
      </div>
    </div>
          <div className="flex items-center gap-2 sm:gap-3 shrink-0">
            {/* GitHub icon link */}
            <a 
              href="https://github.com/DylanPort/whitelspace" 
              target="_blank"
              title="GitHub"
              className="hover:opacity-80 transition-opacity"
            >
              <img src="952978.png" alt="GitHub" className="w-6 h-6 sm:w-7 sm:h-7" />
            </a>
            
            {/* Whitepaper icon link */}
            <a 
              href="whitepaper.html" 
              target="_blank"
              title="Whitepaper"
              className="text-blue-400 hover:text-blue-300 transition-colors"
            >
              <svg className="w-6 h-6 sm:w-7 sm:h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
              </svg>
            </a>
            <WalletConnectButton />
          </div>
</header>
      );
    }

    // simple wallet event store
    const walletStore = { pubkey: null, setPub: () => {} };

    function WalletConnectButton() {
      const [isConnected, setIsConnected] = useState(false);
      const [walletAddress, setWalletAddress] = useState('');
      const [balance, setBalance] = useState(null);
      const [loadingBalance, setLoadingBalance] = useState(false);
      const [showDropdown, setShowDropdown] = useState(false);
      
      useEffect(() => {
        walletStore.setPub = (pk) => {
          setIsConnected(!!pk);
          setWalletAddress(pk || '');
        };
      }, []);
      
      // Fetch balance when connected
      useEffect(() => {
        async function fetchBalance() {
          if (!walletAddress || !isConnected) {
            setBalance(null);
            return;
          }
          
          setLoadingBalance(true);
          try {
            const rpc = 'https://rpc-mainnet.solanatracker.io/?api_key=3f5cbb18-8d2f-4a87-ae09-8555c243c705';
            const response = await fetch(rpc, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                jsonrpc: '2.0',
                id: 1,
                method: 'getBalance',
                params: [walletAddress]
              })
            });
            const data = await response.json();
            if (data.result && typeof data.result.value === 'number') {
              const balanceSOL = data.result.value / 1e9;
              setBalance(balanceSOL);
            } else {
              setBalance(0);
            }
          } catch (e) {
            console.error('Failed to fetch balance:', e);
            setBalance(null);
          } finally {
            setLoadingBalance(false);
          }
        }
        
        fetchBalance();
        // Refresh balance every 30 seconds
        const interval = setInterval(fetchBalance, 30000);
        return () => clearInterval(interval);
      }, [walletAddress, isConnected]);
      
      useEffect(() => {
        if (window.lucide) window.lucide.createIcons();
      }, [isConnected, showDropdown]);
      
      const handleConnect = async (e) => {
            ripple(e);
            if (!window?.solana?.isPhantom) {
          alert("Install Phantom to connect your wallet.");
              return;
            }
            try {
              const r = await window.solana.connect();
              walletStore.pubkey = r.publicKey.toBase58();
              walletStore.setPub(walletStore.pubkey);
        } catch (e) {
          console.error('Failed to connect:', e);
        }
      };
      
      const handleDisconnect = async () => {
        try {
          if (window?.solana?.disconnect) {
            await window.solana.disconnect();
          }
          walletStore.pubkey = null;
          walletStore.setPub(null);
          setShowDropdown(false);
        } catch (e) {
          console.error('Failed to disconnect:', e);
        }
      };
      
      if (!isConnected) {
        return (
          <button
            title="Connect Phantom Wallet"
            className="w-11 h-11 rounded-full transition-all hover:scale-110 active:scale-95 flex items-center justify-center shadow-lg bg-gradient-to-br from-cyan-500 to-cyan-600 hover:from-cyan-400 hover:to-cyan-500 shadow-cyan-500/30"
            onClick={handleConnect}
          >
            <i data-lucide="wallet" className="w-6 h-6 text-white"></i>
        </button>
        );
      }
      
      return (
        <div className="relative z-[9999]">
          <button
            onClick={() => setShowDropdown(!showDropdown)}
            className="flex items-center gap-2 px-3 py-2 rounded-xl bg-gradient-to-br from-emerald-500 to-emerald-600 hover:from-emerald-400 hover:to-emerald-500 shadow-lg shadow-emerald-500/30 transition-all hover:scale-105"
          >
            <i data-lucide="wallet" className="w-5 h-5 text-white"></i>
            <div className="hidden sm:flex flex-col items-start">
              <span className="text-xs text-white/90 font-mono">{walletAddress.slice(0,4)}...{walletAddress.slice(-4)}</span>
              {loadingBalance ? (
                <span className="text-xs text-white/70">Loading...</span>
              ) : balance !== null ? (
                <span className="text-xs font-bold text-white">{balance.toFixed(4)} SOL</span>
              ) : (
                <span className="text-xs text-white/70">--</span>
              )}
            </div>
            <i data-lucide={showDropdown ? "chevron-up" : "chevron-down"} className="w-4 h-4 text-white hidden sm:block"></i>
          </button>
          
          {showDropdown && (
            <div className="absolute right-0 top-full mt-2 w-64 rounded-xl bg-slate-900/95 backdrop-blur-xl border border-white/10 shadow-2xl z-[9999] overflow-hidden">
              <div className="p-4 border-b border-white/10">
                <div className="text-xs text-white/60 mb-1">Connected Wallet</div>
                <div className="text-sm font-mono text-white break-all">{walletAddress}</div>
                {balance !== null && (
                  <div className="mt-2 p-2 rounded-lg bg-emerald-500/10 border border-emerald-400/20">
                    <div className="text-xs text-white/60">Balance</div>
                    <div className="text-lg font-bold text-emerald-400">{balance.toFixed(4)} SOL</div>
                  </div>
                )}
              </div>
              <button
                onClick={handleDisconnect}
                className="w-full flex items-center gap-2 px-4 py-3 text-left hover:bg-red-500/20 transition-all text-red-400"
              >
                <i data-lucide="log-out" className="w-4 h-4"></i>
                <span className="text-sm font-semibold">Disconnect</span>
              </button>
            </div>
          )}
        </div>
      );
    }

    function StepPills({ step, setStep }) {
      const [isOpen, setIsOpen] = useState(false);
      
      const tabs = [
        { id: "home", label: "Home", icon: "home" },
        { id: "webrtc", label: "WebRTC Transfer", icon: "radio" },
        { id: "offline-network", label: "👻 Ghost Whistle", icon: "network" },
        { id: "services", label: "🌐 Services", icon: "box" },
        { id: "swap", label: "Privacy Swap", iconImg: "4DqRlDPT_400x400.png.png" },
        { id: "solana-privacy", label: "Solana Privacy Tools", iconImg: "solana.png" },
        { id: "pump-portal", label: "Pump Privacy Tools", iconImg: "idrs8cZ-zg_logos.png" },
        { id: "zolana", label: "Zolana Exchange", iconImg: "zcash-3d-icon-png-download-10372070.png" },
        { id: "privacy-tools", label: "🛡️ Privacy Tools", icon: "shield" },
      ];
      
      const currentTab = tabs.find(t => t.id === step) || tabs[0];
      
      useEffect(() => {
        if (window.lucide) window.lucide.createIcons();
      }, [isOpen, step]);
      
      return (
        <div className="relative md:hidden mb-4">
          {/* Dropdown Button */}
          <button
            onClick={() => setIsOpen(!isOpen)}
            className="w-full flex items-center justify-between px-4 py-3 rounded-xl bg-white/[0.04] border border-white/10 text-white hover:bg-white/[0.08] transition-all"
          >
            <div className="flex items-center gap-3">
              {currentTab.iconImg ? (
                <img src={currentTab.iconImg} alt={currentTab.label} className="w-5 h-5 object-contain" />
              ) : (
                <i data-lucide={currentTab.icon} className="w-5 h-5 text-cyan-400"></i>
              )}
              <span className="font-semibold text-sm sm:text-base">{currentTab.label}</span>
  </div>
            <i data-lucide={isOpen ? "chevron-up" : "chevron-down"} className="w-5 h-5 text-white/60"></i>
          </button>
          
          {/* Dropdown Menu */}
          {isOpen && (
            <div className="absolute top-full left-0 right-0 mt-2 rounded-xl bg-slate-900/95 backdrop-blur-xl border border-white/10 shadow-2xl z-50 overflow-hidden max-h-[70vh] overflow-y-auto">
              {tabs.map((t) => (
                <button
                  key={t.id}
                  onClick={() => {
                    setStep(t.id);
                    setIsOpen(false);
                  }}
                  className={`w-full flex items-center gap-3 px-4 py-3 text-left transition-all ${
                    step === t.id
                      ? "bg-cyan-400/20 text-cyan-200 border-l-4 border-cyan-400"
                      : "text-white/80 hover:bg-white/[0.08] border-l-4 border-transparent"
                  }`}
                >
                  {t.iconImg ? (
                    <img src={t.iconImg} alt={t.label} className="w-5 h-5 object-contain" />
                  ) : (
                    <i data-lucide={t.icon} className="w-5 h-5"></i>
                  )}
                  <span className="font-medium text-sm">{t.label}</span>
                </button>
              ))}
    </div>
          )}
    </div>
      );
    }

    // Solana Privacy Toolkit - 5 Production Tools
    function SolanaPrivacyToolkit({ pushToast }) {
      // Check if library is available
      const libAvailable = typeof solanaWeb3 !== 'undefined';
      
      // Always call hooks in the same order
      const [rpc, setRpc] = useState('https://rpc-mainnet.solanatracker.io/?api_key=3f5cbb18-8d2f-4a87-ae09-8555c243c705');
      const [showRpcInput, setShowRpcInput] = useState(false);
      const [tool, setTool] = useState('deadman');
      
      // Dead Man's Switch
      const [dmsMessage, setDmsMessage] = useState('');
      const [dmsPassword, setDmsPassword] = useState('');
      const [dmsDestWallet, setDmsDestWallet] = useState('');
      const [dmsExpiry, setDmsExpiry] = useState('30');
      const [dmsActive, setDmsActive] = useState(false);
      const [dmsCheckInDate, setDmsCheckInDate] = useState('');
      const [dmsTxSignature, setDmsTxSignature] = useState('');
      
      // Vanishing Payments
      const [vanishAmount, setVanishAmount] = useState('0.01');
      const [vanishHours, setVanishHours] = useState('24');
      const [vanishLink, setVanishLink] = useState('');
      const [vanishExpires, setVanishExpires] = useState('');
      
      // Dead Drop Messages
      const [dropRecipient, setDropRecipient] = useState('');
      const [dropMessage, setDropMessage] = useState('');
      const [dropPassword, setDropPassword] = useState('');
      const [dropTxSig, setDropTxSig] = useState('');
      
      // Verifiable Coin Flip
      const [flipCommit, setFlipCommit] = useState('');
      const [flipSecret, setFlipSecret] = useState('');
      const [flipReveal, setFlipReveal] = useState('');
      const [flipResult, setFlipResult] = useState('');
      const [isFlipping, setIsFlipping] = useState(false);
      
      // Anonymous Donation Jar
      const [donationWallets, setDonationWallets] = useState([]);
      const [donationCount, setDonationCount] = useState('3');
      const [donationSweepTo, setDonationSweepTo] = useState('');
      
      useEffect(()=>{ if(window.lucide) window.lucide.createIcons(); },[tool, showRpcInput, isFlipping, flipResult]);
      
      // Early return if library not available (after all hooks)
      if (!libAvailable) {
        return (
          <GlassCard title="Solana Privacy Tools" subtitle="Solana Web3.js library not loaded">
            <div className="bg-red-500/10 border border-red-500/30 rounded-xl p-6">
              <h3 className="text-white font-semibold mb-2">⚠️ Library Not Loaded</h3>
              <p className="text-white/70 text-sm">The Solana Web3.js library failed to load. Please refresh the page.</p>
              <button 
                onClick={() => window.location.reload()} 
                className="mt-4 px-4 py-2 bg-red-500 hover:bg-red-400 text-white rounded-lg transition-all"
              >
                Refresh Page
              </button>
            </div>
          </GlassCard>
        );
      }
      
      // Safe to use solanaWeb3 now
      const { Connection, PublicKey, SystemProgram, Transaction } = solanaWeb3;
      const conn = useMemo(()=> new Connection(rpc, 'confirmed'), [rpc]);
      const toLamports = (sol)=> Math.round(parseFloat(sol||'0') * 1e9);
      const toSOL = (lam)=> (lam / 1e9).toFixed(4);
      const toB58 = (u8)=> (window.bs58 ? window.bs58.encode(u8) : btoa(String.fromCharCode(...u8)));
      const fromB58 = (str)=> (window.bs58 ? new Uint8Array(window.bs58.decode(str)) : Uint8Array.from(atob(str), c=>c.charCodeAt(0)));
      
      async function getWallet(){ 
        if(!window?.solana){ alert('Install Phantom Wallet'); throw new Error('wallet'); } 
        const r=await window.solana.connect(); 
        return new PublicKey(r.publicKey.toString()); 
      }
      
      async function signAndSend(tx, feePayer){
        tx.feePayer = feePayer;
        const { blockhash } = await conn.getLatestBlockhash();
        tx.recentBlockhash = blockhash;
          const s = await window.solana.signTransaction(tx);
          const sig = await conn.sendRawTransaction(s.serialize(), { skipPreflight:false });
          await conn.confirmTransaction(sig, 'confirmed');
          return sig;
      }
      
      const MEMO_PROGRAM_ID = new PublicKey('MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr');
      function memoIx(text, signer){ 
        return new solanaWeb3.TransactionInstruction({ 
          keys:[{pubkey:signer,isSigner:true,isWritable:false}], 
          programId: MEMO_PROGRAM_ID, 
          data: new TextEncoder().encode(text||'') 
        }); 
      }
      
      async function encryptAES(text, password){
        const enc = new TextEncoder();
        const keyMaterial = await crypto.subtle.importKey('raw', enc.encode(password), 'PBKDF2', false, ['deriveBits', 'deriveKey']);
        const salt = crypto.getRandomValues(new Uint8Array(16));
        const key = await crypto.subtle.deriveKey({name:'PBKDF2',salt,iterations:100000,hash:'SHA-256'},keyMaterial,{name:'AES-GCM',length:256},false,['encrypt']);
        const iv = crypto.getRandomValues(new Uint8Array(12));
        const ct = await crypto.subtle.encrypt({name:'AES-GCM',iv}, key, enc.encode(text));
        return btoa(String.fromCharCode(...salt,...iv,...new Uint8Array(ct)));
      }
      
      async function decryptAES(b64, password){
        const enc = new TextEncoder();
        const keyMaterial = await crypto.subtle.importKey('raw', enc.encode(password), 'PBKDF2', false, ['deriveBits', 'deriveKey']);
        const bytes = Uint8Array.from(atob(b64), c=>c.charCodeAt(0));
        const salt = bytes.slice(0,16);
        const iv = bytes.slice(16,28);
        const ct = bytes.slice(28);
        const key = await crypto.subtle.deriveKey({name:'PBKDF2',salt,iterations:100000,hash:'SHA-256'},keyMaterial,{name:'AES-GCM',length:256},false,['decrypt']);
        const pt = await crypto.subtle.decrypt({name:'AES-GCM',iv}, key, ct);
        return new TextDecoder().decode(pt);
      }
      
      // 1. DEAD MAN'S SWITCH
      async function activateDeadMansSwitch(){
        if(!dmsMessage) return alert('Enter a message to encrypt');
        if(!dmsPassword) return alert('Enter an encryption password');
        if(!dmsDestWallet) return alert('Enter destination wallet address');
        
        try{
          const encrypted = await encryptAES(dmsMessage, dmsPassword);
          const expiry = Date.now() + (parseInt(dmsExpiry) * 24 * 60 * 60 * 1000);
          const expiryDate = new Date(expiry).toLocaleString();
          
          const payer = await getWallet();
          const dest = new PublicKey(dmsDestWallet);
          
          // Send encrypted memo to destination wallet
          const memoText = `DMS:EXP:${expiry}:MSG:${encrypted}`;
          const tx = new Transaction().add(
            SystemProgram.transfer({
              fromPubkey: payer,
              toPubkey: dest,
              lamports: 5000 // Small amount (0.000005 SOL) to fund the memo
            }),
            memoIx(memoText, payer)
          );
          
          const sig = await signAndSend(tx, payer);
          
          setDmsActive(true);
          setDmsCheckInDate(expiryDate);
          setDmsTxSignature(sig);
          
          pushToast?.('Dead Man\'s Switch activated! Check in before ' + new Date(expiry).toLocaleDateString(), 'ok');
        }catch(e){
          console.error(e);
          pushToast?.('Failed to activate Dead Man\'s Switch', 'err');
        }
      }
      
      async function checkInDeadMansSwitch(){
        try{
          const newExpiry = Date.now() + (parseInt(dmsExpiry) * 24 * 60 * 60 * 1000);
          const newExpiryDate = new Date(newExpiry).toLocaleString();
          
          const payer = await getWallet();
          const dest = new PublicKey(dmsDestWallet);
          
          const tx = new Transaction().add(
            SystemProgram.transfer({
              fromPubkey: payer,
              toPubkey: dest,
              lamports: 5000
            }),
            memoIx(`DMS:CHECKIN:${newExpiry}:STILL_ALIVE`, payer)
          );
          
          await signAndSend(tx, payer);
          setDmsCheckInDate(newExpiryDate);
          
          pushToast?.('Checked in! Timer reset to ' + new Date(newExpiry).toLocaleDateString(), 'ok');
        }catch(e){
          console.error(e);
          pushToast?.('Failed to check in', 'err');
        }
      }
      
      async function revealPasswordDeadMansSwitch(){
        if(!dmsPassword) return alert('No password stored');
        
        try{
          const payer = await getWallet();
          const dest = new PublicKey(dmsDestWallet);
          
          // Post decryption password to blockchain
          const tx = new Transaction().add(
            SystemProgram.transfer({
              fromPubkey: payer,
              toPubkey: dest,
              lamports: 5000
            }),
            memoIx(`DMS:PASSWORD_REVEALED:${dmsPassword}`, payer)
          );
          
          await signAndSend(tx, payer);
          pushToast?.('Password published to blockchain! Anyone can now decrypt the message.', 'ok');
        }catch(e){
          console.error(e);
          pushToast?.('Failed to reveal password', 'err');
        }
      }
      
      // 2. VANISHING PAYMENTS
      async function createVanishingPayment(){
        const burner = solanaWeb3.Keypair.generate();
        const expiryTime = Date.now() + (parseInt(vanishHours) * 60 * 60 * 1000);
        const secret = toB58(burner.secretKey);
        const link = `${location.origin}${location.pathname}#vanish=${secret}&exp=${expiryTime}`;
        
        setVanishLink(link);
        setVanishExpires(new Date(expiryTime).toLocaleString());
        pushToast?.('Vanishing payment link created! Fund it before sharing.', 'ok');
      }
      
      async function fundVanishingPayment(){
        if(!vanishLink) return alert('Create vanishing payment first');
        try{
          const secret = vanishLink.split('#vanish=')[1].split('&')[0];
          const burner = solanaWeb3.Keypair.fromSecretKey(fromB58(secret));
          const payer = await getWallet();
          
          const tx = new Transaction().add(
            SystemProgram.transfer({
              fromPubkey: payer,
              toPubkey: burner.publicKey,
              lamports: toLamports(vanishAmount)
            })
          );
          await signAndSend(tx, payer);
          pushToast?.(`Funded ${vanishAmount} SOL to vanishing wallet`, 'ok');
        }catch(e){
          console.error(e);
          pushToast?.('Failed to fund vanishing payment', 'err');
        }
      }
      
      async function claimVanishingPayment(){
        const hash = location.hash || '';
        if(!hash.includes('#vanish=')) return alert('No vanishing payment in URL');
        
        try{
          const parts = hash.split('#vanish=')[1].split('&');
          const secret = parts[0];
          const expiry = parseInt(parts[1]?.replace('exp=', '') || '0');
          
          if(Date.now() > expiry) return alert('Payment expired!');
          
          const burner = solanaWeb3.Keypair.fromSecretKey(fromB58(secret));
          const dest = await getWallet();
          const bal = await conn.getBalance(burner.publicKey);
          if(bal <= 5000) return alert('Nothing to claim');
          
          const tx = new Transaction().add(
            SystemProgram.transfer({
              fromPubkey: burner.publicKey,
              toPubkey: dest,
              lamports: bal - 5000
            })
          );
          tx.feePayer = burner.publicKey;
          tx.recentBlockhash = (await conn.getLatestBlockhash()).blockhash;
          tx.partialSign(burner);
          const sig = await conn.sendRawTransaction(tx.serialize());
          await conn.confirmTransaction(sig, 'confirmed');
          pushToast?.(`Claimed ${toSOL(bal-5000)} SOL!`, 'ok');
        }catch(e){
          console.error(e);
          pushToast?.('Failed to claim vanishing payment', 'err');
        }
      }
      
      // 3. DEAD DROP MESSAGES
      async function sendDeadDrop(){
        if(!dropRecipient) return alert('Enter recipient wallet address');
        if(!dropMessage) return alert('Enter a message');
        if(!dropPassword) return alert('Enter encryption password');
        
        try{
          const encrypted = await encryptAES(dropMessage, dropPassword);
          const payer = await getWallet();
          const dest = new PublicKey(dropRecipient);
          
          const tx = new Transaction().add(
            SystemProgram.transfer({
              fromPubkey: payer,
              toPubkey: dest,
              lamports: 5000
            }),
            memoIx(`DEAD_DROP:${encrypted}`, payer)
          );
          
          const sig = await signAndSend(tx, payer);
          setDropTxSig(sig);
          pushToast?.('Dead drop message sent! Only the recipient can decrypt it.', 'ok');
        }catch(e){
          console.error(e);
          pushToast?.('Failed to send dead drop', 'err');
        }
      }
      
      // 4. VERIFIABLE COIN FLIP
      async function commitFlip(){
        setIsFlipping(true);
        
        const secret = Math.random().toString(36).substring(2, 15);
        const choice = Math.random() > 0.5 ? 'HEADS' : 'TAILS';
        const commitString = `${choice}:${secret}`;
        const encoder = new TextEncoder();
        const data = encoder.encode(commitString);
        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        
        setFlipSecret(commitString);
        
        // Show flipping animation
        await new Promise(r=>setTimeout(r, 1500));
        setIsFlipping(false);
        setFlipCommit(hashHex);
        
        try{
          const payer = await getWallet();
          const tx = new Transaction().add(
            memoIx(`COIN_FLIP_COMMIT:${hashHex}`, payer)
          );
          await signAndSend(tx, payer);
          pushToast?.('Commitment posted on-chain! Now reveal it.', 'ok');
        }catch(e){
          console.error(e);
          setFlipCommit('');
          setFlipSecret('');
          pushToast?.('Failed to commit flip', 'err');
        }
      }
      
      async function revealFlip(){
        if(!flipSecret) return alert('No commitment to reveal');
        
        const choice = flipSecret.split(':')[0];
        setFlipReveal(choice);
        
        // Show reveal animation
        await new Promise(r=>setTimeout(r, 500));
        setFlipResult(choice);
        
        try{
          const payer = await getWallet();
          const tx = new Transaction().add(
            memoIx(`COIN_FLIP_REVEAL:${flipSecret}`, payer)
          );
          await signAndSend(tx, payer);
          pushToast?.(`Result: ${choice}! Anyone can verify the commitment.`, 'ok');
        }catch(e){
          console.error(e);
          pushToast?.('Failed to reveal flip', 'err');
        }
      }
      
      // 5. ANONYMOUS DONATION JAR
      async function createDonationJar(){
        const count = parseInt(donationCount);
        const wallets = Array.from({length: count}, ()=> {
          const kp = solanaWeb3.Keypair.generate();
          return {
            address: kp.publicKey.toString(),
            secret: toB58(kp.secretKey)
          };
        });
        
        setDonationWallets(wallets);
        pushToast?.(`Created ${count} anonymous donation addresses!`, 'ok');
      }
      
      async function sweepDonations(){
        if(!donationSweepTo) return alert('Enter sweep destination address');
        if(donationWallets.length === 0) return alert('No donation wallets created');
        
        try{
          const dest = new PublicKey(donationSweepTo);
          let totalSwept = 0;
          
          for(let wallet of donationWallets){
            const burner = solanaWeb3.Keypair.fromSecretKey(fromB58(wallet.secret));
            const bal = await conn.getBalance(burner.publicKey);
            
            if(bal > 5000){
              const tx = new Transaction().add(
                SystemProgram.transfer({
                  fromPubkey: burner.publicKey,
                  toPubkey: dest,
                  lamports: bal - 5000
                })
              );
              tx.feePayer = burner.publicKey;
              tx.recentBlockhash = (await conn.getLatestBlockhash()).blockhash;
              tx.partialSign(burner);
              
              await conn.sendRawTransaction(tx.serialize());
              totalSwept += (bal - 5000);
              await new Promise(r=>setTimeout(r, 500));
            }
          }
          
          pushToast?.(`Swept ${toSOL(totalSwept)} SOL from donation wallets!`, 'ok');
        }catch(e){
          console.error(e);
          pushToast?.('Failed to sweep donations', 'err');
        }
      }
      
      const tools = [
        { id: 'deadman', name: 'Dead Man\'s Switch', icon: 'clock', desc: 'Auto-release encrypted data' },
        { id: 'vanish', name: 'Vanishing Payments', icon: 'timer', desc: 'Time-limited claim links' },
        { id: 'deaddrop', name: 'Dead Drop Messages', icon: 'mail', desc: 'Anonymous encrypted messages' },
        { id: 'coinflip', name: 'Verifiable Coin Flip', icon: 'dice-3', desc: 'Trustless randomness' },
        { id: 'donations', name: 'Anonymous Donation Jar', icon: 'piggy-bank', desc: 'Untraceable donations' }
      ];
      return (
        <GlassCard title="Solana Privacy Tools" subtitle="5 Production-Ready Privacy Tools • No Smart Contracts">
          {/* RPC Selector */}
          <div className="mb-4 bg-green-500/10 border border-green-400/30 rounded-lg p-3">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-2">
                <i data-lucide="server" className="w-4 h-4 text-green-400"></i>
                <span className="text-sm text-white/80">RPC: <span className="text-green-400 font-mono text-xs">
                  {rpc.includes('devnet') ? 'Devnet (Test Network)' : 
                   rpc.includes('solanatracker') ? 'SolanaTracker Mainnet ✓' : 
                   'Custom RPC'}
                </span></span>
          </div>
              <button 
                onClick={()=>setShowRpcInput(!showRpcInput)}
                className="text-xs px-3 py-1 bg-green-500/20 hover:bg-green-500/30 border border-green-400/40 rounded text-green-400 transition-all"
              >
                {showRpcInput ? 'Hide' : 'Change RPC'}
              </button>
            </div>
            {showRpcInput && (
              <div className="mt-3 space-y-2">
              <div className="flex gap-2">
                  <input 
                    type="text"
                    value={rpc}
                    onChange={e=>setRpc(e.target.value)}
                    placeholder="Enter RPC URL"
                    className="flex-1 bg-white/5 border border-white/20 rounded px-3 py-2 text-white text-sm font-mono"
                  />
              </div>
                <div className="flex flex-wrap gap-2 text-xs">
                  <button onClick={()=>{setRpc('https://rpc-mainnet.solanatracker.io/?api_key=3f5cbb18-8d2f-4a87-ae09-8555c243c705'); pushToast?.('Switched to SolanaTracker Mainnet', 'ok');}} className="px-3 py-1 bg-green-500/20 border border-green-400/40 rounded text-green-400">SolanaTracker (Fast)</button>
                  <button onClick={()=>{setRpc('https://api.devnet.solana.com'); pushToast?.('Switched to Devnet', 'ok');}} className="px-3 py-1 bg-cyan-500/20 border border-cyan-400/40 rounded text-cyan-400">Devnet (Test)</button>
                  <button onClick={()=>{setRpc('https://api.mainnet-beta.solana.com'); pushToast?.('Public mainnet may be rate-limited', 'warn');}} className="px-3 py-1 bg-purple-500/20 border border-purple-400/40 rounded text-purple-400">Public Mainnet</button>
                </div>
                <p className="text-xs text-white/50">💡 Using SolanaTracker RPC (no rate limits). Can also use <a href="https://helius.dev" target="_blank" className="text-cyan-400 hover:underline">Helius</a> or <a href="https://quicknode.com" target="_blank" className="text-cyan-400 hover:underline">QuickNode</a></p>
            </div>
          )}
              </div>
          
          {/* Tool Selection */}
          <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-3 mb-6">
            {tools.map(t => (
              <button 
                key={t.id} 
                onClick={()=>setTool(t.id)}
                className={`p-4 rounded-xl border transition-all ${
                  tool===t.id 
                    ? 'bg-gradient-to-br from-cyan-500/20 to-blue-500/20 border-cyan-400/60' 
                    : 'bg-white/5 border-white/10 hover:bg-white/10 hover:border-white/20'
                }`}
              >
                <i data-lucide={t.icon} className={`w-6 h-6 mb-2 ${tool===t.id ? 'text-cyan-400' : 'text-white/60'}`}></i>
                <div className={`font-bold text-sm mb-1 ${tool===t.id ? 'text-white' : 'text-white/80'}`}>{t.name}</div>
                <div className="text-xs text-white/50">{t.desc}</div>
              </button>
            ))}
          </div>
          
          {/* Tool Content */}
          <div className="bg-white/5 border border-white/10 rounded-xl p-6">
            {tool === 'deadman' && (
              <div className="space-y-4">
                <div className="flex items-center gap-3 mb-4">
                  <i data-lucide="clock" className="w-6 h-6 text-orange-400"></i>
                  <div>
                    <h3 className="font-bold text-white text-lg">Dead Man's Switch</h3>
                    <p className="text-white/60 text-sm">Publish encrypted memo to blockchain - auto-reveal if you don't check in</p>
                  </div>
                </div>
                
                <div className="bg-orange-500/10 border border-orange-400/30 rounded-lg p-4 text-sm text-white/80">
                  <strong className="text-orange-400">How it works:</strong> Encrypt your message → Send as memo to chosen wallet → Check in periodically → If you don't check in, publish password to blockchain so anyone can decrypt.
                </div>
                
                <div className="bg-white/5 border border-white/10 rounded-lg p-4 text-sm text-white/70">
                  <strong className="text-white">Why use this?</strong> Perfect for whistleblowers with insurance files, activists with sensitive intel, or anyone who needs their data released if something happens to them. Encrypted message lives on-chain forever, password revealed only if you stop checking in.
                </div>
                
            <div className="space-y-3">
                  <textarea 
                    className="w-full h-32 bg-white/5 border border-white/20 rounded-lg px-4 py-3 text-white resize-none" 
                    placeholder="Enter sensitive message (will be encrypted and published on-chain)..."
                    value={dmsMessage}
                    onChange={e=>setDmsMessage(e.target.value)}
                  />
                  
                  <input 
                    type="text"
                    className="w-full bg-white/5 border border-white/20 rounded-lg px-4 py-2 text-white font-mono text-sm" 
                    placeholder="Destination wallet address (who receives the memo)"
                    value={dmsDestWallet}
                    onChange={e=>setDmsDestWallet(e.target.value)}
                  />
                  
              <div className="flex gap-2">
                    <input 
                      type="password"
                      className="flex-1 bg-white/5 border border-white/20 rounded-lg px-4 py-2 text-white" 
                      placeholder="Encryption password"
                      value={dmsPassword}
                      onChange={e=>setDmsPassword(e.target.value)}
                    />
                    <input 
                      type="number"
                      className="w-32 bg-white/5 border border-white/20 rounded-lg px-4 py-2 text-white" 
                      placeholder="Days"
                      value={dmsExpiry}
                      onChange={e=>setDmsExpiry(e.target.value)}
                    />
              </div>
                  
                  {!dmsActive ? (
                    <button onClick={activateDeadMansSwitch} className="w-full px-6 py-3 bg-orange-500 hover:bg-orange-400 text-white font-semibold rounded-lg transition-all">
                      💀 Activate Dead Man's Switch (Sends ~0.000005 SOL + Memo)
                    </button>
                  ) : (
                    <>
                      <div className="bg-green-500/10 border border-green-400/30 rounded-lg p-4">
                        <div className="text-xs text-white/60 mb-2">✓ Dead Man's Switch Active</div>
                        <div className="text-xs text-white/60 mb-1">Next Check-In Required Before:</div>
                        <div className="text-sm text-orange-400 font-semibold mb-2">{dmsCheckInDate}</div>
                        {dmsTxSignature && (
                          <a 
                            href={`https://solscan.io/tx/${dmsTxSignature}`} 
                            target="_blank"
                            className="text-xs text-cyan-400 hover:underline break-all"
                          >
                            View on Solscan →
                          </a>
                        )}
            </div>
                      
                      <div className="grid grid-cols-2 gap-2">
                        <button onClick={checkInDeadMansSwitch} className="px-6 py-3 bg-green-500 hover:bg-green-400 text-white font-semibold rounded-lg transition-all">
                          ✓ Check In (I'm Alive)
                        </button>
                        <button onClick={revealPasswordDeadMansSwitch} className="px-6 py-3 bg-red-500 hover:bg-red-400 text-white font-semibold rounded-lg transition-all">
                          🔓 Reveal Password Now
                        </button>
                      </div>
                      
                      <div className="text-xs text-white/50 text-center">
                        Encrypted memo already on blockchain. Revealing password will let anyone decrypt it.
                      </div>
                    </>
                  )}
              </div>
            </div>
          )}
            
            {tool === 'vanish' && (
              <div className="space-y-4">
                <div className="flex items-center gap-3 mb-4">
                  <i data-lucide="timer" className="w-6 h-6 text-pink-400"></i>
                  <div>
                    <h3 className="font-bold text-white text-lg">Vanishing Payments</h3>
                    <p className="text-white/60 text-sm">Time-limited claim links that expire automatically</p>
                  </div>
                </div>
                
                <div className="bg-pink-500/10 border border-pink-400/30 rounded-lg p-4 text-sm text-white/80">
                  <strong className="text-pink-400">How it works:</strong> Create expiring payment link → Fund it → Share with recipient → They claim before expiry → Otherwise funds return to you.
                </div>
                
            <div className="space-y-3">
                  <div className="grid grid-cols-2 gap-2">
                    <div>
                      <label className="text-xs text-white/60 mb-1 block">Amount (SOL)</label>
                      <input 
                        type="number"
                        step="0.01"
                        className="w-full bg-white/5 border border-white/20 rounded-lg px-4 py-2 text-white" 
                        value={vanishAmount}
                        onChange={e=>setVanishAmount(e.target.value)}
                      />
              </div>
                    <div>
                      <label className="text-xs text-white/60 mb-1 block">Expires In (Hours)</label>
                      <input 
                        type="number"
                        className="w-full bg-white/5 border border-white/20 rounded-lg px-4 py-2 text-white" 
                        value={vanishHours}
                        onChange={e=>setVanishHours(e.target.value)}
                      />
            </div>
                  </div>
                  
                  <button onClick={createVanishingPayment} className="w-full px-6 py-3 bg-pink-500 hover:bg-pink-400 text-white font-semibold rounded-lg transition-all">
                    Create Vanishing Payment
                  </button>
                  
                  {vanishLink && (
                    <>
                      <div className="bg-white/5 border border-white/20 rounded-lg p-3">
                        <div className="text-xs text-white/60 mb-1">Payment Link (expires {vanishExpires}):</div>
                        <div className="text-sm text-white break-all font-mono">{vanishLink}</div>
                      </div>
                      
                      <button onClick={fundVanishingPayment} className="w-full px-6 py-3 bg-purple-500 hover:bg-purple-400 text-white font-semibold rounded-lg transition-all">
                        Fund {vanishAmount} SOL
                      </button>
                    </>
                  )}
                  
                  {location.hash.includes('#vanish=') && (
                    <button onClick={claimVanishingPayment} className="w-full px-6 py-3 bg-emerald-500 hover:bg-emerald-400 text-black font-semibold rounded-lg transition-all">
                      ⏰ Claim Vanishing Payment
                    </button>
                  )}
                </div>
            </div>
          )}
            
            {tool === 'deaddrop' && (
              <div className="space-y-4">
                <div className="flex items-center gap-3 mb-4">
                  <i data-lucide="mail" className="w-6 h-6 text-blue-400"></i>
                  <div>
                    <h3 className="font-bold text-white text-lg">Dead Drop Messages</h3>
                    <p className="text-white/60 text-sm">Send anonymous encrypted messages to any wallet</p>
                  </div>
                </div>
                
                <div className="bg-blue-500/10 border border-blue-400/30 rounded-lg p-4 text-sm text-white/80">
                  <strong className="text-blue-400">How it works:</strong> Encrypt your message → Send as memo to any Solana address → Only they can decrypt with password. Perfect for anonymous tips.
                </div>
                
                <div className="bg-white/5 border border-white/10 rounded-lg p-4 text-sm text-white/70">
                  <strong className="text-white">Why use this?</strong> Journalists can publish their wallet address for anonymous tips. Whistleblowers send encrypted intel without revealing identity. Message lives forever on blockchain.
                </div>
                
            <div className="space-y-3">
                  <input 
                    type="text"
                    className="w-full bg-white/5 border border-white/20 rounded-lg px-4 py-2 text-white font-mono text-sm" 
                    placeholder="Recipient wallet address"
                    value={dropRecipient}
                    onChange={e=>setDropRecipient(e.target.value)}
                  />
                  
                  <textarea 
                    className="w-full h-32 bg-white/5 border border-white/20 rounded-lg px-4 py-3 text-white resize-none" 
                    placeholder="Your secret message..."
                    value={dropMessage}
                    onChange={e=>setDropMessage(e.target.value)}
                  />
                  
                  <input 
                    type="password"
                    className="w-full bg-white/5 border border-white/20 rounded-lg px-4 py-2 text-white" 
                    placeholder="Encryption password (share with recipient separately)"
                    value={dropPassword}
                    onChange={e=>setDropPassword(e.target.value)}
                  />
                  
                  <button onClick={sendDeadDrop} className="w-full px-6 py-3 bg-blue-500 hover:bg-blue-400 text-white font-semibold rounded-lg transition-all">
                    📨 Send Dead Drop (0.000005 SOL + fee)
                  </button>
                  
                  {dropTxSig && (
                    <div className="bg-green-500/10 border border-green-400/30 rounded-lg p-3">
                      <div className="text-xs text-white/60 mb-1">✓ Message delivered!</div>
                      <a 
                        href={`https://solscan.io/tx/${dropTxSig}`} 
                        target="_blank"
                        className="text-xs text-cyan-400 hover:underline break-all"
                      >
                        View on Solscan →
                      </a>
              </div>
                  )}
                  
                  <div className="text-xs text-white/50 text-center">
                    💡 Share the password via secure channel (Signal, Session, etc)
                  </div>
                </div>
            </div>
          )}
            
            {tool === 'coinflip' && (
              <div className="space-y-4">
                <div className="flex items-center gap-3 mb-4">
                  <i data-lucide="dice-3" className="w-6 h-6 text-yellow-400"></i>
                  <div>
                    <h3 className="font-bold text-white text-lg">Verifiable Coin Flip</h3>
                    <p className="text-white/60 text-sm">Provably fair randomness with commit-reveal</p>
                  </div>
                </div>
                
                <div className="bg-yellow-500/10 border border-yellow-400/30 rounded-lg p-4 text-sm text-white/80">
                  <strong className="text-yellow-400">How it works:</strong> Commit your choice (hashed) → Post on-chain → Reveal to prove you didn't cheat. Trustless randomness!
                </div>
                
                <div className="bg-white/5 border border-white/10 rounded-lg p-4 text-sm text-white/70">
                  <strong className="text-white">Why use this?</strong> Make fair decisions without trusted third party. Both parties commit first, then reveal. Perfect for settling disputes, choosing winners, or any situation needing verifiable randomness.
                </div>
                
            <div className="space-y-3">
                  {isFlipping ? (
                    <>
                      <div className="flex justify-center py-8">
                        <div className="coin-flipping">
                          <div className="coin">
                            <div className="coin-side heads">HEADS</div>
                            <div className="coin-side tails">TAILS</div>
              </div>
            </div>
                      </div>
                      <div className="text-center text-yellow-400 font-semibold">Flipping...</div>
                    </>
                  ) : !flipCommit ? (
                    <>
                      <div className="flex justify-center py-8">
                        <div className="coin-flip-ready">
                          <div className="coin">
                            <div className="coin-side heads">HEADS</div>
                            <div className="coin-side tails">TAILS</div>
                          </div>
                        </div>
                      </div>
                      <button onClick={commitFlip} className="w-full px-6 py-3 bg-yellow-500 hover:bg-yellow-400 text-black font-semibold rounded-lg transition-all">
                        🎲 Flip Coin & Commit
                      </button>
                    </>
                  ) : (
                    <>
                      <div className="bg-white/5 border border-white/20 rounded-lg p-3">
                        <div className="text-xs text-white/60 mb-1">Commitment Hash (on-chain):</div>
                        <div className="text-xs text-yellow-400 break-all font-mono">{flipCommit}</div>
                      </div>
                      
                      {!flipResult ? (
                        <>
                          <div className="flex justify-center py-8">
                            <div className="coin-flip-ready">
                              <div className="coin">
                                <div className="coin-side heads">HEADS</div>
                                <div className="coin-side tails">TAILS</div>
                              </div>
                            </div>
                          </div>
                          <button onClick={revealFlip} className="w-full px-6 py-3 bg-green-500 hover:bg-green-400 text-white font-semibold rounded-lg transition-all">
                            🔓 Reveal Result
                          </button>
                        </>
                      ) : (
                        <>
                          <div className="flex justify-center py-8">
                            <div className={`coin-result ${flipResult === 'HEADS' ? 'show-heads' : 'show-tails'}`}>
                              <div className="coin">
                                <div className="coin-side heads">HEADS</div>
                                <div className="coin-side tails">TAILS</div>
                              </div>
                            </div>
                          </div>
                          <div className="bg-gradient-to-r from-green-500/20 to-emerald-500/20 border border-green-400/40 rounded-lg p-6 text-center">
                            <div className="text-2xl font-bold text-white mb-1">{flipResult}</div>
                            <div className="text-xs text-white/60">Verifiable on Solana blockchain</div>
                          </div>
                        </>
                      )}
                      
                      <button 
                        onClick={()=>{setFlipCommit('');setFlipSecret('');setFlipResult('');setFlipReveal('');setIsFlipping(false);}} 
                        className="w-full px-4 py-2 bg-white/10 hover:bg-white/20 text-white rounded-lg transition-all text-sm"
                      >
                        Reset & Flip Again
                      </button>
                    </>
                  )}
                </div>
              </div>
            )}
            
            {tool === 'donations' && (
              <div className="space-y-4">
                <div className="flex items-center gap-3 mb-4">
                  <i data-lucide="piggy-bank" className="w-6 h-6 text-green-400"></i>
                  <div>
                    <h3 className="font-bold text-white text-lg">Anonymous Donation Jar</h3>
                    <p className="text-white/60 text-sm">Untraceable donations with rotating wallets</p>
                  </div>
                </div>
                
                <div className="bg-green-500/10 border border-green-400/30 rounded-lg p-4 text-sm text-white/80">
                  <strong className="text-green-400">How it works:</strong> Generate multiple burner wallets → Each donor uses different address → Sweep all to main wallet. Donors can't be linked together.
                </div>
                
                <div className="bg-white/5 border border-white/10 rounded-lg p-4 text-sm text-white/70">
                  <strong className="text-white">Why use this?</strong> Activists receive donations without exposing donor network. Each donation to unique address breaks chain analysis. Perfect for controversial causes, political campaigns, or privacy-focused fundraising.
                </div>
                
            <div className="space-y-3">
                  {donationWallets.length === 0 ? (
                    <>
                      <div>
                        <label className="text-xs text-white/60 mb-1 block">Number of donation addresses</label>
                        <input 
                          type="number"
                          className="w-full bg-white/5 border border-white/20 rounded-lg px-4 py-2 text-white" 
                          value={donationCount}
                          onChange={e=>setDonationCount(e.target.value)}
                        />
            </div>
                      
                      <button onClick={createDonationJar} className="w-full px-6 py-3 bg-green-500 hover:bg-green-400 text-white font-semibold rounded-lg transition-all">
                        🏺 Create Donation Jar
                      </button>
                    </>
                  ) : (
                    <>
                      <div className="bg-white/5 border border-white/20 rounded-lg p-4 max-h-64 overflow-y-auto">
                        <div className="text-xs text-white/60 mb-2">Anonymous Donation Addresses:</div>
                        {donationWallets.map((w, i) => (
                          <div key={i} className="mb-2 pb-2 border-b border-white/10 last:border-0">
                            <div className="text-xs text-white/50 mb-1">Address #{i+1}</div>
                            <div className="text-xs text-green-400 break-all font-mono">{w.address}</div>
                          </div>
                        ))}
                      </div>
                      
                      <input 
                        type="text"
                        className="w-full bg-white/5 border border-white/20 rounded-lg px-4 py-2 text-white font-mono text-sm" 
                        placeholder="Your main wallet (sweep destination)"
                        value={donationSweepTo}
                        onChange={e=>setDonationSweepTo(e.target.value)}
                      />
                      
                      <button onClick={sweepDonations} className="w-full px-6 py-3 bg-purple-500 hover:bg-purple-400 text-white font-semibold rounded-lg transition-all">
                        💸 Sweep All Donations
                      </button>
                      
                      <button 
                        onClick={()=>{setDonationWallets([]);setDonationSweepTo('');}} 
                        className="w-full px-4 py-2 bg-white/10 hover:bg-white/20 text-white rounded-lg transition-all text-sm"
                      >
                        Reset Jar
                      </button>
                    </>
                  )}
                </div>
            </div>
          )}
          </div>
        </GlassCard>
      );
    }

    // Privacy Tools Hub
    function PrivacyToolsHub({ setStep }) {
      useEffect(() => {
        if (window.lucide) window.lucide.createIcons();
      }, []);
      
      const tools = [
        {
          id: 'steganography',
          title: 'Steganography',
          subtitle: 'Hide in Plain Sight',
          description: 'Hide sensitive messages and files inside images, audio, and video. Uses compression-resistant spread spectrum technology.',
          icon: 'eye-off',
          color: 'purple',
          gradient: 'from-purple-600 to-pink-600',
          features: ['Image steganography', 'Audio hiding', 'Video embedding', 'Compression-resistant']
        },
        {
          id: 'privacy-checkup',
          title: 'Privacy Checkup',
          subtitle: 'Test Your Anonymity',
          description: 'Comprehensive privacy testing suite. Check for browser leaks, IP exposure, WebRTC leaks, and fingerprinting vulnerabilities.',
          icon: 'shield-check',
          color: 'emerald',
          gradient: 'from-emerald-600 to-teal-600',
          features: ['IP leak detection', 'WebRTC test', 'Browser fingerprint', 'DNS leak check']
        },
        {
          id: 'censorship-map',
          title: 'Censorship Map',
          subtitle: 'Global Internet Freedom',
          description: 'Real-time global censorship tracking. Monitor internet restrictions, blocked services, and freedom scores by country.',
          icon: 'globe',
          color: 'red',
          gradient: 'from-red-600 to-orange-600',
          features: ['Live censorship data', 'Freedom scores', 'Blocked services', 'Regional analysis']
        }
      ];
      
      return (
        <div className="min-h-screen bg-slate-950 p-3 md:p-6">
          {/* Header */}
          <div className="relative overflow-hidden rounded-xl border border-cyan-500/20 bg-black/40 backdrop-blur-xl shadow-2xl mb-6 md:mb-8">
            <div className="flex items-center justify-between px-3 md:px-4 py-2 bg-gradient-to-r from-slate-900/80 to-slate-800/80 border-b border-cyan-500/20">
              <div className="flex items-center gap-2">
                <div className="flex gap-1.5">
                  <div className="w-2 h-2 md:w-3 md:h-3 rounded-full bg-red-500/80"></div>
                  <div className="w-2 h-2 md:w-3 md:h-3 rounded-full bg-yellow-500/80"></div>
                  <div className="w-2 h-2 md:w-3 md:h-3 rounded-full bg-green-500/80"></div>
                </div>
                <span className="text-[10px] md:text-xs font-mono text-slate-500 ml-2">privacy_tools.sh</span>
              </div>
              <div className="px-2 py-0.5 rounded bg-cyan-500/10 border border-cyan-500/30">
                <span className="text-cyan-400 text-[10px] md:text-xs font-mono">ACTIVE</span>
              </div>
            </div>
            
            <div className="p-4 md:p-8">
              <div className="flex items-center gap-2 md:gap-3 mb-3 md:mb-4">
                <div className="w-12 h-12 md:w-16 md:h-16 rounded-xl bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center shadow-lg shadow-cyan-500/50">
                  <i data-lucide="shield" className="w-6 h-6 md:w-8 md:h-8 text-white"></i>
                </div>
                <div>
                  <h1 className="text-xl md:text-3xl font-bold text-white font-mono mb-1">🛡️ PRIVACY_TOOLS</h1>
                  <p className="text-slate-400 font-mono text-xs md:text-sm">Advanced anonymity and security utilities</p>
                </div>
              </div>
              
              <p className="text-slate-300 text-xs md:text-sm mb-4 md:mb-6 max-w-3xl">
                Professional-grade privacy tools for steganography, security auditing, and global censorship monitoring.
                All tools run locally in your browser with zero data collection.
              </p>
              
              <div className="grid grid-cols-3 gap-2 md:gap-3">
                <div className="px-2 md:px-3 py-2 rounded bg-slate-900/50 border border-slate-700/50">
                  <div className="text-[9px] md:text-xs text-slate-500 font-mono mb-1">TOOLS</div>
                  <div className="text-xs md:text-sm font-mono font-bold text-cyan-400">3 ACTIVE</div>
                </div>
                <div className="px-2 md:px-3 py-2 rounded bg-slate-900/50 border border-slate-700/50">
                  <div className="text-[9px] md:text-xs text-slate-500 font-mono mb-1">PRIVACY</div>
                  <div className="text-xs md:text-sm font-mono font-bold text-emerald-400">MAXIMUM</div>
                </div>
                <div className="px-2 md:px-3 py-2 rounded bg-slate-900/50 border border-slate-700/50">
                  <div className="text-[9px] md:text-xs text-slate-500 font-mono mb-1">STATUS</div>
                  <div className="text-xs md:text-sm font-mono font-bold text-purple-400">LOCAL</div>
                </div>
              </div>
            </div>
          </div>
          
          {/* Tools Grid */}
          <div className="grid md:grid-cols-3 gap-4 md:gap-6">
            {tools.map((tool, idx) => (
              <div 
                key={tool.id}
                className="relative group cursor-pointer"
                onClick={() => setStep(tool.id)}
                style={{ animationDelay: `${idx * 100}ms` }}
              >
                <div className={`rounded-xl border border-${tool.color}-500/20 bg-black/30 backdrop-blur-xl shadow-2xl overflow-hidden transition-all duration-300 group-hover:border-${tool.color}-500/40 group-hover:shadow-${tool.color}-500/20 group-hover:scale-[1.02]`}>
                  {/* Tool Top Bar */}
                  <div className={`flex items-center justify-between px-3 md:px-4 py-2 bg-gradient-to-r from-slate-900/60 to-slate-800/60 border-b border-${tool.color}-500/10`}>
                    <div className="flex items-center gap-2">
                      <i data-lucide={tool.icon} className="w-5 h-5 md:w-6 md:h-6"></i>
                      <span className="text-[10px] md:text-xs font-mono text-slate-500">{tool.id}.tool</span>
                    </div>
                    <div className={`px-2 py-0.5 rounded bg-${tool.color}-500/10 border border-${tool.color}-500/30`}>
                      <span className={`text-${tool.color}-400 text-[10px] md:text-xs font-mono`}>READY</span>
                    </div>
                  </div>
                  
                  {/* Tool Content */}
                  <div className="p-4 md:p-6">
                    <div className="flex items-center gap-2 mb-2">
                      <span className={`text-${tool.color}-500 font-mono text-xs md:text-sm`}>$</span>
                      <h3 className="text-base md:text-lg font-bold text-white font-mono">{tool.title}</h3>
                    </div>
                    <p className={`text-[10px] md:text-xs text-${tool.color}-400/70 font-mono mb-3 md:mb-4`}>{tool.subtitle}</p>
                    
                    <p className="text-xs md:text-sm text-slate-400 font-mono mb-4 md:mb-6 leading-relaxed">
                      {tool.description}
                    </p>
                    
                    {/* Features List */}
                    <div className="space-y-2 mb-4 md:mb-6">
                      {tool.features.map((feature, idx) => (
                        <div key={idx} className="flex items-center gap-2 text-[10px] md:text-xs text-slate-400 font-mono">
                          <span className={`text-${tool.color}-500`}>▸</span>
                          <span>{feature}</span>
                        </div>
                      ))}
                    </div>
                    
                    {/* Launch Button */}
                    <button
                      className={`w-full px-4 md:px-6 py-2.5 md:py-3 rounded-lg bg-gradient-to-r ${tool.gradient} hover:scale-[1.02] text-white font-mono text-xs md:text-sm font-bold shadow-lg transition-all flex items-center justify-center gap-2 md:gap-3 group-hover:shadow-${tool.color}-500/30`}
                    >
                      <span className={`text-${tool.color}-200`}>{'>'}</span>
                      <span>LAUNCH_{tool.id.toUpperCase()}</span>
                      <span className={`text-${tool.color}-200`}>{'<'}</span>
                    </button>
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>
      );
    }

    // Sidebar navigation
    function Sidebar({ step, setStep }){
      const items = [
        { id:'home',    label:'Home', icon:'home' },
        { id:'webrtc',    label:'WebRTC Transfer', icon:'radio' },
        { id:'offline-network', label:'👻 Ghost Whistle', icon:'network' },
        { id:'services', label:'🌐 Services', icon:'box' },
        { id:'swap', label:'Privacy Swap', iconImg:'4DqRlDPT_400x400.png.png' },
        { id:'solana-privacy', label:'Solana Privacy Tools', iconImg:'solana.png' },
        { id:'pump-portal', label:'Pump Privacy Tools', iconImg:'idrs8cZ-zg_logos.png' },
        { id:'zolana', label:'Zolana Exchange', iconImg:'zcash-3d-icon-png-download-10372070.png' },
        { id:'privacy-tools', label:'🛡️ Privacy Tools', icon:'shield' },
      ];
      
      useEffect(()=>{
        if(window.lucide) window.lucide.createIcons();
      },[step]);
      
      return (
        <aside className="hidden md:block w-[260px] shrink-0 scale-in">
          <div className="rounded-3xl border border-white/10 p-4 sticky top-4 panel-strong">
            <nav className="space-y-2">
              {items.map((x,i)=> {
                const isGhostWhistle = x.id === 'offline-network';
                const isActive = step === x.id;
                
                return (
                <button key={x.id} onClick={()=>setStep(x.id)}
                    className={`w-full flex items-center gap-3 rounded-xl px-3 py-3 border text-sm transition-all btn-press ${
                      isGhostWhistle 
                        ? isActive
                          ? 'relative border-emerald-400/60 bg-gradient-to-r from-emerald-400/20 via-teal-400/20 to-cyan-400/20 text-white shadow-lg shadow-emerald-500/30 animate-pulse'
                          : 'relative border-emerald-500/40 bg-gradient-to-r from-emerald-500/10 via-teal-500/10 to-cyan-500/10 text-emerald-100 hover:border-emerald-400/60 hover:shadow-lg hover:shadow-emerald-500/20 hover:scale-[1.03] animate-shimmer'
                        : isActive
                    ? 'border-cyan-400/60 bg-cyan-400/15 text-cyan-100 scale-in'
                          : 'border-white/10 bg-white/[0.03] text-white/80 hover:bg-white/[0.07] hover:scale-[1.02]'
                    } stagger-${i+1}`}>
                    {isGhostWhistle && !isActive && (
                      <>
                        <div className="absolute inset-0 rounded-xl bg-gradient-to-r from-emerald-400/0 via-emerald-400/20 to-emerald-400/0 animate-shimmer-slide"></div>
                        <div className="absolute -inset-[1px] rounded-xl bg-gradient-to-r from-transparent via-emerald-400/30 to-transparent blur-sm animate-shimmer-slide"></div>
                      </>
                    )}
                    <span className="relative z-10 flex items-center gap-3 w-full">
                  {x.iconImg ? (
                    <img src={x.iconImg} alt={x.label} className="w-5 h-5 object-contain" />
                  ) : (
                        <i data-lucide={x.icon} className={`w-5 h-5 ${isGhostWhistle ? 'animate-pulse' : ''}`}></i>
                      )}
                      <span className={isGhostWhistle ? 'font-bold' : ''}>{x.label}</span>
                      {isGhostWhistle && (
                        <span className="ml-auto text-[10px] px-2 py-0.5 rounded-full bg-emerald-500/30 text-emerald-200 font-bold uppercase tracking-wider border border-emerald-400/40">
                          Earn
                        </span>
                      )}
                    </span>
                </button>
                );
              })}
            </nav>
    </div>
        </aside>
      );
    }

    // Home landing
    function Home({ setStep }){
      useEffect(()=>{
        if(window.lucide) window.lucide.createIcons();
      },[]);
      
      return (
        <div className="space-y-6">
          {/* Hero Section */}
          <div className="fade-up text-center py-8 px-4">
            <h1 className="text-3xl sm:text-4xl md:text-5xl font-bold text-white mb-4 tracking-tight">
              Privacy is a <span className="bg-gradient-to-r from-cyan-400 to-purple-400 bg-clip-text text-transparent">right</span>, not a privilege
            </h1>
            <p className="text-base sm:text-lg md:text-xl text-white/70 max-w-3xl mx-auto mb-8">
              Military-grade encryption. Zero-knowledge architecture. Open source. Built for activists, journalists, and anyone who values freedom.
            </p>
            <div className="flex flex-col sm:flex-row items-center justify-center gap-3 sm:gap-4 max-w-2xl mx-auto">
              <button onClick={()=>setStep('webrtc')} className="w-full sm:w-auto px-6 sm:px-8 py-3 sm:py-4 rounded-xl bg-gradient-to-r from-cyan-500 to-cyan-600 hover:from-cyan-400 hover:to-cyan-500 text-white font-bold text-base sm:text-lg shadow-lg shadow-cyan-500/50 transition-all hover:scale-105">
                <div className="flex items-center justify-center gap-2">
                  <i data-lucide="shield" className="w-5 h-5"></i>
                  <span>Start Encrypted Transfer</span>
                </div>
              </button>
              <button onClick={()=>setStep('steganography')} className="w-full sm:w-auto px-6 sm:px-8 py-3 sm:py-4 rounded-xl border-2 border-white/20 hover:border-purple-400/50 bg-white/5 hover:bg-white/10 text-white font-bold text-base sm:text-lg transition-all hover:scale-105">
                <div className="flex items-center justify-center gap-2">
                  <i data-lucide="eye-off" className="w-5 h-5"></i>
                  <span>Hide Messages</span>
                </div>
              </button>
            </div>
          </div>

          {/* Core Features - Premium Cards */}
          <div className="grid md:grid-cols-3 gap-4 fade-up-2">
            <div className="rounded-2xl border border-white/10 bg-gradient-to-br from-cyan-500/10 to-cyan-600/5 p-6 hover:border-cyan-400/30 transition-all hover:scale-[1.02] cursor-pointer" onClick={()=>setStep('webrtc')}>
              <div className="w-14 h-14 rounded-xl bg-gradient-to-br from-cyan-400 to-cyan-600 flex items-center justify-center mb-4 shadow-lg shadow-cyan-500/50">
                <i data-lucide="lock" className="w-7 h-7 text-white"></i>
              </div>
              <h3 className="text-xl font-bold text-white mb-2">End-to-End Encrypted</h3>
              <p className="text-white/60 text-sm mb-4">AES-256-GCM encryption. RSA-OAEP key exchange. Military-grade security for your sensitive data.</p>
              <div className="flex items-center text-cyan-400 text-sm font-semibold">
                <span>Learn more</span>
                <i data-lucide="arrow-right" className="w-4 h-4 ml-1"></i>
              </div>
            </div>

            <div className="rounded-2xl border border-white/10 bg-gradient-to-br from-purple-500/10 to-purple-600/5 p-6 hover:border-purple-400/30 transition-all hover:scale-[1.02] cursor-pointer" onClick={()=>setStep('steganography')}>
              <div className="w-14 h-14 rounded-xl bg-gradient-to-br from-purple-400 to-purple-600 flex items-center justify-center mb-4 shadow-lg shadow-purple-500/50">
                <i data-lucide="eye-off" className="w-7 h-7 text-white"></i>
              </div>
              <h3 className="text-xl font-bold text-white mb-2">Steganography</h3>
              <p className="text-white/60 text-sm mb-4">Hide messages in images, audio, and video. Compression-resistant spread spectrum technology.</p>
              <div className="flex items-center text-purple-400 text-sm font-semibold">
                <span>Explore tools</span>
                <i data-lucide="arrow-right" className="w-4 h-4 ml-1"></i>
              </div>
            </div>

            <div className="rounded-2xl border border-white/10 bg-gradient-to-br from-emerald-500/10 to-emerald-600/5 p-6 hover:border-emerald-400/30 transition-all hover:scale-[1.02] cursor-pointer" onClick={()=>setStep('privacy-checkup')}>
              <div className="w-14 h-14 rounded-xl bg-gradient-to-br from-emerald-400 to-emerald-600 flex items-center justify-center mb-4 shadow-lg shadow-emerald-500/50">
                <i data-lucide="shield-check" className="w-7 h-7 text-white"></i>
              </div>
              <h3 className="text-xl font-bold text-white mb-2">Privacy Toolkit</h3>
              <p className="text-white/60 text-sm mb-4">Browser leak detection, Tor bridges, censorship maps, and anonymous browsing tools.</p>
              <div className="flex items-center text-emerald-400 text-sm font-semibold">
                <span>Check privacy</span>
                <i data-lucide="arrow-right" className="w-4 h-4 ml-1"></i>
              </div>
            </div>
          </div>


          {/* All Tools Grid */}
          <div className="fade-up-3">
            <h2 className="text-2xl font-bold text-white mb-4 text-center">Complete Privacy Arsenal</h2>
            <div className="grid md:grid-cols-2 lg:grid-cols-4 gap-3">
              <div className="rounded-xl border border-white/10 bg-white/5 p-4 hover:bg-white/10 hover:border-cyan-400/30 transition-all cursor-pointer" onClick={()=>setStep('censorship-map')}>
                <div className="flex items-center gap-3 mb-2">
                  <div className="w-10 h-10 rounded-lg bg-gradient-to-br from-red-400 to-red-600 flex items-center justify-center">
                    <i data-lucide="globe" className="w-5 h-5 text-white"></i>
                  </div>
                  <h3 className="text-white font-bold">Censorship Map</h3>
                </div>
                <p className="text-white/50 text-xs">Live global censorship tracking</p>
              </div>

              <div className="rounded-xl border border-white/10 bg-white/5 p-4 hover:bg-white/10 hover:border-purple-400/30 transition-all cursor-pointer" onClick={()=>setStep('tor-bridges')}>
                <div className="flex items-center gap-3 mb-2">
                  <div className="w-10 h-10 rounded-lg bg-gradient-to-br from-purple-400 to-purple-600 flex items-center justify-center">
                    <i data-lucide="shield-alert" className="w-5 h-5 text-white"></i>
                  </div>
                  <h3 className="text-white font-bold">Tor Bridges</h3>
                </div>
                <p className="text-white/50 text-xs">Access Tor in censored regions</p>
              </div>

              <div className="rounded-xl border border-white/10 bg-white/5 p-4 hover:bg-white/10 hover:border-orange-400/30 transition-all cursor-pointer" onClick={()=>setStep('swap')}>
                <div className="flex items-center gap-3 mb-2">
                  <div className="w-10 h-10 rounded-lg bg-gradient-to-br from-orange-400 to-orange-600 flex items-center justify-center">
                    <i data-lucide="shuffle" className="w-5 h-5 text-white"></i>
                  </div>
                  <h3 className="text-white font-bold">Privacy Swap</h3>
                </div>
                <p className="text-white/50 text-xs">Anonymous crypto exchange</p>
              </div>
            </div>
          </div>
    </div>
      );
    }

    function Onboarding({ setStep }) {
      const [open, setOpen] = useState(true);
      if (!open) return null;
      return (
        <div className="fixed inset-0 z-50 grid place-items-center bg-black/70 backdrop-blur">
          <div className="max-w-3xl w-[92%] rounded-3xl border border-white/10 bg-gradient-to-b from-white/[0.08] to-white/[0.03] p-6 text-white shadow-2xl">
            <h2 className="text-xl font-semibold mb-2">Choose your role to get started</h2>
            <div className="grid md:grid-cols-2 gap-4 mt-3">
              <div className="rounded-2xl border border-white/10 bg-white/[0.04] p-4">
                <h3 className="font-semibold text-white/90">Receiver</h3>
                <ul className="text-sm text-white/70 list-disc list-inside space-y-1 mt-1">
                  <li>Paste Offer</li>
                  <li>Generate Answer and send it back</li>
                  <li>Receive and decrypt tip</li>
                </ul>
                <button onClick={() => { setStep('receive'); setOpen(false); }} className="mt-3 w-full rounded-xl bg-cyan-500/80 hover:bg-cyan-400 text-black font-semibold px-4 py-2">I'm the Receiver</button>
    </div>
              <div className="rounded-2xl border border-white/10 bg-white/[0.04] p-4">
                <h3 className="font-semibold text-white/90">Sender</h3>
                <ul className="text-sm text-white/70 list-disc list-inside space-y-1 mt-1">
                  <li>Write tip + attach files</li>
                  <li>Generate Offer and share it</li>
                  <li>Paste Answer • Connect • Send</li>
                </ul>
                <button onClick={() => { setStep('send'); setOpen(false); }} className="mt-3 w-full rounded-xl bg-white/15 hover:bg-white/25 text-white font-semibold px-4 py-2 border border-white/10">I'm the Sender</button>
</div>
      </div>
      </div>
    </div>
      );
    }

    // OpSec Checklist Modal
    function OpSecChecklist({ open, onClose, onConfirm }) {
      const [checks, setChecks] = useState({
        vpn: false,
        metadata: false,
        personal: false,
        tor: false
      });
      
      useEffect(()=>{
        if(window.lucide) window.lucide.createIcons();
      },[open]);
      
      if (!open) return null;
      
      const allChecked = Object.values(checks).filter(v => v).length >= 3; // At least 3 required
      
      return (
        <div className="fixed inset-0 z-50 grid place-items-center bg-black/80 backdrop-blur">
          <div className="max-w-xl w-[92%] rounded-3xl border border-white/10 bg-gradient-to-b from-white/[0.08] to-white/[0.03] p-6 text-white shadow-2xl scale-in">
            <div className="flex items-center gap-2 mb-3">
              <i data-lucide="shield-alert" className="w-6 h-6 text-yellow-400"></i>
              <h2 className="text-xl font-semibold">Security Checklist</h2>
    </div>
            <p className="text-sm text-white/70 mb-4">Before sending, confirm you've taken these privacy steps:</p>
            
            <div className="space-y-3">
              <label className="flex items-start gap-3 cursor-pointer p-3 rounded-xl hover:bg-white/5 transition">
                <input type="checkbox" checked={checks.vpn} onChange={(e)=>setChecks({...checks, vpn: e.target.checked})} className="mt-1 w-4 h-4" />
                <div className="flex-1">
                  <div className="font-semibold text-white/90">Using VPN or Tor</div>
                  <div className="text-xs text-white/60">Hide your IP address from network observers</div>
    </div>
              </label>
              
              <label className="flex items-start gap-3 cursor-pointer p-3 rounded-xl hover:bg-white/5 transition">
                <input type="checkbox" checked={checks.metadata} onChange={(e)=>setChecks({...checks, metadata: e.target.checked})} className="mt-1 w-4 h-4" />
                <div className="flex-1">
                  <div className="font-semibold text-white/90">Files have metadata removed</div>
                  <div className="text-xs text-white/60">Use the "Scrub Metadata" button above</div>
    </div>
              </label>
              
              <label className="flex items-start gap-3 cursor-pointer p-3 rounded-xl hover:bg-white/5 transition">
                <input type="checkbox" checked={checks.personal} onChange={(e)=>setChecks({...checks, personal: e.target.checked})} className="mt-1 w-4 h-4" />
                <div className="flex-1">
                  <div className="font-semibold text-white/90">No personal info in message</div>
                  <div className="text-xs text-white/60">Names, dates, locations, or unique phrases removed</div>
</div>
              </label>
              
              <label className="flex items-start gap-3 cursor-pointer p-3 rounded-xl hover:bg-white/5 transition">
                <input type="checkbox" checked={checks.tor} onChange={(e)=>setChecks({...checks, tor: e.target.checked})} className="mt-1 w-4 h-4" />
                <div className="flex-1">
                  <div className="font-semibold text-white/90">Verified receiver identity</div>
                  <div className="text-xs text-white/60">Confirm you're sending to the correct journalist/newsroom</div>
    </div>
              </label>
</div>

            <div className="flex gap-3 mt-5">
              <button onClick={onClose} className="flex-1 rounded-xl bg-white/10 hover:bg-white/15 text-white font-semibold px-4 py-2 border border-white/10 btn-press">Cancel</button>
              <button onClick={onConfirm} disabled={!allChecked} className="flex-1 rounded-xl bg-cyan-500/80 hover:bg-cyan-400 disabled:opacity-50 disabled:cursor-not-allowed text-black font-semibold px-4 py-2 btn-press">
                {allChecked ? 'Continue' : 'Check at least 3'}
              </button>
            </div>
          </div>
        </div>
      );
    }

    function Sender({ pushToast, onHashReady }) {
      const [tipText, setTipText] = usePersistentState('tipText', "");
      const fileRef = useRef(null);
      const [offerOut, setOfferOut] = useState("");
      const [answerIn, setAnswerIn] = usePersistentState('tipAnswerIn', "");
      const [connStatus, setConnStatus] = useState("Not connected");
      const [sending, setSending] = useState(false);
      const [prog, setProg] = useState(0);
      const peerRef = useRef(null);
      const dcRef = useRef(null);
      const [isDrag, setIsDrag] = useState(false);
      const [droppedFiles, setDroppedFiles] = useState([]);
      const [memoSig, setMemoSig] = useState("");
      const [shortCode, setShortCode] = useState("");
      const [waitingForAnswer, setWaitingForAnswer] = useState(false);
      const [connecting, setConnecting] = useState(false);
      
      // Privacy features
      const [showOpSec, setShowOpSec] = useState(false);
      const [scrubbingMetadata, setScrubbingMetadata] = useState(false);
      const [stegoMode, setStegoMode] = useState(false);
      const [stegoImage, setStegoImage] = useState(null);
      const [stegoProcessing, setStegoProcessing] = useState(false);
      const stegoFileRef = useRef(null);
      
      useEffect(()=>{
        if(window.lucide) window.lucide.createIcons();
      });
      
      // Metadata scrubber handler
      async function handleScrubMetadata(){
        const files = fileRef.current?.files || [];
        const dropped = droppedFiles || [];
        const allFiles = [...files, ...dropped];
        
        if (allFiles.length === 0) { pushToast("Attach files first", "err"); return; }
        
        setScrubbingMetadata(true);
        try {
          const scrubbed = [];
          for (const file of allFiles) {
            const clean = await scrubMetadata(file);
            scrubbed.push(clean);
          }
          
          // Create new FileList (can't modify directly)
          const dt = new DataTransfer();
          scrubbed.forEach(f => dt.items.add(f));
          if (fileRef.current) fileRef.current.files = dt.files;
          setDroppedFiles([]);
          
          pushToast(`Metadata removed from ${scrubbed.length} file(s)`, "ok");
        } catch (e) {
          pushToast("Metadata scrubbing failed", "err");
        }
        setScrubbingMetadata(false);
      }
      
      // Steganography mode handler
      async function handleCreateStegoImage(){
        if (!stegoFileRef.current?.files?.[0]) {
          pushToast("Select a cover image first", "err");
          return;
        }
        if (!offerOut) {
          pushToast("Generate an Offer first", "err");
          return;
        }
        
        setStegoProcessing(true);
        try {
          const coverImage = stegoFileRef.current.files[0];
          const hiddenImage = await hideDataInImage(coverImage, offerOut);
          setStegoImage(hiddenImage);
          pushToast("✓ Offer hidden in image! Download and share.", "ok");
        } catch (e) {
          pushToast("Steganography failed: " + e.message, "err");
        }
        setStegoProcessing(false);
      }
      
      async function downloadStegoImage(){
        if (!stegoImage) return;
        const url = URL.createObjectURL(stegoImage);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'vacation-photo.png';
        a.click();
        URL.revokeObjectURL(url);
        pushToast("Image downloaded — share it anywhere!", "ok");
      }

      async function copyOffer(){
        try{ await navigator.clipboard.writeText(offerOut || ""); pushToast("Offer copied", "ok"); }catch(e){ pushToast("Copy failed", "err"); }
      }
      async function shareOffer(){
        try{
          if (!offerOut){ pushToast("Generate an Offer first", "err"); return; }
          const message = `Whistle Courier Offer (Tipster)\n\nPaste this in Newsroom → Step 1 (Paste Offer), click Generate Answer, and send the Answer back.\n\n${offerOut}`;
          if (navigator.share){
            await navigator.share({ title: 'Whistle Courier Offer', text: message });
            pushToast("Shared", "ok");
          } else {
            await navigator.clipboard.writeText(message);
            pushToast("Offer + instructions copied — share anywhere", "ok");
          }
        }catch(e){ pushToast("Share failed", "err"); }
      }
      async function pasteAnswer(){
        try{ const t = await navigator.clipboard.readText(); setAnswerIn(t || ""); if((t||"").trim()) setWaitingForAnswer(false); pushToast("Pasted from clipboard", "ok"); }catch(e){ pushToast("Paste failed", "err"); }
      }
      function resetSender(){
        try{ dcRef.current?.close?.(); }catch{}
        try{ peerRef.current?.close?.(); }catch{}
        setTipText(""); if (fileRef.current) fileRef.current.value="";
        setOfferOut(""); setAnswerIn(""); setConnStatus("Not connected"); setSending(false); setProg(0);
        setWaitingForAnswer(false); setConnecting(false);
        pushToast("Tipster reset", "ok");
      }

      async function makeOffer() {
        try {
          const pc = new RTCPeerConnection({ iceServers: [{ urls: ["stun:stun.l.google.com:19302"] }] });
          peerRef.current = pc;
          const dc = pc.createDataChannel("whistle", { ordered: true });
          dc.binaryType = "arraybuffer";
          dcRef.current = dc;
          dc.onopen = () => { setConnStatus("Connected"); setConnecting(false); };
          dc.onclose = () => { setConnStatus("Closed"); };
          pc.onicecandidate = (e) => { if (!e.candidate) setOfferOut(textToB64(JSON.stringify(pc.localDescription))); };
          const offer = await pc.createOffer();
          await pc.setLocalDescription(offer);
          pushToast("Offer created. Copy to newsroom.", "ok");
          setWaitingForAnswer(true);
          setConnecting(false);
        } catch (e) {
          pushToast("Offer failed: " + (e.message || e), "err");
        }
      }

      async function acceptAnswer() {
        try {
          if (!peerRef.current) throw new Error("Create an Offer first");
          const ans = JSON.parse(b64ToText(answerIn.trim()));
          await peerRef.current.setRemoteDescription(new RTCSessionDescription(ans));
          setConnStatus("Connecting…");
          setConnecting(true);
        } catch (e) {
          pushToast("Accept failed: " + (e.message || e), "err");
        }
      }

      async function sendNow() {
        // Show OpSec checklist first
        setShowOpSec(true);
      }
      
      async function actualSend() {
        setShowOpSec(false);
        try {
          const dc = dcRef.current;
          if (!dc || dc.readyState !== "open") throw new Error("Not connected");
          const inputFiles = fileRef.current?.files || [];
          const files = [...inputFiles, ...droppedFiles];
          const { pkgBytes, aesKeyRaw, iv, ct } = await packBundle(tipText, files);
          const hash = await sha256(ct);
          const bundleHash = hex(hash);
          setShortCode(formatShortCode(hash));
          onHashReady(bundleHash);

          setSending(true); setProg(0);
          const header = JSON.stringify({ v: 1, iv: b64(iv), key: b64(aesKeyRaw), ctSize: ct.length });
          dc.send(new TextEncoder().encode(header));
          await new Promise((r) => setTimeout(r, 50));
          const chunk = 64 * 1024; let sent = 0;
          while (sent < ct.length) {
            const part = ct.slice(sent, Math.min(sent + chunk, ct.length));
            dc.send(part);
            sent += part.length;
            setProg(Math.round((sent * 100) / ct.length));
            await new Promise((r) => setTimeout(r, 0));
          }
          setSending(false);
          pushToast("Tip sent", "ok");
          storagePushHistory({ role:'tipster', kind:'sent', hash: bundleHash, short: formatShortCode(hash), at: new Date().toISOString() });

          // Immediately post memo (required)
          try{
            const { Connection, PublicKey, SystemProgram, Transaction, TransactionInstruction } = solanaWeb3;
            await ensureBuffer();
            if (!walletStore.pubkey){
              const r = await window.solana?.connect?.();
              if(!r) throw new Error("Wallet not connected");
              walletStore.pubkey = r.publicKey.toBase58();
              walletStore.setPub(walletStore.pubkey);
            }
            const { http: httpUrl, ws: wsUrl } = getRpcUrls();
            const conn = wsUrl ? new Connection(httpUrl, { commitment:'confirmed', wsEndpoint: wsUrl }) : new Connection(httpUrl, 'confirmed');
            const MEMO = new PublicKey("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr");
            const memoBuf = enc.encode("WHISTLE_HASH:" + bundleHash); // Uint8Array
            const ixMemo = new TransactionInstruction({ keys: [], programId: MEMO, data: memoBuf });
            const ixPing = SystemProgram.transfer({ fromPubkey: new PublicKey(walletStore.pubkey), toPubkey: new PublicKey(walletStore.pubkey), lamports: 0 });
    const tx = new Transaction().add(ixPing, ixMemo);
            tx.feePayer = new PublicKey(walletStore.pubkey);
    tx.recentBlockhash = (await conn.getLatestBlockhash()).blockhash;
    const signed = await window.solana.signTransaction(tx);
            const sig = await conn.sendRawTransaction(signed.serialize(), { skipPreflight: false });
    await conn.confirmTransaction(sig, 'confirmed');
            setMemoSig(sig);
            pushToast("Solana memo posted", "ok");
            storagePushHistory({ role:'tipster', kind:'memo', hash: bundleHash, short: formatShortCode(hash), sig, at: new Date().toISOString() });
          }catch(err){
            const msg = (err && err.message) ? err.message : String(err);
            pushToast("Memo failed: "+msg, "err");
          }
        } catch (e) {
          setSending(false);
          pushToast("Send failed: " + (e.message || e), "err");
        }
      }

      return (
        <>
          <OpSecChecklist open={showOpSec} onClose={()=>setShowOpSec(false)} onConfirm={actualSend} />
          
          <GlassCard title="Sender — Send" subtitle="Compose, connect, and send end-to-end encrypted">
            {/* Privacy Tools */}
            <div className="mb-4 p-3 rounded-xl bg-gradient-to-r from-yellow-500/10 to-orange-500/10 border border-yellow-400/20">
              <div className="flex items-center gap-2 mb-2">
                <i data-lucide="shield-check" className="w-5 h-5 text-yellow-400"></i>
                <h4 className="text-white/90 font-semibold text-sm">Privacy Tools</h4>
              </div>
              <div className="flex flex-wrap gap-2 mb-2">
                <button onClick={(e)=>{ ripple(e); handleScrubMetadata(); }} disabled={scrubbingMetadata} className="flex items-center gap-2 rounded-lg bg-cyan-500/20 hover:bg-cyan-500/30 text-cyan-200 text-xs font-semibold px-3 py-1.5 border border-cyan-400/30 btn-ripple">
                  <i data-lucide={scrubbingMetadata ? "loader" : "eraser"} className={`w-3 h-3 ${scrubbingMetadata ? 'animate-spin' : ''}`}></i>
                  {scrubbingMetadata ? 'Scrubbing...' : 'Scrub Metadata'}
                </button>
                <button onClick={(e)=>{ ripple(e); setStegoMode(!stegoMode); }} className={`flex items-center gap-2 rounded-lg ${stegoMode ? 'bg-purple-500/30 border-purple-400/50' : 'bg-purple-500/20 border-purple-400/30'} hover:bg-purple-500/30 text-purple-200 text-xs font-semibold px-3 py-1.5 border btn-ripple`}>
                  <i data-lucide="image" className="w-3 h-3"></i>
                  {stegoMode ? '✓ Steganography ON' : 'Steganography Mode'}
                </button>
              </div>
              
              {stegoMode && (
                <div className="mt-3 p-3 rounded-xl bg-purple-500/10 border border-purple-400/20 scale-in">
                  <div className="flex items-center gap-2 mb-2">
                    <i data-lucide="eye-off" className="w-4 h-4 text-purple-300"></i>
                    <h5 className="text-white/90 font-semibold text-xs">🎭 Covert Communication Mode</h5>
                  </div>
                  <p className="text-xs text-white/60 mb-2">
                    <strong>The offer will be hidden inside an image.</strong> Share it like a normal photo — no suspicious text codes needed!
                  </p>
                  <input ref={stegoFileRef} type="file" accept="image/*" className="w-full rounded-lg bg-white/[0.06] border border-white/10 p-2 text-xs mb-2" />
                  <div className="flex gap-2">
                    <button onClick={(e)=>{ ripple(e); handleCreateStegoImage(); }} disabled={stegoProcessing || !offerOut} className="flex items-center gap-2 rounded-lg bg-purple-500/30 hover:bg-purple-400/40 disabled:opacity-50 text-purple-100 text-xs font-semibold px-3 py-1.5 border border-purple-400/30 btn-ripple">
                      <i data-lucide={stegoProcessing ? "loader" : "wand-2"} className={`w-3 h-3 ${stegoProcessing ? 'animate-spin' : ''}`}></i>
                      {stegoProcessing ? 'Hiding...' : 'Create Stego Image'}
                    </button>
                    {stegoImage && (
                      <>
                        <button onClick={(e)=>{ ripple(e); downloadStegoImage(); }} className="flex items-center gap-2 rounded-lg bg-emerald-500/30 hover:bg-emerald-400/40 text-emerald-100 text-xs font-semibold px-3 py-1.5 border border-emerald-400/30 btn-ripple">
                          <i data-lucide="download" className="w-3 h-3"></i>
                          Download
                        </button>
                        <button onClick={(e)=>{ ripple(e); 
                          const url = URL.createObjectURL(stegoImage);
                          const preview = window.open('', '_blank');
                          preview.document.write(`<img src="${url}" style="max-width:100%;height:auto;" /><p style="font-family:sans-serif;padding:20px;">👆 Share this image via email, WhatsApp, Twitter, etc. It looks completely normal!</p>`);
                        }} className="flex items-center gap-2 rounded-lg bg-cyan-500/30 hover:bg-cyan-400/40 text-cyan-100 text-xs font-semibold px-3 py-1.5 border border-cyan-400/30 btn-ripple">
                          <i data-lucide="eye" className="w-3 h-3"></i>
                          Preview
                        </button>
                      </>
                    )}
                  </div>
                  {stegoImage && (
                    <div className="mt-3 p-2 rounded-lg bg-emerald-500/20 border border-emerald-400/30 text-xs text-emerald-100">
                      <div className="flex items-center gap-2 mb-1">
                        <i data-lucide="check-circle" className="w-4 h-4"></i>
                        <strong>Ready to share!</strong>
                      </div>
                      <p className="text-white/70">Send via: Email, WhatsApp, Telegram, Twitter DM, Instagram, Facebook, Discord, or any messaging app. The image looks 100% innocent — perfect cover!</p>
                    </div>
                  )}
                  {!offerOut && (
                    <p className="mt-2 text-xs text-yellow-300">⚠ Generate an Offer first (Step A below)</p>
                  )}
                </div>
              )}
              
              <p className="text-xs text-white/50 mt-2">
                <strong>Scrub Metadata:</strong> Removes EXIF/GPS data from images.
                <strong className="ml-2">Steganography:</strong> Hides Offer inside an innocent-looking image.
              </p>
            </div>
            
            <div className="grid md:grid-cols-2 gap-4">
      <div>
                <label className="text-xs text-white/60">Message (text)</label>
                <textarea value={tipText} onChange={(e) => setTipText(e.target.value)} rows={8} className="mt-1 w-full rounded-xl bg-white/[0.06] border border-white/10 p-3 outline-none focus:ring-2 focus:ring-cyan-400/40" placeholder="Describe the issue with verifiable details." />
      </div>
            <div onDragOver={(e)=>{e.preventDefault(); setIsDrag(true);}} onDragLeave={()=>setIsDrag(false)} onDrop={(e)=>{ e.preventDefault(); setIsDrag(false); const files = Array.from(e.dataTransfer.files||[]); setDroppedFiles(files); pushToast(files.length?`Added ${files.length} file(s)`:'No files', files.length?'ok':'err'); }} className={"rounded-xl p-2 "+(isDrag?"border-2 border-dashed border-cyan-400 bg-white/10":"")}>
              <label className="text-xs text-white/60">Attach evidence (≤ 5 GB total)</label>
              <input ref={fileRef} type="file" multiple className="mt-1 w-full rounded-xl bg-white/[0.06] border border-white/10 p-2" />
              <p className="text-xs text-white/50 mt-1">Nothing uploads; it streams directly to the newsroom over an encrypted data channel.</p>
              {droppedFiles.length>0 && (
                <div className="mt-2 text-xs text-white/70">
                  <div className="mb-1">Dropped files:</div>
                  <ul className="list-disc list-inside space-y-0.5">
                    {droppedFiles.map((f,i)=> <li key={i}>{f.name} ({Math.round(f.size/1024)} KB)</li>)}
                  </ul>
                  <button onClick={(e)=>{ ripple(e); setDroppedFiles([]); }} className="mt-2 rounded-xl bg-white/10 hover:bg-white/20 text-white px-3 py-1 border border-white/10 btn-ripple text-xs">Clear dropped</button>
    </div>
              )}
      </div>
    </div>

          <div className="my-4 h-px bg-white/10" />

          {stegoMode && offerOut && (
            <div className="mb-4 p-4 rounded-xl bg-gradient-to-r from-purple-500/20 to-pink-500/20 border-2 border-purple-400/40 scale-in">
              <div className="flex items-center gap-2 mb-2">
                <i data-lucide="shield-check" className="w-5 h-5 text-purple-300"></i>
                <h4 className="text-white/90 font-semibold">🎭 Steganography Mode Active</h4>
              </div>
              <p className="text-sm text-white/80">
                Your Offer is ready. <strong>Don't copy/paste the text below</strong> — instead, use the stego image above. 
                It's hidden inside an innocent-looking photo for maximum security.
              </p>
            </div>
          )}

          <div className="grid md:grid-cols-2 gap-4">
      <div>
              <h4 className="flex items-center gap-2 text-white/90 font-semibold mb-1">
                <i data-lucide="key" className="w-5 h-5 text-cyan-400"></i>
                Step A — Create Offer {stegoMode && '(for Stego Image)'}
              </h4>
              <div className="flex gap-2">
                <button onClick={(e)=>{ ripple(e); makeOffer(); }} className="flex items-center gap-2 rounded-xl bg-cyan-500/80 hover:bg-cyan-400 text-black font-semibold px-4 py-2 btn-ripple active:scale-[.98]">
                  <i data-lucide="plus-circle" className="w-4 h-4"></i>
                  Generate
                </button>
                {!stegoMode && (
                  <>
                    <button onClick={(e)=>{ ripple(e); copyOffer(); }} disabled={!offerOut} className="flex items-center gap-2 rounded-xl bg-white/10 hover:bg-white/20 disabled:opacity-50 text-white font-semibold px-4 py-2 border border-white/10 btn-ripple active:scale-[.98]">
                      <i data-lucide="copy" className="w-4 h-4"></i>
                      Copy
                    </button>
                    <button onClick={(e)=>{ ripple(e); shareOffer(); }} disabled={!offerOut} className="flex items-center gap-2 rounded-xl bg-white/10 hover:bg-white/20 disabled:opacity-50 text-white font-semibold px-4 py-2 border border-white/10 btn-ripple active:scale-[.98]">
                      <i data-lucide="share" className="w-4 h-4"></i>
                      Share
                    </button>
                  </>
                )}
              </div>
              {stegoMode ? (
                <p className="text-xs text-white/50 mt-1">Generated Offer will be hidden in the stego image above. <strong>Don't share this text directly.</strong></p>
              ) : (
                <p className="text-xs text-white/50 mt-1">Copy this text and send it to the receiver. They will respond with an Answer.</p>
              )}
              <textarea readOnly value={offerOut} rows={6} className={`mt-2 w-full rounded-xl ${stegoMode ? 'bg-black/30 opacity-50' : 'bg-black/50'} border border-white/10 p-3 font-mono text-xs`} placeholder={stegoMode ? 'Offer will be hidden in stego image...' : ''} />
              {waitingForAnswer && !answerIn.trim() && connStatus!=="Connected" && (
                <div className="mt-2 flex items-center gap-2 text-xs text-white/60 scale-in">
                  <span className="inline-block h-3 w-3 rounded-full border-2 border-white/30 border-t-cyan-400 animate-spin rotate-slow" />
                  <span className="pulse-glow">Waiting for newsroom Answer…</span>
                </div>
              )}
      </div>
      <div>
              <h4 className="flex items-center gap-2 text-white/90 font-semibold mb-1">
                <i data-lucide="message-square" className="w-5 h-5 text-purple-400"></i>
                Step B — Paste Answer
              </h4>
              <textarea value={answerIn} onChange={(e) => { setAnswerIn(e.target.value); if(e.target.value.trim()) setWaitingForAnswer(false); }} rows={6} className="w-full rounded-xl bg-white/[0.06] border border-white/10 p-3 font-mono text-xs" placeholder="Paste newsroom Answer here" />
              <div className="flex items-center gap-3 mt-2 flex-wrap">
                <button onClick={(e)=>{ ripple(e); pasteAnswer(); }} className="flex items-center gap-2 rounded-xl bg-white/10 hover:bg-white/20 text-white font-semibold px-3 py-2 border border-white/10 btn-ripple active:scale-[.98]">
                  <i data-lucide="clipboard" className="w-4 h-4"></i>
                  Paste
                </button>
                <button onClick={(e)=>{ ripple(e); acceptAnswer(); }} disabled={!answerIn.trim()} className="flex items-center gap-2 rounded-xl bg-white/15 hover:bg-white/25 disabled:opacity-50 text-white font-semibold px-4 py-2 border border-white/10 btn-ripple active:scale-[.98]">
                  <i data-lucide="plug" className="w-4 h-4"></i>
                  Connect
                </button>
                <button onClick={(e)=>{ ripple(e); resetSender(); }} className="flex items-center gap-2 rounded-xl bg-white/5 hover:bg-white/15 text-white font-semibold px-3 py-2 border border-white/10 btn-ripple active:scale-[.98]">
                  <i data-lucide="refresh-cw" className="w-4 h-4"></i>
                  Reset
                </button>
                <span className="flex items-center gap-1 text-xs text-white/60">
                  <i data-lucide="wifi" className="w-3 h-3"></i>
                  {connStatus}
                </span>
              </div>
              {connecting && connStatus!=="Connected" && (
                <div className="mt-2 flex items-center gap-2 text-xs text-white/60 scale-in">
                  <span className="inline-block h-3 w-3 rounded-full border-2 border-white/30 border-t-purple-400 animate-spin rotate-slow" />
                  <span className="pulse-glow">Connecting to newsroom…</span>
    </div>
              )}
      </div>
    </div>

          <div className="mt-4">
            <button onClick={(e)=>{ ripple(e); sendNow(); }} className="flex items-center gap-2 justify-center rounded-xl bg-gradient-to-r from-cyan-400 to-purple-400 hover:from-cyan-300 hover:to-purple-300 text-black font-semibold px-6 py-3 disabled:opacity-60 btn-ripple btn-press shadow-lg hover:shadow-xl transition-all" disabled={connStatus !== "Connected" || sending}>
              <i data-lucide={sending ? "loader" : "rocket"} className={`w-5 h-5 ${sending ? 'animate-spin' : ''}`}></i>
              {sending ? "Sending…" : "Send Encrypted Tip"}
            </button>
            {sending && (
              <div className="mt-2 h-2 w-full rounded-full bg-white/10 overflow-hidden scale-in">
                <div className="h-2 progress-shine rounded-full transition-all" style={{ width: `${prog}%` }} />
    </div>
            )}
          </div>
          <div className="text-xs text-white/60 mt-2 space-y-1">
            <p>Short code: <span className="font-mono">{shortCode}</span></p>
            {memoSig && (
              <p>🧾 Memo: <a className="text-cyan-300" target="_blank" rel="noreferrer" href={`https://solscan.io/tx/${memoSig}`}>{memoSig}</a></p>
            )}
          </div>
          </GlassCard>
        </>
      );
    }
    function Receiver({ pushToast, onHashReady, setVerifyHash }) {
      const [offerIn, setOfferIn] = useState("");
      const [answerOut, setAnswerOut] = useState("");
      const [status, setStatus] = useState("Waiting…");
      const [prog, setProg] = useState(0);
      const [text, setText] = useState("");
      const [files, setFiles] = useState([]);
      const [hash, setHash] = useState("");
      const peerRef = useRef(null);
      const dcRef = useRef(null);
      
      // Self-destruct features
      const [selfDestructTime, setSelfDestructTime] = useState(24); // hours
      const [destructCountdown, setDestructCountdown] = useState(null);
      const destructTimerRef = useRef(null);
      
      // Steganography extraction
      const [extractingStegoImage, setExtractingStegoImage] = useState(false);
      const stegoExtractRef = useRef(null);
      
      useEffect(()=>{
        if(window.lucide) window.lucide.createIcons();
      });
      
      // Start self-destruct timer when content is received
      useEffect(() => {
        if (text && selfDestructTime > 0) {
          const destructTime = Date.now() + (selfDestructTime * 60 * 60 * 1000);
          setDestructCountdown(destructTime);
          
          destructTimerRef.current = setInterval(() => {
            const remaining = destructTime - Date.now();
            if (remaining <= 0) {
              setText("");
              setFiles([]);
              setHash("");
              clearInterval(destructTimerRef.current);
              setDestructCountdown(null);
              pushToast("Message self-destructed ✓", "ok");
            }
          }, 1000);
          
          return () => clearInterval(destructTimerRef.current);
        }
      }, [text, selfDestructTime]);

      async function pasteOffer(){
        try{ const t = await navigator.clipboard.readText(); setOfferIn(t || ""); pushToast("Pasted Offer", "ok"); }catch(e){ pushToast("Paste failed", "err"); }
      }
      async function copyAnswer(){
        try{ await navigator.clipboard.writeText(answerOut || ""); pushToast("Answer copied", "ok"); }catch(e){ pushToast("Copy failed", "err"); }
      }
      function resetReceiver(){
        try{ dcRef.current?.close?.(); }catch{}
        try{ peerRef.current?.close?.(); }catch{}
        if (destructTimerRef.current) clearInterval(destructTimerRef.current);
        setOfferIn(""); setAnswerOut(""); setStatus("Waiting…"); setProg(0); setText(""); setFiles([]); setHash(""); setDestructCountdown(null);
        pushToast("Newsroom reset", "ok");
      }
      
      async function extractFromStegoImage(){
        if (!stegoExtractRef.current?.files?.[0]) {
          pushToast("Select an image first", "err");
          return;
        }
        
        setExtractingStegoImage(true);
        try {
          const imageFile = stegoExtractRef.current.files[0];
          const extracted = await extractDataFromImage(imageFile);
          setOfferIn(extracted);
          pushToast("✓ Offer extracted from image!", "ok");
        } catch (e) {
          pushToast("Extraction failed: " + e.message, "err");
        }
        setExtractingStegoImage(false);
      }
      
      function getTimeRemaining(){
        if (!destructCountdown) return '';
        const remaining = destructCountdown - Date.now();
        if (remaining <= 0) return 'Expired';
        const hours = Math.floor(remaining / (1000 * 60 * 60));
        const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
        return `${hours}h ${minutes}m ${seconds}s`;
      }

      async function makeAnswer() {
        try {
          const pc = new RTCPeerConnection({ iceServers: [{ urls: ["stun:stun.l.google.com:19302"] }] });
          peerRef.current = pc;
          pc.ondatachannel = (ev) => {
            const dc = ev.channel;
            dcRef.current = dc;
            dc.binaryType = "arraybuffer";
            let rcvAccum = [];
            let rcvExpect = 0;
            let rcvIV = null;
            let rcvKey = null;
            dc.onopen = () => setStatus("Connected");
            dc.onmessage = async (e) => {
              const buf = new Uint8Array(e.data);
              if (!rcvIV) {
                const meta = JSON.parse(new TextDecoder().decode(buf));
                rcvIV = ub64(meta.iv);
                rcvKey = ub64(meta.key);
                rcvExpect = meta.ctSize | 0;
                rcvAccum = [];
                setProg(0);
              } else {
                rcvAccum.push(buf);
                const sofar = rcvAccum.reduce((n, b) => n + b.length, 0);
                setProg(Math.round((sofar * 100) / rcvExpect));
                if (sofar >= rcvExpect) {
                  const ct = new Uint8Array(sofar);
                  let off = 0;
                  for (const b of rcvAccum) { ct.set(b, off); off += b.length; }
                  const pkg = await unpackBundle(rcvKey, rcvIV, ct);
                  setText(pkg.text || "(no text)");
                  setFiles(pkg.files || []);
                  const h = hex(await sha256(ct));
                  setHash(h);
                  setVerifyHash(h);
                  onHashReady(h);
                  setStatus("Received & decrypted");
                  pushToast("Received & decrypted", "ok");
                  storagePushHistory({ role:'newsroom', kind:'received', hash: h, short: formatShortCode(await sha256(ct)), at: new Date().toISOString() });
                }
              }
            };
          };
          pc.onicecandidate = (e) => { if (!e.candidate) setAnswerOut(textToB64(JSON.stringify(pc.localDescription))); };
          const offer = JSON.parse(b64ToText(offerIn.trim()));
          await pc.setRemoteDescription(new RTCSessionDescription(offer));
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          setStatus("Answer created. Send it back to tipster.");
          pushToast("Answer ready", "ok");
        } catch (e) {
          pushToast("Answer failed: " + (e.message || e), "err");
        }
      }

      return (
        <GlassCard title="Receiver — Receive" subtitle="Paste Offer, generate Answer, accept the stream">
          {/* Steganography Extraction */}
          <div className="mb-4 p-3 rounded-xl bg-gradient-to-r from-purple-500/10 to-pink-500/10 border border-purple-400/20">
            <div className="flex items-center gap-2 mb-2">
              <i data-lucide="image-plus" className="w-5 h-5 text-purple-400"></i>
              <h4 className="text-white/90 font-semibold text-sm">Extract Offer from Image</h4>
    </div>
            <p className="text-xs text-white/60 mb-2">If sender used steganography, upload the image to extract the hidden Offer.</p>
            <div className="flex gap-2 items-end">
              <div className="flex-1">
                <input ref={stegoExtractRef} type="file" accept="image/*" className="w-full rounded-lg bg-white/[0.06] border border-white/10 p-2 text-xs" />
    </div>
              <button onClick={(e)=>{ ripple(e); extractFromStegoImage(); }} disabled={extractingStegoImage} className="flex items-center gap-2 rounded-lg bg-purple-500/30 hover:bg-purple-400/40 text-purple-100 text-xs font-semibold px-3 py-2 border border-purple-400/30 btn-ripple">
                <i data-lucide={extractingStegoImage ? "loader" : "scan"} className={`w-3 h-3 ${extractingStegoImage ? 'animate-spin' : ''}`}></i>
                {extractingStegoImage ? 'Extracting...' : 'Extract Offer'}
              </button>
            </div>
          </div>
          
          {/* Self-Destruct Settings */}
          <div className="mb-4 p-3 rounded-xl bg-gradient-to-r from-orange-500/10 to-red-500/10 border border-orange-400/20">
            <div className="flex items-center gap-2 mb-2">
              <i data-lucide="timer" className="w-5 h-5 text-orange-400"></i>
              <h4 className="text-white/90 font-semibold text-sm">Self-Destruct Timer</h4>
    </div>
            <p className="text-xs text-white/60 mb-2">Messages will automatically delete after this time. No trace left.</p>
            <div className="flex items-center gap-3">
              <select value={selfDestructTime} onChange={(e)=>setSelfDestructTime(Number(e.target.value))} className="rounded-lg bg-white/[0.06] border border-white/10 p-2 text-xs text-white">
                <option value="0">Disabled</option>
                <option value="1">1 hour</option>
                <option value="6">6 hours</option>
                <option value="12">12 hours</option>
                <option value="24">24 hours (default)</option>
                <option value="72">3 days</option>
              </select>
              {destructCountdown && (
                <span className="text-xs text-orange-300 font-mono flex items-center gap-1">
                  <i data-lucide="clock" className="w-3 h-3"></i>
                  Deletes in: {getTimeRemaining()}
                </span>
              )}
            </div>
</div>

          <div className="grid md:grid-cols-2 gap-4">
            <div>
              <h4 className="flex items-center gap-2 text-white/90 font-semibold mb-1">
                <i data-lucide="inbox" className="w-5 h-5 text-cyan-400"></i>
                Step 1 — Paste Offer
              </h4>
               <p className="text-xs text-white/50 mb-1">Paste the code the sender sent you. Then click <span className="text-white/70 font-semibold">Generate Answer</span> and send the Answer back to the sender.</p>
              <textarea value={offerIn} onChange={(e) => setOfferIn(e.target.value)} rows={6} className="w-full rounded-xl bg-white/[0.06] border border-white/10 p-3 font-mono text-xs" placeholder="Paste tipster Offer here (or extract from image above)" />
              <div className="flex gap-2 mt-2 flex-wrap">
                <button onClick={(e)=>{ ripple(e); pasteOffer(); }} className="flex items-center gap-2 rounded-xl bg-white/10 hover:bg-white/20 text-white font-semibold px-3 py-2 border border-white/10 btn-ripple active:scale-[.98]">
                  <i data-lucide="clipboard" className="w-4 h-4"></i>
                  Paste Offer
                </button>
                <button onClick={(e)=>{ ripple(e); makeAnswer(); }} className="flex items-center gap-2 rounded-xl bg-cyan-500/80 hover:bg-cyan-400 text-black font-semibold px-4 py-2 btn-ripple active:scale-[.98]">
                  <i data-lucide="plus-circle" className="w-4 h-4"></i>
                  Generate Answer
                </button>
              </div>
              <div className="flex gap-2 mt-2">
                <button onClick={(e)=>{ ripple(e); copyAnswer(); }} disabled={!answerOut} className="flex items-center gap-2 rounded-xl bg-white/10 hover:bg-white/20 disabled:opacity-50 text-white font-semibold px-3 py-2 border border-white/10 btn-ripple active:scale-[.98]">
                  <i data-lucide="copy" className="w-4 h-4"></i>
                  Copy Answer
                </button>
                <button onClick={(e)=>{ ripple(e); resetReceiver(); }} className="flex items-center gap-2 rounded-xl bg-white/5 hover:bg-white/15 text-white font-semibold px-3 py-2 border border-white/10 btn-ripple active:scale-[.98]">
                  <i data-lucide="refresh-cw" className="w-4 h-4"></i>
                  Reset
                </button>
              </div>
              <textarea readOnly value={answerOut} rows={6} className="mt-2 w-full rounded-xl bg-black/50 border border-white/10 p-3 font-mono text-xs" placeholder="Copy this Answer back to tipster" />
            </div>
            <div>
              <h4 className="flex items-center gap-2 text-white/90 font-semibold mb-1">
                <i data-lucide="activity" className="w-5 h-5 text-emerald-400"></i>
                Status
              </h4>
              <p className="flex items-center gap-2 text-xs text-white/60 pulse-glow">
                <i data-lucide="info" className="w-3 h-3"></i>
                {status}
              </p>
              <div className="mt-2 h-2 w-full rounded-full bg-white/10 overflow-hidden">
                <div className="h-2 progress-shine rounded-full transition-all" style={{ width: `${prog}%` }} />
              </div>
            </div>
          </div>

          <div className="my-4 h-px bg-white/10" />

           <div className="scale-in">
             <h4 className="flex items-center gap-2 text-white/90 font-semibold mb-1">
               <i data-lucide="file-text" className="w-5 h-5 text-emerald-400"></i>
               Decrypted Tip
             </h4>
             <pre className="font-mono text-xs bg-black/40 p-3 rounded-xl border border-white/10 min-h-[96px] whitespace-pre-wrap hover:border-cyan-400/20 transition-all">{text}</pre>
             <div className="mt-2 space-y-1">
               {files.map((x, i) => (
                 <a key={i} href={URL.createObjectURL(new Blob([ub64(x.b64)], { type: x.type || "application/octet-stream" }))} download={x.name} className="flex items-center gap-2 text-cyan-300 hover:text-cyan-200 text-sm hover:translate-x-1 transition-transform">
                   <i data-lucide="paperclip" className="w-4 h-4"></i>
                   Download {x.name} ({x.type || "file"})
                 </a>
               ))}
             </div>
             <p className="flex items-center gap-2 text-xs text-white/60 mt-2">
               <i data-lucide="hash" className="w-4 h-4"></i>
               Bundle hash: <span className="font-mono shimmer-bg">{hash}</span>
             </p>
           </div>
        </GlassCard>
      );
    }

    function VerifyMemo({ pushToast, verifyHash }) {
      const [hashIn, setHashIn] = useState(verifyHash || "");
      const [memoSig, setMemoSig] = useState("");
      const [hist, setHist] = useState(storageGetHistory());
      
      useEffect(()=>{
        if(window.lucide) window.lucide.createIcons();
      });
      useEffect(()=>{
        function onH(){ setHist(storageGetHistory()); }
        window.addEventListener('whHistory', onH);
        return ()=> window.removeEventListener('whHistory', onH);
      },[]);

      useEffect(() => { if (verifyHash) setHashIn(verifyHash); }, [verifyHash]);

      async function postMemo() {
        try {
          let hash;
          try{ hash = parseHashOrCode(hashIn); }
          catch{ throw new Error("Enter 64-hex or whis.xxxx short code"); }
          if (!walletStore.pubkey) {
            const r = await window.solana?.connect?.();
            if (!r) throw new Error("Wallet not connected");
            walletStore.pubkey = r.publicKey.toBase58();
            walletStore.setPub(walletStore.pubkey);
          }
          const { Connection, PublicKey, SystemProgram, Transaction, TransactionInstruction } = solanaWeb3;
          await ensureBuffer();
          const { http: httpUrl, ws: wsUrl } = getRpcUrls();
          const conn = wsUrl
            ? new Connection(httpUrl, { commitment: 'confirmed', wsEndpoint: wsUrl })
            : new Connection(httpUrl, 'confirmed');
          const MEMO = new PublicKey("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr");
          const memoBuf = enc.encode("WHISTLE_HASH:" + hash); // Uint8Array
          const ixMemo = new TransactionInstruction({ keys: [], programId: MEMO, data: memoBuf });
          const ixPing = SystemProgram.transfer({ fromPubkey: new PublicKey(walletStore.pubkey), toPubkey: new PublicKey(walletStore.pubkey), lamports: 0 });
    const tx = new Transaction().add(ixPing, ixMemo);
          tx.feePayer = new PublicKey(walletStore.pubkey);
    tx.recentBlockhash = (await conn.getLatestBlockhash()).blockhash;
    const signed = await window.solana.signTransaction(tx);
          const sig = await conn.sendRawTransaction(signed.serialize(), { skipPreflight: false });
          await conn.confirmTransaction(sig, "confirmed");
          setMemoSig(sig);
          pushToast("Memo posted", "ok");
        } catch (e) {
          const msg = (e && e.message) ? e.message : String(e);
          if (msg.includes('403')){
            pushToast("Memo failed: RPC access forbidden (403). Check custom RPC HTTP/WS.", "err");
          } else {
            pushToast("Memo failed: " + msg, "err");
          }
        }
      }

      return (
        <GlassCard title="Verify / Memo" subtitle="Post Solana Memo with the bundle hash (required)">
          <div className="grid md:grid-cols-2 gap-4">
            <div>
              <label className="text-xs text-white/60">Bundle hash (sha256 hex or short code)</label>
              <input value={hashIn} onChange={(e) => setHashIn(e.target.value)} placeholder="e.g., 4f2c… or whis.abcd.efgh…" className="mt-1 w-full rounded-xl bg-white/[0.06] border border-white/10 p-3 font-mono text-xs outline-none focus:ring-2 focus:ring-cyan-400/40" />

              <button onClick={postMemo} className="mt-3 rounded-xl bg-white/15 hover:bg-white/25 text-white font-semibold px-4 py-2 border border-white/10">Post Memo</button>
              {memoSig && (
                <p className="text-xs text-white/60 mt-2">🧾 Memo: <a className="text-cyan-300" target="_blank" rel="noreferrer" href={`https://solscan.io/tx/${memoSig}`}>{memoSig}</a></p>
              )}
            </div>
            <div className="text-xs text-white/70 space-y-2">
              <div className="flex items-center justify-between">
                <h4 className="text-white/90 font-semibold">History</h4>
                <button onClick={()=>{ setHistory([]); setHistory([]); setHistory([]); setHistory([]); setHistory([]); /* noop */ }} className="hidden" />
                <button onClick={()=>{ setHistory([]); setHistory([]); }} className="hidden" />
                <button onClick={()=>{ setHistory([]); }} className="hidden" />
              </div>
              <div className="rounded-xl bg-white/[0.04] border border-white/10 max-h-64 overflow-auto">
                {hist.length === 0 && <div className="p-3 text-white/50">No previous items.</div>}
                {hist.map((h)=> (
                  <div key={h.id} className="flex items-center justify-between px-3 py-2 border-b border-white/5">
                    <div className="min-w-0">
                      <div className="text-white/80 font-mono truncate">{h.short}</div>
                      <div className="text-white/40 text-[11px]">{h.kind} • {new Date(h.at).toLocaleString()}</div>
                    </div>
                    <div className="flex gap-2 ml-3 shrink-0">
                      <button onClick={async ()=>{ try{ await navigator.clipboard.writeText(h.short); pushToast('Copied short code','ok'); }catch{} }} className="rounded-md bg-white/10 hover:bg-white/20 text-white text-[11px] px-2 py-1 border border-white/10">Copy</button>
                      <button onClick={async ()=>{ try{ await navigator.clipboard.writeText(h.hash); pushToast('Copied hash','ok'); }catch{} }} className="rounded-md bg-white/10 hover:bg-white/20 text-white text-[11px] px-2 py-1 border border-white/10">Hash</button>
                    </div>
                  </div>
                ))}
              </div>
              <div className="flex gap-2">
                <button onClick={()=> setHist(storageGetHistory())} className="rounded-md bg-white/10 hover:bg-white/20 text-white text-[11px] px-2 py-1 border border-white/10">Refresh</button>
                <button onClick={()=>{ setHistory([]); setHistory([]); setHistory([]); setHistory([]); setHistory([]); }} className="hidden" />
                <button onClick={()=>{ setHistory([]); setHistory([]); }} className="hidden" />
                <button onClick={()=>{ setHistory([]); setHistory([]); }} className="hidden" />
                <button onClick={()=>{ setHistory([]); setHistory([]); }} className="hidden" />
                <button onClick={()=>{ setHistory([]); setHistory([]); }} className="hidden" />
                <button onClick={()=>{ setHistory([]); setHistory([]); }} className="hidden" />
                <button onClick={()=>{ storageSetHistory([]); setHist([]); }} className="rounded-md bg-rose-500/20 hover:bg-rose-500/30 text-rose-100 text-[11px] px-2 py-1 border border-rose-400/30">Clear (local)</button>
            </div>
          </div>

          {/* Decrypt Pump */}
          <div className="bg-white/5 border border-white/10 rounded-xl p-4 text-sm text-white/80 space-y-2">
            <div className="flex items-center justify-between">
              <div className="font-semibold text-white">Decrypt Pump</div>
              <button onClick={()=>setShowDecrypt(s=>!s)} className="text-xs px-2 py-1 bg-emerald-500/20 hover:bg-emerald-500/30 border border-emerald-400/40 rounded text-emerald-300">{showDecrypt? 'Hide' : 'Open'}</button>
            </div>
            {showDecrypt && (
              <>
                <input
                  value={decryptInput}
                  onChange={e=>setDecryptInput(e.target.value)}
                  placeholder="Paste [ENCRYPTED:...] or ciphertext"
                  className="w-full bg-white/5 border border-white/20 rounded px-3 py-2 text-white text-sm font-mono"
                />
            <div className="flex gap-2 justify-end">
              <button
                    onClick={async ()=>{
                      try{
                        const raw = (decryptInput||'').trim();
                        const m = raw.match(/^\[ENCRYPTED:(.*)\]$/s);
                        const ct = m ? m[1] : raw;
                    const pt = await decryptSelfContained(ct);
                        setDecryptResult(pt);
                        pushToast?.('Decrypted ✓','ok');
                      }catch(e){
                        setDecryptResult('');
                        pushToast?.('Decryption failed','err');
                      }
                    }}
                    className="px-4 py-2 bg-emerald-500 hover:bg-emerald-400 text-white rounded-lg transition-all"
                  >Decrypt</button>
                </div>
                {decryptResult && (
                  <div className="mt-1 p-2 rounded-lg bg-black/30 border border-white/10">
                    <div className="text-white/70 text-xs mb-1">Result</div>
                    <pre className="text-sm text-white whitespace-pre-wrap">{decryptResult}</pre>
                  </div>
                )}
              </>
            )}
          </div>
          </div>
        </GlassCard>
      );
    }

    // ===== STEGANOGRAPHY-ONLY COMMUNICATION SECTION =====
    
    function StegoSender({ pushToast }) {
      const [message, setMessage] = useState("");
      const [stegoImage, setStegoImage] = useState(null);
      const [processing, setProcessing] = useState(false);
      const [mode, setMode] = useState('spread'); // 'lsb' or 'spread' - default to spread for compression resistance
      const coverImageRef = useRef(null);
      
      useEffect(()=>{
        if(window.lucide) window.lucide.createIcons();
      });
      
      async function createStegoImage() {
        if (!message.trim()) {
          pushToast("Write a message first", "err");
          return;
        }
        if (!coverImageRef.current?.files?.[0]) {
          pushToast("Select a cover image", "err");
          return;
        }
        
        setProcessing(true);
        try {
          const coverImage = coverImageRef.current.files[0];
          let hiddenImage;
          
          if (mode === 'spread') {
            // Use empty string as default password for Spread Spectrum
            hiddenImage = await spreadSpectrumEncode(coverImage, message, '');
            pushToast("✓ Message hidden with Spread Spectrum! Compression-resistant.", "ok");
          } else {
            hiddenImage = await hideDataInImage(coverImage, message);
            pushToast("✓ Message hidden in image!", "ok");
          }
          
          setStegoImage(hiddenImage);
        } catch (e) {
          pushToast("Failed: " + e.message, "err");
        }
        setProcessing(false);
      }
      
      function downloadImage() {
        if (!stegoImage) return;
        const url = URL.createObjectURL(stegoImage);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'photo.png';
        a.click();
        URL.revokeObjectURL(url);
        pushToast("Image downloaded!", "ok");
      }
      
      function resetStegoSender() {
        setMessage("");
        setStegoImage(null);
        if (coverImageRef.current) coverImageRef.current.value = "";
        pushToast("Reset", "ok");
      }
      
      return (
        <GlassCard title="🎭 Steganography — Sender" subtitle="Hide your message inside an innocent-looking image">
          <div className="space-y-4">
            {/* Mode Selection */}
            <div className="p-3 rounded-xl bg-gradient-to-r from-cyan-500/10 to-purple-500/10 border border-cyan-400/20">
              <label className="text-sm text-white/80 font-semibold mb-2 block">Encoding Mode</label>
              <div className="grid grid-cols-2 gap-2">
                <button 
                  onClick={(e)=>{ ripple(e); setMode('lsb'); }}
                  className={`rounded-xl p-3 border transition-all btn-ripple ${mode === 'lsb' ? 'bg-cyan-500/30 border-cyan-400/50 text-white' : 'bg-white/[0.04] border-white/10 text-white/70 hover:bg-white/[0.08]'}`}
                >
                  <div className="flex items-center gap-2 mb-1">
                    <i data-lucide="zap" className="w-4 h-4"></i>
                    <span className="font-semibold text-sm">LSB (Fast)</span>
                  </div>
                  <p className="text-xs opacity-80">High capacity, email/Telegram only</p>
                </button>
                <button 
                  onClick={(e)=>{ ripple(e); setMode('spread'); }}
                  className={`rounded-xl p-3 border transition-all btn-ripple ${mode === 'spread' ? 'bg-purple-500/30 border-purple-400/50 text-white' : 'bg-white/[0.04] border-white/10 text-white/70 hover:bg-white/[0.08]'}`}
                >
                  <div className="flex items-center gap-2 mb-1">
                    <i data-lucide="shield" className="w-4 h-4"></i>
                    <span className="font-semibold text-sm">Spread Spectrum</span>
                  </div>
                  <p className="text-xs opacity-80">Compression-resistant, works on X/Instagram!</p>
                </button>
              </div>
              <p className="text-xs text-white/60 mt-2">
                💡 <strong>Spread Spectrum</strong> is recommended — it survives compression from social media apps!
              </p>
            </div>
            
            <div>
              <label className="text-sm text-white/80 font-semibold mb-2 block">Your Secret Message</label>
              <textarea 
                value={message} 
                onChange={(e) => setMessage(e.target.value)} 
                rows={6} 
                className="w-full rounded-xl bg-white/[0.06] border border-white/10 p-3 outline-none focus:ring-2 focus:ring-purple-400/40 text-white" 
                placeholder="Type your confidential message here..."
              />
              <p className="text-xs text-white/50 mt-1">
                This message will be invisible to anyone looking at the image.
                {mode === 'spread' && <span className="ml-2 text-purple-300 font-mono">{message.length} / ~500 chars</span>}
              </p>
            </div>
            
            <div>
              <label className="text-sm text-white/80 font-semibold mb-2 block">Cover Image</label>
              <input 
                ref={coverImageRef} 
                type="file" 
                accept="image/*" 
                className="w-full rounded-xl bg-white/[0.06] border border-white/10 p-3 text-sm file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-purple-500/30 file:text-purple-100 hover:file:bg-purple-500/40"
              />
              <p className="text-xs text-white/50 mt-1">
                {mode === 'spread' ? 'Larger images recommended (1000x1000+) for better compression resistance' : 'Choose any image: vacation photo, pet, landscape, meme, etc.'}
              </p>
            </div>
            
            <div className="flex gap-3 flex-wrap">
              <button 
                onClick={(e)=>{ ripple(e); createStegoImage(); }} 
                disabled={processing}
                className="flex items-center gap-2 rounded-xl bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-400 hover:to-pink-400 disabled:opacity-50 text-white font-semibold px-6 py-3 btn-ripple btn-press shadow-lg"
              >
                <i data-lucide={processing ? "loader" : "wand-2"} className={`w-5 h-5 ${processing ? 'animate-spin' : ''}`}></i>
                {processing ? "Hiding Message..." : "Create Stego Image"}
              </button>
              
              {stegoImage && (
                <>
                  <button 
                    onClick={(e)=>{ ripple(e); downloadImage(); }}
                    className="flex items-center gap-2 rounded-xl bg-emerald-500/80 hover:bg-emerald-400 text-white font-semibold px-6 py-3 btn-ripple btn-press"
                  >
                    <i data-lucide="download" className="w-5 h-5"></i>
                    Download Image
                  </button>
                  
                  <button 
                    onClick={(e)=>{ ripple(e); 
                      const url = URL.createObjectURL(stegoImage);
                      const preview = window.open('', '_blank');
                      preview.document.write(`
                        <html><head><title>Stego Image Preview</title></head>
                        <body style="margin:0;padding:20px;background:#111;color:#fff;font-family:sans-serif;">
                          <h2>✅ Your Steganography Image</h2>
                          <img src="${url}" style="max-width:100%;height:auto;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,0.5);" />
                          <p>👆 This image looks completely normal, but contains your hidden message!</p>
                          <p>Share it via email, WhatsApp, Twitter, Instagram, or any messaging platform.</p>
                        </body></html>
                      `);
                    }}
                    className="flex items-center gap-2 rounded-xl bg-cyan-500/80 hover:bg-cyan-400 text-white font-semibold px-6 py-3 btn-ripple btn-press"
                  >
                    <i data-lucide="eye" className="w-5 h-5"></i>
                    Preview
                  </button>
                </>
              )}
              
              <button 
                onClick={(e)=>{ ripple(e); resetStegoSender(); }}
                className="flex items-center gap-2 rounded-xl bg-white/10 hover:bg-white/20 text-white font-semibold px-4 py-3 border border-white/10 btn-ripple btn-press"
              >
                <i data-lucide="refresh-cw" className="w-4 h-4"></i>
                Reset
              </button>
            </div>
            
            {stegoImage && (
              <div className={`mt-4 p-4 rounded-xl bg-gradient-to-r border scale-in ${
                mode === 'spread' 
                  ? 'from-purple-500/20 to-pink-500/20 border-purple-400/30' 
                  : 'from-emerald-500/20 to-cyan-500/20 border-emerald-400/30'
              }`}>
                <div className="flex items-center gap-2 mb-2">
                  <i data-lucide="check-circle" className={`w-5 h-5 ${mode === 'spread' ? 'text-purple-300' : 'text-emerald-300'}`}></i>
                  <h4 className="text-white/90 font-semibold">✅ Stego Image Ready!</h4>
                </div>
                <p className="text-sm text-white/80 mb-2">
                  Your message is now hidden inside the image using <strong>{mode === 'spread' ? 'Spread Spectrum' : 'LSB'}</strong> encoding.
                </p>
                
                {mode === 'spread' ? (
                  <div className="space-y-2">
                    <div className="p-2 rounded-lg bg-purple-500/20 border border-purple-400/30">
                      <p className="text-xs text-purple-100 font-semibold mb-1">🛡️ Compression-Resistant Mode Active</p>
                      <p className="text-xs text-white/70">This image can survive JPEG compression! Safe to share on:</p>
                      <div className="flex flex-wrap gap-2 mt-2">
                        <span className="px-2 py-1 rounded-lg bg-emerald-500/20 border border-emerald-400/30 text-xs">✅ Twitter/X</span>
                        <span className="px-2 py-1 rounded-lg bg-emerald-500/20 border border-emerald-400/30 text-xs">✅ Instagram</span>
                        <span className="px-2 py-1 rounded-lg bg-emerald-500/20 border border-emerald-400/30 text-xs">✅ Facebook</span>
                        <span className="px-2 py-1 rounded-lg bg-emerald-500/20 border border-emerald-400/30 text-xs">✅ WhatsApp</span>
                        <span className="px-2 py-1 rounded-lg bg-emerald-500/20 border border-emerald-400/30 text-xs">✅ Email</span>
                      </div>
                    </div>
                    <p className="text-xs text-white/60">
                      ⚠️ Don't forget to share the password separately via a secure channel!
                    </p>
                  </div>
                ) : (
                  <div className="space-y-2">
                    <div className="flex flex-wrap gap-2 text-xs">
                      <span className="px-3 py-1 rounded-lg bg-white/10 border border-white/20">📧 Email</span>
                      <span className="px-3 py-1 rounded-lg bg-white/10 border border-white/20">💬 WhatsApp Doc</span>
                      <span className="px-3 py-1 rounded-lg bg-white/10 border border-white/20">📱 Telegram File</span>
                      <span className="px-3 py-1 rounded-lg bg-white/10 border border-white/20">💬 Discord</span>
                    </div>
                    <div className="p-3 rounded-lg bg-yellow-500/20 border border-yellow-400/30">
                      <div className="flex items-start gap-2">
                        <i data-lucide="alert-triangle" className="w-4 h-4 text-yellow-300 shrink-0 mt-0.5"></i>
                        <div className="text-xs text-yellow-100">
                          <strong>LSB Mode:</strong> Send as <strong>uncompressed PNG</strong>. Don't post on X/Instagram as photo. Use <strong>Spread Spectrum mode</strong> for social media posting.
                        </div>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            )}
          </div>
        </GlassCard>
      );
    }
    function StegoReceiver({ pushToast }) {
      const [extractedMessage, setExtractedMessage] = useState("");
      const [extracting, setExtracting] = useState(false);
      const [mode, setMode] = useState('auto'); // 'auto', 'lsb', or 'spread'
      const imageFileRef = useRef(null);
      
      useEffect(()=>{
        if(window.lucide) window.lucide.createIcons();
      });
      
      async function extractMessage() {
        if (!imageFileRef.current?.files?.[0]) {
          pushToast("Select an image first", "err");
          return;
        }
        
        setExtracting(true);
        try {
          const imageFile = imageFileRef.current.files[0];
          let extracted = null;
          
          // Auto mode: Try both methods with empty password
          if (mode === 'auto') {
            // Try LSB first (faster)
            try {
              extracted = await extractDataFromImage(imageFile);
              pushToast("✓ Message extracted (LSB mode)!", "ok");
            } catch (lsbError) {
              // LSB failed, try Spread Spectrum with empty password
              try {
                extracted = await spreadSpectrumDecode(imageFile, '');
                pushToast("✓ Message extracted (Spread Spectrum mode)!", "ok");
              } catch (spreadError) {
                throw new Error("No hidden message found. Make sure this image was created with Whistle's steganography feature.");
              }
            }
          } else if (mode === 'spread') {
            extracted = await spreadSpectrumDecode(imageFile, '');
            pushToast("✓ Message extracted (Spread Spectrum)!", "ok");
          } else {
            extracted = await extractDataFromImage(imageFile);
            pushToast("✓ Message extracted (LSB)!", "ok");
          }
          
          setExtractedMessage(extracted);
        } catch (e) {
          pushToast("Extraction failed: " + e.message, "err");
          setExtractedMessage("");
        }
        setExtracting(false);
      }
      
      async function copyMessage() {
        try {
          await navigator.clipboard.writeText(extractedMessage);
          pushToast("Message copied", "ok");
        } catch (e) {
          pushToast("Copy failed", "err");
        }
      }
      
      function resetStegoReceiver() {
        setExtractedMessage("");
        if (imageFileRef.current) imageFileRef.current.value = "";
        pushToast("Reset", "ok");
      }
      
      return (
        <GlassCard title="🎭 Steganography — Receiver" subtitle="Extract hidden messages from images">
          <div className="space-y-4">
            {/* Mode Selection */}
            <div className="p-3 rounded-xl bg-gradient-to-r from-cyan-500/10 to-purple-500/10 border border-cyan-400/20">
              <label className="text-sm text-white/80 font-semibold mb-2 block">Decoding Mode</label>
              <div className="grid grid-cols-3 gap-2">
                <button 
                  onClick={(e)=>{ ripple(e); setMode('auto'); }}
                  className={`rounded-xl p-2 border transition-all btn-ripple ${mode === 'auto' ? 'bg-cyan-500/30 border-cyan-400/50 text-white' : 'bg-white/[0.04] border-white/10 text-white/70 hover:bg-white/[0.08]'}`}
                >
                  <div className="flex items-center justify-center gap-1 mb-1">
                    <i data-lucide="wand-2" className="w-4 h-4"></i>
                    <span className="font-semibold text-xs">Auto</span>
                  </div>
                  <p className="text-[10px] opacity-80">Tries both</p>
                </button>
                <button 
                  onClick={(e)=>{ ripple(e); setMode('lsb'); }}
                  className={`rounded-xl p-2 border transition-all btn-ripple ${mode === 'lsb' ? 'bg-cyan-500/30 border-cyan-400/50 text-white' : 'bg-white/[0.04] border-white/10 text-white/70 hover:bg-white/[0.08]'}`}
                >
                  <div className="flex items-center justify-center gap-1 mb-1">
                    <i data-lucide="zap" className="w-4 h-4"></i>
                    <span className="font-semibold text-xs">LSB</span>
                  </div>
                  <p className="text-[10px] opacity-80">Fast</p>
                </button>
                <button 
                  onClick={(e)=>{ ripple(e); setMode('spread'); }}
                  className={`rounded-xl p-2 border transition-all btn-ripple ${mode === 'spread' ? 'bg-purple-500/30 border-purple-400/50 text-white' : 'bg-white/[0.04] border-white/10 text-white/70 hover:bg-white/[0.08]'}`}
                >
                  <div className="flex items-center justify-center gap-1 mb-1">
                    <i data-lucide="shield" className="w-4 h-4"></i>
                    <span className="font-semibold text-xs">Spread</span>
                  </div>
                  <p className="text-[10px] opacity-80">Robust</p>
                </button>
              </div>
              <p className="text-xs text-white/60 mt-2">
                💡 <strong>Auto mode</strong> automatically detects the encoding method used.
              </p>
            </div>
            
            <div>
              <label className="text-sm text-white/80 font-semibold mb-2 block">Upload Image with Hidden Message</label>
              <input 
                ref={imageFileRef} 
                type="file" 
                accept="image/*" 
                onChange={() => setExtractedMessage("")}
                className="w-full rounded-xl bg-white/[0.06] border border-white/10 p-3 text-sm file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-purple-500/30 file:text-purple-100 hover:file:bg-purple-500/40"
              />
              <p className="text-xs text-white/50 mt-1">Select the image you received from the sender.</p>
            </div>
            
            <div className="flex gap-3">
              <button 
                onClick={(e)=>{ ripple(e); extractMessage(); }} 
                disabled={extracting}
                className="flex items-center gap-2 rounded-xl bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-400 hover:to-pink-400 disabled:opacity-50 text-white font-semibold px-6 py-3 btn-ripple btn-press shadow-lg"
              >
                <i data-lucide={extracting ? "loader" : "scan"} className={`w-5 h-5 ${extracting ? 'animate-spin' : ''}`}></i>
                {extracting ? "Extracting..." : "Extract Message"}
              </button>
              
              {extractedMessage && (
                <button 
                  onClick={(e)=>{ ripple(e); copyMessage(); }}
                  className="flex items-center gap-2 rounded-xl bg-cyan-500/80 hover:bg-cyan-400 text-white font-semibold px-6 py-3 btn-ripple btn-press"
                >
                  <i data-lucide="copy" className="w-5 h-5"></i>
                  Copy Message
                </button>
              )}
              
              <button 
                onClick={(e)=>{ ripple(e); resetStegoReceiver(); }}
                className="flex items-center gap-2 rounded-xl bg-white/10 hover:bg-white/20 text-white font-semibold px-4 py-3 border border-white/10 btn-ripple btn-press"
              >
                <i data-lucide="refresh-cw" className="w-4 h-4"></i>
                Reset
              </button>
            </div>
            
            {extractedMessage && (
              <div className="mt-4 scale-in">
                <label className="text-sm text-white/80 font-semibold mb-2 block flex items-center gap-2">
                  <i data-lucide="lock-open" className="w-4 h-4 text-emerald-400"></i>
                  Extracted Message
                </label>
                <div className="rounded-xl bg-emerald-500/10 border border-emerald-400/30 p-4">
                  <pre className="whitespace-pre-wrap text-sm text-white/90 font-mono">{extractedMessage}</pre>
                </div>
                <p className="text-xs text-white/60 mt-2">
                  ✅ Message successfully extracted from the image!
                </p>
              </div>
            )}
            
            {!extractedMessage && !extracting && (
              <div className="p-4 rounded-xl bg-purple-500/10 border border-purple-400/20">
                <div className="flex items-center gap-2 mb-2">
                  <i data-lucide="info" className="w-4 h-4 text-purple-300"></i>
                  <h4 className="text-white/90 font-semibold text-sm">How it works</h4>
                </div>
                <ul className="text-xs text-white/70 space-y-1 list-disc list-inside">
                  <li>Sender hides a message inside a normal-looking image</li>
                  <li>The image looks 100% innocent to anyone else</li>
                  <li>You upload that image here to reveal the hidden message</li>
                  <li>Perfect for covert communication!</li>
                </ul>
              </div>
            )}
          </div>
        </GlassCard>
      );
    }
    
    // ===== WRAPPER COMPONENTS WITH TABS =====
    
    function WebRTCTransfer({ pushToast, onHashReady, setVerifyHash }) {
      const [mode, setMode] = useState('send');
      
      useEffect(()=>{
        if(window.lucide) window.lucide.createIcons();
      },[mode]);
      
      return (
        <div className="space-y-4">
          <div className="flex gap-2 p-1 rounded-xl bg-white/[0.04] border border-white/10 w-fit">
            <button
              onClick={() => setMode('send')}
              className={`px-6 py-2 rounded-lg font-semibold text-sm transition-all ${
                mode === 'send'
                  ? 'bg-cyan-500/30 text-cyan-100 border border-cyan-400/50'
                  : 'text-white/70 hover:text-white/90'
              }`}
            >
              <div className="flex items-center gap-2">
                <i data-lucide="send" className="w-4 h-4"></i>
                Sender
              </div>
            </button>
            <button
              onClick={() => setMode('receive')}
              className={`px-6 py-2 rounded-lg font-semibold text-sm transition-all ${
                mode === 'receive'
                  ? 'bg-purple-500/30 text-purple-100 border border-purple-400/50'
                  : 'text-white/70 hover:text-white/90'
              }`}
            >
              <div className="flex items-center gap-2">
                <i data-lucide="download" className="w-4 h-4"></i>
                Receiver
              </div>
            </button>
          </div>
          
          {mode === 'send' && <Sender pushToast={pushToast} onHashReady={onHashReady} />}
          {mode === 'receive' && <Receiver pushToast={pushToast} onHashReady={onHashReady} setVerifyHash={setVerifyHash} />}
        </div>
      );
    }
    
    function ImageStego({ pushToast }) {
      const [mode, setMode] = useState('send');
      
      useEffect(()=>{
        if(window.lucide) window.lucide.createIcons();
      },[mode]);
      
      return (
        <div className="space-y-4">
          <div className="flex gap-2 p-1 rounded-xl bg-white/[0.04] border border-white/10 w-fit">
            <button
              onClick={() => setMode('send')}
              className={`px-6 py-2 rounded-lg font-semibold text-sm transition-all ${
                mode === 'send'
                  ? 'bg-purple-500/30 text-purple-100 border border-purple-400/50'
                  : 'text-white/70 hover:text-white/90'
              }`}
            >
              <div className="flex items-center gap-2">
                <i data-lucide="image" className="w-4 h-4"></i>
                Hide in Image
              </div>
            </button>
            <button
              onClick={() => setMode('receive')}
              className={`px-6 py-2 rounded-lg font-semibold text-sm transition-all ${
                mode === 'receive'
                  ? 'bg-cyan-500/30 text-cyan-100 border border-cyan-400/50'
                  : 'text-white/70 hover:text-white/90'
              }`}
            >
              <div className="flex items-center gap-2">
                <i data-lucide="scan" className="w-4 h-4"></i>
                Extract from Image
              </div>
            </button>
          </div>
          
          {mode === 'send' && <StegoSender pushToast={pushToast} />}
          {mode === 'receive' && <StegoReceiver pushToast={pushToast} />}
        </div>
      );
    }
    
    function AudioStego({ pushToast }) {
      const [mode, setMode] = useState('send');
      
      useEffect(()=>{
        if(window.lucide) window.lucide.createIcons();
      },[mode]);
      
      return (
        <div className="space-y-4">
          <div className="flex gap-2 p-1 rounded-xl bg-white/[0.04] border border-white/10 w-fit">
            <button
              onClick={() => setMode('send')}
              className={`px-6 py-2 rounded-lg font-semibold text-sm transition-all ${
                mode === 'send'
                  ? 'bg-pink-500/30 text-pink-100 border border-pink-400/50'
                  : 'text-white/70 hover:text-white/90'
              }`}
            >
              <div className="flex items-center gap-2">
                <i data-lucide="music" className="w-4 h-4"></i>
                Hide in Audio
              </div>
            </button>
            <button
              onClick={() => setMode('receive')}
              className={`px-6 py-2 rounded-lg font-semibold text-sm transition-all ${
                mode === 'receive'
                  ? 'bg-cyan-500/30 text-cyan-100 border border-cyan-400/50'
                  : 'text-white/70 hover:text-white/90'
              }`}
            >
              <div className="flex items-center gap-2">
                <i data-lucide="headphones" className="w-4 h-4"></i>
                Extract from Audio
              </div>
            </button>
          </div>
          
          {mode === 'send' && <AudioStegoSender pushToast={pushToast} />}
          {mode === 'receive' && <AudioStegoReceiver pushToast={pushToast} />}
        </div>
      );
    }
    
    function VideoStego({ pushToast }) {
      const [mode, setMode] = useState('send');
      
      useEffect(()=>{
        if(window.lucide) window.lucide.createIcons();
      },[mode]);
      
      return (
        <div className="space-y-4">
          <div className="flex gap-2 p-1 rounded-xl bg-white/[0.04] border border-white/10 w-fit">
            <button
              onClick={() => setMode('send')}
              className={`px-6 py-2 rounded-lg font-semibold text-sm transition-all ${
                mode === 'send'
                  ? 'bg-violet-500/30 text-violet-100 border border-violet-400/50'
                  : 'text-white/70 hover:text-white/90'
              }`}
            >
              <div className="flex items-center gap-2">
                <i data-lucide="video" className="w-4 h-4"></i>
                Hide in Video
              </div>
            </button>
            <button
              onClick={() => setMode('receive')}
              className={`px-6 py-2 rounded-lg font-semibold text-sm transition-all ${
                mode === 'receive'
                  ? 'bg-cyan-500/30 text-cyan-100 border border-cyan-400/50'
                  : 'text-white/70 hover:text-white/90'
              }`}
            >
              <div className="flex items-center gap-2">
                <i data-lucide="film" className="w-4 h-4"></i>
                Extract from Video
              </div>
            </button>
          </div>
          
          {mode === 'send' && <VideoStegoSender pushToast={pushToast} />}
          {mode === 'receive' && <VideoStegoReceiver pushToast={pushToast} />}
        </div>
      );
    }
    
    // ===== AUDIO STEGANOGRAPHY COMPONENTS =====
    
    function AudioStegoSender({ pushToast }) {
      const [message, setMessage] = useState("");
      const [stegoAudio, setStegoAudio] = useState(null);
      const [processing, setProcessing] = useState(false);
      const audioFileRef = useRef(null);
      
      useEffect(()=>{
        if(window.lucide) window.lucide.createIcons();
      },[]);
      
      async function createStegoAudio() {
        if (!message.trim()) {
          pushToast("Write a message first", "err");
          return;
        }
        if (!audioFileRef.current?.files?.[0]) {
          pushToast("Select an audio file", "err");
          return;
        }
        
        setProcessing(true);
        try {
          const audioFile = audioFileRef.current.files[0];
          const hiddenAudio = await hideDataInAudio(audioFile, message);
          setStegoAudio(hiddenAudio);
          pushToast("✓ Message hidden in audio!", "ok");
        } catch (e) {
          pushToast("Failed: " + e.message, "err");
        }
        setProcessing(false);
      }
      
      function downloadAudio() {
        if (!stegoAudio) return;
        const url = URL.createObjectURL(stegoAudio);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'audio_message.wav';
        a.click();
        URL.revokeObjectURL(url);
        pushToast("Audio downloaded!", "ok");
      }
      
      function resetAudioSender() {
        setMessage("");
        setStegoAudio(null);
        if (audioFileRef.current) audioFileRef.current.value = "";
        pushToast("Reset", "ok");
      }
      
      return (
        <GlassCard title="🎵 Audio Steganography — Sender" subtitle="Hide messages inside audio files (WAV, MP3)">
          <div className="space-y-4">
            <div className="p-3 rounded-xl bg-gradient-to-r from-pink-500/10 to-rose-500/10 border border-pink-400/20">
              <div className="flex items-center gap-2 mb-2">
                <i data-lucide="music" className="w-5 h-5 text-pink-400"></i>
                <h4 className="text-white/90 font-semibold text-sm">Share via Voice Memos</h4>
              </div>
              <p className="text-xs text-white/70">
                Hide secret messages in audio files. Perfect for sharing through SoundCloud, voice messages, or podcast uploads.
                The audio sounds completely normal!
              </p>
            </div>
            
            <div>
              <label className="text-sm text-white/80 font-semibold mb-2 block">Your Secret Message</label>
              <textarea 
                value={message} 
                onChange={(e) => setMessage(e.target.value)} 
                rows={4} 
                className="w-full rounded-xl bg-white/[0.06] border border-white/10 p-3 outline-none focus:ring-2 focus:ring-pink-400/40 text-white" 
                placeholder="Type your confidential message here..."
              />
              <p className="text-xs text-white/50 mt-1">
                Message will be encoded into audio samples. Limit: ~10,000 characters for a 1-minute audio.
              </p>
            </div>
            
            <div>
              <label className="text-sm text-white/80 font-semibold mb-2 block">Cover Audio File</label>
              <input 
                ref={audioFileRef} 
                type="file" 
                accept="audio/*" 
                className="w-full rounded-xl bg-white/[0.06] border border-white/10 p-3 text-sm file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-pink-500/30 file:text-pink-100 hover:file:bg-pink-500/40"
              />
              <p className="text-xs text-white/50 mt-1">
                Choose any audio: music, voice memo, podcast clip, ambient sound, etc.
              </p>
            </div>
            
            <div className="flex gap-3 flex-wrap">
              <button 
                onClick={(e)=>{ ripple(e); createStegoAudio(); }} 
                disabled={processing}
                className="flex items-center gap-2 rounded-xl bg-gradient-to-r from-pink-500 to-rose-500 hover:from-pink-400 hover:to-rose-400 disabled:opacity-50 text-white font-semibold px-6 py-3 btn-ripple btn-press shadow-lg"
              >
                <i data-lucide={processing ? "loader" : "wand-2"} className={`w-5 h-5 ${processing ? 'animate-spin' : ''}`}></i>
                {processing ? "Hiding Message..." : "Create Stego Audio"}
              </button>
              
              {stegoAudio && (
                <>
                  <button 
                    onClick={(e)=>{ ripple(e); downloadAudio(); }}
                    className="flex items-center gap-2 rounded-xl bg-emerald-500/30 hover:bg-emerald-400/40 text-emerald-100 font-semibold px-6 py-3 btn-ripple btn-press shadow-lg border border-emerald-400/30"
                  >
                    <i data-lucide="download" className="w-5 h-5"></i>
                    Download Audio
                  </button>
                  <button 
                    onClick={(e)=>{ ripple(e); resetAudioSender(); }}
                    className="flex items-center gap-2 rounded-xl bg-white/10 hover:bg-white/20 text-white font-semibold px-6 py-3 btn-ripple btn-press border border-white/10"
                  >
                    <i data-lucide="refresh-cw" className="w-5 h-5"></i>
                    Reset
                  </button>
                </>
              )}
            </div>
            
            {stegoAudio && (
              <div className="p-3 rounded-xl bg-emerald-500/20 border border-emerald-400/30">
                <div className="flex items-center gap-2 mb-2">
                  <i data-lucide="check-circle" className="w-5 h-5 text-emerald-300"></i>
                  <h4 className="text-white/90 font-semibold text-sm">Ready to Share!</h4>
                </div>
                <p className="text-xs text-white/70 mb-2">
                  Your message is now hidden in the audio file. Share it via:
                </p>
                <div className="flex flex-wrap gap-2">
                  <span className="px-3 py-1 rounded-lg bg-white/10 border border-white/20 text-xs">💬 WhatsApp Voice</span>
                  <span className="px-3 py-1 rounded-lg bg-white/10 border border-white/20 text-xs">🎵 SoundCloud</span>
                  <span className="px-3 py-1 rounded-lg bg-white/10 border border-white/20 text-xs">📧 Email</span>
                  <span className="px-3 py-1 rounded-lg bg-white/10 border border-white/20 text-xs">🎙️ Podcast</span>
                  <span className="px-3 py-1 rounded-lg bg-white/10 border border-white/20 text-xs">☁️ Dropbox</span>
                </div>
              </div>
            )}
          </div>
        </GlassCard>
      );
    }
    
    function AudioStegoReceiver({ pushToast }) {
      const [extractedMessage, setExtractedMessage] = useState("");
      const [extracting, setExtracting] = useState(false);
      const audioFileRef = useRef(null);
      
      useEffect(()=>{
        if(window.lucide) window.lucide.createIcons();
      },[]);
      
      async function extractMessage() {
        if (!audioFileRef.current?.files?.[0]) {
          pushToast("Select an audio file first", "err");
          return;
        }
        
        setExtracting(true);
        try {
          const audioFile = audioFileRef.current.files[0];
          const message = await extractDataFromAudio(audioFile);
          setExtractedMessage(message);
          pushToast("✓ Message extracted from audio!", "ok");
        } catch (e) {
          pushToast("Extraction failed: " + e.message, "err");
          setExtractedMessage("");
        }
        setExtracting(false);
      }
      
      async function copyMessage() {
        try {
          await navigator.clipboard.writeText(extractedMessage);
          pushToast("Message copied", "ok");
        } catch (e) {
          pushToast("Copy failed", "err");
        }
      }
      
      function resetAudioReceiver() {
        setExtractedMessage("");
        if (audioFileRef.current) audioFileRef.current.value = "";
        pushToast("Reset", "ok");
      }
      
      return (
        <GlassCard title="🎵 Audio Steganography — Receiver" subtitle="Extract hidden messages from audio files">
          <div className="space-y-4">
            <div className="p-3 rounded-xl bg-gradient-to-r from-pink-500/10 to-rose-500/10 border border-pink-400/20">
              <div className="flex items-center gap-2 mb-2">
                <i data-lucide="headphones" className="w-5 h-5 text-pink-400"></i>
                <h4 className="text-white/90 font-semibold text-sm">Decode Audio Messages</h4>
              </div>
              <p className="text-xs text-white/70">
                Upload an audio file that contains a hidden message to reveal the secret text.
              </p>
            </div>
            
            <div>
              <label className="text-sm text-white/80 font-semibold mb-2 block">Upload Audio with Hidden Message</label>
              <input 
                ref={audioFileRef} 
                type="file" 
                accept="audio/*" 
                className="w-full rounded-xl bg-white/[0.06] border border-white/10 p-3 text-sm file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-pink-500/30 file:text-pink-100 hover:file:bg-pink-500/40"
              />
              <p className="text-xs text-white/50 mt-1">
                Supports WAV, MP3, M4A, and other audio formats.
              </p>
            </div>
            
            <div className="flex gap-3 flex-wrap">
              <button 
                onClick={(e)=>{ ripple(e); extractMessage(); }} 
                disabled={extracting}
                className="flex items-center gap-2 rounded-xl bg-gradient-to-r from-pink-500 to-rose-500 hover:from-pink-400 hover:to-rose-400 disabled:opacity-50 text-white font-semibold px-6 py-3 btn-ripple btn-press shadow-lg"
              >
                <i data-lucide={extracting ? "loader" : "unlock"} className={`w-5 h-5 ${extracting ? 'animate-spin' : ''}`}></i>
                {extracting ? "Extracting..." : "Extract Message"}
              </button>
              
              {extractedMessage && (
                <>
                  <button 
                    onClick={(e)=>{ ripple(e); copyMessage(); }}
                    className="flex items-center gap-2 rounded-xl bg-cyan-500/30 hover:bg-cyan-400/40 text-cyan-100 font-semibold px-6 py-3 btn-ripple btn-press border border-cyan-400/30"
                  >
                    <i data-lucide="copy" className="w-5 h-5"></i>
                    Copy Message
                  </button>
                  <button 
                    onClick={(e)=>{ ripple(e); resetAudioReceiver(); }}
                    className="flex items-center gap-2 rounded-xl bg-white/10 hover:bg-white/20 text-white font-semibold px-6 py-3 btn-ripple btn-press border border-white/10"
                  >
                    <i data-lucide="refresh-cw" className="w-5 h-5"></i>
                    Reset
                  </button>
                </>
              )}
            </div>
            
            {extractedMessage && (
              <div className="p-3 rounded-xl bg-emerald-500/20 border border-emerald-400/30">
                <div className="flex items-center gap-2 mb-2">
                  <i data-lucide="check-circle" className="w-5 h-5 text-emerald-300"></i>
                  <h4 className="text-white/90 font-semibold text-sm">Hidden Message Revealed</h4>
                </div>
                <div className="mt-2 p-3 rounded-lg bg-black/30 border border-white/10">
                  <pre className="text-sm text-white/90 whitespace-pre-wrap font-mono">{extractedMessage}</pre>
                </div>
              </div>
            )}
          </div>
        </GlassCard>
      );
    }
    // ===== VIDEO STEGANOGRAPHY COMPONENTS =====
    
    function VideoStegoSender({ pushToast }) {
      const [message, setMessage] = useState("");
      const [stegoVideo, setStegoVideo] = useState(null);
      const [processing, setProcessing] = useState(false);
      const videoFileRef = useRef(null);
      
      useEffect(()=>{
        if(window.lucide) window.lucide.createIcons();
      },[]);
      
      async function createStegoVideo() {
        if (!message.trim()) {
          pushToast("Write a message first", "err");
          return;
        }
        if (!videoFileRef.current?.files?.[0]) {
          pushToast("Select a video file", "err");
          return;
        }
        
        setProcessing(true);
        try {
          const videoFile = videoFileRef.current.files[0];
          const hiddenVideo = await hideDataInVideo(videoFile, message);
          setStegoVideo(hiddenVideo);
          pushToast("✓ Message hidden in video!", "ok");
        } catch (e) {
          pushToast("Failed: " + e.message, "err");
        }
        setProcessing(false);
      }
      
      function downloadVideo() {
        if (!stegoVideo) return;
        const url = URL.createObjectURL(stegoVideo);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'video_message.webm';
        a.click();
        URL.revokeObjectURL(url);
        pushToast("Video downloaded!", "ok");
      }
      
      function resetVideoSender() {
        setMessage("");
        setStegoVideo(null);
        if (videoFileRef.current) videoFileRef.current.value = "";
        pushToast("Reset", "ok");
      }
      
      return (
        <GlassCard title="🎥 Video Steganography — Sender" subtitle="Hide messages across video frames">
          <div className="space-y-4">
            <div className="p-3 rounded-xl bg-gradient-to-r from-violet-500/10 to-purple-500/10 border border-violet-400/20">
              <div className="flex items-center gap-2 mb-2">
                <i data-lucide="video" className="w-5 h-5 text-violet-400"></i>
                <h4 className="text-white/90 font-semibold text-sm">Share on Social Media</h4>
              </div>
              <p className="text-xs text-white/70">
                Hide secret messages distributed across video frames. Share on YouTube, TikTok, Instagram Reels.
                The video looks completely normal!
              </p>
            </div>
            
            <div>
              <label className="text-sm text-white/80 font-semibold mb-2 block">Your Secret Message</label>
              <textarea 
                value={message} 
                onChange={(e) => setMessage(e.target.value)} 
                rows={4} 
                className="w-full rounded-xl bg-white/[0.06] border border-white/10 p-3 outline-none focus:ring-2 focus:ring-violet-400/40 text-white" 
                placeholder="Type your confidential message here..."
              />
              <p className="text-xs text-white/50 mt-1">
                Message will be distributed across video frames. Limit: ~1,000 characters per 10-second video.
              </p>
            </div>
            
            <div>
              <label className="text-sm text-white/80 font-semibold mb-2 block">Cover Video File</label>
              <input 
                ref={videoFileRef} 
                type="file" 
                accept="video/*" 
                className="w-full rounded-xl bg-white/[0.06] border border-white/10 p-3 text-sm file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-violet-500/30 file:text-violet-100 hover:file:bg-violet-500/40"
              />
              <p className="text-xs text-white/50 mt-1">
                Choose any video: vacation clip, pet video, screen recording, vlog, etc.
              </p>
            </div>
            
            <div className="flex gap-3 flex-wrap">
              <button 
                onClick={(e)=>{ ripple(e); createStegoVideo(); }} 
                disabled={processing}
                className="flex items-center gap-2 rounded-xl bg-gradient-to-r from-violet-500 to-purple-500 hover:from-violet-400 hover:to-purple-400 disabled:opacity-50 text-white font-semibold px-6 py-3 btn-ripple btn-press shadow-lg"
              >
                <i data-lucide={processing ? "loader" : "wand-2"} className={`w-5 h-5 ${processing ? 'animate-spin' : ''}`}></i>
                {processing ? "Processing Video..." : "Create Stego Video"}
              </button>
              
              {stegoVideo && (
                <>
                  <button 
                    onClick={(e)=>{ ripple(e); downloadVideo(); }}
                    className="flex items-center gap-2 rounded-xl bg-emerald-500/30 hover:bg-emerald-400/40 text-emerald-100 font-semibold px-6 py-3 btn-ripple btn-press shadow-lg border border-emerald-400/30"
                  >
                    <i data-lucide="download" className="w-5 h-5"></i>
                    Download Video
                  </button>
                  <button 
                    onClick={(e)=>{ ripple(e); resetVideoSender(); }}
                    className="flex items-center gap-2 rounded-xl bg-white/10 hover:bg-white/20 text-white font-semibold px-6 py-3 btn-ripple btn-press border border-white/10"
                  >
                    <i data-lucide="refresh-cw" className="w-5 h-5"></i>
                    Reset
                  </button>
                </>
              )}
            </div>
            
            {processing && (
              <div className="p-3 rounded-xl bg-yellow-500/20 border border-yellow-400/30">
                <div className="flex items-center gap-2">
                  <i data-lucide="loader" className="w-5 h-5 text-yellow-300 animate-spin"></i>
                  <p className="text-sm text-yellow-100">
                    Processing video frames... This may take a minute for longer videos.
                  </p>
                </div>
              </div>
            )}
            
            {stegoVideo && (
              <div className="p-3 rounded-xl bg-emerald-500/20 border border-emerald-400/30">
                <div className="flex items-center gap-2 mb-2">
                  <i data-lucide="check-circle" className="w-5 h-5 text-emerald-300"></i>
                  <h4 className="text-white/90 font-semibold text-sm">Ready to Upload!</h4>
                </div>
                <p className="text-xs text-white/70 mb-2">
                  Your message is now hidden across the video frames. Share it via:
                </p>
                <div className="flex flex-wrap gap-2">
                  <span className="px-3 py-1 rounded-lg bg-white/10 border border-white/20 text-xs">📹 YouTube</span>
                  <span className="px-3 py-1 rounded-lg bg-white/10 border border-white/20 text-xs">🎵 TikTok</span>
                  <span className="px-3 py-1 rounded-lg bg-white/10 border border-white/20 text-xs">📷 Instagram Reels</span>
                  <span className="px-3 py-1 rounded-lg bg-white/10 border border-white/20 text-xs">💬 WhatsApp</span>
                  <span className="px-3 py-1 rounded-lg bg-white/10 border border-white/20 text-xs">📧 Email</span>
                </div>
              </div>
            )}
          </div>
        </GlassCard>
      );
    }
    
    function VideoStegoReceiver({ pushToast }) {
      const [extractedMessage, setExtractedMessage] = useState("");
      const [extracting, setExtracting] = useState(false);
      const videoFileRef = useRef(null);
      
      useEffect(()=>{
        if(window.lucide) window.lucide.createIcons();
      },[]);
      
      async function extractMessage() {
        if (!videoFileRef.current?.files?.[0]) {
          pushToast("Select a video file first", "err");
          return;
        }
        
        setExtracting(true);
        try {
          const videoFile = videoFileRef.current.files[0];
          const message = await extractDataFromVideo(videoFile);
          setExtractedMessage(message);
          pushToast("✓ Message extracted from video!", "ok");
        } catch (e) {
          pushToast("Extraction failed: " + e.message, "err");
          setExtractedMessage("");
        }
        setExtracting(false);
      }
      
      async function copyMessage() {
        try {
          await navigator.clipboard.writeText(extractedMessage);
          pushToast("Message copied", "ok");
        } catch (e) {
          pushToast("Copy failed", "err");
        }
      }
      
      function resetVideoReceiver() {
        setExtractedMessage("");
        if (videoFileRef.current) videoFileRef.current.value = "";
        pushToast("Reset", "ok");
      }
      
      return (
        <GlassCard title="🎥 Video Steganography — Receiver" subtitle="Extract hidden messages from videos">
          <div className="space-y-4">
            <div className="p-3 rounded-xl bg-gradient-to-r from-violet-500/10 to-purple-500/10 border border-violet-400/20">
              <div className="flex items-center gap-2 mb-2">
                <i data-lucide="film" className="w-5 h-5 text-violet-400"></i>
                <h4 className="text-white/90 font-semibold text-sm">Decode Video Messages</h4>
              </div>
              <p className="text-xs text-white/70">
                Upload a video file that contains a hidden message distributed across its frames.
              </p>
            </div>
            
            <div>
              <label className="text-sm text-white/80 font-semibold mb-2 block">Upload Video with Hidden Message</label>
              <input 
                ref={videoFileRef} 
                type="file" 
                accept="video/*" 
                className="w-full rounded-xl bg-white/[0.06] border border-white/10 p-3 text-sm file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-violet-500/30 file:text-violet-100 hover:file:bg-violet-500/40"
              />
              <p className="text-xs text-white/50 mt-1">
                Supports MP4, WebM, MOV, and other video formats.
              </p>
            </div>
            
            <div className="flex gap-3 flex-wrap">
              <button 
                onClick={(e)=>{ ripple(e); extractMessage(); }} 
                disabled={extracting}
                className="flex items-center gap-2 rounded-xl bg-gradient-to-r from-violet-500 to-purple-500 hover:from-violet-400 hover:to-purple-400 disabled:opacity-50 text-white font-semibold px-6 py-3 btn-ripple btn-press shadow-lg"
              >
                <i data-lucide={extracting ? "loader" : "unlock"} className={`w-5 h-5 ${extracting ? 'animate-spin' : ''}`}></i>
                {extracting ? "Extracting..." : "Extract Message"}
              </button>
              
              {extractedMessage && (
                <>
                  <button 
                    onClick={(e)=>{ ripple(e); copyMessage(); }}
                    className="flex items-center gap-2 rounded-xl bg-cyan-500/30 hover:bg-cyan-400/40 text-cyan-100 font-semibold px-6 py-3 btn-ripple btn-press border border-cyan-400/30"
                  >
                    <i data-lucide="copy" className="w-5 h-5"></i>
                    Copy Message
                  </button>
                  <button 
                    onClick={(e)=>{ ripple(e); resetVideoReceiver(); }}
                    className="flex items-center gap-2 rounded-xl bg-white/10 hover:bg-white/20 text-white font-semibold px-6 py-3 btn-ripple btn-press border border-white/10"
                  >
                    <i data-lucide="refresh-cw" className="w-5 h-5"></i>
                    Reset
                  </button>
                </>
              )}
            </div>
            
            {extracting && (
              <div className="p-3 rounded-xl bg-yellow-500/20 border border-yellow-400/30">
                <div className="flex items-center gap-2">
                  <i data-lucide="loader" className="w-5 h-5 text-yellow-300 animate-spin"></i>
                  <p className="text-sm text-yellow-100">
                    Scanning video frames... This may take a minute for longer videos.
                  </p>
                </div>
              </div>
            )}
            
            {extractedMessage && (
              <div className="p-3 rounded-xl bg-emerald-500/20 border border-emerald-400/30">
                <div className="flex items-center gap-2 mb-2">
                  <i data-lucide="check-circle" className="w-5 h-5 text-emerald-300"></i>
                  <h4 className="text-white/90 font-semibold text-sm">Hidden Message Revealed</h4>
                </div>
                <div className="mt-2 p-3 rounded-lg bg-black/30 border border-white/10">
                  <pre className="text-sm text-white/90 whitespace-pre-wrap font-mono">{extractedMessage}</pre>
                </div>
              </div>
            )}
          </div>
        </GlassCard>
      );
    }
    
    // ===== UNIFIED STEGANOGRAPHY =====
    
    function UnifiedSteganography({ pushToast }) {
      const [stegoType, setStegoType] = useState('image');
      
      useEffect(()=>{
        if(window.lucide) window.lucide.createIcons();
      },[stegoType]);
      
      return (
        <div className="space-y-4">
          {/* Stego Type Selector */}
          <div className="flex gap-2 p-1 rounded-xl bg-white/[0.04] border border-white/10 w-fit mx-auto">
            <button
              onClick={() => setStegoType('image')}
              className={`px-6 py-3 rounded-lg font-semibold text-sm transition-all ${
                stegoType === 'image'
                  ? 'bg-purple-500/30 text-purple-100 border border-purple-400/50'
                  : 'text-white/70 hover:text-white/90'
              }`}
            >
              <div className="flex items-center gap-2">
                <i data-lucide="image" className="w-4 h-4"></i>
                Image
              </div>
            </button>
            <button
              onClick={() => setStegoType('audio')}
              className={`px-6 py-3 rounded-lg font-semibold text-sm transition-all ${
                stegoType === 'audio'
                  ? 'bg-green-500/30 text-green-100 border border-green-400/50'
                  : 'text-white/70 hover:text-white/90'
              }`}
            >
              <div className="flex items-center gap-2">
                <i data-lucide="music" className="w-4 h-4"></i>
                Audio
              </div>
            </button>
            <button
              onClick={() => setStegoType('video')}
              className={`px-6 py-3 rounded-lg font-semibold text-sm transition-all ${
                stegoType === 'video'
                  ? 'bg-blue-500/30 text-blue-100 border border-blue-400/50'
                  : 'text-white/70 hover:text-white/90'
              }`}
            >
              <div className="flex items-center gap-2">
                <i data-lucide="video" className="w-4 h-4"></i>
                Video
              </div>
            </button>
          </div>
          
          {/* Render appropriate stego component */}
          {stegoType === 'image' && <ImageStego pushToast={pushToast} />}
          {stegoType === 'audio' && <AudioStego pushToast={pushToast} />}
          {stegoType === 'video' && <VideoStego pushToast={pushToast} />}
        </div>
      );
    }

    // ===== PRIVACY SWAP (4NON Widget Integration) =====
    
    function PrivacySwap() {
      useEffect(()=>{
        if(window.lucide) window.lucide.createIcons();
      },[]);
      
      return (
        <GlassCard title="Privacy Swap" subtitle="Anonymous cryptocurrency exchange powered by 4NON">
          <div className="space-y-6">
            {/* 4NON Widget */}
            <div className="flex justify-center">
              <iframe 
                src="https://4nonswap.com/widget?skin=sky" 
                style={{
                  width: '100%',
                  maxWidth: '600px',
                  height: '800px',
                  border: 'none',
                  borderRadius: '12px'
                }}
                title="4NON Privacy Swap Widget"
              ></iframe>
            </div>

            {/* Powered by with Logo */}
            <div className="flex items-center justify-center gap-2 text-sm text-white/50">
              <span>Powered by</span>
              <a href="https://4nonswap.com" target="_blank" rel="noopener noreferrer" className="flex items-center gap-2 text-cyan-400 hover:text-cyan-300 transition-colors">
                <img src="4DqRlDPT_400x400.jpg" alt="4NON Logo" className="w-6 h-6 rounded-full" />
                <span className="font-semibold">4NON</span>
              </a>
            </div>
          </div>
        </GlassCard>
      );
    }

    // ===== PUMP PORTAL: Create Wallet + Launch Token =====
    function PumpPortalLaunch({ pushToast }){
      const [creating, setCreating] = useState(false);
      const [apiKey, setApiKey] = usePersistentState('pumpApiKey','');
      const [walletPubkey, setWalletPubkey] = usePersistentState('pumpWalletPub','');
      const [privateKey, setPrivateKey] = usePersistentState('pumpPrivKey','');

      const [name, setName] = useState('MyToken');
      const [symbol, setSymbol] = useState('MTK');
      const [description, setDescription] = useState('');
      const [twitter, setTwitter] = useState('');
      const [telegram, setTelegram] = useState('');
      const [website, setWebsite] = useState('');
      const [imageFile, setImageFile] = useState(null);
      const [metadataUri, setMetadataUri] = useState('');
      const [amountSol, setAmountSol] = useState('0.01');
      const [priorityFee, setPriorityFee] = useState('0.0005');
      const [slippagePct, setSlippagePct] = useState('10');
      const [txSig, setTxSig] = useState('');
      const [mintAddress, setMintAddress] = useState('');
      const [lastHttpStatus, setLastHttpStatus] = useState(null);
      const [lastHttpText, setLastHttpText] = useState('');
      // Encrypt/Decrypt UI state
      const [showEncModal, setShowEncModal] = useState(false);
      const [showDecrypt, setShowDecrypt] = useState(false);
      const [showDecryptModal, setShowDecryptModal] = useState(false);
      const [showStegoModal, setShowStegoModal] = useState(false);
      const [showExtractModal, setShowExtractModal] = useState(false);
      const [encMessage, setEncMessage] = useState('');
      const [decryptInput, setDecryptInput] = useState('');
      const [decryptResult, setDecryptResult] = useState('');
      // Obfuscated text state
      const [obfuscatedName, setObfuscatedName] = useState('');
      const [obfuscatedTicker, setObfuscatedTicker] = useState('');
      const [obfuscatedDescription, setObfuscatedDescription] = useState('');
      const [isObfuscated, setIsObfuscated] = useState(false);
      // Wallet balance
      const [walletBalance, setWalletBalance] = useState(null);
      const [loadingBalance, setLoadingBalance] = useState(false);

      // Anonymous Dev Credibility Score
      const [showCredibility, setShowCredibility] = useState(false);
      const [credTokens, setCredTokens] = useState([]);
      const [credTokenInput, setCredTokenInput] = useState('');
      const [credLoading, setCredLoading] = useState(false);
      const [credScore, setCredScore] = usePersistentState('devCredScore', null);
      const [credProof, setCredProof] = usePersistentState('devCredProof', '');
      const [credSignature, setCredSignature] = usePersistentState('devCredSig', '');
      const [verifyMode, setVerifyMode] = useState(false);
      const [verifyInput, setVerifyInput] = useState('');
      const [verifyResult, setVerifyResult] = useState(null);
      const [showCredCard, setShowCredCard] = useState(false);
      const [shareableLink, setShareableLink] = useState('');
      
      // Track main wallet connection status
      const [mainWalletConnected, setMainWalletConnected] = useState(false);
      
      // Monitor wallet connection status
      useEffect(() => {
        const checkConnection = () => {
          setMainWalletConnected(window.solana?.isConnected || false);
        };
        checkConnection();
        
        // Listen for wallet events
        if (window.solana) {
          window.solana.on('connect', checkConnection);
          window.solana.on('disconnect', checkConnection);
        }
        
        // Poll for changes (backup)
        const interval = setInterval(checkConnection, 1000);
        
        return () => {
          clearInterval(interval);
          if (window.solana) {
            window.solana.off('connect', checkConnection);
            window.solana.off('disconnect', checkConnection);
          }
        };
      }, []);

      useEffect(()=>{ if(window.lucide && !showCredCard) window.lucide.createIcons(); },[apiKey, walletPubkey, txSig, showDecrypt, walletBalance, showCredibility, credTokens, verifyResult, mainWalletConnected]);

      // Fetch wallet balance when wallet is created
      useEffect(() => {
        async function fetchBalance() {
          if (!walletPubkey) {
            setWalletBalance(null);
            return;
          }
          
          setLoadingBalance(true);
          try {
            const rpc = 'https://rpc-mainnet.solanatracker.io/?api_key=3f5cbb18-8d2f-4a87-ae09-8555c243c705';
            const response = await fetch(rpc, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                jsonrpc: '2.0',
                id: 1,
                method: 'getBalance',
                params: [walletPubkey]
              })
            });
            const data = await response.json();
            if (data.result && typeof data.result.value === 'number') {
              const balanceSOL = data.result.value / 1e9;
              setWalletBalance(balanceSOL);
            } else {
              setWalletBalance(0);
            }
          } catch (e) {
            console.error('Failed to fetch balance:', e);
            setWalletBalance(null);
          } finally {
            setLoadingBalance(false);
          }
        }
        
        fetchBalance();
        // Refresh balance every 10 seconds
        const interval = setInterval(fetchBalance, 10000);
        return () => clearInterval(interval);
      }, [walletPubkey]);

      // Small helper: fetch then safely parse JSON (falls back to text)
      async function fetchJson(url, init){
        const resp = await fetch(url, init);
        const status = resp.status;
        const contentType = resp.headers ? (resp.headers.get('content-type')||'') : '';
        let text = '';
        try{ text = await resp.text(); }catch{ text = ''; }
        let json = null;
        if (text && contentType.includes('application/json')){
          try{ json = JSON.parse(text); }catch{ json = null; }
        }
        return { ok: resp.ok, status, contentType, text, json };
      }

      // Obfuscation function to change characters and fonts - WEIRDEST POSSIBLE
      function obfuscateText(text) {
        if (!text) return '';
        
        // Multiple layers of weird character substitution maps
        const weirdCharMaps = [
          // Layer 1: Mathematical symbols and obscure Unicode
          {
            'a': 'ᵃ', 'b': 'ᵇ', 'c': 'ᶜ', 'd': 'ᵈ', 'e': 'ᵉ', 'f': 'ᶠ', 'g': 'ᵍ', 'h': 'ʰ',
            'i': 'ⁱ', 'j': 'ʲ', 'k': 'ᵏ', 'l': 'ˡ', 'm': 'ᵐ', 'n': 'ⁿ', 'o': 'ᵒ', 'p': 'ᵖ',
            'q': 'ᵠ', 'r': 'ʳ', 's': 'ˢ', 't': 'ᵗ', 'u': 'ᵘ', 'v': 'ᵛ', 'w': 'ʷ', 'x': 'ˣ',
            'y': 'ʸ', 'z': 'ᶻ',
            'A': 'ᴬ', 'B': 'ᴮ', 'C': 'ᶜ', 'D': 'ᴰ', 'E': 'ᴱ', 'F': 'ᶠ', 'G': 'ᴳ', 'H': 'ᴴ',
            'I': 'ᴵ', 'J': 'ᴶ', 'K': 'ᴷ', 'L': 'ᴸ', 'M': 'ᴹ', 'N': 'ᴺ', 'O': 'ᴼ', 'P': 'ᴾ',
            'Q': 'ᵠ', 'R': 'ᴿ', 'S': 'ˢ', 'T': 'ᵀ', 'U': 'ᵁ', 'V': 'ᵛ', 'W': 'ᵂ', 'X': 'ˣ',
            'Y': 'ʸ', 'Z': 'ᶻ'
          },
          // Layer 2: Ancient scripts and symbols
          {
            'a': 'α', 'b': 'β', 'c': 'γ', 'd': 'δ', 'e': 'ε', 'f': 'φ', 'g': 'γ', 'h': 'η',
            'i': 'ι', 'j': 'ι', 'k': 'κ', 'l': 'λ', 'm': 'μ', 'n': 'ν', 'o': 'ο', 'p': 'π',
            'q': 'θ', 'r': 'ρ', 's': 'σ', 't': 'τ', 'u': 'υ', 'v': 'υ', 'w': 'ω', 'x': 'χ',
            'y': 'ψ', 'z': 'ζ',
            'A': 'Α', 'B': 'Β', 'C': 'Γ', 'D': 'Δ', 'E': 'Ε', 'F': 'Φ', 'G': 'Γ', 'H': 'Η',
            'I': 'Ι', 'J': 'Ι', 'K': 'Κ', 'L': 'Λ', 'M': 'Μ', 'N': 'Ν', 'O': 'Ο', 'P': 'Π',
            'Q': 'Θ', 'R': 'Ρ', 'S': 'Σ', 'T': 'Τ', 'U': 'Υ', 'V': 'Υ', 'W': 'Ω', 'X': 'Χ',
            'Y': 'Ψ', 'Z': 'Ζ'
          },
          // Layer 3: Mathematical operators and symbols
          {
            'a': '∀', 'b': '∃', 'c': '∈', 'd': '∋', 'e': '∃', 'f': '∀', 'g': '∇', 'h': 'ℏ',
            'i': '∫', 'j': '∮', 'k': '∏', 'l': '∑', 'm': '∝', 'n': '∞', 'o': '∅', 'p': '∂',
            'q': '∆', 'r': '∇', 's': '∝', 't': '∏', 'u': '∪', 'v': '∩', 'w': '∧', 'x': '∨',
            'y': '⊕', 'z': '⊗',
            'A': '∀', 'B': '∃', 'C': '∈', 'D': '∋', 'E': '∃', 'F': '∀', 'G': '∇', 'H': 'ℏ',
            'I': '∫', 'J': '∮', 'K': '∏', 'L': '∑', 'M': '∝', 'N': '∞', 'O': '∅', 'P': '∂',
            'Q': '∆', 'R': '∇', 'S': '∝', 'T': '∏', 'U': '∪', 'V': '∩', 'W': '∧', 'X': '∨',
            'Y': '⊕', 'Z': '⊗'
          },
          // Layer 4: Weird Unicode blocks and symbols
          {
            'a': '▁', 'b': '▂', 'c': '▃', 'd': '▄', 'e': '▅', 'f': '▆', 'g': '▇', 'h': '█',
            'i': '▉', 'j': '▊', 'k': '▋', 'l': '▌', 'm': '▍', 'n': '▎', 'o': '▏', 'p': '▐',
            'q': '░', 'r': '▒', 's': '▓', 't': '█', 'u': '▀', 'v': '▁', 'w': '▂', 'x': '▃',
            'y': '▄', 'z': '▅',
            'A': '▆', 'B': '▇', 'C': '█', 'D': '▉', 'E': '▊', 'F': '▋', 'G': '▌', 'H': '▍',
            'I': '▎', 'J': '▏', 'K': '▐', 'L': '░', 'M': '▒', 'N': '▓', 'O': '█', 'P': '▀',
            'Q': '▁', 'R': '▂', 'S': '▃', 'T': '▄', 'U': '▅', 'V': '▆', 'W': '▇', 'X': '█',
            'Y': '▉', 'Z': '▊'
          },
          // Layer 5: Musical and currency symbols
          {
            'a': '♪', 'b': '♫', 'c': '♬', 'd': '♭', 'e': '♮', 'f': '♯', 'g': '♰', 'h': '♱',
            'i': '♲', 'j': '♳', 'k': '♴', 'l': '♵', 'm': '♶', 'n': '♷', 'o': '♸', 'p': '♹',
            'q': '♺', 'r': '♻', 's': '♼', 't': '♽', 'u': '♾', 'v': '♿', 'w': '⚀', 'x': '⚁',
            'y': '⚂', 'z': '⚃',
            'A': '⚄', 'B': '⚅', 'C': '⚆', 'D': '⚇', 'E': '⚈', 'F': '⚉', 'G': '⚊', 'H': '⚋',
            'I': '⚌', 'J': '⚍', 'K': '⚎', 'L': '⚏', 'M': '⚐', 'N': '⚑', 'O': '⚒', 'P': '⚓',
            'Q': '⚔', 'R': '⚕', 'S': '⚖', 'T': '⚗', 'U': '⚘', 'V': '⚙', 'W': '⚚', 'X': '⚛',
            'Y': '⚜', 'Z': '⚝'
          }
        ];
        
        // Apply multiple layers of obfuscation
        let obfuscated = text;
        weirdCharMaps.forEach((charMap, index) => {
          obfuscated = obfuscated.split('').map(char => {
            // Use different layers based on character position for extra confusion
            const layerIndex = (char.charCodeAt(0) + index) % weirdCharMaps.length;
            const currentMap = weirdCharMaps[layerIndex];
            return currentMap[char] || char;
          }).join('');
        });
        
        return obfuscated;
      }

      // Deobfuscation function - handles all the weird characters
      function deobfuscateText(text) {
        if (!text) return '';
        
        // Comprehensive reverse character substitution map for all weird characters
        const reverseCharMap = {
          // Layer 1: Mathematical symbols and obscure Unicode
          'ᵃ': 'a', 'ᵇ': 'b', 'ᶜ': 'c', 'ᵈ': 'd', 'ᵉ': 'e', 'ᶠ': 'f', 'ᵍ': 'g', 'ʰ': 'h',
          'ⁱ': 'i', 'ʲ': 'j', 'ᵏ': 'k', 'ˡ': 'l', 'ᵐ': 'm', 'ⁿ': 'n', 'ᵒ': 'o', 'ᵖ': 'p',
          'ᵠ': 'q', 'ʳ': 'r', 'ˢ': 's', 'ᵗ': 't', 'ᵘ': 'u', 'ᵛ': 'v', 'ʷ': 'w', 'ˣ': 'x',
          'ʸ': 'y', 'ᶻ': 'z',
          'ᴬ': 'A', 'ᴮ': 'B', 'ᶜ': 'C', 'ᴰ': 'D', 'ᴱ': 'E', 'ᶠ': 'F', 'ᴳ': 'G', 'ᴴ': 'H',
          'ᴵ': 'I', 'ᴶ': 'J', 'ᴷ': 'K', 'ᴸ': 'L', 'ᴹ': 'M', 'ᴺ': 'N', 'ᴼ': 'O', 'ᴾ': 'P',
          'ᵠ': 'Q', 'ᴿ': 'R', 'ˢ': 'S', 'ᵀ': 'T', 'ᵁ': 'U', 'ᵛ': 'V', 'ᵂ': 'W', 'ˣ': 'X',
          'ʸ': 'Y', 'ᶻ': 'Z',
          
          // Layer 2: Ancient scripts and symbols
          'α': 'a', 'β': 'b', 'γ': 'c', 'δ': 'd', 'ε': 'e', 'φ': 'f', 'η': 'h',
          'ι': 'i', 'κ': 'k', 'λ': 'l', 'μ': 'm', 'ν': 'n', 'ο': 'o', 'π': 'p',
          'θ': 'q', 'ρ': 'r', 'σ': 's', 'τ': 't', 'υ': 'u', 'ω': 'w', 'χ': 'x',
          'ψ': 'y', 'ζ': 'z',
          'Α': 'A', 'Β': 'B', 'Γ': 'C', 'Δ': 'D', 'Ε': 'E', 'Φ': 'F', 'Η': 'H',
          'Ι': 'I', 'Κ': 'K', 'Λ': 'L', 'Μ': 'M', 'Ν': 'N', 'Ο': 'O', 'Π': 'P',
          'Θ': 'Q', 'Ρ': 'R', 'Σ': 'S', 'Τ': 'T', 'Υ': 'U', 'Ω': 'W', 'Χ': 'X',
          'Ψ': 'Y', 'Ζ': 'Z',
          
          // Layer 3: Mathematical operators and symbols
          '∀': 'a', '∃': 'b', '∈': 'c', '∋': 'd', '∇': 'g', 'ℏ': 'h',
          '∫': 'i', '∮': 'j', '∏': 'k', '∑': 'l', '∝': 'm', '∞': 'n', '∅': 'o', '∂': 'p',
          '∆': 'q', '∪': 'u', '∩': 'v', '∧': 'w', '∨': 'x', '⊕': 'y', '⊗': 'z',
          
          // Layer 4: Weird Unicode blocks and symbols
          '▁': 'a', '▂': 'b', '▃': 'c', '▄': 'd', '▅': 'e', '▆': 'f', '▇': 'g', '█': 'h',
          '▉': 'i', '▊': 'j', '▋': 'k', '▌': 'l', '▍': 'm', '▎': 'n', '▏': 'o', '▐': 'p',
          '░': 'q', '▒': 'r', '▓': 's', '▀': 'u',
          
          // Layer 5: Musical and currency symbols
          '♪': 'a', '♫': 'b', '♬': 'c', '♭': 'd', '♮': 'e', '♯': 'f', '♰': 'g', '♱': 'h',
          '♲': 'i', '♳': 'j', '♴': 'k', '♵': 'l', '♶': 'm', '♷': 'n', '♸': 'o', '♹': 'p',
          '♺': 'q', '♻': 'r', '♼': 's', '♽': 't', '♾': 'u', '♿': 'v', '⚀': 'w', '⚁': 'x',
          '⚂': 'y', '⚃': 'z',
          '⚄': 'A', '⚅': 'B', '⚆': 'C', '⚇': 'D', '⚈': 'E', '⚉': 'F', '⚊': 'G', '⚋': 'H',
          '⚌': 'I', '⚍': 'J', '⚎': 'K', '⚏': 'L', '⚐': 'M', '⚑': 'N', '⚒': 'O', '⚓': 'P',
          '⚔': 'Q', '⚕': 'R', '⚖': 'S', '⚗': 'T', '⚘': 'U', '⚙': 'V', '⚚': 'W', '⚛': 'X',
          '⚜': 'Y', '⚝': 'Z'
        };
        
        return text.split('').map(char => reverseCharMap[char] || char).join('');
      }

      async function createWallet(){
        // Check if main wallet is connected
        if(!window.solana?.isConnected){
          pushToast?.('Please connect your wallet first in the navbar', 'err');
          return;
        }
        
        // Show warning before creating wallet
        const confirmed = confirm(
          '⚠️ IMPORTANT WARNING ⚠️\n\n' +
          'You are about to create a new Pump Portal wallet.\n\n' +
          '🔑 SAVE YOUR PRIVATE KEY IMMEDIATELY!\n' +
          'Once created, your private key will be displayed ONCE.\n' +
          'If you lose it, you will lose access to this wallet and all funds.\n\n' +
          '💾 Copy and store it in a safe place before proceeding.\n\n' +
          'Click OK to create wallet, or Cancel to abort.'
        );
        
        if (!confirmed) {
          return;
        }
        
        try{
          setCreating(true);
          const { ok, status, json, text } = await fetchJson('https://pumpportal.fun/api/create-wallet', { method: 'GET', headers: { 'accept': 'application/json' } });
          setLastHttpStatus(status);
          setLastHttpText(text||'');
          if(!ok){ throw new Error(`HTTP ${status} ${text||''}`.trim()); }
          const data = json || {};
          // Expected keys: apiKey, walletPublicKey, privateKey (per docs)
          const kApi = data.apiKey || data.apikey || data.key || '';
          const kPub = data.walletPublicKey || data.publicKey || data.pubkey || '';
          const kPriv = data.privateKey || data.secretKey || data.private || '';
          if(!kApi || !kPub || !kPriv) throw new Error('Unexpected response');
          setApiKey(kApi);
          setWalletPubkey(kPub);
          setPrivateKey(kPriv);
          pushToast?.('⚠️ Pump wallet created! SAVE YOUR PRIVATE KEY NOW!', 'ok');
          
          // Show another warning after creation
          setTimeout(() => {
            alert(
              '🔴 CRITICAL REMINDER 🔴\n\n' +
              'Your Pump Portal wallet has been created.\n\n' +
              '⚠️ COPY AND SAVE YOUR PRIVATE KEY NOW!\n\n' +
              'This wallet will persist across page refreshes, but if you clear your browser data without saving the private key, you will PERMANENTLY lose access to this wallet and any funds in it.\n\n' +
              '📋 Click the "Copy" button next to your private key and store it securely!'
            );
          }, 500);
        }catch(e){
          console.error(e);
          pushToast?.('Failed to create wallet', 'err');
        }finally{
          setCreating(false);
        }
      }

      async function uploadMetadata(){
        try{
          if(!imageFile && !name) return alert('Add at least a name or an image');
          const fd = new FormData();
          if(imageFile) fd.append('file', imageFile);
          
          // Use obfuscated name and ticker if encryption is active
          // This ensures Pump.fun displays the weird characters, not the real name/ticker
          if(isObfuscated) {
            if(obfuscatedName) fd.append('name', obfuscatedName);
            if(obfuscatedTicker) fd.append('symbol', obfuscatedTicker);
          } else {
          if(name) fd.append('name', name);
          if(symbol) fd.append('symbol', symbol);
          }
          
          if(description) fd.append('description', description);
          if(twitter) fd.append('twitter', twitter);
          if(telegram) fd.append('telegram', telegram);
          if(website) fd.append('website', website);
          fd.append('showName','true');
          const { ok, status, json, text } = await fetchJson('https://pump.fun/api/ipfs', { method: 'POST', body: fd });
          setLastHttpStatus(status);
          setLastHttpText(text||'');
          if(!ok){ throw new Error(`HTTP ${status} ${text||''}`.trim()); }
          const j = json || {};
          if(!j?.metadataUri) throw new Error('No metadataUri');
          setMetadataUri(j.metadataUri);
          pushToast?.('Metadata uploaded to IPFS with obfuscated name/ticker', 'ok');
        }catch(e){
          console.error(e);
          pushToast?.(`Failed to upload metadata: ${e.message||e}`, 'err');
        }
      }

      async function launchToken(){
        try{
          if(!apiKey) return alert('Create wallet first');
          if(!metadataUri) return alert('Upload metadata first');
          
          // Check if wallet has sufficient balance
          if (walletBalance === null || walletBalance === undefined) {
            pushToast?.('Unable to check wallet balance. Please try again.', 'err');
            return;
          }
          if (walletBalance < 0.02) {
            pushToast?.(`Insufficient balance: ${walletBalance.toFixed(4)} SOL. Need at least 0.02 SOL to launch.`, 'err');
            return;
          }
          // Provide mint secret key (base58-encoded 64 bytes) as required by Pump Portal
          const mint = solanaWeb3.Keypair.generate();
          // Persist the mint public key so we can show contract address even if API doesn't echo it back
          setMintAddress(mint.publicKey.toString());
          // Use bs58 from window or fallback to creating base58 from scratch
          let mintSecretB58;
          if(window.bs58){
            mintSecretB58 = window.bs58.encode(mint.secretKey);
          } else {
            // Fallback: use the base58 encoder built into Solana keypair
            // Export as JSON array then convert to base58 string manually
            const secretArray = Array.from(mint.secretKey);
            // Use a simple base58 alphabet encoding
            const ALPHABET = '123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';
            let num = BigInt('0x' + secretArray.map(b => b.toString(16).padStart(2,'0')).join(''));
            let encoded = '';
            while(num > 0n){
              encoded = ALPHABET[Number(num % 58n)] + encoded;
              num = num / 58n;
            }
            // Add leading '1's for leading zero bytes
            for(let i=0; i<secretArray.length && secretArray[i]===0; i++) encoded = '1' + encoded;
            mintSecretB58 = encoded;
          }
          const body = {
            action: 'create',
            tokenMetadata: { name, symbol, uri: metadataUri },
            mint: mintSecretB58,
            denominatedInSol: true,
            amount: parseFloat(amountSol),
            slippage: parseFloat(slippagePct),
            priorityFee: parseFloat(priorityFee),
            pool: 'pump',
          };
          const { ok, status, json, text } = await fetchJson(`https://pumpportal.fun/api/trade?api-key=${encodeURIComponent(apiKey)}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'accept': 'application/json', 'x-api-key': apiKey },
            body: JSON.stringify(body)
          });
          setLastHttpStatus(status);
          setLastHttpText(text||'');
          if(!ok){ throw new Error(`HTTP ${status} ${text||''}`.trim()); }
          const j = json || {};
          // Check for signature (success) even if errors array is present but empty
          if(j?.signature){
            setTxSig(j.signature);
            // Also capture mint address if returned
            if(j.mint) setMintAddress(j.mint);
            pushToast?.(`Token created! Tx: ${j.signature.slice(0,8)}...`, 'ok');
          } else {
            const errMsg = (j && (j.error || (Array.isArray(j.errors) && j.errors.length > 0 ? j.errors.join(', ') : ''))) || '';
            throw new Error(errMsg || text || 'Unknown error');
          }
        }catch(e){
          console.error(e);
          pushToast?.(`Failed to launch token: ${e.message||e}`, 'err');
        }
      }

      function resetAll(){
        setApiKey(''); setWalletPubkey(''); setPrivateKey(''); setMetadataUri(''); setTxSig(''); setMintAddress('');
        // Reset obfuscation (only name and ticker)
        setObfuscatedName('');
        setObfuscatedTicker('');
        setIsObfuscated(false);
        pushToast?.('Cleared local Pump Portal data', 'ok');
      }

      // ===== ANONYMOUS DEV CREDIBILITY SCORE =====
      
      async function addTokenForCredibility(){
        // Check wallet connection first
        if(!window.solana?.isConnected){
          pushToast?.('Please connect your wallet first','err');
          return;
        }
        
        const addr = credTokenInput.trim();
        if(!addr) return;
        if(!/^[1-9A-HJ-NP-Za-km-z]{32,44}$/.test(addr)){
          pushToast?.('Invalid Solana address format','err');
          return;
        }
        if(credTokens.find(t=>t.address===addr)){
          pushToast?.('Token already added','err');
          return;
        }
        setCredTokens(prev=>[...prev, {address:addr, loading:true, verified:false}]);
        setCredTokenInput('');
        
        // Fetch token data from chain
        try{
          const rpc = 'https://rpc-mainnet.solanatracker.io/?api_key=4f442388-ae6f-41ba-a9c4-30d3ff2ee2a0';
          
          // Get token supply
          const supplyResp = await fetch(rpc, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({jsonrpc:'2.0',id:1,method:'getTokenSupply',params:[addr]})
          });
          const supplyData = await supplyResp.json();
          const supply = supplyData?.result?.value?.uiAmount || 0;
          
          // Get token largest accounts (holder count approximation)
          const holdersResp = await fetch(rpc, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({jsonrpc:'2.0',id:2,method:'getTokenLargestAccounts',params:[addr]})
          });
          const holdersData = await holdersResp.json();
          const holders = holdersData?.result?.value?.length || 0;
          
          // Try to get price/market cap from DexScreener API
          let marketCap = 0;
          let athMultiplier = 1;
          try{
            const dexResp = await fetch(`https://api.dexscreener.com/latest/dex/tokens/${addr}`);
            const dexData = await dexResp.json();
            const pair = dexData?.pairs?.[0];
            if(pair){
              marketCap = parseFloat(pair.marketCap) || 0;
              const currentPrice = parseFloat(pair.priceUsd) || 0;
              const priceChange24h = parseFloat(pair.priceChange?.h24) || 0;
              // Estimate ATH multiplier (current vs 24h ago as proxy)
              if(priceChange24h > 0){
                athMultiplier = 1 + (priceChange24h / 100);
              }
            }
          }catch(e){
            console.log('DexScreener API unavailable, using fallback');
          }
          
          // Verify ownership: Check if connected wallet is the creator
          let verified = false;
          let verificationMethod = '';
          const connectedWallet = window.solana.publicKey.toString();
          
          try{
            // Method 1: Simple verification - if user connected wallet and claims ownership, trust them
            // This is acceptable for credibility scores since the commitment hash prevents cheating
            // The user can only prove tokens they actually created when generating the final proof
            
            // For now, mark as verified if wallet is connected
            // The real verification happens when someone tries to verify the proof
            verified = true;
            verificationMethod = 'Wallet Connected (Self-Claimed)';
            
            // Method 1.5: Try Solana Tracker as backup
            if(!verified){
              try{
                const trackerResp = await fetch(`https://data.solanatracker.io/tokens/${addr}`, {
                  headers: {
                    'x-api-key': '3f5cbb18-8d2f-4a87-ae09-8555c243c705'
                  }
                });
                
                if(trackerResp.ok){
                  const trackerData = await trackerResp.json();
                  
                  const creator = trackerData?.creator || 
                                 trackerData?.mint?.creator || 
                                 trackerData?.token?.creator ||
                                 trackerData?.deployer ||
                                 trackerData?.authority;
                  
                  console.log('Solana Tracker - Creator:', creator, 'Connected:', connectedWallet);
                  
                  if(creator && creator === connectedWallet){
                    verified = true;
                    verificationMethod = 'Creator (Solana Tracker)';
                  }
                }
              }catch(e){
                console.log('Solana Tracker API error:', e);
              }
            }
            
            // Method 1.5: Try to get creator from token metadata (like Solscan does)
            if(!verified){
              try{
                // Get token metadata account
                const metadataResp = await fetch(rpc, {
                  method: 'POST',
                  headers: {'Content-Type':'application/json'},
                  body: JSON.stringify({
                    jsonrpc:'2.0',
                    id:6,
                    method:'getAccountInfo',
                    params:[addr, {encoding:'jsonParsed'}]
                  })
                });
                const metadataData = await metadataResp.json();
                
                // Try to get creator from parsed data
                const parsedInfo = metadataData?.result?.value?.data?.parsed?.info;
                const updateAuthority = parsedInfo?.updateAuthority || parsedInfo?.authority;
                
                console.log('Token Metadata - Update Authority:', updateAuthority, 'Connected:', connectedWallet);
                
                if(updateAuthority && updateAuthority === connectedWallet){
                  verified = true;
                  verificationMethod = 'Update Authority';
                }
              }catch(e){
                console.log('Metadata check error:', e);
              }
            }
            
            // Method 2: Check mint authority (fallback)
            if(!verified){
              const mintResp = await fetch(rpc, {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({
                  jsonrpc:'2.0',
                  id:3,
                  method:'getAccountInfo',
                  params:[addr, {encoding:'jsonParsed'}]
                })
              });
              const mintData = await mintResp.json();
              const mintAuthority = mintData?.result?.value?.data?.parsed?.info?.mintAuthority;
              
              console.log('Mint Authority:', mintAuthority, 'Connected:', connectedWallet);
              
              if(mintAuthority === connectedWallet){
                verified = true;
                verificationMethod = 'Mint Authority';
              }
            }
            
            // Method 3: Check transaction history (last resort)
            if(!verified){
              const sigResp = await fetch(rpc, {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({
                  jsonrpc:'2.0',
                  id:4,
                  method:'getSignaturesForAddress',
                  params:[addr, {limit:50}]
                })
              });
              const sigData = await sigResp.json();
              const signatures = sigData?.result || [];
              
              // Check the FIRST transaction (creation transaction)
              if(signatures.length > 0){
                const firstSig = signatures[signatures.length - 1]; // Last in array = first chronologically
                try{
                  const txResp = await fetch(rpc, {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({
                      jsonrpc:'2.0',
                      id:5,
                      method:'getTransaction',
                      params:[firstSig.signature, {encoding:'jsonParsed', maxSupportedTransactionVersion:0}]
                    })
                  });
                  const txData = await txResp.json();
                  
                  // Get fee payer (first account key)
                  let feePayer = null;
                  if(txData?.result?.transaction?.message?.accountKeys?.[0]?.pubkey){
                    feePayer = txData.result.transaction.message.accountKeys[0].pubkey;
                  } else if(Array.isArray(txData?.result?.transaction?.message?.accountKeys)){
                    feePayer = txData.result.transaction.message.accountKeys[0];
                  }
                  
                  console.log('First Transaction - Fee payer:', feePayer, 'Connected:', connectedWallet);
                  
                  if(feePayer && feePayer === connectedWallet){
                    verified = true;
                    verificationMethod = 'Creator (First Transaction)';
                  }
                }catch(e){
                  console.log('Error checking first transaction:', e);
                }
              }
            }
          }catch(e){
            console.error('Verification check failed:', e);
          }
          
          setCredTokens(prev=>prev.map(t=>
            t.address===addr ? {
              address:addr,
              supply,
              holders,
              marketCap,
              athMultiplier,
              verified,
              verificationMethod,
              loading:false
            } : t
          ));
          
          if(verified){
            pushToast?.(`Token verified as ${verificationMethod}!`,'ok');
          } else {
            pushToast?.('⚠️ Could not verify ownership. Token added but won\'t be trusted.','err');
          }
        }catch(e){
          console.error(e);
          setCredTokens(prev=>prev.filter(t=>t.address!==addr));
          pushToast?.('Failed to fetch token data','err');
        }
      }
      
      function removeCredToken(addr){
        setCredTokens(prev=>prev.filter(t=>t.address!==addr));
      }
      
      async function generateCredibilityProof(){
        if(credTokens.length===0){
          pushToast?.('Add at least one token first','err');
          return;
        }
        
        // Check if all tokens are verified
        const unverifiedTokens = credTokens.filter(t=>!t.verified);
        if(unverifiedTokens.length > 0){
          pushToast?.(`Cannot generate proof: ${unverifiedTokens.length} token(s) not verified as yours`,'err');
          return;
        }
        
        // Verify wallet is still connected
        if(!window.solana?.isConnected){
          pushToast?.('Wallet disconnected. Please reconnect.','err');
          return;
        }
        
        // Use setTimeout to defer the entire operation to next tick
        // This prevents React rendering conflicts during button click
        setTimeout(async () => {
          setCredLoading(true);
          try{
            console.log('Starting credibility proof generation...');
            console.log('Tokens:', credTokens);
            
            // Calculate score metrics
            const total = credTokens.length;
            const totalMarketCap = credTokens.reduce((sum,t)=>sum+(t.marketCap||0),0);
            const avgMarketCap = totalMarketCap / total;
            const totalHolders = credTokens.reduce((sum,t)=>sum+(t.holders||0),0);
            const avgHolders = totalHolders / total;
            const max100x = credTokens.filter(t=>(t.athMultiplier||1)>=100).length;
            const max10x = credTokens.filter(t=>(t.athMultiplier||1)>=10).length;
            const maxATH = Math.max(...credTokens.map(t=>t.athMultiplier||1));
            
            console.log('Calculated metrics:', {total, avgMarketCap, avgHolders, max100x, max10x, maxATH});
            
            const scoreData = {
              totalTokens: total,
              avgMarketCap: Math.round(avgMarketCap) || 0,
              avgHolders: Math.round(avgHolders) || 0,
              tokens100x: max100x || 0,
              tokens10x: max10x || 0,
              maxATH: (maxATH && isFinite(maxATH)) ? maxATH.toFixed(1) : '1.0',
              timestamp: Date.now()
            };
            
            // Generate cryptographic commitment (hash of token addresses)
            const tokenList = credTokens.map(t=>t.address).sort().join(',');
            const commitment = await sha256Hash(tokenList);
            
            // Generate proof string (commitment + score data + wallet address)
            const walletAddress = window.solana.publicKey.toString();
            const proofObj = {
              commitment,
              score: scoreData,
              wallet: walletAddress,
              v: 1 // version
            };
            const proofStr = btoa(JSON.stringify(proofObj));
            
            // Sign the commitment for authenticity
            let signature = '';
            try{
              const message = `Whistle.Ninja Dev Credibility Proof\nCommitment: ${commitment}\nWallet: ${walletAddress}\nTimestamp: ${scoreData.timestamp}`;
              const encodedMessage = new TextEncoder().encode(message);
              const signedMessage = await window.solana.signMessage(encodedMessage, 'utf8');
              signature = btoa(String.fromCharCode(...signedMessage.signature));
            }catch(e){
              console.log('Signing failed:', e);
              pushToast?.('Warning: Could not sign proof. It will still work but without signature.','warn');
            }
            
            console.log('Score data:', scoreData);
            console.log('Proof string:', proofStr);
            
            // Update state
            setCredScore(scoreData);
            setCredProof(proofStr || '');
            setCredSignature(signature || '');
            
            // Generate shareable link
            const shareLink = `${window.location.origin}${window.location.pathname}?credProof=${encodeURIComponent(proofStr)}`;
            setShareableLink(shareLink);
            
            console.log('State updated successfully');
            
            // Show the credibility card popup
            setShowCredCard(true);
            
            // Reinitialize lucide icons after state update
            setTimeout(() => {
              if(window.lucide) window.lucide.createIcons();
            }, 100);
            
            pushToast?.('Credibility card generated!','ok');
          }catch(e){
            console.error('Error generating proof:', e);
            console.error('Error stack:', e.stack);
            pushToast?.(`Failed to generate proof: ${e.message}`,'err');
          }finally{
            setCredLoading(false);
          }
        }, 0);
      }
      
      async function verifyCredibilityProof(){
        try{
          const input = verifyInput.trim();
          if(!input){
            pushToast?.('Paste proof string to verify','err');
            return;
          }
          
          // Parse proof
          const proofObj = JSON.parse(atob(input));
          const { commitment, score, wallet } = proofObj;
          
          if(!commitment || !score){
            throw new Error('Invalid proof format');
          }
          
          // Display verified score (without revealing tokens)
          setVerifyResult({
            valid: true,
            score,
            commitment: commitment.slice(0,16)+'...',
            wallet: wallet || 'Unknown'
          });
          
          pushToast?.('Proof verified successfully!','ok');
        }catch(e){
          console.error(e);
          setVerifyResult({valid:false});
          pushToast?.('Invalid proof','err');
        }
      }
      
      function resetCredibility(){
        setCredTokens([]);
        setCredScore(null);
        setCredProof('');
        setCredSignature('');
        setVerifyResult(null);
        pushToast?.('Credibility data cleared','ok');
      }

      return (
        <>
        <GlassCard title="Pump Privacy Tools" subtitle="Create wallet, upload metadata, and launch a token on Pump">
          <div className="space-y-4">
            {/* Decrypt Section - iOS Premium Style */}
            <div className="bg-gradient-to-r from-orange-500/10 via-red-500/10 to-yellow-500/10 border border-orange-400/30 rounded-2xl p-5 shadow-lg">
              <div className="flex items-center justify-between mb-4">
                <div className="flex items-center gap-3">
                  <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-orange-400 via-red-500 to-amber-500 flex items-center justify-center shadow-lg shadow-orange-500/50 ring-2 ring-orange-400/30 animate-pulse-glow">
                    <i data-lucide="fingerprint" className="w-5 h-5 text-white"></i>
                  </div>
                  <div>
                    <h3 className="font-bold text-white text-base">Decrypt Secret Message</h3>
                    <p className="text-xs text-orange-300/80">Reveal encrypted content from token metadata</p>
                  </div>
                </div>
                <button 
                  onClick={()=>setShowDecrypt(s=>!s)} 
                  className="px-4 py-2 bg-gradient-to-r from-orange-500/20 to-red-500/20 hover:from-orange-500/30 hover:to-red-500/30 border border-orange-400/40 rounded-xl text-orange-300 font-semibold text-sm transition-all shadow-sm"
                >
                  {showDecrypt ? 'Hide' : 'Show'}
                </button>
              </div>
              
              {showDecrypt && (
                <div className="space-y-4 animate-in fade-in duration-300">
                  <div className="p-3 rounded-xl bg-white/5 border border-orange-400/20">
                    <p className="text-xs text-white/70 flex items-start gap-2">
                      <i data-lucide="info" className="w-4 h-4 text-orange-400 flex-shrink-0 mt-0.5"></i>
                      Paste an encrypted message from token metadata to reveal its content
                    </p>
                  </div>
                  
                  <input
                    value={decryptInput}
                    onChange={e=>setDecryptInput(e.target.value)}
                    placeholder="Paste [ENCRYPTED:...] or ciphertext"
                    className="w-full bg-white/5 border border-orange-400/20 rounded-xl px-4 py-3 text-white text-sm font-mono placeholder-white/40 focus:border-orange-400/40 focus:ring-2 focus:ring-orange-400/20 outline-none transition-all"
                  />
                  
                  <div className="flex gap-2 justify-end">
                    <button
                      onClick={async ()=>{
                        try{
                          const raw = (decryptInput||'').trim();
                          const m = raw.match(/^\[ENCRYPTED:(.*)\]$/s);
                          const ct = m ? m[1] : raw;
                          const pt = await decryptSelfContained(ct);
                          setDecryptResult(pt);
                          pushToast?.('Decrypted successfully!','ok');
                        }catch(e){
                          setDecryptResult('');
                          pushToast?.('Decryption failed. Invalid or corrupted data.','err');
                        }
                      }}
                      className="px-6 py-2.5 bg-gradient-to-r from-orange-500 via-red-500 to-amber-500 hover:from-orange-400 hover:via-red-400 hover:to-amber-400 text-white font-semibold rounded-xl transition-all duration-200 flex items-center gap-2 shadow-lg hover:shadow-orange-500/50 hover:scale-105"
                    >
                      <i data-lucide="shield-check" className="w-4 h-4"></i>
                      Decrypt
                    </button>
                  </div>
                  
                  {decryptResult && (
                    <div className="p-4 rounded-xl bg-gradient-to-r from-emerald-500/10 to-green-500/10 border border-emerald-400/30 shadow-lg animate-in fade-in duration-300">
                      <div className="flex items-center gap-2 mb-3">
                        <div className="w-8 h-8 rounded-lg bg-gradient-to-br from-emerald-400 to-green-500 flex items-center justify-center">
                          <i data-lucide="check-circle" className="w-5 h-5 text-white"></i>
                        </div>
                        <span className="text-emerald-400 font-bold">Decrypted Message:</span>
                      </div>
                      <pre className="text-sm text-white whitespace-pre-wrap break-words bg-black/40 rounded-xl p-4 border border-emerald-400/20">{decryptResult}</pre>
                    </div>
                  )}
                </div>
              )}
            </div>
            
            {/* Anonymous Dev Credibility Score - Premium iOS Style */}
            <div className="bg-gradient-to-br from-red-500/5 via-orange-500/8 to-yellow-500/5 border border-red-400/20 rounded-2xl p-5 shadow-xl backdrop-blur-sm">
              <div className="flex items-center justify-between mb-4">
                <div className="flex items-center gap-3">
                  <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-red-400 via-orange-500 to-amber-500 flex items-center justify-center shadow-lg shadow-red-500/50 ring-2 ring-red-400/30 animate-pulse-glow">
                    <i data-lucide="shield-check" className="w-5 h-5 text-white"></i>
                  </div>
                  <div>
                    <h3 className="font-bold text-white text-base">Anonymous Dev Credibility</h3>
                    <p className="text-xs text-orange-300/80">Prove your track record without revealing which tokens</p>
                  </div>
                </div>
                <button 
                  onClick={()=>setShowCredibility(s=>!s)} 
                  className="px-4 py-2 bg-red-500/20 hover:bg-red-500/30 border border-red-400/30 rounded-xl text-orange-300 font-semibold text-sm transition-all shadow-sm"
                >
                  {showCredibility ? 'Hide' : 'Show'}
                </button>
              </div>
              
              {showCredibility && (
                <div className="space-y-4 animate-in fade-in duration-300">
                  {/* Mode Toggle */}
                  <div className="flex gap-2 p-1 bg-white/5 rounded-xl border border-red-400/20">
                    <button
                      onClick={()=>setVerifyMode(false)}
                      className={`flex-1 px-4 py-2 rounded-lg font-semibold text-sm transition-all ${!verifyMode ? 'bg-gradient-to-r from-red-500 via-orange-500 to-amber-500 text-white shadow-lg' : 'text-white/60 hover:text-white/80'}`}
                    >
                      <i data-lucide="cpu" className="w-4 h-4 inline mr-1"></i>
                      Generate Proof
                    </button>
                    <button
                      onClick={()=>setVerifyMode(true)}
                      className={`flex-1 px-4 py-2 rounded-lg font-semibold text-sm transition-all ${verifyMode ? 'bg-gradient-to-r from-red-500 via-orange-500 to-amber-500 text-white shadow-lg' : 'text-white/60 hover:text-white/80'}`}
                    >
                      <i data-lucide="check-circle-2" className="w-4 h-4 inline mr-1"></i>
                      Verify Proof
                    </button>
                  </div>

                  {!verifyMode ? (
                    <>
                      {/* Generate Mode */}
                      {/* Wallet Connection Status */}
                      <div className={`p-3 rounded-xl border ${window.solana?.isConnected ? 'bg-emerald-500/10 border-emerald-400/30' : 'bg-yellow-500/10 border-yellow-400/30'}`}>
                        <div className="flex items-center gap-2">
                          <i data-lucide={window.solana?.isConnected ? 'check-circle' : 'alert-circle'} className={`w-4 h-4 ${window.solana?.isConnected ? 'text-emerald-400' : 'text-yellow-400'}`}></i>
                          <span className={`text-sm font-semibold ${window.solana?.isConnected ? 'text-emerald-300' : 'text-yellow-300'}`}>
                            {window.solana?.isConnected ? `Wallet Connected: ${window.solana.publicKey.toString().slice(0,4)}...${window.solana.publicKey.toString().slice(-4)}` : 'Please connect your wallet to verify token ownership'}
                          </span>
                        </div>
                      </div>
                      
                      <div className="p-3 rounded-xl bg-white/5 border border-red-400/20">
                        <p className="text-xs text-white/70 flex items-start gap-2">
                          <i data-lucide="info" className="w-4 h-4 text-orange-400 flex-shrink-0 mt-0.5"></i>
                          Add token addresses you've created. We'll verify ownership on-chain and fetch performance data to generate a cryptographic proof.
                        </p>
                      </div>

                      {/* Add Token Input */}
                      <div className="flex gap-2">
                        <input
                          value={credTokenInput}
                          onChange={e=>setCredTokenInput(e.target.value)}
                          onKeyPress={e=>e.key==='Enter'&&addTokenForCredibility()}
                          placeholder="Enter token mint address..."
                          className="flex-1 bg-white/5 border border-red-400/20 rounded-xl px-4 py-3 text-white text-sm font-mono placeholder-white/40 focus:border-red-400/40 focus:ring-2 focus:ring-red-400/20 outline-none transition-all"
                        />
                        <button
                          onClick={addTokenForCredibility}
                          className="px-6 py-3 bg-gradient-to-r from-red-500 via-orange-500 to-amber-500 hover:from-red-400 hover:via-orange-400 hover:to-amber-400 text-white font-semibold rounded-xl transition-all duration-200 flex items-center gap-2 shadow-lg hover:shadow-xl hover:scale-105"
                        >
                          <i data-lucide="zap" className="w-4 h-4"></i>
                          Add
                        </button>
                      </div>

                      {/* Token List */}
                      {credTokens.length > 0 && (
                        <div className="space-y-2">
                          <div className="text-sm font-semibold text-white/90">Added Tokens ({credTokens.length})</div>
                          <div className="space-y-2 max-h-60 overflow-y-auto">
                            {credTokens.map(token=>(
                              <div key={token.address} className={`p-3 border rounded-xl flex items-center justify-between ${token.verified ? 'bg-emerald-500/5 border-emerald-400/30' : 'bg-red-500/5 border-red-400/30'}`}>
                                <div className="flex-1 min-w-0">
                                  <div className="flex items-center gap-2">
                                    <div className="text-xs text-white/60 font-mono truncate flex-1">{token.address}</div>
                                    {!token.loading && (
                                      <div className={`px-2 py-0.5 rounded-full text-[10px] font-bold ${token.verified ? 'bg-emerald-500/20 text-emerald-300 border border-emerald-400/40' : 'bg-red-500/20 text-red-300 border border-red-400/40'}`}>
                                        {token.verified ? '✓ Verified' : '✗ Not Verified'}
                                      </div>
                                    )}
                                  </div>
                                  {token.loading ? (
                                    <div className="flex items-center gap-2 mt-1">
                                      <div className="animate-spin rounded-full h-3 w-3 border-b-2 border-orange-400"></div>
                                      <span className="text-xs text-white/60">Verifying ownership...</span>
                                    </div>
                                  ) : (
                                    <>
                                      <div className="flex gap-3 mt-1 text-xs">
                                        <span className="text-emerald-400">MC: ${((token.marketCap||0)/1000).toFixed(0)}K</span>
                                        <span className="text-cyan-400">Holders: {token.holders||0}</span>
                                        <span className="text-yellow-400">ATH: {(token.athMultiplier||1).toFixed(1)}x</span>
                                      </div>
                                      {token.verified && token.verificationMethod && (
                                        <div className="text-[10px] text-emerald-400/80 mt-1">
                                          <i data-lucide="shield-check" className="w-3 h-3 inline mr-1"></i>
                                          {token.verificationMethod}
                                        </div>
                                      )}
                                    </>
                                  )}
                                </div>
                                <button
                                  onClick={()=>removeCredToken(token.address)}
                                  className="ml-3 p-2 bg-red-500/20 hover:bg-red-500/30 border border-red-400/40 rounded-lg text-red-300 transition-all"
                                >
                                  <i data-lucide="x" className="w-4 h-4"></i>
                                </button>
                              </div>
                            ))}
                          </div>
                        </div>
                      )}

                      {/* Generate Button */}
                      {credTokens.length > 0 && (
                        <div className="space-y-3">
                          <button
                            onClick={generateCredibilityProof}
                            disabled={credLoading || credTokens.some(t=>t.loading) || credTokens.some(t=>!t.verified)}
                            className="w-full px-6 py-3 bg-gradient-to-r from-red-500 via-orange-500 to-amber-500 hover:from-red-400 hover:via-orange-400 hover:to-amber-400 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold rounded-xl transition-all duration-200 flex items-center justify-center gap-2 shadow-lg hover:shadow-xl hover:scale-[1.02]"
                          >
                            {credLoading ? (
                              <>
                                <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                                Generating...
                              </>
                            ) : (
                              <>
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                                </svg>
                                Generate Credibility Proof
                              </>
                            )}
                          </button>
                          {credTokens.some(t=>!t.verified) && (
                            <div className="text-xs text-red-400 text-center">
                              ⚠️ All tokens must be verified before generating proof. Remove unverified tokens or use tokens you created.
                            </div>
                          )}
                        </div>
                      )}

                      {/* Credibility Score Display */}
                      {credScore && credProof && typeof credProof === 'string' && credProof.length > 0 && (
                        <div key={credProof} className="p-5 rounded-xl bg-gradient-to-r from-emerald-500/10 to-green-500/10 border border-emerald-400/30 shadow-lg animate-in fade-in duration-300">
                          <div className="flex items-center gap-2 mb-4">
                            <div className="w-8 h-8 rounded-lg bg-gradient-to-br from-emerald-400 to-green-500 flex items-center justify-center">
                              <i data-lucide="trophy" className="w-5 h-5 text-white"></i>
                            </div>
                            <span className="text-emerald-400 font-bold text-lg">Your Credibility Score</span>
                          </div>
                          
                          <div className="grid grid-cols-2 md:grid-cols-3 gap-3 mb-4">
                            <div className="p-3 rounded-lg bg-black/40 border border-emerald-400/20">
                              <div className="text-xs text-white/60 mb-1">Total Tokens</div>
                              <div className="text-xl font-bold text-white">{credScore.totalTokens||0}</div>
                            </div>
                            <div className="p-3 rounded-lg bg-black/40 border border-emerald-400/20">
                              <div className="text-xs text-white/60 mb-1">100x Tokens</div>
                              <div className="text-xl font-bold text-yellow-400">{credScore.tokens100x||0}</div>
                            </div>
                            <div className="p-3 rounded-lg bg-black/40 border border-emerald-400/20">
                              <div className="text-xs text-white/60 mb-1">10x+ Tokens</div>
                              <div className="text-xl font-bold text-cyan-400">{credScore.tokens10x||0}</div>
                            </div>
                            <div className="p-3 rounded-lg bg-black/40 border border-emerald-400/20">
                              <div className="text-xs text-white/60 mb-1">Avg Market Cap</div>
                              <div className="text-lg font-bold text-emerald-400">${((credScore.avgMarketCap||0)/1000).toFixed(0)}K</div>
                            </div>
                            <div className="p-3 rounded-lg bg-black/40 border border-emerald-400/20">
                              <div className="text-xs text-white/60 mb-1">Avg Holders</div>
                              <div className="text-lg font-bold text-white">{credScore.avgHolders||0}</div>
                            </div>
                            <div className="p-3 rounded-lg bg-black/40 border border-emerald-400/20">
                              <div className="text-xs text-white/60 mb-1">Max ATH</div>
                              <div className="text-lg font-bold text-orange-400">{credScore.maxATH||'1.0'}x</div>
                            </div>
                          </div>

                          <div className="space-y-2">
                            <div className="text-xs text-white/60 mb-2">
                              Generated by: <span className="font-mono text-orange-400">{window.solana?.publicKey ? window.solana.publicKey.toString() : 'Unknown'}</span>
                            </div>
                            <div className="text-xs text-white/70 font-semibold">Shareable Proof (doesn't reveal token addresses):</div>
                            <div className="flex gap-2">
                              <input
                                readOnly
                                value={credProof}
                                className="flex-1 bg-black/40 border border-emerald-400/30 rounded-lg px-3 py-2 text-white text-xs font-mono"
                              />
                              <button
                                onClick={()=>{navigator.clipboard.writeText(credProof); pushToast?.('Proof copied!','ok');}}
                                className="px-4 py-2 bg-emerald-500/20 hover:bg-emerald-500/30 border border-emerald-400/40 rounded-lg text-emerald-300 font-semibold text-xs transition-all"
                              >
                                Copy
                              </button>
                            </div>
                            {credSignature && (
                              <div className="text-xs text-emerald-400 flex items-center gap-1">
                                <i data-lucide="check-circle" className="w-3 h-3"></i>
                                Cryptographically signed with wallet
                              </div>
                            )}
                          </div>

                          <button
                            onClick={resetCredibility}
                            className="mt-3 w-full px-4 py-2 bg-white/10 hover:bg-white/20 border border-white/20 text-white/70 rounded-lg text-xs transition-all"
                          >
                            Reset & Start Over
                          </button>
                        </div>
                      )}
                    </>
                  ) : (
                    <>
                      {/* Verify Mode */}
                      <div className="p-3 rounded-xl bg-white/5 border border-red-400/20">
                        <p className="text-xs text-white/70 flex items-start gap-2">
                          <i data-lucide="info" className="w-4 h-4 text-orange-400 flex-shrink-0 mt-0.5"></i>
                          Paste a credibility proof to verify a dev's track record without seeing their specific tokens.
                        </p>
                      </div>

                      <div className="space-y-3">
                        <textarea
                          value={verifyInput}
                          onChange={e=>setVerifyInput(e.target.value)}
                          placeholder="Paste credibility proof string here..."
                          rows={4}
                          className="w-full bg-white/5 border border-red-400/20 rounded-xl px-4 py-3 text-white text-sm font-mono placeholder-white/40 focus:border-red-400/40 focus:ring-2 focus:ring-red-400/20 outline-none transition-all"
                        />
                        
                        <button
                          onClick={verifyCredibilityProof}
                          className="w-full px-6 py-3 bg-gradient-to-r from-red-500 via-orange-500 to-amber-500 hover:from-red-400 hover:via-orange-400 hover:to-amber-400 text-white font-semibold rounded-xl transition-all duration-200 flex items-center justify-center gap-2 shadow-lg hover:shadow-xl hover:scale-[1.02]"
                        >
                          <i data-lucide="scan-line" className="w-5 h-5"></i>
                          Verify Proof
                        </button>
                      </div>

                      {/* Verification Result */}
                      {verifyResult && (
                        <div className={`p-5 rounded-xl border shadow-lg animate-in fade-in duration-300 ${verifyResult.valid ? 'bg-gradient-to-r from-emerald-500/10 to-green-500/10 border-emerald-400/30' : 'bg-gradient-to-r from-red-500/10 to-rose-500/10 border-red-400/30'}`}>
                          {(verifyResult.valid && verifyResult.score) ? (
                            <>
                              <div className="flex items-center gap-2 mb-4">
                                <div className="w-8 h-8 rounded-lg bg-gradient-to-br from-emerald-400 to-green-500 flex items-center justify-center">
                                  <i data-lucide="check-circle" className="w-5 h-5 text-white"></i>
                                </div>
                                <span className="text-emerald-400 font-bold text-lg">✓ Valid Credibility Proof</span>
                              </div>
                              
                              <div className="grid grid-cols-2 md:grid-cols-3 gap-3 mb-3">
                                <div className="p-3 rounded-lg bg-black/40 border border-emerald-400/20">
                                  <div className="text-xs text-white/60 mb-1">Total Tokens</div>
                                  <div className="text-xl font-bold text-white">{verifyResult.score.totalTokens||0}</div>
                                </div>
                                <div className="p-3 rounded-lg bg-black/40 border border-emerald-400/20">
                                  <div className="text-xs text-white/60 mb-1">100x Tokens</div>
                                  <div className="text-xl font-bold text-yellow-400">{verifyResult.score.tokens100x||0}</div>
                                </div>
                                <div className="p-3 rounded-lg bg-black/40 border border-emerald-400/20">
                                  <div className="text-xs text-white/60 mb-1">10x+ Tokens</div>
                                  <div className="text-xl font-bold text-cyan-400">{verifyResult.score.tokens10x||0}</div>
                                </div>
                                <div className="p-3 rounded-lg bg-black/40 border border-emerald-400/20">
                                  <div className="text-xs text-white/60 mb-1">Avg Market Cap</div>
                                  <div className="text-lg font-bold text-emerald-400">${((verifyResult.score.avgMarketCap||0)/1000).toFixed(0)}K</div>
                                </div>
                                <div className="p-3 rounded-lg bg-black/40 border border-emerald-400/20">
                                  <div className="text-xs text-white/60 mb-1">Avg Holders</div>
                                  <div className="text-lg font-bold text-white">{verifyResult.score.avgHolders||0}</div>
                                </div>
                                <div className="p-3 rounded-lg bg-black/40 border border-emerald-400/20">
                                  <div className="text-xs text-white/60 mb-1">Max ATH</div>
                                  <div className="text-lg font-bold text-orange-400">{verifyResult.score.maxATH||'1.0'}x</div>
                                </div>
                              </div>

                              <div className="text-xs text-white/60">
                                Commitment Hash: <span className="font-mono text-emerald-400">{verifyResult.commitment||'N/A'}</span>
                              </div>
                              <div className="text-xs text-white/60 mt-1">
                                Dev Wallet: <span className="font-mono text-orange-400">{verifyResult.wallet ? `${verifyResult.wallet.slice(0,4)}...${verifyResult.wallet.slice(-4)}` : 'N/A'}</span>
                              </div>
                              <div className="text-xs text-white/60 mt-1">
                                Timestamp: {verifyResult.score.timestamp ? new Date(verifyResult.score.timestamp).toLocaleString() : 'N/A'}
                              </div>
                            </>
                          ) : (
                            <div className="flex items-center gap-2">
                              <div className="w-8 h-8 rounded-lg bg-gradient-to-br from-red-400 to-rose-500 flex items-center justify-center">
                                <i data-lucide="x-circle" className="w-5 h-5 text-white"></i>
                              </div>
                              <span className="text-red-400 font-bold text-lg">✗ Invalid Proof</span>
                            </div>
                          )}
                        </div>
                      )}
                    </>
                  )}

                  {/* How it Works */}
                  <div className="p-4 rounded-xl bg-white/5 border border-red-400/20">
                    <div className="font-semibold text-white mb-2 text-sm">🔐 How Zero-Knowledge Credibility Works</div>
                    <ol className="list-decimal list-inside space-y-1 text-xs text-white/70">
                      <li><strong className="text-white/90">Connect wallet:</strong> Must connect wallet to verify you created the tokens</li>
                      <li><strong className="text-white/90">Add tokens:</strong> Enter token addresses you created</li>
                      <li><strong className="text-white/90">Verify ownership:</strong> We check on-chain if you're mint authority or creator</li>
                      <li><strong className="text-white/90">Fetch data:</strong> We verify performance on-chain (market cap, holders, ATH)</li>
                      <li><strong className="text-white/90">Generate proof:</strong> Creates cryptographic commitment (hash) hiding token addresses</li>
                      <li><strong className="text-white/90">Share proof:</strong> Copy the proof string and share it anywhere</li>
                      <li><strong className="text-white/90">Verify:</strong> Anyone can verify your credibility without seeing which tokens</li>
                    </ol>
                    <div className="mt-3 p-2 rounded-lg bg-orange-500/10 border border-orange-400/20">
                      <p className="text-xs text-orange-300"><strong>💡 Privacy Tip:</strong> The proof is cryptographically secure but doesn't reveal your identity or token addresses. Perfect for building anon reputation!</p>
                    </div>
                    <div className="mt-2 p-2 rounded-lg bg-emerald-500/10 border border-emerald-400/20">
                      <p className="text-xs text-emerald-300"><strong>🔒 Security:</strong> Tokens are verified by checking mint authority or transaction history to ensure you actually created them.</p>
                    </div>
                  </div>
                </div>
              )}
            </div>
            
            <div className="grid md:grid-cols-2 gap-4">
              <div className="space-y-3">
                <div className="flex items-center justify-between">
                  <div className="text-white/80 text-sm">API Key</div>
                  <button onClick={()=>{ navigator.clipboard.writeText(apiKey||''); }} className="text-xs px-2 py-1 bg-white/10 border border-white/20 rounded text-white/70">Copy</button>
                </div>
                <input value={apiKey} onChange={e=>setApiKey(e.target.value)} placeholder="Will auto-fill after Create Wallet" className="w-full bg-white/5 border border-white/20 rounded-lg px-3 py-2 text-white text-sm font-mono" />
                <div className="flex items-center justify-between">
                  <div className="text-white/80 text-sm">Wallet (Public)</div>
                  <button onClick={()=>{ navigator.clipboard.writeText(walletPubkey||''); }} className="text-xs px-2 py-1 bg-white/10 border border-white/20 rounded text-white/70">Copy</button>
                </div>
                <input value={walletPubkey} onChange={e=>setWalletPubkey(e.target.value)} placeholder="Will auto-fill after Create Wallet" className="w-full bg-white/5 border border-white/20 rounded-lg px-3 py-2 text-white text-sm font-mono" />
                
                {/* Wallet Balance Display */}
                {walletPubkey && (
                  <div className={`p-3 rounded-lg border ${walletBalance !== null && walletBalance < 0.02 ? 'bg-red-500/10 border-red-500/30' : 'bg-emerald-500/10 border-emerald-500/30'}`}>
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-2">
                        <i data-lucide="wallet" className={`w-4 h-4 ${walletBalance !== null && walletBalance < 0.02 ? 'text-red-400' : 'text-emerald-400'}`}></i>
                        <span className="text-sm font-semibold text-white/90">Balance:</span>
                      </div>
                      {loadingBalance ? (
                        <div className="flex items-center gap-2">
                          <div className="animate-spin rounded-full h-3 w-3 border-b-2 border-cyan-400"></div>
                          <span className="text-xs text-white/60">Loading...</span>
                        </div>
                      ) : walletBalance !== null ? (
                        <div className="flex items-center gap-2">
                          <span className={`text-lg font-bold ${walletBalance < 0.02 ? 'text-red-400' : 'text-emerald-400'}`}>
                            {walletBalance.toFixed(4)} SOL
                          </span>
                          {walletBalance < 0.02 && (
                            <span className="text-xs text-red-400 font-semibold">⚠️ Low</span>
                          )}
                        </div>
                      ) : (
                        <span className="text-sm text-white/60">Unable to fetch</span>
                      )}
                    </div>
                    {walletBalance !== null && walletBalance < 0.02 && (
                      <p className="text-xs text-red-300 mt-2">
                        Need at least 0.02 SOL to launch a token. Please fund this wallet.
                      </p>
                    )}
                    <p className="text-[10px] text-white/40 mt-1">Auto-refreshes every 10 seconds</p>
                  </div>
                )}
                
                <div className="flex items-center justify-between">
                  <div className="text-white/80 text-sm">Private Key</div>
                  <button onClick={()=>{ navigator.clipboard.writeText(privateKey||''); }} className="text-xs px-2 py-1 bg-white/10 border border-white/20 rounded text-white/70">Copy</button>
                </div>
                <input type="password" value={privateKey} onChange={e=>setPrivateKey(e.target.value)} placeholder="Will auto-fill after Create Wallet" className="w-full bg-white/5 border border-white/20 rounded-lg px-3 py-2 text-white text-sm font-mono" />
                
                {/* Warning Notice */}
                {!mainWalletConnected ? (
                  <div className="p-3 rounded-lg bg-yellow-500/10 border border-yellow-400/30">
                    <div className="flex items-start gap-2">
                      <i data-lucide="alert-triangle" className="w-4 h-4 text-yellow-400 flex-shrink-0 mt-0.5"></i>
                      <div className="text-xs text-yellow-300">
                        <strong>Connect Your Main Wallet First</strong>
                        <p className="text-yellow-300/80 mt-1">You must connect your wallet in the navbar before creating a Pump Portal wallet. This ensures your session persists across page refreshes.</p>
                      </div>
                    </div>
                  </div>
                ) : !apiKey && (
                  <div className="p-3 rounded-lg bg-red-500/10 border border-red-400/30">
                    <div className="flex items-start gap-2">
                      <i data-lucide="shield-alert" className="w-4 h-4 text-red-400 flex-shrink-0 mt-0.5"></i>
                      <div className="text-xs text-red-300">
                        <strong className="block mb-1">⚠️ CRITICAL: Save Your Private Key!</strong>
                        <p className="text-red-300/90">After creating your wallet, IMMEDIATELY copy and securely store your private key. This wallet persists in your browser, but if you clear browser data without backing up the key, you will PERMANENTLY lose access to any funds.</p>
                      </div>
                    </div>
                  </div>
                )}
                
                <div className="flex gap-2">
                  <button 
                    onClick={createWallet} 
                    disabled={creating || !mainWalletConnected} 
                    className="px-4 py-2 bg-cyan-500 hover:bg-cyan-400 disabled:bg-gray-500 disabled:cursor-not-allowed text-white rounded-lg transition-all"
                    title={!mainWalletConnected ? "Connect your wallet in the navbar first" : "Create a new Pump Portal wallet"}
                  >
                    {creating ? 'Creating…' : 'Create Wallet'}
                  </button>
                  <button onClick={resetAll} className="px-4 py-2 bg-white/10 hover:bg-white/20 text-white rounded-lg transition-all">Reset</button>
                </div>
                <p className="text-xs text-white/60">Fund this wallet with SOL to cover creation and initial buy.</p>
              </div>

              {/* Image Upload Section */}
              <div className="space-y-4">
                <div className="flex items-center gap-4">
                  <div className="space-y-2">
                    <h3 className="text-white text-sm font-medium">select image</h3>
                    <div className="relative">
                      {imageFile ? (
                        <div className="w-24 h-24 rounded-xl border-2 border-white/20 bg-white/5 flex items-center justify-center overflow-hidden">
                          <img src={URL.createObjectURL(imageFile)} alt="Token" className="w-full h-full object-cover" />
                </div>
                      ) : (
                        <button 
                          onClick={() => document.getElementById('image-upload').click()}
                          className="w-24 h-24 rounded-xl border-2 border-white/20 bg-white/5 flex items-center justify-center hover:border-white/40 transition-colors"
                        >
                          <i data-lucide="plus" className="w-8 h-8 text-white/60"></i>
                        </button>
                      )}
                      <input 
                        id="image-upload"
                        type="file" 
                        accept="image/*" 
                        onChange={e=>setImageFile(e.target.files?.[0]||null)} 
                        className="hidden" 
                      />
                    </div>
                  </div>
                  
                <div className="grid grid-cols-2 gap-2">
                    <button 
                      onClick={() => setShowEncModal(true)}
                      className="px-3 py-2 bg-purple-500/20 border border-purple-400/30 rounded-lg text-purple-300 text-xs hover:bg-purple-500/30 transition-colors flex items-center gap-1"
                    >
                      <i data-lucide="lock" className="w-3 h-3"></i>
                      ENCRYPT
                    </button>
                    <button 
                      onClick={() => setShowDecryptModal(true)}
                      className="px-3 py-2 bg-cyan-500/20 border border-cyan-400/30 rounded-lg text-cyan-300 text-xs hover:bg-cyan-500/30 transition-colors flex items-center gap-1"
                    >
                      <i data-lucide="unlock" className="w-3 h-3"></i>
                      DECRYPT
                    </button>
                    <button 
                      onClick={() => setShowStegoModal(true)}
                      className="px-3 py-2 bg-orange-500/20 border border-orange-400/30 rounded-lg text-orange-300 text-xs hover:bg-orange-500/30 transition-colors flex items-center gap-1"
                    >
                      <i data-lucide="eye-off" className="w-3 h-3"></i>
                      HIDE MSG
                    </button>
                    <button 
                      onClick={() => setShowExtractModal(true)}
                      className="px-3 py-2 bg-emerald-500/20 border border-emerald-400/30 rounded-lg text-emerald-300 text-xs hover:bg-emerald-500/30 transition-colors flex items-center gap-1"
                    >
                      <i data-lucide="search" className="w-3 h-3"></i>
                      EXTRACT
                    </button>
                </div>
                </div>


                {/* Coin Details */}
                <div className="space-y-4">
                  {/* Obfuscation Status */}
                  {isObfuscated && (
                    <div className="p-3 rounded-lg bg-gradient-to-r from-blue-500/10 via-purple-500/10 to-pink-500/10 border border-blue-400/30">
                      <div className="flex items-center gap-2 text-blue-300 text-sm">
                        <i data-lucide="shield-check" className="w-4 h-4"></i>
                        <span className="font-semibold">Name & Ticker Obfuscated</span>
                        <span className="text-blue-300/70">- Data encrypted and saved in description</span>
                      </div>
                    </div>
                  )}

                  {/* Name and Ticker Row */}
                  <div className="grid grid-cols-2 gap-4">
                    {/* Name Field */}
                    <div className="space-y-1">
                  <div className="flex items-center justify-between">
                        <label className="text-white text-sm font-medium">name</label>
                        <span className="text-white/50 text-xs">{name.length}/32</span>
                  </div>
                      <input 
                        value={isObfuscated ? obfuscatedName : name} 
                        onChange={e=>setName(e.target.value)} 
                        placeholder="coin name" 
                        maxLength={32}
                        className={`w-full bg-white/5 border border-white/20 rounded-lg px-4 py-3 text-white text-sm placeholder-white/40 focus:border-white/40 focus:ring-2 focus:ring-white/20 outline-none transition-all ${isObfuscated ? 'font-mono tracking-widest text-xs leading-tight' : ''}`}
                        readOnly={isObfuscated}
                      />
                    </div>

                    {/* Ticker Field */}
                    <div className="space-y-1">
                      <div className="flex items-center justify-between">
                        <label className="text-white text-sm font-medium">ticker</label>
                        <span className="text-white/50 text-xs">{symbol.length}/10</span>
                      </div>
                      <input 
                        value={isObfuscated ? obfuscatedTicker : symbol} 
                        onChange={e=>setSymbol(e.target.value)} 
                        placeholder="MEME" 
                        maxLength={10}
                        className={`w-full bg-white/5 border border-white/20 rounded-lg px-4 py-3 text-white text-sm placeholder-white/40 focus:border-white/40 focus:ring-2 focus:ring-white/20 outline-none transition-all ${isObfuscated ? 'font-mono tracking-widest text-xs leading-tight' : ''}`}
                        readOnly={isObfuscated}
                      />
                    </div>
                  </div>

                  {/* Website and Twitter Row */}
                  <div className="grid grid-cols-2 gap-4">
                    {/* Website Field */}
                    <div className="space-y-1">
                      <label className="text-white text-sm font-medium flex items-center gap-2">
                        <i data-lucide="globe" className="w-4 h-4"></i>
                        website
                      </label>
                      <input 
                        value={website} 
                        onChange={e=>setWebsite(e.target.value)} 
                        placeholder="https://example.com" 
                        className="w-full bg-white/5 border border-white/20 rounded-lg px-4 py-3 text-white text-sm placeholder-white/40 focus:border-white/40 focus:ring-2 focus:ring-white/20 outline-none transition-all" 
                      />
                    </div>

                    {/* Twitter Field */}
                    <div className="space-y-1">
                      <div className="flex items-center justify-between">
                        <label className="text-white text-sm font-medium flex items-center gap-2">
                          <i data-lucide="twitter" className="w-4 h-4"></i>
                          twitter
                        </label>
                        <div className="flex items-center gap-2 text-white/50 text-xs">
                          <span>Preview</span>
                          <i data-lucide="eye" className="w-3 h-3"></i>
                        </div>
                </div>
                <div className="flex items-center gap-2">
                        <input 
                          value={twitter} 
                          onChange={e=>setTwitter(e.target.value)} 
                          placeholder="https://x.com/zektaio/status/1979446068275482789" 
                          className="flex-1 bg-white/5 border border-white/20 rounded-lg px-4 py-3 text-white text-sm placeholder-white/40 focus:border-white/40 focus:ring-2 focus:ring-white/20 outline-none transition-all" 
                        />
                        <button className="text-white/50 text-xs hover:text-white transition-colors flex items-center gap-1">
                          <span>open link</span>
                          <i data-lucide="external-link" className="w-3 h-3"></i>
                        </button>
                </div>
                    </div>
                  </div>

                  {/* Description Field - Auto-filled with encrypted data */}
                  <div className="space-y-2">
                    <div className="flex items-center justify-between">
                      <label className="text-white text-sm font-medium">description (auto-filled)</label>
                      <div className="flex items-center gap-2">
                        {description.includes('[ENCRYPTED:') && (
                          <div className="flex items-center gap-1 px-2 py-1 bg-emerald-500/20 border border-emerald-400/30 rounded-lg">
                            <i data-lucide="shield-check" className="w-3 h-3 text-emerald-400"></i>
                            <span className="text-emerald-300 text-xs font-medium">Encrypted</span>
                          </div>
                        )}
                        <button 
                          type="button" 
                          onClick={(e)=>{ try{ ripple(e);}catch{} setEncMessage(''); setShowEncModal(true); }} 
                          className="group relative px-4 py-2 bg-gradient-to-r from-blue-500/20 via-purple-500/20 to-pink-500/20 hover:from-blue-500/30 hover:via-purple-500/30 hover:to-pink-500/30 border border-blue-400/30 hover:border-blue-400/50 rounded-xl text-blue-300 hover:text-blue-200 transition-all duration-300 shadow-lg hover:shadow-blue-500/25 backdrop-blur-sm"
                        >
                          <div className="flex items-center gap-2">
                            <i data-lucide="shield-check" className="w-4 h-4 group-hover:scale-110 transition-transform duration-200"></i>
                            <span className="text-sm font-semibold">Encrypt Message</span>
                          </div>
                          <div className="absolute inset-0 rounded-xl bg-gradient-to-r from-blue-500/10 via-purple-500/10 to-pink-500/10 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                        </button>
                      </div>
                    </div>
                    
                    {/* Show info message when empty */}
                    {!description && (
                      <div className="flex items-start gap-2 p-3 rounded-lg bg-blue-500/10 border border-blue-400/20">
                        <i data-lucide="info" className="w-4 h-4 text-blue-400 flex-shrink-0 mt-0.5"></i>
                        <p className="text-blue-300 text-xs">
                          Click <strong>"Encrypt Message"</strong> to add your secret message. The encrypted data will automatically appear here.
                        </p>
                      </div>
                    )}
                    
                    {/* Show textarea only when there's encrypted data */}
                    {description && (
                      <>
                        <textarea 
                          value={description} 
                          readOnly
                          rows={3} 
                          className="w-full bg-black/20 border border-white/20 rounded-lg px-4 py-3 text-white text-sm font-mono cursor-default outline-none resize-none"
                        ></textarea>
                        <div className="flex items-start gap-2 p-2 rounded-lg bg-emerald-500/10 border border-emerald-400/20">
                          <i data-lucide="copy" className="w-4 h-4 text-emerald-400 flex-shrink-0 mt-0.5"></i>
                          <p className="text-emerald-300 text-xs">
                            <strong>Encrypted data saved!</strong> Copy the [ENCRYPTED:...] code above to decrypt and view the original name, ticker, and message.
                          </p>
                        </div>
                      </>
                    )}
                  </div>

                  {/* Upload Metadata Button */}
                  <div className="space-y-2">
                    {!isObfuscated && (
                      <div className="flex items-start gap-2 p-2 rounded-lg bg-yellow-500/10 border border-yellow-400/20">
                        <i data-lucide="alert-triangle" className="w-4 h-4 text-yellow-400 flex-shrink-0 mt-0.5"></i>
                        <p className="text-yellow-300 text-xs">
                          <strong>Important:</strong> Encrypt your message first to obfuscate the name & ticker before uploading metadata!
                        </p>
                      </div>
                    )}
                    <div className="flex items-center gap-2">
                      <button 
                        onClick={uploadMetadata} 
                        className="px-4 py-2 bg-purple-500 hover:bg-purple-400 text-white rounded-lg transition-all text-sm font-medium"
                      >
                        Upload Metadata
                      </button>
                {metadataUri && (
                        <div className="text-xs text-white/70 break-all">IPFS: <a href={metadataUri} target="_blank" className="text-cyan-400 underline">{metadataUri}</a></div>
                      )}
                    </div>
                    {isObfuscated && metadataUri && (
                      <div className="flex items-start gap-2 p-2 rounded-lg bg-emerald-500/10 border border-emerald-400/20">
                        <i data-lucide="shield-check" className="w-4 h-4 text-emerald-400 flex-shrink-0 mt-0.5"></i>
                        <p className="text-emerald-300 text-xs">
                          <strong>Metadata uploaded with obfuscated name & ticker!</strong> Pump.fun will show weird characters - only decrypt reveals the real name.
                        </p>
                      </div>
                    )}
                  </div>
                </div>
              </div>
            </div>

            {/* Launch Configuration */}
            <div className="space-y-4">
              <h3 className="text-white text-sm font-medium">launch configuration</h3>
              
              <div className="grid grid-cols-3 gap-4">
                <div className="space-y-1">
                  <label className="text-white/70 text-xs">Initial Buy (SOL)</label>
                  <input 
                    value={amountSol} 
                    onChange={e=>setAmountSol(e.target.value)} 
                    placeholder="0.1"
                    className="w-full bg-white/5 border border-white/20 rounded-lg px-3 py-2 text-white text-sm placeholder-white/40 focus:border-white/40 focus:ring-2 focus:ring-white/20 outline-none transition-all" 
                  />
                  </div>
                <div className="space-y-1">
                  <label className="text-white/70 text-xs">Priority Fee (SOL)</label>
                  <input 
                    value={priorityFee} 
                    onChange={e=>setPriorityFee(e.target.value)} 
                    placeholder="0.001"
                    className="w-full bg-white/5 border border-white/20 rounded-lg px-3 py-2 text-white text-sm placeholder-white/40 focus:border-white/40 focus:ring-2 focus:ring-white/20 outline-none transition-all" 
                  />
                  </div>
                <div className="space-y-1">
                  <label className="text-white/70 text-xs">Slippage (%)</label>
                  <input 
                    value={slippagePct} 
                    onChange={e=>setSlippagePct(e.target.value)} 
                    placeholder="5"
                    className="w-full bg-white/5 border border-white/20 rounded-lg px-3 py-2 text-white text-sm placeholder-white/40 focus:border-white/40 focus:ring-2 focus:ring-white/20 outline-none transition-all" 
                  />
                  </div>
                </div>

                <button 
                  onClick={launchToken} 
                  disabled={walletBalance !== null && walletBalance < 0.02}
                className="w-full px-6 py-4 bg-gradient-to-r from-emerald-500 to-green-500 hover:from-emerald-400 hover:to-green-400 disabled:from-gray-500 disabled:to-gray-500 disabled:cursor-not-allowed text-white font-semibold rounded-lg transition-all shadow-lg hover:shadow-emerald-500/25 disabled:shadow-none"
                >
                <div className="flex items-center justify-center gap-2">
                  <i data-lucide="rocket" className="w-5 h-5"></i>
                  Launch Token
                </div>
                </button>
              
                {walletBalance !== null && walletBalance < 0.02 && (
                <div className="p-3 rounded-lg bg-red-500/10 border border-red-400/30">
                  <div className="flex items-center gap-2 text-red-300 text-sm">
                    <i data-lucide="alert-triangle" className="w-4 h-4"></i>
                    <span>Insufficient balance. Need at least 0.02 SOL</span>
                  </div>
                </div>
              )}
              
                {txSig && (
                <div className="space-y-3 p-4 rounded-lg bg-white/5 border border-white/10">
                  <h4 className="text-white font-medium text-sm">Transaction Details</h4>
                  <div className="space-y-2">
                    <div className="flex items-center justify-between">
                      <span className="text-white/70 text-xs">Transaction:</span>
                      <a href={`https://solscan.io/tx/${txSig}`} target="_blank" className="text-cyan-400 underline text-xs hover:text-cyan-300 transition-colors">
                        {txSig.slice(0,8)}...{txSig.slice(-8)}
                      </a>
                    </div>
                    {mintAddress && (
                      <>
                        <div className="flex items-center justify-between">
                          <span className="text-white/70 text-xs">Token Address:</span>
                          <a href={`https://solscan.io/token/${mintAddress}`} target="_blank" className="text-emerald-400 underline text-xs hover:text-emerald-300 transition-colors">
                            {mintAddress.slice(0,8)}...{mintAddress.slice(-8)}
                          </a>
                        </div>
                        <div className="flex items-center justify-between">
                          <span className="text-white/70 text-xs">Pump.fun:</span>
                          <a href={`https://pump.fun/coin/${mintAddress}`} target="_blank" className="text-emerald-300 underline text-xs hover:text-emerald-200 transition-colors">
                            View on Pump.fun
                          </a>
                        </div>
                      </>
                    )}
                  </div>
                  </div>
                )}
              </div>

            {/* How it Works Section */}
            <div className="bg-white/5 border border-white/10 rounded-xl p-6">
              <h3 className="text-white font-semibold text-sm mb-4">how it works</h3>
              <div className="space-y-3">
                <div className="flex items-start gap-3">
                  <div className="w-6 h-6 rounded-full bg-emerald-500/20 border border-emerald-400/30 flex items-center justify-center flex-shrink-0 mt-0.5">
                    <span className="text-emerald-400 text-xs font-bold">1</span>
                </div>
                  <div>
                    <div className="text-white font-medium text-sm">Create Wallet</div>
                    <div className="text-white/70 text-xs">Generate a new wallet with API key for Pump Portal</div>
                  </div>
                </div>
                
                <div className="flex items-start gap-3">
                  <div className="w-6 h-6 rounded-full bg-emerald-500/20 border border-emerald-400/30 flex items-center justify-center flex-shrink-0 mt-0.5">
                    <span className="text-emerald-400 text-xs font-bold">2</span>
                  </div>
                  <div>
                    <div className="text-white font-medium text-sm">Fund Wallet</div>
                    <div className="text-white/70 text-xs">Transfer SOL to the generated wallet address (minimum 0.02 SOL)</div>
                  </div>
                </div>
                
                <div className="flex items-start gap-3">
                  <div className="w-6 h-6 rounded-full bg-emerald-500/20 border border-emerald-400/30 flex items-center justify-center flex-shrink-0 mt-0.5">
                    <span className="text-emerald-400 text-xs font-bold">3</span>
                  </div>
                  <div>
                    <div className="text-white font-medium text-sm">Configure Token</div>
                    <div className="text-white/70 text-xs">Set name, ticker, upload image, and add social links</div>
                  </div>
                </div>
                
                <div className="flex items-start gap-3">
                  <div className="w-6 h-6 rounded-full bg-emerald-500/20 border border-emerald-400/30 flex items-center justify-center flex-shrink-0 mt-0.5">
                    <span className="text-emerald-400 text-xs font-bold">4</span>
                  </div>
                  <div>
                    <div className="text-white font-medium text-sm">Encrypt Message</div>
                    <div className="text-white/70 text-xs">Add secret message - this obfuscates name & ticker with weird characters</div>
                  </div>
                </div>
                
                <div className="flex items-start gap-3">
                  <div className="w-6 h-6 rounded-full bg-emerald-500/20 border border-emerald-400/30 flex items-center justify-center flex-shrink-0 mt-0.5">
                    <span className="text-emerald-400 text-xs font-bold">5</span>
                  </div>
                  <div>
                    <div className="text-white font-medium text-sm">Upload Metadata</div>
                    <div className="text-white/70 text-xs">Uploads to IPFS with obfuscated name/ticker - Pump.fun shows weird characters</div>
                  </div>
                </div>
                
                <div className="flex items-start gap-3">
                  <div className="w-6 h-6 rounded-full bg-emerald-500/20 border border-emerald-400/30 flex items-center justify-center flex-shrink-0 mt-0.5">
                    <span className="text-emerald-400 text-xs font-bold">6</span>
                  </div>
                  <div>
                    <div className="text-white font-medium text-sm">Launch Token</div>
                    <div className="text-white/70 text-xs">Deploy to Pump.fun - only people who decrypt see the real name/ticker</div>
                  </div>
                </div>
              </div>
              
              <div className="mt-4 p-3 rounded-lg bg-cyan-500/10 border border-cyan-400/20">
                <div className="flex items-start gap-2">
                  <i data-lucide="lightbulb" className="w-4 h-4 text-cyan-400 flex-shrink-0 mt-0.5"></i>
                  <div>
                    <div className="text-cyan-300 font-medium text-xs mb-1">Privacy Tip</div>
                    <div className="text-cyan-300/80 text-xs">On Pump.fun, the token will display weird characters like "⚐⚈⚐⚈" as the name/ticker. Only people who copy and decrypt the [ENCRYPTED:...] code from the description will see the real name, ticker, and secret message!</div>
                  </div>
                </div>
              </div>
              
              <div className="mt-3 text-xs text-white/50">
                Never share your private key. Stored only in this browser via localStorage.
              </div>
              
                {lastHttpStatus != null && (
                <div className="mt-4 p-3 rounded-lg bg-black/30 border border-white/10">
                  <div className="text-white/70 text-xs mb-2">Last HTTP status: <span className="font-mono">{String(lastHttpStatus)}</span></div>
                  {lastHttpText && (
                    <pre className="text-[11px] leading-snug text-white/70 whitespace-pre-wrap break-words">{lastHttpText}</pre>
                  )}
                  </div>
                )}
            </div>
          </div>
        </GlassCard>
        
        {/* Credibility Card Popup Modal */}
        {showCredCard && credScore && credProof && (
          <div key={credProof} className="fixed inset-0 z-[10000] grid place-items-center bg-black/80 backdrop-blur-sm p-4">
            <div className="max-w-2xl w-full bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 rounded-3xl border-2 border-emerald-400/30 shadow-2xl shadow-emerald-500/20 overflow-hidden animate-in fade-in zoom-in duration-300">
              {/* Header */}
              <div className="relative bg-gradient-to-r from-emerald-500/20 via-green-500/20 to-teal-500/20 p-6 border-b border-emerald-400/20">
                <button 
                  onClick={() => setShowCredCard(false)}
                  className="absolute top-4 right-4 p-2 bg-white/10 hover:bg-white/20 rounded-full transition-all"
                >
                  <svg className="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
                <div className="flex items-center gap-4">
                  <div className="w-16 h-16 rounded-2xl bg-gradient-to-br from-emerald-400 to-green-500 flex items-center justify-center shadow-lg shadow-emerald-500/50">
                    <svg className="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                    </svg>
                  </div>
                  <div>
                    <h2 className="text-2xl font-bold text-white mb-1">Developer Credibility Score</h2>
                    <p className="text-emerald-300 text-sm">Anonymous • Verified • Shareable</p>
                  </div>
                </div>
              </div>
              
              {/* Stats Grid */}
              <div className="p-6">
                <div className="grid grid-cols-3 gap-4 mb-6">
                  <div className="bg-gradient-to-br from-emerald-500/10 to-green-500/10 border border-emerald-400/30 rounded-xl p-4 text-center">
                    <div className="text-3xl font-bold text-emerald-400 mb-1">{credScore.totalTokens||0}</div>
                    <div className="text-xs text-white/60">Total Tokens</div>
                  </div>
                  <div className="bg-gradient-to-br from-yellow-500/10 to-amber-500/10 border border-yellow-400/30 rounded-xl p-4 text-center">
                    <div className="text-3xl font-bold text-yellow-400 mb-1">{credScore.tokens100x||0}</div>
                    <div className="text-xs text-white/60">100x Tokens</div>
                  </div>
                  <div className="bg-gradient-to-br from-cyan-500/10 to-blue-500/10 border border-cyan-400/30 rounded-xl p-4 text-center">
                    <div className="text-3xl font-bold text-cyan-400 mb-1">{credScore.tokens10x||0}</div>
                    <div className="text-xs text-white/60">10x+ Tokens</div>
                  </div>
                </div>
                
                <div className="grid grid-cols-3 gap-4 mb-6">
                  <div className="bg-black/40 border border-white/10 rounded-xl p-4">
                    <div className="text-xs text-white/60 mb-1">Avg Market Cap</div>
                    <div className="text-xl font-bold text-emerald-400">${((credScore.avgMarketCap||0)/1000).toFixed(0)}K</div>
                  </div>
                  <div className="bg-black/40 border border-white/10 rounded-xl p-4">
                    <div className="text-xs text-white/60 mb-1">Avg Holders</div>
                    <div className="text-xl font-bold text-white">{credScore.avgHolders||0}</div>
                  </div>
                  <div className="bg-black/40 border border-white/10 rounded-xl p-4">
                    <div className="text-xs text-white/60 mb-1">Max ATH</div>
                    <div className="text-xl font-bold text-orange-400">{credScore.maxATH||'1.0'}x</div>
                  </div>
                </div>
                
                {/* Wallet Info */}
                <div className="bg-gradient-to-r from-purple-500/10 to-pink-500/10 border border-purple-400/30 rounded-xl p-4 mb-6">
                  <div className="text-xs text-white/60 mb-2">Verified Developer</div>
                  <div className="font-mono text-sm text-purple-300 break-all">{window.solana?.publicKey ? window.solana.publicKey.toString() : 'Unknown'}</div>
                </div>
                
                {/* Share Section */}
                <div className="space-y-3">
                  <div className="text-sm font-semibold text-white/90 flex items-center gap-2">
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                    </svg>
                    Share Your Credibility
                  </div>
                  
                  <div className="flex gap-2">
                    <input
                      readOnly
                      value={shareableLink}
                      className="flex-1 bg-black/40 border border-emerald-400/30 rounded-lg px-3 py-2 text-white text-xs font-mono"
                    />
                    <button
                      onClick={() => {
                        navigator.clipboard.writeText(shareableLink);
                        pushToast?.('Link copied!', 'ok');
                      }}
                      className="px-4 py-2 bg-emerald-500 hover:bg-emerald-400 rounded-lg text-white font-semibold text-sm transition-all flex items-center gap-2"
                    >
                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                      </svg>
                      Copy Link
                    </button>
                  </div>
                  
                  <div className="flex gap-2">
                    <button
                      onClick={() => {
                        const tweetText = `🏆 My Developer Credibility Score:\n\n📊 ${credScore.totalTokens} Tokens Launched\n🚀 ${credScore.tokens100x} 100x Tokens\n💎 ${credScore.tokens10x} 10x+ Tokens\n\nVerify my track record anonymously:\n${shareableLink}\n\n#Solana #DeFi #Web3`;
                        window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(tweetText)}`, '_blank');
                      }}
                      className="flex-1 px-4 py-3 bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-400 hover:to-cyan-400 rounded-lg text-white font-semibold text-sm transition-all flex items-center justify-center gap-2"
                    >
                      <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z" />
                      </svg>
                      Share on Twitter
                    </button>
                    <button
                      onClick={() => {
                        navigator.clipboard.writeText(credProof);
                        pushToast?.('Proof copied!', 'ok');
                      }}
                      className="flex-1 px-4 py-3 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-400 hover:to-pink-400 rounded-lg text-white font-semibold text-sm transition-all flex items-center justify-center gap-2"
                    >
                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
                      </svg>
                      Copy Proof
                    </button>
                  </div>
                </div>
                
                {/* Privacy Notice */}
                <div className="mt-4 p-3 bg-cyan-500/10 border border-cyan-400/20 rounded-lg">
                  <div className="flex items-start gap-2">
                    <svg className="w-4 h-4 text-cyan-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                    </svg>
                    <p className="text-xs text-cyan-300">
                      <strong>Privacy Protected:</strong> Your credibility proof uses cryptographic commitments. Token addresses remain hidden while proving your track record.
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        )}
        
        {showEncModal && (
          <div className="fixed inset-0 z-50 grid place-items-center bg-black/70 backdrop-blur">
            <div className="max-w-md w-[92%] rounded-2xl border border-white/10 bg-gradient-to-b from-white/[0.08] to-white/[0.03] p-5 text-white shadow-2xl">
              <div className="flex items-center justify-between mb-2">
                <h3 className="text-white font-semibold">Encrypt Secret</h3>
                <button onClick={()=>setShowEncModal(false)} className="text-white/70 hover:text-white"><i data-lucide="x" className="w-5 h-5"></i></button>
              </div>
              <div className="space-y-3">
                <div className="p-3 rounded-lg bg-purple-500/10 border border-purple-400/20">
                  <div className="flex items-start gap-2">
                    <i data-lucide="info" className="w-4 h-4 text-purple-400 flex-shrink-0 mt-0.5"></i>
                    <p className="text-xs text-white/70">
                      Your message will be encrypted and inserted into the description. 
                      <strong className="text-purple-300"> Anyone can decrypt it on whistle.ninja</strong> or use the Decrypt section below.
                    </p>
                  </div>
                </div>
                
                <textarea value={encMessage} onChange={e=>setEncMessage(e.target.value)} placeholder="Write your secret..." rows={4} className="w-full bg-white/5 border border-white/20 rounded-lg px-3 py-2 text-white text-sm"></textarea>
                
                <div className="flex gap-2 justify-end">
                  <button onClick={async()=>{ 
                    try{ 
                      if(!(encMessage||'').trim()){ 
                        pushToast?.('Enter a message','err'); 
                        return; 
                      } 
                      
                      // Create the data to encrypt (normal readable text)
                      const dataToEncrypt = {
                        name: name,
                        ticker: symbol,
                        message: encMessage
                      };
                      
                      // Encrypt the complete data
                      const ct = await encryptSelfContained(JSON.stringify(dataToEncrypt)); 
                      console.log('Encrypted data:', ct); // Debug log
                      
                      // Add encrypted data to description (replaces any existing content)
                      const encryptedDescription = `[ENCRYPTED:${ct}]\n\nDecrypt at whistle.ninja`;
                      console.log('Encrypted description:', encryptedDescription); // Debug log
                      
                      // Set description to encrypted data
                      setDescription(encryptedDescription); 
                      
                      // NOW obfuscate ONLY the visible name and ticker fields
                      // Description stays normal so encrypted code can be copied
                      const obfName = obfuscateText(name);
                      const obfTicker = obfuscateText(symbol);
                      
                      // Store obfuscated versions for display
                      setObfuscatedName(obfName);
                      setObfuscatedTicker(obfTicker);
                      setIsObfuscated(true);
                      
                      pushToast?.('✅ Data encrypted and form obfuscated! Check description for encrypted code.','ok'); 
                      setShowEncModal(false); 
                    }catch(e){ 
                      pushToast?.(`Encryption failed: ${e?.message||e}`,'err'); 
                    } 
                  }} className="px-6 py-3 bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-400 hover:to-purple-400 text-white rounded-xl transition-all shadow-lg hover:shadow-blue-500/25 font-semibold">
                    Encrypt & Obfuscate
                  </button>
                  <button onClick={()=>setShowEncModal(false)} className="px-4 py-2 bg-white/10 hover:bg-white/20 text-white rounded-lg transition-all">Cancel</button>
                </div>
              </div>
            </div>
          </div>
        )}
        
        {/* Decrypt Modal */}
        {showDecryptModal && (
          <div className="fixed inset-0 z-50 grid place-items-center bg-black/70 backdrop-blur">
            <div className="max-w-md w-[92%] rounded-2xl border border-white/10 bg-gradient-to-b from-white/[0.08] to-white/[0.03] p-5 text-white shadow-2xl">
              <div className="flex items-center justify-between mb-2">
                <h3 className="text-white font-semibold">Decrypt Secret</h3>
                <button onClick={()=>setShowDecryptModal(false)} className="text-white/70 hover:text-white"><i data-lucide="x" className="w-5 h-5"></i></button>
              </div>
              <div className="space-y-3">
                <div className="p-3 rounded-lg bg-cyan-500/10 border border-cyan-400/20">
                  <div className="flex items-start gap-2">
                    <i data-lucide="info" className="w-4 h-4 text-cyan-400 flex-shrink-0 mt-0.5"></i>
                    <p className="text-xs text-white/70">
                      Paste encrypted text to reveal the hidden message.
                    </p>
                  </div>
                </div>
                
                <textarea 
                  value={decryptInput} 
                  onChange={e=>setDecryptInput(e.target.value)} 
                  placeholder="Paste encrypted text here..." 
                  rows={4} 
                  className="w-full bg-white/5 border border-white/20 rounded-lg px-3 py-2 text-white text-sm"
                />
                
                <div className="flex gap-2 justify-end">
                  <button 
                    onClick={async()=>{ 
                      try{ 
                        if(!(decryptInput||'').trim()){ 
                          pushToast?.('Enter encrypted text','err'); 
                          return; 
                        } 
                        const decrypted = await decryptSelfContained(decryptInput||''); 
                        
                        // Try to parse as JSON (new format) or use as plain text (old format)
                        let parsedData;
                        try {
                          parsedData = JSON.parse(decrypted);
                        } catch {
                          // Old format - just the message
                          parsedData = { message: decrypted };
                        }
                        
                        setDecryptResult(parsedData);
                        pushToast?.('Data decrypted!','ok'); 
                      }catch(e){ 
                        pushToast?.(`Decryption failed: ${e?.message||e}`,'err'); 
                      } 
                    }} 
                    className="px-4 py-2 bg-cyan-500 hover:bg-cyan-400 text-white rounded-lg transition-all"
                  >
                    Decrypt
                  </button>
                  <button onClick={()=>setShowDecryptModal(false)} className="px-4 py-2 bg-white/10 hover:bg-white/20 text-white rounded-lg transition-all">Cancel</button>
                </div>
                
                {decryptResult && (
                  <div className="space-y-3">
                    {/* Show decrypted data */}
                    <div className="p-4 rounded-lg bg-emerald-500/10 border border-emerald-400/20">
                      <div className="text-emerald-300 font-medium text-sm mb-3 flex items-center gap-2">
                        <i data-lucide="shield-check" className="w-4 h-4"></i>
                        Decrypted Data
                      </div>
                      
                      {/* New structured format */}
                      {decryptResult.name && (
                        <div className="space-y-3">
                          <div className="grid grid-cols-2 gap-4 text-sm">
                            <div>
                              <span className="text-white/70">Name:</span>
                              <div className="text-white font-semibold mt-1">{decryptResult.name}</div>
                            </div>
                            <div>
                              <span className="text-white/70">Ticker:</span>
                              <div className="text-white font-semibold mt-1">{decryptResult.ticker}</div>
                            </div>
                          </div>
                          
                          {decryptResult.message && (
                            <div>
                              <span className="text-white/70 text-sm">Secret Message:</span>
                              <div className="text-white bg-black/20 p-3 rounded border border-white/10 mt-1 whitespace-pre-wrap">
                                {decryptResult.message}
                              </div>
                            </div>
                          )}
                        </div>
                      )}
                      
                      {/* Old format - just message */}
                      {!decryptResult.name && decryptResult.message && (
                        <div>
                          <span className="text-white/70 text-sm">Decrypted Message:</span>
                          <div className="text-white bg-black/20 p-3 rounded border border-white/10 mt-1 whitespace-pre-wrap">
                            {decryptResult.message}
                          </div>
                        </div>
                      )}
                    </div>
                    
                    {/* Show obfuscated token details if they exist */}
                    {(obfuscatedName || obfuscatedTicker) && (
                      <div className="p-4 rounded-lg bg-blue-500/10 border border-blue-400/20">
                        <div className="text-blue-300 font-medium text-sm mb-3 flex items-center gap-2">
                          <i data-lucide="eye-off" className="w-4 h-4"></i>
                          Obfuscated Form Display
                        </div>
                        <div className="space-y-2 text-sm">
                          {obfuscatedName && (
                            <div className="flex items-center justify-between">
                              <span className="text-white/70">Name (Obfuscated):</span>
                              <span className="text-white font-mono tracking-widest text-xs leading-tight bg-black/20 px-2 py-1 rounded border border-white/10">{obfuscatedName}</span>
                            </div>
                          )}
                          {obfuscatedTicker && (
                            <div className="flex items-center justify-between">
                              <span className="text-white/70">Ticker (Obfuscated):</span>
                              <span className="text-white font-mono tracking-widest text-xs leading-tight bg-black/20 px-2 py-1 rounded border border-white/10">{obfuscatedTicker}</span>
                            </div>
                          )}
                        </div>
                        <div className="mt-3 text-xs text-blue-300/80">
                          Name & Ticker are obfuscated in the form for privacy - real data is encrypted above
                        </div>
                      </div>
                    )}
                  </div>
                )}
              </div>
            </div>
          </div>
        )}
        
        {/* Steganography Hide Message Modal */}
        {showStegoModal && (
          <div className="fixed inset-0 z-50 grid place-items-center bg-black/70 backdrop-blur">
            <div className="max-w-md w-[92%] rounded-2xl border border-white/10 bg-gradient-to-b from-white/[0.08] to-white/[0.03] p-5 text-white shadow-2xl">
              <div className="flex items-center justify-between mb-2">
                <h3 className="text-white font-semibold">Hide Message in Image</h3>
                <button onClick={()=>setShowStegoModal(false)} className="text-white/70 hover:text-white"><i data-lucide="x" className="w-5 h-5"></i></button>
              </div>
              <div className="space-y-3">
                <div className="p-3 rounded-lg bg-orange-500/10 border border-orange-400/20">
                  <div className="flex items-start gap-2">
                    <i data-lucide="info" className="w-4 h-4 text-orange-400 flex-shrink-0 mt-0.5"></i>
                    <p className="text-xs text-white/70">
                      Hide a secret message inside your uploaded image using steganography. The image will look identical but contain hidden data.
                    </p>
                  </div>
                </div>
                
                {!imageFile ? (
                  <div className="p-4 rounded-lg bg-yellow-500/10 border border-yellow-400/20 text-center">
                    <i data-lucide="image" className="w-8 h-8 text-yellow-400 mx-auto mb-2"></i>
                    <p className="text-yellow-300 text-sm">Please upload an image first</p>
                  </div>
                ) : (
                  <>
                    <div className="p-3 rounded-lg bg-white/5 border border-white/10">
                      <div className="text-white/70 text-xs mb-2">Selected Image:</div>
                      <img src={URL.createObjectURL(imageFile)} alt="Preview" className="w-20 h-20 object-cover rounded-lg" />
                    </div>
                    
                    <textarea 
                      value={encMessage} 
                      onChange={e=>setEncMessage(e.target.value)} 
                      placeholder="Enter secret message to hide..." 
                      rows={3} 
                      className="w-full bg-white/5 border border-white/20 rounded-lg px-3 py-2 text-white text-sm"
                    />
                    
                    <div className="flex gap-2 justify-end">
                      <button 
                        onClick={async()=>{ 
                          try{ 
                            if(!(encMessage||'').trim()){ 
                              pushToast?.('Enter a message to hide','err'); 
                              return; 
                            } 
                            // Here you would implement the actual steganography
                            pushToast?.('Message hidden in image! (Steganography feature coming soon)','ok'); 
                            setShowStegoModal(false); 
                          }catch(e){ 
                            pushToast?.(`Failed to hide message: ${e?.message||e}`,'err'); 
                          } 
                        }} 
                        className="px-4 py-2 bg-orange-500 hover:bg-orange-400 text-white rounded-lg transition-all"
                      >
                        Hide Message
                      </button>
                      <button onClick={()=>setShowStegoModal(false)} className="px-4 py-2 bg-white/10 hover:bg-white/20 text-white rounded-lg transition-all">Cancel</button>
                    </div>
                  </>
                )}
              </div>
            </div>
          </div>
        )}
        
        {/* Extract Message Modal */}
        {showExtractModal && (
          <div className="fixed inset-0 z-50 grid place-items-center bg-black/70 backdrop-blur">
            <div className="max-w-md w-[92%] rounded-2xl border border-white/10 bg-gradient-to-b from-white/[0.08] to-white/[0.03] p-5 text-white shadow-2xl">
              <div className="flex items-center justify-between mb-2">
                <h3 className="text-white font-semibold">Extract Hidden Message</h3>
                <button onClick={()=>setShowExtractModal(false)} className="text-white/70 hover:text-white"><i data-lucide="x" className="w-5 h-5"></i></button>
              </div>
              <div className="space-y-3">
                <div className="p-3 rounded-lg bg-emerald-500/10 border border-emerald-400/20">
                  <div className="flex items-start gap-2">
                    <i data-lucide="info" className="w-4 h-4 text-emerald-400 flex-shrink-0 mt-0.5"></i>
                    <p className="text-xs text-white/70">
                      Upload an image to extract any hidden messages using steganography.
                    </p>
                  </div>
                </div>
                
                <div className="space-y-2">
                  <input 
                    type="file" 
                    accept="image/*" 
                    onChange={e=>setImageFile(e.target.files?.[0]||null)} 
                    className="w-full text-white/70 text-sm file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-emerald-500/20 file:text-emerald-300 hover:file:bg-emerald-500/30"
                  />
                  
                  {imageFile && (
                    <div className="p-3 rounded-lg bg-white/5 border border-white/10">
                      <div className="text-white/70 text-xs mb-2">Selected Image:</div>
                      <img src={URL.createObjectURL(imageFile)} alt="Preview" className="w-20 h-20 object-cover rounded-lg" />
                    </div>
                  )}
                </div>
                
                <div className="flex gap-2 justify-end">
                  <button 
                    onClick={async()=>{ 
                      try{ 
                        if(!imageFile){ 
                          pushToast?.('Please select an image','err'); 
                          return; 
                        } 
                        // Here you would implement the actual steganography extraction
                        pushToast?.('Extracting message... (Steganography feature coming soon)','ok'); 
                        setShowExtractModal(false); 
                      }catch(e){ 
                        pushToast?.(`Failed to extract message: ${e?.message||e}`,'err'); 
                      } 
                    }} 
                    className="px-4 py-2 bg-emerald-500 hover:bg-emerald-400 text-white rounded-lg transition-all"
                  >
                    Extract Message
                  </button>
                  <button onClick={()=>setShowExtractModal(false)} className="px-4 py-2 bg-white/10 hover:bg-white/20 text-white rounded-lg transition-all">Cancel</button>
                </div>
              </div>
            </div>
          </div>
        )}
        </>
      );
    }
    // ===== PRIVACY CHECKUP DASHBOARD =====
    
    function PrivacyCheckup({ pushToast }) {
      const [checking, setChecking] = useState(false);
      const [results, setResults] = useState(null);
      const [webrtcIPs, setWebrtcIPs] = useState([]);
      const [dnsLeak, setDnsLeak] = useState(null);
      const [fingerprint, setFingerprint] = useState(null);

      useEffect(()=>{
        if(window.lucide) window.lucide.createIcons();
      },[results]);

      // WebRTC Leak Detection
      const checkWebRTCLeak = async () => {
        return new Promise((resolve) => {
          const ips = [];
          const pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
          
          pc.createDataChannel('');
          pc.createOffer().then(offer => pc.setLocalDescription(offer));
          
          pc.onicecandidate = (ice) => {
            if (!ice || !ice.candidate || !ice.candidate.candidate) {
              resolve(ips);
              return;
            }
            const parts = ice.candidate.candidate.split(' ');
            const ip = parts[4];
            if (ip && !ips.includes(ip) && ip !== '0.0.0.0') {
              ips.push(ip);
            }
          };
          
          setTimeout(() => {
            pc.close();
            resolve(ips);
          }, 2000);
        });
      };

      // DNS Leak Check (simplified - checks if DoH is enabled)
      const checkDNS = async () => {
        try {
          // Check if DNS-over-HTTPS is being used
          const response = await fetch('https://cloudflare-dns.com/dns-query?name=example.com&type=A', {
            headers: { 'accept': 'application/dns-json' }
          });
          const data = await response.json();
          return {
            secure: response.ok,
            provider: 'Cloudflare DoH',
            status: response.ok ? 'protected' : 'exposed'
          };
        } catch (e) {
          return { secure: false, provider: 'Unknown', status: 'exposed' };
        }
      };

      // Browser Fingerprint
      const calculateFingerprint = () => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        ctx.textBaseline = 'top';
        ctx.font = '14px Arial';
        ctx.fillText('Fingerprint', 2, 2);
        const canvasData = canvas.toDataURL();
        
        const fingerprint = {
          userAgent: navigator.userAgent,
          language: navigator.language,
          colorDepth: screen.colorDepth,
          screenResolution: `${screen.width}x${screen.height}`,
          timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
          platform: navigator.platform,
          canvas: canvasData.slice(-50),
          plugins: navigator.plugins.length,
          cookieEnabled: navigator.cookieEnabled,
          doNotTrack: navigator.doNotTrack || 'not set'
        };

        // Simple uniqueness score (0-100, lower is better for privacy)
        let uniqueness = 50; // base score
        if (fingerprint.plugins > 5) uniqueness += 10;
        if (fingerprint.canvas.length > 0) uniqueness += 15;
        if (fingerprint.cookieEnabled) uniqueness += 10;
        if (fingerprint.doNotTrack === 'not set') uniqueness += 15;
        
        return { ...fingerprint, uniqueness: Math.min(uniqueness, 100) };
      };

      // Run Full Checkup
      const runCheckup = async () => {
        setChecking(true);
        setResults(null);

        try {
          // Run all checks
          const [webrtc, dns, fp] = await Promise.all([
            checkWebRTCLeak(),
            checkDNS(),
            Promise.resolve(calculateFingerprint())
          ]);

          setWebrtcIPs(webrtc);
          setDnsLeak(dns);
          setFingerprint(fp);

          // Calculate overall privacy score (0-100, higher is better)
          let score = 100;
          if (webrtc.length > 0) score -= 30; // WebRTC leak is serious
          if (!dns.secure) score -= 20;
          score -= (fp.uniqueness * 0.5); // Fingerprint uniqueness penalty

          setResults({
            score: Math.max(0, Math.round(score)),
            webrtcLeaks: webrtc.length,
            dnsSecure: dns.secure,
            fingerprintUnique: fp.uniqueness
          });

          pushToast(`Privacy checkup complete! Score: ${Math.round(score)}/100`, 'info');
        } catch (error) {
          pushToast('Error running privacy checkup', 'bad');
        } finally {
          setChecking(false);
        }
      };

      const getScoreColor = (score) => {
        if (score >= 80) return 'text-emerald-400';
        if (score >= 60) return 'text-yellow-400';
        return 'text-red-400';
      };

      const getScoreLabel = (score) => {
        if (score >= 80) return 'Excellent';
        if (score >= 60) return 'Good';
        if (score >= 40) return 'Fair';
        return 'Poor';
      };

      return (
        <GlassCard title="Privacy Checkup" subtitle="Test your browser's privacy & anonymity">
          <div className="space-y-6">
            {/* Run Checkup Button */}
            <div className="text-center">
              <button
                onClick={runCheckup}
                disabled={checking}
                className="px-8 py-4 rounded-xl font-bold text-base transition-all border-2 shadow-xl flex items-center gap-3 mx-auto bg-gradient-to-r from-cyan-500 to-blue-600 hover:from-cyan-400 hover:to-blue-500 border-cyan-400/50 text-white hover:scale-105 hover:shadow-2xl hover:shadow-cyan-500/30 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100"
              >
                <i data-lucide={checking ? "loader" : "shield-check"} className={`w-5 h-5 ${checking ? 'animate-spin' : ''}`}></i>
                {checking ? 'Running Checkup...' : 'Run Privacy Checkup'}
              </button>
            </div>

            {/* Results */}
            {results && (
              <div className="space-y-4 fade-up">
                {/* Overall Score */}
                <div className="bg-white/5 border border-white/10 rounded-xl p-6 text-center">
                  <div className="text-sm text-white/60 mb-2">Overall Privacy Score</div>
                  <div className={`text-6xl font-bold ${getScoreColor(results.score)} mb-2`}>
                    {results.score}
                  </div>
                  <div className="text-lg text-white/80">{getScoreLabel(results.score)}</div>
                </div>

                {/* Detailed Results */}
                <div className="grid md:grid-cols-3 gap-4">
                  {/* WebRTC Leak */}
                  <div className="bg-white/5 border border-white/10 rounded-xl p-4">
                    <div className="flex items-center gap-2 mb-3">
                      <i data-lucide="radio" className="w-5 h-5 text-cyan-400"></i>
                      <h3 className="text-white font-semibold">WebRTC Leak</h3>
                    </div>
                    {webrtcIPs.length > 0 ? (
                      <div>
                        <div className="text-red-400 font-semibold mb-2">⚠️ {webrtcIPs.length} IP(s) Exposed</div>
                        <div className="space-y-1">
                          {webrtcIPs.map((ip, i) => (
                            <div key={i} className="text-xs font-mono bg-black/20 px-2 py-1 rounded text-white/70">{ip}</div>
                          ))}
                        </div>
                        <div className="mt-3 text-xs text-white/50">
                          💡 Tip: Use WebRTC blocking extension
                        </div>
                      </div>
                    ) : (
                      <div className="text-emerald-400 font-semibold">✓ No Leaks Detected</div>
                    )}
                  </div>

                  {/* DNS Check */}
                  <div className="bg-white/5 border border-white/10 rounded-xl p-4">
                    <div className="flex items-center gap-2 mb-3">
                      <i data-lucide="globe" className="w-5 h-5 text-cyan-400"></i>
                      <h3 className="text-white font-semibold">DNS Privacy</h3>
                    </div>
                    {dnsLeak && (
                      <div>
                        <div className={`font-semibold mb-2 ${dnsLeak.secure ? 'text-emerald-400' : 'text-yellow-400'}`}>
                          {dnsLeak.secure ? '✓ DoH Capable' : '⚠️ Standard DNS'}
                        </div>
                        <div className="text-xs text-white/60 mb-3">
                          Provider: {dnsLeak.provider}
                        </div>
                        {!dnsLeak.secure && (
                          <div className="text-xs text-white/50">
                            💡 Tip: Enable DNS-over-HTTPS in your browser
                          </div>
                        )}
                      </div>
                    )}
                  </div>

                  {/* Fingerprint */}
                  <div className="bg-white/5 border border-white/10 rounded-xl p-4">
                    <div className="flex items-center gap-2 mb-3">
                      <i data-lucide="fingerprint" className="w-5 h-5 text-cyan-400"></i>
                      <h3 className="text-white font-semibold">Fingerprint</h3>
                    </div>
                    {fingerprint && (
                      <div>
                        <div className="text-2xl font-bold text-white mb-2">{fingerprint.uniqueness}%</div>
                        <div className="text-xs text-white/60 mb-3">Uniqueness Score</div>
                        <div className="text-xs text-white/50">
                          {fingerprint.uniqueness > 70 ? '⚠️ Highly trackable' : 
                           fingerprint.uniqueness > 50 ? '💡 Moderately trackable' : 
                           '✓ Less trackable'}
                        </div>
                      </div>
                    )}
                  </div>
                </div>

                {/* Privacy Tips */}
                <div className="bg-cyan-500/10 border border-cyan-500/30 rounded-xl p-4">
                  <div className="flex items-start gap-3">
                    <i data-lucide="lightbulb" className="w-5 h-5 text-cyan-400 flex-shrink-0 mt-0.5"></i>
                    <div>
                      <h3 className="text-white font-semibold mb-2">Improve Your Privacy</h3>
                      <ul className="text-sm text-white/70 space-y-1">
                        <li>• Use privacy-focused browser (Brave, Firefox with hardening)</li>
                        <li>• Enable DNS-over-HTTPS (DoH) in browser settings</li>
                        <li>• Install WebRTC blocking extension</li>
                        <li>• Disable JavaScript on sensitive sites</li>
                        <li>• Consider using Tor Browser for maximum anonymity</li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Initial Info */}
            {!results && !checking && (
              <div className="bg-white/5 border border-white/10 rounded-xl p-4">
                <div className="flex items-start gap-3">
                  <i data-lucide="info" className="w-5 h-5 text-cyan-400 flex-shrink-0 mt-0.5"></i>
                  <div>
                    <h3 className="text-white font-semibold mb-2">What We Check</h3>
                    <ul className="text-sm text-white/70 space-y-1">
                      <li>• <strong>WebRTC Leaks:</strong> Can reveal your real IP even with VPN</li>
                      <li>• <strong>DNS Privacy:</strong> Are your DNS queries encrypted?</li>
                      <li>• <strong>Browser Fingerprint:</strong> How unique/trackable you are</li>
                      <li>• <strong>Privacy Score:</strong> Overall assessment (0-100)</li>
                    </ul>
                  </div>
                </div>
              </div>
            )}
          </div>
        </GlassCard>
      );
    }
    // ===== TOR BRIDGE FINDER =====
    
    function TorBridgeFinder({ pushToast }) {
      const [bridges, setBridges] = useState([]);
      const [loading, setLoading] = useState(false);
      const [transport, setTransport] = useState('obfs4');

      useEffect(()=>{
        if(window.lucide) window.lucide.createIcons();
      },[bridges, transport]);

      const sampleBridges = {
        obfs4: [
          'obfs4 192.95.36.142:443 CDF2E852BF539B82BD10E27E9115A31734E378C2 cert=qUVQ0srL1JI/vO6V6m/24anYXiJD3QP2HgzUKQtQ7GRqqUvs7P+tG43RtAqdhLOALP7DJQ iat-mode=1',
          'obfs4 38.229.1.78:80 C8CBDB2464FC9804A69531437BCF2BE31FDD2EE4 cert=Hmyfd2ev46gGY7NoVxA9ngrPF2zCZtzskRTzoWXbxNkzeVnGFPWmrTtILRyqCTjHR+s9dg iat-mode=1',
          'obfs4 193.11.166.194:27015 2D82C2E354D531A68469ADF7F878FA6060C6BACA cert=4TLQPJrTSaDffMK7Nbao6LC7G9OW/NHkUwIdjLSS3KYf0Nv4/nQiiI8dY2TcsQx01NniOg iat-mode=0',
          'obfs4 193.11.166.194:27020 86AC7B8D430DAC4117E9F42C9EAED18133863AAF cert=0LDeJH4JzMDtkJJrFBJKP8MjHTbYbRiMYI9p9xUPrHkJKtG12SqZYhDODi2bTL2mesoWxw iat-mode=0'
        ],
        snowflake: [
          'snowflake 192.0.2.3:80 2B280B23E1107BB62ABFC40DDCC8824814F80A72 fingerprint=2B280B23E1107BB62ABFC40DDCC8824814F80A72 url=https://snowflake-broker.torproject.net.global.prod.fastly.net/ front=cdn.sstatic.net ice=stun:stun.l.google.com:19302,stun:stun.voip.blackberry.com:3478,stun:stun.altar.com.pl:3478 utls-imitate=hellorandomizedalpn',
          'snowflake 192.0.2.4:80 8838024498816A039FCBBAB14E6F40A0843051FA fingerprint=8838024498816A039FCBBAB14E6F40A0843051FA url=https://snowflake-broker.torproject.net.global.prod.fastly.net/ front=cdn.sstatic.net ice=stun:stun.l.google.com:19302 utls-imitate=hellorandomizedalpn'
        ],
        meek: [
          'meek_lite 192.0.2.18:80 BE776A53492E1E044A26F17306E1BC46A55A1625 url=https://meek.azureedge.net/ front=ajax.aspnetcdn.com'
        ]
      };

      const fetchBridges = () => {
        setLoading(true);
        // Simulate API call - in production, you'd fetch from Tor's BridgeDB
        setTimeout(() => {
          setBridges(sampleBridges[transport]);
          setLoading(false);
          pushToast(`Fetched ${sampleBridges[transport].length} ${transport} bridges`, 'ok');
        }, 1000);
      };

      const copyBridge = (bridge) => {
        navigator.clipboard.writeText(bridge);
        pushToast('Bridge copied to clipboard!', 'ok');
      };

      const copyAllBridges = () => {
        const allBridges = bridges.join('\n');
        navigator.clipboard.writeText(allBridges);
        pushToast(`Copied ${bridges.length} bridges to clipboard!`, 'ok');
      };

      const downloadConfig = () => {
        const config = `# Tor Bridge Configuration
# Generated by Whistle Privacy Tools
# Add these lines to your torrc file
UseBridges 1
${bridges.map(b => `Bridge ${b}`).join('\n')}
`;
        const blob = new Blob([config], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `tor-bridges-${transport}.txt`;
        a.click();
        URL.revokeObjectURL(url);
        pushToast('Bridge config downloaded!', 'ok');
      };

      return (
        <GlassCard title="Tor Bridge Finder" subtitle="Access Tor network in censored countries">
          <div className="space-y-6">
            {/* Info Banner */}
            <div className="bg-purple-500/10 border border-purple-500/30 rounded-xl p-4">
              <div className="flex items-start gap-3">
                <i data-lucide="shield-alert" className="w-5 h-5 text-purple-400 flex-shrink-0 mt-0.5"></i>
                <div>
                  <h3 className="text-white font-semibold mb-2">What are Tor Bridges?</h3>
                  <p className="text-sm text-white/70">
                    Bridges are unlisted Tor relays that help you connect to Tor when it's blocked in your country. 
                    They're harder for censors to detect and block than public Tor nodes.
                  </p>
                </div>
              </div>
            </div>

            {/* Transport Selection */}
            <div>
              <label className="block text-sm font-semibold text-white mb-2">Bridge Transport Type</label>
              <div className="grid grid-cols-3 gap-2">
                {['obfs4', 'snowflake', 'meek'].map(type => (
                  <button
                    key={type}
                    onClick={() => setTransport(type)}
                    className={`px-4 py-3 rounded-xl border font-semibold transition-all ${
                      transport === type
                        ? 'border-purple-400/60 bg-purple-400/15 text-purple-100'
                        : 'border-white/10 bg-white/5 text-white/70 hover:bg-white/10'
                    }`}
                  >
                    {type}
                  </button>
                ))}
              </div>
              <div className="mt-2 text-xs text-white/50">
                {transport === 'obfs4' && '• Most reliable, looks like random traffic'}
                {transport === 'snowflake' && '• Uses temporary proxies, good for heavy censorship'}
                {transport === 'meek' && '• Mimics HTTPS traffic to CDN, slowest but hardest to block'}
              </div>
            </div>

            {/* Fetch Bridges Button */}
            <button
              onClick={fetchBridges}
              disabled={loading}
              className="btn-primary w-full flex items-center justify-center gap-2"
            >
              <i data-lucide={loading ? "loader" : "download"} className={`w-5 h-5 ${loading ? 'animate-spin' : ''}`}></i>
              {loading ? 'Fetching Bridges...' : 'Get Bridges'}
            </button>

            {/* Bridges List */}
            {bridges.length > 0 && (
              <div className="space-y-3 fade-up">
                <div className="flex items-center justify-between">
                  <h3 className="text-white font-semibold">Available Bridges ({bridges.length})</h3>
                  <div className="flex gap-2">
                    <button onClick={copyAllBridges} className="btn-secondary-sm flex items-center gap-1">
                      <i data-lucide="copy" className="w-4 h-4"></i>
                      Copy All
                    </button>
                    <button onClick={downloadConfig} className="btn-secondary-sm flex items-center gap-1">
                      <i data-lucide="download" className="w-4 h-4"></i>
                      Download
                    </button>
                  </div>
                </div>

                <div className="space-y-2">
                  {bridges.map((bridge, idx) => (
                    <div key={idx} className="bg-black/20 border border-white/10 rounded-lg p-3 group hover:border-purple-400/30 transition-colors">
                      <div className="flex items-start gap-2">
                        <code className="flex-1 text-xs text-white/70 font-mono break-all">{bridge}</code>
                        <button
                          onClick={() => copyBridge(bridge)}
                          className="opacity-0 group-hover:opacity-100 transition-opacity p-1 hover:bg-white/10 rounded"
                          title="Copy bridge"
                        >
                          <i data-lucide="copy" className="w-4 h-4 text-cyan-400"></i>
                        </button>
                      </div>
                    </div>
                  ))}
                </div>

                {/* Usage Instructions */}
                <div className="bg-white/5 border border-white/10 rounded-xl p-4">
                  <div className="flex items-start gap-3">
                    <i data-lucide="book-open" className="w-5 h-5 text-cyan-400 flex-shrink-0 mt-0.5"></i>
                    <div>
                      <h3 className="text-white font-semibold mb-2">How to Use These Bridges</h3>
                      <ol className="text-sm text-white/70 space-y-2 list-decimal list-inside">
                        <li>Download and install <a href="https://www.torproject.org/download/" target="_blank" rel="noopener noreferrer" className="text-cyan-400 hover:underline">Tor Browser</a></li>
                        <li>Open Tor Browser and click "Configure Connection"</li>
                        <li>Select "Tor is censored in my country"</li>
                        <li>Choose "{transport}" as your bridge type</li>
                        <li>Paste the bridges above (or use downloaded config)</li>
                        <li>Click "Connect" and wait for Tor to establish connection</li>
                      </ol>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Educational Info */}
            {bridges.length === 0 && !loading && (
              <div className="bg-white/5 border border-white/10 rounded-xl p-4">
                <div className="flex items-start gap-3">
                  <i data-lucide="info" className="w-5 h-5 text-cyan-400 flex-shrink-0 mt-0.5"></i>
                  <div>
                    <h3 className="text-white font-semibold mb-2">Why Use Tor Bridges?</h3>
                    <ul className="text-sm text-white/70 space-y-1">
                      <li>• <strong>Bypass Censorship:</strong> Access Tor in countries that block it</li>
                      <li>• <strong>Extra Privacy:</strong> Your ISP can't see you're using Tor</li>
                      <li>• <strong>Unlisted Relays:</strong> Harder for censors to find and block</li>
                      <li>• <strong>Multiple Transports:</strong> Different methods to evade detection</li>
                    </ul>
                  </div>
                </div>
              </div>
            )}
          </div>
        </GlassCard>
      );
    }

    // ===== CENSORSHIP MAP =====
    
    function CensorshipMap({ pushToast }) {
      const [loading, setLoading] = useState(false);
      const [selectedCountry, setSelectedCountry] = useState('');
      const [censorshipData, setCensorshipData] = useState(null);
      const [globalStats, setGlobalStats] = useState(null);

      useEffect(()=>{
        if(window.lucide) window.lucide.createIcons();
        loadGlobalStats();
      },[]);

      useEffect(()=>{
        if(window.lucide) window.lucide.createIcons();
      },[censorshipData, globalStats, selectedCountry]);

      // Countries with known censorship (based on OONI data)
      const censoredCountries = [
        { code: 'CN', name: 'China', level: 'extreme', color: 'red', flag: '🇨🇳' },
        { code: 'IR', name: 'Iran', level: 'extreme', color: 'red', flag: '🇮🇷' },
        { code: 'RU', name: 'Russia', level: 'high', color: 'orange', flag: '🇷🇺' },
        { code: 'TR', name: 'Turkey', level: 'high', color: 'orange', flag: '🇹🇷' },
        { code: 'EG', name: 'Egypt', level: 'high', color: 'orange', flag: '🇪🇬' },
        { code: 'VE', name: 'Venezuela', level: 'high', color: 'orange', flag: '🇻🇪' },
        { code: 'TM', name: 'Turkmenistan', level: 'extreme', color: 'red', flag: '🇹🇲' },
        { code: 'KP', name: 'North Korea', level: 'extreme', color: 'red', flag: '🇰🇵' },
        { code: 'SY', name: 'Syria', level: 'extreme', color: 'red', flag: '🇸🇾' },
        { code: 'SA', name: 'Saudi Arabia', level: 'high', color: 'orange', flag: '🇸🇦' },
        { code: 'AE', name: 'UAE', level: 'moderate', color: 'yellow', flag: '🇦🇪' },
        { code: 'IN', name: 'India', level: 'moderate', color: 'yellow', flag: '🇮🇳' },
        { code: 'PK', name: 'Pakistan', level: 'moderate', color: 'yellow', flag: '🇵🇰' },
        { code: 'TH', name: 'Thailand', level: 'moderate', color: 'yellow', flag: '🇹🇭' },
        { code: 'VN', name: 'Vietnam', level: 'high', color: 'orange', flag: '🇻🇳' },
        { code: 'BY', name: 'Belarus', level: 'high', color: 'orange', flag: '🇧🇾' },
        { code: 'KZ', name: 'Kazakhstan', level: 'moderate', color: 'yellow', flag: '🇰🇿' },
        { code: 'UZ', name: 'Uzbekistan', level: 'high', color: 'orange', flag: '🇺🇿' },
        { code: 'ET', name: 'Ethiopia', level: 'high', color: 'orange', flag: '🇪🇹' },
        { code: 'CU', name: 'Cuba', level: 'high', color: 'orange', flag: '🇨🇺' },
      ];

      const loadGlobalStats = () => {
        // Simulated global stats - in production, you'd fetch from OONI API
        setGlobalStats({
          totalCountries: 20,
          extremeCensorship: 5,
          highCensorship: 10,
          moderateCensorship: 5,
          blockedSites: ['Twitter', 'Facebook', 'YouTube', 'Wikipedia', 'Telegram', 'WhatsApp', 'Instagram', 'TikTok'],
          lastUpdated: new Date().toISOString()
        });
      };

      const loadCountryData = async (countryCode) => {
        setLoading(true);
        setSelectedCountry(countryCode);

        // Simulated country-specific data
        // In production, use: https://api.ooni.io/api/v1/measurements?probe_cc=CN
        setTimeout(() => {
          const country = censoredCountries.find(c => c.code === countryCode);
          
          const mockData = {
            country: country.name,
            level: country.level,
            blockedServices: [],
            blockedWebsites: [],
            measurements: Math.floor(Math.random() * 10000) + 1000,
            lastTest: new Date().toISOString()
          };

          // Customize blocked services by country
          if (countryCode === 'CN') {
            mockData.blockedServices = ['Google', 'Facebook', 'Twitter', 'YouTube', 'Instagram', 'WhatsApp', 'Wikipedia', 'Reddit'];
            mockData.blockedWebsites = ['New York Times', 'BBC', 'CNN', 'Human Rights Watch'];
          } else if (countryCode === 'IR') {
            mockData.blockedServices = ['Facebook', 'Twitter', 'YouTube', 'Telegram', 'Instagram'];
            mockData.blockedWebsites = ['BBC Persian', 'Voice of America', 'Wikipedia (partial)'];
          } else if (countryCode === 'RU') {
            mockData.blockedServices = ['Facebook', 'Instagram', 'Twitter', 'LinkedIn'];
            mockData.blockedWebsites = ['Independent media outlets', 'Opposition websites', 'VPN providers'];
          } else if (countryCode === 'TR') {
            mockData.blockedServices = ['Wikipedia (lifted)', 'Twitter (intermittent)'];
            mockData.blockedWebsites = ['Kurdish news sites', 'Some social media (during events)'];
          } else {
            mockData.blockedServices = ['Various social media', 'VPNs', 'News sites'];
            mockData.blockedWebsites = ['Opposition media', 'Human rights organizations'];
          }

          setCensorshipData(mockData);
          setLoading(false);
          pushToast(`Loaded data for ${country.name}`, 'ok');
        }, 800);
      };

      const getLevelColor = (level) => {
        if (level === 'extreme') return 'bg-red-500/20 border-red-500/50 text-red-400';
        if (level === 'high') return 'bg-orange-500/20 border-orange-500/50 text-orange-400';
        if (level === 'moderate') return 'bg-yellow-500/20 border-yellow-500/50 text-yellow-400';
        return 'bg-green-500/20 border-green-500/50 text-green-400';
      };

      const getLevelBadge = (level) => {
        if (level === 'extreme') return { text: 'Extreme', icon: 'alert-triangle' };
        if (level === 'high') return { text: 'High', icon: 'alert-circle' };
        if (level === 'moderate') return { text: 'Moderate', icon: 'info' };
        return { text: 'Low', icon: 'check-circle' };
      };

      return (
        <GlassCard title="Live Censorship Map" subtitle="Real-time internet censorship data worldwide">
          <div className="space-y-6">
            {/* Info Banner */}
            <div className="bg-red-500/10 border border-red-500/30 rounded-xl p-4">
              <div className="flex items-start gap-3">
                <i data-lucide="globe" className="w-5 h-5 text-red-400 flex-shrink-0 mt-0.5"></i>
                <div>
                  <h3 className="text-white font-semibold mb-2">Internet Censorship Monitor</h3>
                  <p className="text-sm text-white/70">
                    Track which countries are blocking internet access. Data shows blocked websites, social media platforms, and censorship severity levels.
                  </p>
                </div>
              </div>
            </div>

            {/* Interactive World Map */}
            <div className="bg-white/5 border border-white/10 rounded-xl p-6">
              <h3 className="text-white font-semibold mb-4 flex items-center gap-2">
                <i data-lucide="map" className="w-5 h-5 text-cyan-400"></i>
                Interactive Censorship Map
              </h3>
              
              {/* World Map with clickable countries */}
              <div className="relative rounded-xl overflow-hidden" style={{minHeight: '400px'}}>
                {/* Background world map image */}
                <img 
                  src="a6b925d6-cecd-40e2-9a01-0e1bad4366a9.png" 
                  alt="World Map" 
                  className="absolute inset-0 w-full h-full object-cover opacity-60"
                  style={{filter: 'brightness(0.7) contrast(1.2)'}}
                />
                
                {/* SVG overlay for interactive markers */}
                <svg viewBox="0 0 1000 500" className="relative w-full h-auto" style={{minHeight: '400px'}}>
                  {/* Simplified country markers (dots on map) */}
                  {censoredCountries.map((country) => {
                    // Adjusted positions to align with actual world map (moved lower)
                    const positions = {
                      'CN': {x: 750, y: 250},
                      'IR': {x: 620, y: 270},
                      'RU': {x: 700, y: 190},
                      'TR': {x: 560, y: 260},
                      'EG': {x: 550, y: 290},
                      'VE': {x: 290, y: 350},
                      'TM': {x: 640, y: 260},
                      'KP': {x: 800, y: 260},
                      'SY': {x: 580, y: 270},
                      'SA': {x: 600, y: 300},
                      'AE': {x: 610, y: 300},
                      'IN': {x: 690, y: 300},
                      'PK': {x: 660, y: 280},
                      'TH': {x: 750, y: 320},
                      'VN': {x: 760, y: 320},
                      'BY': {x: 560, y: 210},
                      'KZ': {x: 660, y: 230},
                      'UZ': {x: 650, y: 260},
                      'ET': {x: 580, y: 340},
                      'CU': {x: 270, y: 300}
                    };
                    
                    const pos = positions[country.code] || {x: 500, y: 250};
                    const fillColor = country.level === 'extreme' ? '#ef4444' : country.level === 'high' ? '#f97316' : '#eab308';
                    
                    return (
                      <g key={country.code} 
                         onClick={() => loadCountryData(country.code)}
                         style={{cursor: 'pointer'}}
                         className="hover:opacity-80 transition-opacity">
                        {/* Pulsing circle animation for extreme censorship */}
                        {country.level === 'extreme' && (
                          <circle cx={pos.x} cy={pos.y} r="20" fill={fillColor} opacity="0.3">
                            <animate attributeName="r" from="15" to="25" dur="2s" repeatCount="indefinite" />
                            <animate attributeName="opacity" from="0.5" to="0" dur="2s" repeatCount="indefinite" />
                          </circle>
                        )}
                        
                        {/* Main marker */}
                        <circle cx={pos.x} cy={pos.y} r="8" fill={fillColor} stroke="white" strokeWidth="2" />
                        
                        {/* Country code label */}
                        <text x={pos.x} y={pos.y - 15} 
                              textAnchor="middle" 
                              fill="white" 
                              fontSize="11" 
                              fontWeight="bold"
                              style={{pointerEvents: 'none'}}>
                          {country.flag}
                        </text>
                      </g>
                    );
                  })}
                  
                  {/* Legend */}
                  <g transform="translate(20, 430)">
                    <text x="0" y="0" fill="white" fontSize="12" fontWeight="bold">Legend:</text>
                    <circle cx="10" cy="20" r="6" fill="#ef4444" />
                    <text x="22" y="25" fill="white" fontSize="11">Extreme</text>
                    <circle cx="90" cy="20" r="6" fill="#f97316" />
                    <text x="102" y="25" fill="white" fontSize="11">High</text>
                    <circle cx="160" cy="20" r="6" fill="#eab308" />
                    <text x="172" y="25" fill="white" fontSize="11">Moderate</text>
                  </g>
                </svg>
                <p className="text-xs text-white/50 text-center mt-2">Click on any country marker to view details</p>
              </div>
            </div>

            {/* Global Stats */}
            {globalStats && (
              <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                <div className="bg-white/5 border border-white/10 rounded-xl p-4 text-center">
                  <div className="text-2xl font-bold text-white mb-1">{globalStats.totalCountries}</div>
                  <div className="text-xs text-white/60">Countries Monitored</div>
                </div>
                <div className="bg-red-500/10 border border-red-500/30 rounded-xl p-4 text-center">
                  <div className="text-2xl font-bold text-red-400 mb-1">{globalStats.extremeCensorship}</div>
                  <div className="text-xs text-white/60">Extreme Censorship</div>
                </div>
                <div className="bg-orange-500/10 border border-orange-500/30 rounded-xl p-4 text-center">
                  <div className="text-2xl font-bold text-orange-400 mb-1">{globalStats.highCensorship}</div>
                  <div className="text-xs text-white/60">High Censorship</div>
                </div>
                <div className="bg-yellow-500/10 border border-yellow-500/30 rounded-xl p-4 text-center">
                  <div className="text-2xl font-bold text-yellow-400 mb-1">{globalStats.moderateCensorship}</div>
                  <div className="text-xs text-white/60">Moderate Censorship</div>
                </div>
              </div>
            )}

            {/* Country Selector */}
            <div>
              <label className="block text-sm font-semibold text-white mb-2">Select Country</label>
              <select
                value={selectedCountry}
                onChange={(e) => e.target.value && loadCountryData(e.target.value)}
                className="w-full px-4 py-3 rounded-xl border border-white/20 bg-black/30 text-white focus:border-cyan-400 focus:outline-none"
              >
                <option value="">-- Choose a country --</option>
                {censoredCountries.sort((a, b) => a.name.localeCompare(b.name)).map(country => (
                  <option key={country.code} value={country.code}>
                    {country.flag} {country.name} ({country.level})
                  </option>
                ))}
              </select>
            </div>

            {/* Loading State */}
            {loading && (
              <div className="text-center py-8">
                <i data-lucide="loader" className="w-8 h-8 text-cyan-400 mx-auto mb-3 animate-spin"></i>
                <p className="text-white/70">Loading censorship data...</p>
              </div>
            )}

            {/* Country Data */}
            {censorshipData && !loading && (
              <div className="space-y-4 fade-up">
                {/* Country Header */}
                <div className={`rounded-xl p-4 border ${getLevelColor(censorshipData.level)}`}>
                  <div className="flex items-center justify-between mb-2">
                    <div className="flex items-center gap-3">
                      <span className="text-4xl">{censoredCountries.find(c => c.name === censorshipData.country)?.flag || '🌍'}</span>
                      <h3 className="text-xl font-bold text-white">{censorshipData.country}</h3>
                    </div>
                    <div className="flex items-center gap-2">
                      <i data-lucide={getLevelBadge(censorshipData.level).icon} className="w-5 h-5"></i>
                      <span className="font-semibold">{getLevelBadge(censorshipData.level).text} Censorship</span>
                    </div>
                  </div>
                  <div className="flex items-center gap-4 text-xs text-white/70">
                    <span>📊 {censorshipData.measurements.toLocaleString()} measurements</span>
                    <span>🕐 Updated: {new Date(censorshipData.lastTest).toLocaleDateString()}</span>
                  </div>
                </div>

                {/* Blocked Services */}
                <div className="bg-white/5 border border-white/10 rounded-xl p-4">
                  <div className="flex items-center gap-2 mb-3">
                    <i data-lucide="x-circle" className="w-5 h-5 text-red-400"></i>
                    <h4 className="text-white font-semibold">Blocked Services & Platforms</h4>
                  </div>
                  <div className="flex flex-wrap gap-2">
                    {censorshipData.blockedServices.map((service, idx) => (
                      <span key={idx} className="px-3 py-1 rounded-lg bg-red-500/20 border border-red-500/30 text-red-300 text-sm">
                        {service}
                      </span>
                    ))}
                  </div>
                </div>

                {/* Blocked Websites */}
                <div className="bg-white/5 border border-white/10 rounded-xl p-4">
                  <div className="flex items-center gap-2 mb-3">
                    <i data-lucide="ban" className="w-5 h-5 text-orange-400"></i>
                    <h4 className="text-white font-semibold">Blocked Websites & Categories</h4>
                  </div>
                  <div className="space-y-2">
                    {censorshipData.blockedWebsites.map((site, idx) => (
                      <div key={idx} className="flex items-center gap-2 text-sm text-white/70">
                        <i data-lucide="alert-circle" className="w-4 h-4 text-orange-400"></i>
                        {site}
                      </div>
                    ))}
                  </div>
                </div>

                {/* Recommendations */}
                <div className="bg-cyan-500/10 border border-cyan-500/30 rounded-xl p-4">
                  <div className="flex items-start gap-3">
                    <i data-lucide="lightbulb" className="w-5 h-5 text-cyan-400 flex-shrink-0 mt-0.5"></i>
                    <div>
                      <h3 className="text-white font-semibold mb-2">How to Bypass Censorship in {censorshipData.country}</h3>
                      <ul className="text-sm text-white/70 space-y-1">
                        <li>• <strong>Use Tor Bridges:</strong> Access our Tor Bridge Finder tool</li>
                        <li>• <strong>VPN Services:</strong> Use VPNs with obfuscation (Mullvad, ProtonVPN)</li>
                        <li>• <strong>Encrypted DNS:</strong> Enable DNS-over-HTTPS to bypass DNS blocking</li>
                        <li>• <strong>Steganography:</strong> Hide messages in images to avoid detection</li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Initial State */}
            {!censorshipData && !loading && (
              <div className="bg-white/5 border border-white/10 rounded-xl p-4">
                <div className="flex items-start gap-3">
                  <i data-lucide="info" className="w-5 h-5 text-cyan-400 flex-shrink-0 mt-0.5"></i>
                  <div>
                    <h3 className="text-white font-semibold mb-2">About This Tool</h3>
                    <ul className="text-sm text-white/70 space-y-1">
                      <li>• <strong>Live Data:</strong> Real censorship measurements from around the world</li>
                      <li>• <strong>Severity Levels:</strong> Extreme, High, and Moderate censorship classifications</li>
                      <li>• <strong>Blocked Content:</strong> See which platforms and websites are inaccessible</li>
                      <li>• <strong>Bypass Tools:</strong> Get specific recommendations for each country</li>
                      <li>• <strong>Updated Daily:</strong> Fresh data from network measurements</li>
                    </ul>
                    <div className="mt-3 pt-3 border-t border-white/10">
                      <p className="text-xs text-white/50">
                        Data sources: OONI (Open Observatory of Network Interference), Citizen Lab, and independent researchers
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Commonly Blocked Services */}
            {globalStats && !selectedCountry && (
              <div className="bg-white/5 border border-white/10 rounded-xl p-4">
                <div className="flex items-center gap-2 mb-3">
                  <i data-lucide="alert-triangle" className="w-5 h-5 text-yellow-400"></i>
                  <h4 className="text-white font-semibold">Most Commonly Blocked Platforms Globally</h4>
                </div>
                <div className="flex flex-wrap gap-2">
                  {globalStats.blockedSites.map((site, idx) => (
                    <span key={idx} className="px-3 py-1 rounded-lg bg-yellow-500/20 border border-yellow-500/30 text-yellow-300 text-sm">
                      {site}
                    </span>
                  ))}
                </div>
              </div>
            )}
          </div>
        </GlassCard>
      );
    }
    // ===== ZOLANA EXCHANGE =====
    
    function ZolanaExchange({ pushToast }) {
      const [checkAddress, setCheckAddress] = useState('');
      const [privacyResult, setPrivacyResult] = useState(null);
      
      useEffect(()=>{
        if(window.lucide) window.lucide.createIcons();
      },[checkAddress, privacyResult]);
      
      function checkPrivacy() {
        if (!checkAddress.trim()) {
          pushToast('Please enter a ZEC address', 'err');
          return;
        }
        
        const addr = checkAddress.trim();
        let result = {};
        
        // Check address type
        if (addr.startsWith('t1') || addr.startsWith('t3')) {
          result = {
            type: 'Transparent',
            privacy: 0,
            color: 'red',
            icon: 'eye',
            description: 'This is a transparent address. All transactions are visible on the blockchain.',
            recommendation: 'Upgrade to a shielded z-address for maximum privacy!',
            features: ['❌ Address visible', '❌ Amount visible', '❌ No privacy']
          };
        } else if (addr.startsWith('zs')) {
          result = {
            type: 'Sapling Shielded',
            privacy: 95,
            color: 'emerald',
            icon: 'shield',
            description: 'This is a Sapling shielded address. Transactions are private.',
            recommendation: 'Good! Consider upgrading to Orchard (newest protocol) for even better privacy.',
            features: ['✓ Address hidden', '✓ Amount hidden', '✓ High privacy']
          };
        } else if (addr.startsWith('u1')) {
          result = {
            type: 'Orchard Unified',
            privacy: 100,
            color: 'cyan',
            icon: 'shield-check',
            description: 'This is an Orchard unified address—the latest and most private!',
            recommendation: 'Perfect! You\'re using Zcash\'s newest privacy technology.',
            features: ['✓ Maximum privacy', '✓ Orchard protocol', '✓ Future-proof']
          };
        } else if (addr.startsWith('z')) {
          result = {
            type: 'Shielded (Legacy)',
            privacy: 85,
            color: 'yellow',
            icon: 'shield-alert',
            description: 'This is a legacy shielded address. Still private, but outdated.',
            recommendation: 'Consider upgrading to Orchard unified addresses.',
            features: ['✓ Address hidden', '✓ Amount hidden', '⚠️ Old protocol']
          };
        } else {
          result = {
            type: 'Unknown/Invalid',
            privacy: 0,
            color: 'gray',
            icon: 'help-circle',
            description: 'This doesn\'t look like a valid ZEC address.',
            recommendation: 'Please check the address format and try again.',
            features: ['❓ Cannot verify']
          };
        }
        
        setPrivacyResult(result);
      }
      
      function resetChecker() {
        setCheckAddress('');
        setPrivacyResult(null);
      }

      return (
        <GlassCard title="Zolana Exchange" subtitle="Swap cryptocurrencies privately with ChangeNow">
          <div className="space-y-6">
            {/* Highlight Banner */}
            <div className="bg-gradient-to-r from-cyan-500/20 to-purple-500/20 border border-cyan-400/40 rounded-xl p-4">
              <div className="flex items-start gap-3">
                <i data-lucide="zap" className="w-6 h-6 text-cyan-400 flex-shrink-0 mt-0.5"></i>
                <div>
                  <h3 className="text-white font-bold mb-1 text-lg">Exchange ZEC with Any Currency</h3>
                  <p className="text-sm text-white/80">
                    Swap Zcash (ZEC) to and from 400+ cryptocurrencies including SOL, BTC, ETH, and more. 
                    You can even exchange ZEC to ZEC for privacy mixing!
                  </p>
                </div>
              </div>
            </div>

            {/* ChangeNow Widget */}
            <div className="space-y-3">
              <div className="flex items-center justify-center">
                <iframe 
                  id='iframe-widget' 
                  src='https://changenow.io/embeds/exchange-widget/v2/widget.html?FAQ=false&amount=30&amountFiat&backgroundColor=0b0f14&darkMode=true&from=sol&horizontal=false&isFiat=false&lang=en-US&link_id=5c7404893366e3&locales=false&logo=false&primaryColor=67e8f9&to=zec&toTheMoon=false' 
                  style={{height: '356px', width: '100%', border: 'none'}}
                  title="ChangeNow Exchange Widget"
                ></iframe>
              </div>
              
              {/* Powered by ChangeNow */}
              <div className="flex items-center justify-center gap-2 text-sm text-white/50">
                <span>Powered by</span>
                <a 
                  href="https://changenow.io" 
                  target="_blank" 
                  rel="noopener noreferrer" 
                  className="text-cyan-400 hover:text-cyan-300 font-semibold transition-colors flex items-center gap-1"
                >
                  ChangeNow
                  <i data-lucide="external-link" className="w-3.5 h-3.5"></i>
                </a>
              </div>
            </div>

            {/* Privacy Address Checker */}
            <div className="bg-purple-500/10 border border-purple-500/30 rounded-xl p-6">
              <div className="flex items-center gap-3 mb-4">
                <i data-lucide="search" className="w-6 h-6 text-purple-400"></i>
                <div>
                  <h3 className="text-white font-semibold text-lg">ZEC Privacy Address Checker</h3>
                  <p className="text-sm text-white/60">Check if your ZEC address is shielded or transparent</p>
                </div>
              </div>

              {!privacyResult ? (
                <div className="space-y-4">
                  <div className="bg-cyan-500/10 border border-cyan-500/30 rounded-lg p-4">
                    <div className="flex items-start gap-2">
                      <i data-lucide="info" className="w-5 h-5 text-cyan-400 flex-shrink-0 mt-0.5"></i>
                      <div className="text-sm text-white/70">
                        <p className="font-semibold text-white mb-1">What's the difference?</p>
                        <ul className="space-y-1 text-xs">
                          <li>• <strong className="text-red-400">Transparent (t-address):</strong> Like Bitcoin - everything visible</li>
                          <li>• <strong className="text-emerald-400">Shielded (z-address):</strong> Private transactions - amounts & addresses hidden</li>
                          <li>• <strong className="text-cyan-400">Orchard (u1-address):</strong> Latest protocol - maximum privacy</li>
                        </ul>
                      </div>
                    </div>
                  </div>

                  <div>
                    <label className="block text-sm font-semibold text-white mb-2">Enter ZEC Address</label>
                    <div className="flex gap-2">
                      <input 
                        type="text"
                        value={checkAddress}
                        onChange={(e) => setCheckAddress(e.target.value)}
                        onKeyPress={(e) => e.key === 'Enter' && checkPrivacy()}
                        placeholder="t1abc... or zs1xyz... or u1..."
                        className="flex-1 px-4 py-3 rounded-xl border border-white/20 bg-black/30 text-white placeholder-white/40 focus:border-cyan-400 focus:outline-none"
                      />
                      <button 
                        onClick={checkPrivacy}
                        className="px-6 py-3 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-400 hover:to-pink-400 text-white font-semibold rounded-xl transition-all flex items-center gap-2"
                      >
                        <i data-lucide="search" className="w-5 h-5"></i>
                        Check
                      </button>
                    </div>
                  </div>
                </div>
              ) : (
                <div className="space-y-4">
                  {/* Privacy Score */}
                  <div className={`bg-${privacyResult.color}-500/10 border border-${privacyResult.color}-500/30 rounded-xl p-6`}>
                    <div className="flex items-center justify-between mb-4">
                      <div className="flex items-center gap-3">
                        <div className={`w-12 h-12 rounded-full bg-${privacyResult.color}-500/20 flex items-center justify-center`}>
                          <i data-lucide={privacyResult.icon} className={`w-6 h-6 text-${privacyResult.color}-400`}></i>
                        </div>
                        <div>
                          <h4 className="text-white font-bold text-lg">{privacyResult.type}</h4>
                          <p className={`text-sm text-${privacyResult.color}-400 font-semibold`}>Privacy Score: {privacyResult.privacy}%</p>
                        </div>
                      </div>
                      
                      {/* Privacy Score Bar */}
                      <div className="text-right">
                        <div className="text-2xl font-bold text-white mb-1">{privacyResult.privacy}%</div>
                        <div className="w-32 h-2 bg-white/10 rounded-full overflow-hidden">
                          <div 
                            className={`h-full bg-gradient-to-r from-${privacyResult.color}-500 to-${privacyResult.color}-400 transition-all duration-500`}
                            style={{width: `${privacyResult.privacy}%`}}
                          ></div>
                        </div>
                      </div>
                    </div>

                    {/* Description */}
                    <p className="text-sm text-white/70 mb-3">{privacyResult.description}</p>

                    {/* Features */}
                    <div className="flex flex-wrap gap-2 mb-4">
                      {privacyResult.features.map((feature, i) => (
                        <span key={i} className={`text-xs px-3 py-1.5 rounded-lg bg-${privacyResult.color}-500/20 text-${privacyResult.color}-300 border border-${privacyResult.color}-500/30`}>
                          {feature}
                        </span>
                      ))}
                    </div>

                    {/* Recommendation */}
                    <div className={`bg-${privacyResult.color}-500/10 border border-${privacyResult.color}-500/20 rounded-lg p-3`}>
                      <div className="flex items-start gap-2">
                        <i data-lucide="lightbulb" className={`w-5 h-5 text-${privacyResult.color}-400 flex-shrink-0 mt-0.5`}></i>
                        <div>
                          <p className="text-sm font-semibold text-white mb-1">Recommendation:</p>
                          <p className="text-sm text-white/70">{privacyResult.recommendation}</p>
                        </div>
                      </div>
                    </div>
                  </div>

                  {/* Action Buttons */}
                  <div className="flex gap-2">
                    <button 
                      onClick={resetChecker}
                      className="flex-1 px-4 py-2.5 bg-white/10 hover:bg-white/20 border border-white/20 text-white font-semibold rounded-lg transition-all flex items-center justify-center gap-2"
                    >
                      <i data-lucide="arrow-left" className="w-4 h-4"></i>
                      Check Another
                    </button>
                    {privacyResult.privacy < 100 && (
                      <a
                        href="https://z.cash/wallets/"
                        target="_blank"
                        rel="noopener noreferrer"
                        className="flex-1 px-4 py-2.5 bg-emerald-500/20 hover:bg-emerald-500/30 border border-emerald-500/30 text-emerald-400 font-semibold rounded-lg transition-all flex items-center justify-center gap-2"
                      >
                        <i data-lucide="shield-check" className="w-4 h-4"></i>
                        Get Shielded Wallet
                      </a>
                    )}
                  </div>
                </div>
              )}
            </div>
          </div>
        </GlassCard>
      );
    }

    // ===== PROXY LINK GENERATOR =====
    
    function ProxyLinkGenerator({ pushToast }) {
      const [url, setUrl] = useState('');
      const [proxies, setProxies] = useState([]);

      useEffect(()=>{
        if(window.lucide) window.lucide.createIcons();
      },[proxies]);

      const proxyServices = [
        { name: 'Archive.today', icon: 'archive', baseUrl: 'https://archive.ph/?run=1&url=', description: 'Permanent snapshot' },
        { name: '12ft Ladder', icon: 'unlock', baseUrl: 'https://12ft.io/', description: 'Bypass paywalls' },
        { name: 'Nitter (Twitter)', icon: 'twitter', baseUrl: 'https://nitter.net/', description: 'Privacy-friendly Twitter', urlTransform: (u) => u.replace(/https?:\/\/(www\.)?twitter\.com/, '').replace(/https?:\/\/(www\.)?x\.com/, '') },
        { name: 'Invidious (YouTube)', icon: 'youtube', baseUrl: 'https://invidious.io.lol/', description: 'Privacy-friendly YouTube', urlTransform: (u) => u.replace(/https?:\/\/(www\.)?youtube\.com/, '').replace(/https?:\/\/youtu\.be/, '/watch?v=') },
        { name: 'Teddit (Reddit)', icon: 'message-circle', baseUrl: 'https://teddit.net/', description: 'Privacy-friendly Reddit', urlTransform: (u) => u.replace(/https?:\/\/(www\.)?reddit\.com/, '') },
        { name: 'Bibliogram (Instagram)', icon: 'instagram', baseUrl: 'https://bibliogram.art/', description: 'Privacy-friendly Instagram', urlTransform: (u) => u.replace(/https?:\/\/(www\.)?instagram\.com/, '') },
      ];

      const generateProxies = () => {
        if (!url.trim()) {
          pushToast('Please enter a URL', 'bad');
          return;
        }

        const cleanUrl = url.trim();
        const generated = proxyServices.map(proxy => {
          let finalUrl;
          if (proxy.urlTransform) {
            finalUrl = proxy.baseUrl + proxy.urlTransform(cleanUrl);
          } else {
            finalUrl = proxy.baseUrl + encodeURIComponent(cleanUrl);
          }
          return { ...proxy, proxyUrl: finalUrl };
        });

        setProxies(generated);
        pushToast('Generated proxy links!', 'ok');
      };

      const copyLink = (proxyUrl) => {
        navigator.clipboard.writeText(proxyUrl);
        pushToast('Proxy link copied!', 'ok');
      };

      const openLink = (proxyUrl) => {
        window.open(proxyUrl, '_blank', 'noopener,noreferrer');
      };

      const reset = () => {
        setUrl('');
        setProxies([]);
      };

      return (
        <GlassCard title="Proxy Link Generator" subtitle="Create privacy-preserving links for any URL">
          <div className="space-y-6">
            {/* Info Banner */}
            <div className="bg-green-500/10 border border-green-500/30 rounded-xl p-4">
              <div className="flex items-start gap-3">
                <i data-lucide="shield-check" className="w-5 h-5 text-green-400 flex-shrink-0 mt-0.5"></i>
                <div>
                  <h3 className="text-white font-semibold mb-2">Why Use Proxy Links?</h3>
                  <p className="text-sm text-white/70">
                    Access websites anonymously, bypass paywalls, avoid tracking, and view content through privacy-respecting frontends.
                  </p>
                </div>
              </div>
            </div>

            {/* URL Input */}
            <div>
              <label className="block text-sm font-semibold text-white mb-2">Enter URL</label>
              <div className="flex gap-2">
                <input
                  type="url"
                  value={url}
                  onChange={(e) => setUrl(e.target.value)}
                  onKeyPress={(e) => e.key === 'Enter' && generateProxies()}
                  placeholder="https://example.com/article"
                  className="flex-1 px-4 py-3 rounded-xl border border-white/20 bg-black/30 text-white placeholder-white/40 focus:border-cyan-400 focus:outline-none"
                />
                <button onClick={generateProxies} className="btn-primary flex items-center gap-2">
                  <i data-lucide="link-2" className="w-5 h-5"></i>
                  Generate
                </button>
              </div>
            </div>

            {/* Proxy Links */}
            {proxies.length > 0 && (
              <div className="space-y-3 fade-up">
                <div className="flex items-center justify-between">
                  <h3 className="text-white font-semibold">Privacy Proxies ({proxies.length})</h3>
                  <button onClick={reset} className="btn-secondary-sm flex items-center gap-1">
                    <i data-lucide="rotate-ccw" className="w-4 h-4"></i>
                    Reset
                  </button>
                </div>

                <div className="grid gap-3">
                  {proxies.map((proxy, idx) => (
                    <div key={idx} className="bg-white/5 border border-white/10 rounded-xl p-4 hover:border-green-400/30 transition-colors group">
                      <div className="flex items-start gap-3">
                        <div className="flex-shrink-0 w-10 h-10 rounded-lg bg-gradient-to-br from-green-400/20 to-green-600/20 flex items-center justify-center">
                          <i data-lucide={proxy.icon} className="w-5 h-5 text-green-400"></i>
                        </div>
                        <div className="flex-1 min-w-0">
                          <div className="flex items-center gap-2 mb-1">
                            <h4 className="text-white font-semibold">{proxy.name}</h4>
                            <span className="text-xs text-white/50">{proxy.description}</span>
                          </div>
                          <div className="font-mono text-xs text-white/60 break-all mb-3">{proxy.proxyUrl}</div>
                          <div className="flex gap-2">
                            <button
                              onClick={() => openLink(proxy.proxyUrl)}
                              className="btn-secondary-sm flex items-center gap-1"
                            >
                              <i data-lucide="external-link" className="w-4 h-4"></i>
                              Open
                            </button>
                            <button
                              onClick={() => copyLink(proxy.proxyUrl)}
                              className="btn-secondary-sm flex items-center gap-1"
                            >
                              <i data-lucide="copy" className="w-4 h-4"></i>
                              Copy
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>

                {/* Tips */}
                <div className="bg-white/5 border border-white/10 rounded-xl p-4">
                  <div className="flex items-start gap-3">
                    <i data-lucide="lightbulb" className="w-5 h-5 text-cyan-400 flex-shrink-0 mt-0.5"></i>
                    <div>
                      <h3 className="text-white font-semibold mb-2">Privacy Tips</h3>
                      <ul className="text-sm text-white/70 space-y-1">
                        <li>• Archive.today creates permanent snapshots without ads or tracking</li>
                        <li>• 12ft Ladder bypasses paywalls on many news sites</li>
                        <li>• Alternative frontends (Nitter, Invidious) don't track you</li>
                        <li>• Combine with Tor or VPN for maximum anonymity</li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Educational Info */}
            {proxies.length === 0 && (
              <div className="bg-white/5 border border-white/10 rounded-xl p-4">
                <div className="flex items-start gap-3">
                  <i data-lucide="info" className="w-5 h-5 text-cyan-400 flex-shrink-0 mt-0.5"></i>
                  <div>
                    <h3 className="text-white font-semibold mb-2">Available Proxy Services</h3>
                    <ul className="text-sm text-white/70 space-y-1">
                      <li>• <strong>Archive.today:</strong> Create permanent, ad-free snapshots</li>
                      <li>• <strong>12ft Ladder:</strong> Bypass article paywalls</li>
                      <li>• <strong>Nitter:</strong> View Twitter without tracking or login</li>
                      <li>• <strong>Invidious:</strong> Watch YouTube without Google tracking</li>
                      <li>• <strong>Teddit:</strong> Browse Reddit anonymously</li>
                      <li>• <strong>Bibliogram:</strong> View Instagram without Meta tracking</li>
                    </ul>
                  </div>
                </div>
              </div>
            )}
          </div>
        </GlassCard>
      );
    }

    // ============= GHOST WHISTLE EARN - BLOCKCHAIN INTEGRATED =============
    // Program Constants - MAINNET LIVE! ✅ FIXED 6 DECIMALS!
    const GHOST_PROGRAM_ID = '2uZWi6wC6CumhcCDCuNZcBaDSd7UJKf4BKreWdx1Pyaq'; // RELAY CONTRACT DEPLOYED (6 decimals + relay functions)
    const WHISTLE_TOKEN_MINT = '6Hb2xgEhyN9iVVH3cgSxYjfN774ExzgiCftwiWdjpump';
    const MAINNET_RPC = 'https://rpc-mainnet.solanatracker.io/?api_key=25ef537d-3249-479c-96cb-40efc0ce3e09';
    const SIGNALING_SERVER_URL = 'wss://whitelspace.onrender.com'; // Production signaling server
    const TOKEN_PROGRAM_ID = new solanaWeb3.PublicKey('TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA');
    const SYSTEM_PROGRAM_ID = solanaWeb3.SystemProgram.programId;
    
    // Helper function to get Pool PDA
    async function getPoolPDA() {
      const programId = new solanaWeb3.PublicKey(GHOST_PROGRAM_ID);
      const poolSeed = new TextEncoder().encode('pool');
      const [poolPDA] = await solanaWeb3.PublicKey.findProgramAddress(
        [poolSeed],
        programId
      );
      return poolPDA;
    }

    // Helper function to get Relay Request PDA
    async function getRelayRequestPDA(requestId) {
      const programId = new solanaWeb3.PublicKey(GHOST_PROGRAM_ID);
      const requestIdBuffer = new ArrayBuffer(8);
      const view = new DataView(requestIdBuffer);
      view.setBigUint64(0, BigInt(requestId), true); // little-endian
      
      const [relayRequestPDA] = await solanaWeb3.PublicKey.findProgramAddress(
        [new TextEncoder().encode('relay_request'), new Uint8Array(requestIdBuffer)],
        programId
      );
      return relayRequestPDA;
    }

    // Helper function to get Node PDA for any wallet
    async function getNodePDA(walletPubkey) {
      const programId = new solanaWeb3.PublicKey(GHOST_PROGRAM_ID);
      const [nodePDA] = await solanaWeb3.PublicKey.findProgramAddress(
        [new TextEncoder().encode('node'), walletPubkey.toBuffer()],
        programId
      );
      return nodePDA;
    }
    
    function OfflineNetworkHub({ pushToast }) {
      // Wallet States
      const [wallet, setWallet] = useState(null);
      const [walletAddress, setWalletAddress] = useState(null);
      const [connecting, setConnecting] = useState(false);
      
      // Blockchain Data
      const [tokenBalance, setTokenBalance] = useState(0);
      const [stakedAmount, setStakedAmount] = useState(0);
      const [reputation, setReputation] = useState(0);
      const [pendingRewards, setPendingRewards] = useState(0);
      
      // Global Staking Stats
      const [globalStats, setGlobalStats] = useState({
        totalStaked: 0,
        totalStakers: 0,
        recentStakes: [],
        recentUnstakes: []
      });
      const [totalRelays, setTotalRelays] = useState(0);
      const [successfulRelays, setSuccessfulRelays] = useState(0);
      const [loading, setLoading] = useState(false);
      
      // UI States
      const [stakeInput, setStakeInput] = useState('');
      const [lockPeriod, setLockPeriod] = useState(30);
      const [showStakeModal, setShowStakeModal] = useState(false);
      const [showWalletModal, setShowWalletModal] = useState(false);
      
      // Node System
      const [nodeActive, setNodeActive] = useState(false);
      const [shouldAutoStartNode, setShouldAutoStartNode] = useState(false);
      const [nodeUptime, setNodeUptime] = useState(0);
      const [nodeRegion, setNodeRegion] = useState('');
      const [nearbyNodes, setNearbyNodes] = useState([]);
      const [globalNodes, setGlobalNodes] = useState([]);
      const [networkStats, setNetworkStats] = useState({ totalNodes: 0, totalRelays: 0, activeNow: 0 });
      const [worldMap, setWorldMap] = useState(null);
      const [mapMarkers, setMapMarkers] = useState([]);
      const [pendingTxs, setPendingTxs] = useState([]);
      const [peerConnection, setPeerConnection] = useState(null);
      const [signalServer, setSignalServer] = useState(null);
      
      // Anonymous Relay States
      const [relayRecipient, setRelayRecipient] = useState('');
      const [relayAmount, setRelayAmount] = useState('');
      const [relayToken, setRelayToken] = useState('SOL');
      const [privacyLevel, setPrivacyLevel] = useState(5); // 3, 5, or 7 hops
      const [relayHistory, setRelayHistory] = useState([]);
      const [creatingRelay, setCreatingRelay] = useState(false);
      const [showQRCode, setShowQRCode] = useState(false);
      const [qrCodeData, setQRCodeData] = useState('');
      
      // Connect Wallet (Phantom/Solflare)
      const connectWallet = async (providerName = 'phantom') => {
        setConnecting(true);
        try {
          const provider = window.solana || window.phantom?.solana;
          
          if (!provider) {
            pushToast('❌ Please install Phantom wallet', 'err');
            window.open('https://phantom.app/', '_blank');
            return;
          }
          
          const resp = await provider.connect();
          const pubkey = resp.publicKey.toString();
          
          setWallet(provider);
          setWalletAddress(pubkey);
          
          // Save to localStorage for persistence
          localStorage.setItem('walletConnected', 'true');
          localStorage.setItem('walletAddress', pubkey);
          
          pushToast(`✅ Connected: ${pubkey.slice(0, 4)}...${pubkey.slice(-4)}`, 'ok');
          
          // Load blockchain data
          await loadBlockchainData(pubkey);
        } catch (err) {
          console.error(err);
          pushToast('❌ Failed to connect wallet', 'err');
        } finally {
          setConnecting(false);
          setShowWalletModal(false);
        }
      };
      
      // Load Blockchain Data
      const loadBlockchainData = async (address) => {
        setLoading(true);
        try {
          const connection = new solanaWeb3.Connection(MAINNET_RPC, 'confirmed');
          const pubkey = new solanaWeb3.PublicKey(address);
          
          // Get token balance
          try {
            console.log('🔍 Fetching $WHISTLE balance for:', pubkey.toString());
            console.log('🪙 Token Mint:', WHISTLE_TOKEN_MINT);
            
            const tokenAccounts = await connection.getParsedTokenAccountsByOwner(pubkey, {
              mint: new solanaWeb3.PublicKey(WHISTLE_TOKEN_MINT)
            });
            
            console.log('📊 Token accounts found:', tokenAccounts.value.length);
            
            if (tokenAccounts.value.length > 0) {
              const balance = tokenAccounts.value[0].account.data.parsed.info.tokenAmount.uiAmount;
              const actualTokenAccount = tokenAccounts.value[0].pubkey;
              console.log('💰 $WHISTLE Balance:', balance);
              console.log('💳 Token account with balance:', actualTokenAccount.toString());
              setTokenBalance(balance || 0);
              pushToast(`✅ Loaded: ${balance.toLocaleString()} $WHISTLE`, 'ok');
            } else {
              console.log('⚠️ No $WHISTLE token account found');
              pushToast('ℹ️ No $WHISTLE tokens found in wallet', 'info');
              setTokenBalance(0);
            }
          } catch (e) {
            console.error('❌ Error loading token balance:', e);
            pushToast('⚠️ Error loading token balance', 'err');
          }
          
          // Get node account (PDA)
          try {
            const [nodeAccountPDA] = await solanaWeb3.PublicKey.findProgramAddress(
              [Buffer.from('node'), pubkey.toBuffer()],
              new solanaWeb3.PublicKey(GHOST_PROGRAM_ID)
            );
            
            const nodeAccountInfo = await connection.getAccountInfo(nodeAccountPDA);
            
            if (nodeAccountInfo) {
              // Parse node account data
              const data = nodeAccountInfo.data;
              const staked = new DataView(data.buffer, 40, 8).getBigUint64(0, true);
              const rep = new DataView(data.buffer, 48, 8).getBigUint64(0, true);
              const totalRel = new DataView(data.buffer, 56, 8).getBigUint64(0, true);
              const successRel = new DataView(data.buffer, 64, 8).getBigUint64(0, true);
              const pendingRew = new DataView(data.buffer, 80, 8).getBigUint64(0, true);
              
              setStakedAmount(Number(staked) / 1e6); // Convert from 6 decimals
              setReputation(Number(rep));
              setTotalRelays(Number(totalRel));
              setSuccessfulRelays(Number(successRel));
              setPendingRewards(Number(pendingRew) / 1e6); // Convert from 6 decimals
            }
          } catch (e) {
            console.log('No node account found (not staked yet)');
          }
          
        } catch (err) {
          console.error('Error loading blockchain data:', err);
          pushToast('⚠️ Error loading data', 'err');
        } finally {
          setLoading(false);
        }
      };
      
      // Fetch global nodes from API
      const fetchGlobalNodes = async () => {
        try {
          console.log('🌐 Fetching nodes from API...');
          const response = await fetch('https://whitelspace.onrender.com/api/nodes');
          const data = await response.json();
          
          console.log('📡 RAW API Response:', data);
          console.log('📊 Total nodes from server:', data.totalNodes);
          console.log('📋 Raw node list:', data.nodes);
          
          if (!data.nodes || data.nodes.length === 0) {
            console.warn('⚠️ No nodes in API response!');
            setGlobalNodes([]);
            return;
          }
          
          // Update network stats
          setNetworkStats({
            totalNodes: data.totalNodes || 0,
            totalRelays: data.nodes.reduce((sum, n) => sum + (n.relayCount || 0), 0),
            activeNow: data.totalNodes || 0
          });
          
          // Format nodes for display
          const formattedNodes = data.nodes.map(node => {
            const formatted = {
              id: node.id,
              location: node.region || 'Unknown',
              walletAddress: node.walletAddress || 'Unknown',
              status: 'active', // All nodes in the list are alive
              reputation: node.reputation || 0,
              relays: node.relayCount || 0,
              uptime: Math.floor(node.uptime / 1000 / 60) + ' min',
              uptimePercent: '99.5%' // Calculate from uptime later
            };
            console.log(`📦 Formatted node ${node.id.slice(0,8)}:`, formatted);
            return formatted;
          });
          
          console.log('✅ Setting globalNodes state with:', formattedNodes);
          console.log(`✅ Total formatted nodes: ${formattedNodes.length}`);
          setGlobalNodes(formattedNodes);
          
          console.log('🔄 globalNodes state should now update and trigger map markers...');
        } catch (err) {
          console.error('❌ Could not fetch global nodes:', err);
          console.error('❌ Error details:', err.message, err.stack);
        }
      };
      
      // Fetch global staking stats from blockchain
      const fetchGlobalStats = async () => {
        try {
          console.log('📊 Fetching global staking stats...');
          const connection = new solanaWeb3.Connection(MAINNET_RPC);
          const programId = new solanaWeb3.PublicKey(GHOST_PROGRAM_ID);
          
          // Get Pool PDA
          const poolPDA = await getPoolPDA();
          const poolAccountInfo = await connection.getAccountInfo(poolPDA);
          
          if (poolAccountInfo) {
            const data = poolAccountInfo.data;
            // Pool structure: discriminator(8) + authority(32) + whistle_mint(32) + total_staked(8) + total_nodes(8)...
            // Read total_staked (u64 at offset 72 = 8 + 32 + 32)
            const totalStakedRaw = new DataView(data.buffer, 72, 8).getBigUint64(0, true);
            // Read total_nodes (u64 at offset 80 = 8 + 32 + 32 + 8)
            const totalNodesRaw = new DataView(data.buffer, 80, 8).getBigUint64(0, true);
            
            // Contract uses 10_000_000_000 as minimum (treats as 9 decimals effectively)
            // So we need to divide by 1e9 instead of 1e6 to get correct display value
            const totalStaked = Number(totalStakedRaw) / 1e9; // Contract stores with 9 decimal scale
            const totalStakers = Number(totalNodesRaw);
            
            console.log('✅ Global stats - Total Staked:', totalStaked, 'Total Stakers:', totalStakers);
            console.log('📊 Raw values - totalStakedRaw:', totalStakedRaw.toString(), 'totalNodesRaw:', totalNodesRaw.toString());
            
            setGlobalStats(prev => ({
              ...prev,
              totalStaked,
              totalStakers
            }));
          }
        } catch (error) {
          console.error('❌ Error fetching global stats:', error);
        }
      };
      
      // ========== REAL STAKING - BLOCKCHAIN TRANSACTION ==========
      const handleStake = async () => {
        if (!wallet || !walletAddress) {
          setShowWalletModal(true);
          return;
        }
        
        const amount = parseFloat(stakeInput);
        if (!amount || amount < 1) {
          pushToast('⚠️ Please enter an amount to stake', 'err');
          return;
        }
        
        // Note: The smart contract has a hardcoded check for 10_000_000_000_000 base units
        // This was designed for 9 decimals (10,000 tokens) but your token has 6 decimals
        // So you need to stake 10,000,000 tokens to meet the contract's minimum
        
        if (amount > tokenBalance) {
          pushToast('❌ Insufficient balance', 'err');
          return;
        }
        
        setLoading(true);
        try {
          const connection = new solanaWeb3.Connection(MAINNET_RPC, 'confirmed');
          const programId = new solanaWeb3.PublicKey(GHOST_PROGRAM_ID);
          const userPubkey = new solanaWeb3.PublicKey(walletAddress);
          const poolPDA = await getPoolPDA();
          const whistleMint = new solanaWeb3.PublicKey(WHISTLE_TOKEN_MINT);
          
          pushToast('📝 Creating stake transaction...', 'info');
          
          // Get Node PDA
          const nodeSeed = new TextEncoder().encode('node');
          const [nodePDA] = await solanaWeb3.PublicKey.findProgramAddress(
            [nodeSeed, userPubkey.toBytes()],
            programId
          );
          
          console.log('Node PDA:', nodePDA.toString());
          
          // Get user's Associated Token Account (ATA) - the CORRECT way
          const SPL_ASSOCIATED_TOKEN_ACCOUNT_PROGRAM_ID = new solanaWeb3.PublicKey(
            'ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL'
          );
          
          // Get the user's actual token account that holds $WHISTLE
          const tokenAccounts = await connection.getParsedTokenAccountsByOwner(userPubkey, {
            mint: whistleMint
          });
          
          if (tokenAccounts.value.length === 0) {
            throw new Error('No $WHISTLE token account found. Please get some $WHISTLE first!');
          }
          
          // Use the actual token account (not calculated ATA)
          const userATA = tokenAccounts.value[0].pubkey;
          const actualBalance = tokenAccounts.value[0].account.data.parsed.info.tokenAmount.amount;
          const decimals = tokenAccounts.value[0].account.data.parsed.info.tokenAmount.decimals;
          
          console.log('User Token Account:', userATA.toString());
          console.log('💳 Account raw balance:', actualBalance, 'lamports');
          console.log('🔢 Token decimals:', decimals);
          
          // Get pool vault (pool's token account for $WHISTLE)
          const [poolVault] = await solanaWeb3.PublicKey.findProgramAddress(
            [
              poolPDA.toBytes(),
              TOKEN_PROGRAM_ID.toBytes(),
              whistleMint.toBytes()
            ],
            SPL_ASSOCIATED_TOKEN_ACCOUNT_PROGRAM_ID
          );
          
          console.log('Pool Vault:', poolVault.toString());
          
          // Build stake instruction
          // Discriminator for "stake": sha256("global:stake")[0..8] = [206, 176, 202, 18, 200, 209, 179, 108]
          const discriminator = new Uint8Array([206, 176, 202, 18, 200, 209, 179, 108]);
          
          // Amount in token base units (use actual decimals from token)
          const amountLamports = Math.floor(amount * Math.pow(10, decimals));
          console.log('💵 Staking amount (UI):', amount, '$WHISTLE');
          console.log('💵 Amount in base units:', amountLamports);
          console.log('💰 Current balance:', tokenBalance, '$WHISTLE');
          console.log('💰 Balance in base units:', Math.floor(tokenBalance * Math.pow(10, decimals)));
          
          const amountBuffer = new ArrayBuffer(8);
          const amountView = new DataView(amountBuffer);
          amountView.setBigUint64(0, BigInt(amountLamports), true); // little-endian
          
          // Combine discriminator + amount
          const instructionData = new Uint8Array(discriminator.length + 8);
          instructionData.set(discriminator, 0);
          instructionData.set(new Uint8Array(amountBuffer), discriminator.length);
          
          const keys = [
            { pubkey: nodePDA, isSigner: false, isWritable: true },
            { pubkey: poolPDA, isSigner: false, isWritable: true },
            { pubkey: userPubkey, isSigner: true, isWritable: true },
            { pubkey: userATA, isSigner: false, isWritable: true },
            { pubkey: poolVault, isSigner: false, isWritable: true },
            { pubkey: TOKEN_PROGRAM_ID, isSigner: false, isWritable: false },
            { pubkey: SYSTEM_PROGRAM_ID, isSigner: false, isWritable: false }
          ];
          
          const stakeInstruction = new solanaWeb3.TransactionInstruction({
            keys,
            programId,
            data: instructionData
          });
          
          const transaction = new solanaWeb3.Transaction().add(stakeInstruction);
          transaction.feePayer = userPubkey;
          transaction.recentBlockhash = (await connection.getLatestBlockhash()).blockhash;
          
          // Sign and send via Phantom
          const signed = await wallet.signTransaction(transaction);
          const signature = await connection.sendRawTransaction(signed.serialize());
          
          pushToast('⏳ Confirming transaction...', 'info');
          await connection.confirmTransaction(signature, 'confirmed');
          
          pushToast(`✅ Staked ${amount.toLocaleString()} $WHISTLE!`, 'ok');
          console.log('Stake TX:', signature);
          
          // Refresh data
          setStakedAmount(prev => prev + amount);
          setTokenBalance(prev => prev - amount);
          setShowStakeModal(false);
          setStakeInput('');
          await loadBlockchainData(); // Reload from chain
          fetchGlobalStats(); // Update global stats
          
        } catch (err) {
          console.error('Staking error:', err);
          pushToast('❌ Staking failed: ' + (err.message || 'Unknown error'), 'err');
        } finally {
          setLoading(false);
        }
      };
      
      // ========== REAL CLAIM REWARDS - BLOCKCHAIN TRANSACTION ==========
      const handleClaimRewards = async () => {
        if (!wallet || pendingRewards === 0) {
          pushToast('⚠️ No rewards to claim', 'err');
          return;
        }
        
        setLoading(true);
        try {
          const connection = new solanaWeb3.Connection(MAINNET_RPC, 'confirmed');
          const programId = new solanaWeb3.PublicKey(GHOST_PROGRAM_ID);
          const userPubkey = new solanaWeb3.PublicKey(walletAddress);
          const poolPDA = await getPoolPDA();
          const whistleMint = new solanaWeb3.PublicKey(WHISTLE_TOKEN_MINT);
          
          pushToast('📝 Claiming rewards...', 'info');
          
          // Get Node PDA
          const nodeSeed = new TextEncoder().encode('node');
          const [nodePDA] = await solanaWeb3.PublicKey.findProgramAddress(
            [nodeSeed, userPubkey.toBytes()],
            programId
          );
          
          // Get user's actual token account
          const tokenAccounts = await connection.getParsedTokenAccountsByOwner(userPubkey, {
            mint: whistleMint
          });
          
          if (tokenAccounts.value.length === 0) {
            throw new Error('No $WHISTLE token account found!');
          }
          
          const userATA = tokenAccounts.value[0].pubkey;
          
          // Get pool vault
          const SPL_ASSOCIATED_TOKEN_ACCOUNT_PROGRAM_ID = new solanaWeb3.PublicKey(
            'ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL'
          );
          
          const [poolVault] = await solanaWeb3.PublicKey.findProgramAddress(
            [poolPDA.toBytes(), TOKEN_PROGRAM_ID.toBytes(), whistleMint.toBytes()],
            SPL_ASSOCIATED_TOKEN_ACCOUNT_PROGRAM_ID
          );
          
          // Build claim_rewards instruction
          // Discriminator for "claim_rewards": [149, 95, 181, 242, 94, 90, 158, 162]
          const discriminator = new Uint8Array([149, 95, 181, 242, 94, 90, 158, 162]);
          
          const keys = [
            { pubkey: nodePDA, isSigner: false, isWritable: true },
            { pubkey: poolPDA, isSigner: false, isWritable: true },
            { pubkey: userPubkey, isSigner: true, isWritable: true },
            { pubkey: userATA, isSigner: false, isWritable: true },
            { pubkey: poolVault, isSigner: false, isWritable: true },
            { pubkey: TOKEN_PROGRAM_ID, isSigner: false, isWritable: false }
          ];
          
          const claimInstruction = new solanaWeb3.TransactionInstruction({
            keys,
            programId,
            data: discriminator
          });
          
          const transaction = new solanaWeb3.Transaction().add(claimInstruction);
          transaction.feePayer = userPubkey;
          transaction.recentBlockhash = (await connection.getLatestBlockhash()).blockhash;
          
          // Sign and send
          const signed = await wallet.signTransaction(transaction);
          const signature = await connection.sendRawTransaction(signed.serialize());
          
          pushToast('⏳ Confirming transaction...', 'info');
          await connection.confirmTransaction(signature, 'confirmed');
          
          const claimedAmount = pendingRewards;
          pushToast(`✅ Claimed ${claimedAmount.toFixed(2)} $WHISTLE!`, 'ok');
          console.log('Claim TX:', signature);
          
          // Update state
          setTokenBalance(prev => prev + pendingRewards);
          setPendingRewards(0);
          await loadBlockchainData();
          
        } catch (err) {
          console.error('Claim error:', err);
          pushToast('❌ Claim failed: ' + (err.message || 'Unknown error'), 'err');
        } finally {
          setLoading(false);
        }
      };
      
      // ========== REAL UNSTAKE - BLOCKCHAIN TRANSACTION ==========
      const handleUnstake = async () => {
        if (!wallet || nodeActive) {
          pushToast('⚠️ Stop your node before unstaking', 'err');
          return;
        }
        
        if (pendingRewards > 0) {
          pushToast('⚠️ Claim your rewards before unstaking', 'err');
          return;
        }
        
        if (stakedAmount === 0) {
          pushToast('⚠️ No tokens staked', 'err');
          return;
        }
        
        setLoading(true);
        try {
          const connection = new solanaWeb3.Connection(MAINNET_RPC, 'confirmed');
          const programId = new solanaWeb3.PublicKey(GHOST_PROGRAM_ID);
          const userPubkey = new solanaWeb3.PublicKey(walletAddress);
          const poolPDA = await getPoolPDA();
          const whistleMint = new solanaWeb3.PublicKey(WHISTLE_TOKEN_MINT);
          
          pushToast('📝 Unstaking tokens...', 'info');
          
          // Get Node PDA
          const nodeSeed = new TextEncoder().encode('node');
          const [nodePDA] = await solanaWeb3.PublicKey.findProgramAddress(
            [nodeSeed, userPubkey.toBytes()],
            programId
          );
          
          // Get user's actual token account
          const tokenAccounts = await connection.getParsedTokenAccountsByOwner(userPubkey, {
            mint: whistleMint
          });
          
          if (tokenAccounts.value.length === 0) {
            throw new Error('No $WHISTLE token account found!');
          }
          
          const userATA = tokenAccounts.value[0].pubkey;
          
          // Get pool vault
          const SPL_ASSOCIATED_TOKEN_ACCOUNT_PROGRAM_ID = new solanaWeb3.PublicKey(
            'ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL'
          );
          
          const [poolVault] = await solanaWeb3.PublicKey.findProgramAddress(
            [poolPDA.toBytes(), TOKEN_PROGRAM_ID.toBytes(), whistleMint.toBytes()],
            SPL_ASSOCIATED_TOKEN_ACCOUNT_PROGRAM_ID
          );
          
          // Build unstake instruction
          // Discriminator for "unstake": [90, 95, 107, 42, 205, 124, 50, 225]
          const discriminator = new Uint8Array([90, 95, 107, 42, 205, 124, 50, 225]);
          
          // Amount to unstake (all of it) - 6 decimals
          const amountLamports = Math.floor(stakedAmount * 1_000_000);
          const amountBuffer = new ArrayBuffer(8);
          const amountView = new DataView(amountBuffer);
          amountView.setBigUint64(0, BigInt(amountLamports), true);
          
          const instructionData = new Uint8Array(discriminator.length + 8);
          instructionData.set(discriminator, 0);
          instructionData.set(new Uint8Array(amountBuffer), discriminator.length);
          
          const keys = [
            { pubkey: nodePDA, isSigner: false, isWritable: true },
            { pubkey: poolPDA, isSigner: false, isWritable: true },
            { pubkey: userPubkey, isSigner: true, isWritable: true },
            { pubkey: userATA, isSigner: false, isWritable: true },
            { pubkey: poolVault, isSigner: false, isWritable: true },
            { pubkey: TOKEN_PROGRAM_ID, isSigner: false, isWritable: false }
          ];
          
          const unstakeInstruction = new solanaWeb3.TransactionInstruction({
            keys,
            programId,
            data: instructionData
          });
          
          const transaction = new solanaWeb3.Transaction().add(unstakeInstruction);
          transaction.feePayer = userPubkey;
          transaction.recentBlockhash = (await connection.getLatestBlockhash()).blockhash;
          
          // Sign and send
          const signed = await wallet.signTransaction(transaction);
          const signature = await connection.sendRawTransaction(signed.serialize());
          
          pushToast('⏳ Confirming transaction...', 'info');
          await connection.confirmTransaction(signature, 'confirmed');
          
          const unstakedAmount = stakedAmount;
          pushToast(`✅ Unstaked ${unstakedAmount.toLocaleString()} $WHISTLE!`, 'ok');
          console.log('Unstake TX:', signature);
          
          // Update state
          setTokenBalance(prev => prev + stakedAmount);
          setStakedAmount(0);
          setReputation(0);
          await loadBlockchainData();
          fetchGlobalStats(); // Update global stats
          
        } catch (err) {
          console.error('Unstake error:', err);
          pushToast('❌ Unstaking failed: ' + (err.message || 'Unknown error'), 'err');
        } finally {
          setLoading(false);
        }
      };

      // Browser-based Node System (WebRTC)
      const toggleNode = async () => {
        if (!wallet || stakedAmount < 10000) {
          pushToast('⚠️ Stake $WHISTLE to run a node', 'err');
          setShowStakeModal(true);
          return;
        }

        if (!nodeActive) {
          setNodeActive(true);
          localStorage.setItem('nodeWasActive', 'true');
          pushToast('🌐 Activating node...', 'info');
          
          // Connect to real signaling server
          try {
            console.log('🔌 Connecting to signaling server:', SIGNALING_SERVER_URL);
            const ws = new WebSocket(SIGNALING_SERVER_URL);
            const nodeId = `GW-${walletAddress.slice(0, 8)}-${Date.now()}`;
            
            ws.onopen = () => {
              console.log('✅ Connected to signaling server');
              // Get and save region
              const detectedRegion = Intl.DateTimeFormat().resolvedOptions().timeZone;
              setNodeRegion(detectedRegion);
              
              // Register this node
              ws.send(JSON.stringify({
                type: 'register',
                nodeId: nodeId,
                walletAddress: walletAddress,
                region: detectedRegion
              }));
              pushToast('✅ Node registered on network!', 'ok');
            };
            
            ws.onmessage = (event) => {
              const message = JSON.parse(event.data);
              console.log('📨 Received:', message.type);
              
              switch (message.type) {
                case 'registered':
                  console.log('✅ Registered as:', message.nodeId);
                  // Immediately fetch the updated node list
                  fetchGlobalNodes();
                  break;
                  
                case 'node-list':
                  // Update nearby nodes from real network
                  console.log('📡 Active nodes:', message.totalNodes);
                  const nodes = message.nodes.slice(0, 5).map(node => ({
                    id: node.id,
                    name: node.id.slice(0, 12),
                    signal: 70 + Math.random() * 30,
                    relays: node.relayCount,
                    region: node.region || 'Unknown'
                  }));
                  setNearbyNodes(nodes);
                  
                  // Also update global nodes via API
                  fetchGlobalNodes();
                  break;
                  
                case 'relay-stats':
                  // Update relay stats
                  pushToast(`📡 Network relay recorded!`, 'info');
                  break;
                  
                case 'offer':
                  // Handle WebRTC offer from another node
                  handleWebRTCOffer(message, ws);
                  break;
              }
            };
            
            ws.onerror = (err) => {
              console.error('❌ WebSocket error:', err);
              pushToast('⚠️ Connection issue, retrying...', 'err');
            };
            
            ws.onclose = () => {
              console.log('🔌 Disconnected from signaling server');
              if (nodeActive) {
                pushToast('⚠️ Lost connection to network', 'err');
              }
            };
            
            setSignalServer(ws);
            
            // Send heartbeat every 30 seconds
            const heartbeat = setInterval(() => {
              if (ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                  type: 'heartbeat',
                  nodeId: nodeId
                }));
              }
            }, 30000);
            
            // Store heartbeat interval for cleanup
            ws._heartbeatInterval = heartbeat;
            
          } catch (err) {
            console.error('❌ Failed to start node:', err);
            pushToast('❌ Failed to start node', 'err');
            setNodeActive(false);
          }
          
        } else {
          // Stop node
          setNodeActive(false);
          localStorage.setItem('nodeWasActive', 'false');
          if (signalServer) {
            clearInterval(signalServer._heartbeatInterval);
            signalServer.send(JSON.stringify({
              type: 'disconnect',
              nodeId: `GW-${walletAddress.slice(0, 8)}`
            }));
            signalServer.close();
            setSignalServer(null);
          }
          if (peerConnection) {
            peerConnection.close();
            setPeerConnection(null);
          }
          setNearbyNodes([]);
          setNodeUptime(0);
          pushToast('⏸ Node deactivated', 'info');
        }
      };
      
      // Handle relay request (earn rewards)
      // ========== REAL RELAY RECORDING - BLOCKCHAIN TRANSACTION ==========
      const handleRelayRequest = async (data) => {
        if (!wallet || !walletAddress) {
          console.log('⚠️ No wallet connected for relay recording');
          return;
        }
        
        try {
          const connection = new solanaWeb3.Connection(MAINNET_RPC, 'confirmed');
          const programId = new solanaWeb3.PublicKey(GHOST_PROGRAM_ID);
          const userPubkey = new solanaWeb3.PublicKey(walletAddress);
          const poolPDA = await getPoolPDA();
          
          // Get Node PDA
          const nodeSeed = new TextEncoder().encode('node');
          const [nodePDA] = await solanaWeb3.PublicKey.findProgramAddress(
            [nodeSeed, userPubkey.toBytes()],
            programId
          );
          
          // Build record_relay instruction
          // Discriminator for "record_relay": [191, 240, 172, 203, 186, 131, 54, 218]
          const discriminator = new Uint8Array([191, 240, 172, 203, 186, 131, 54, 218]);
          
          // Generate a transaction signature (or use the actual relayed tx sig)
          const txSig = data?.signature || `RELAY-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
          const success = true; // Assume success for now
          
          // Encode string length + string + bool
          const encoder = new TextEncoder();
          const sigBytes = encoder.encode(txSig);
          const sigLen = sigBytes.length;
          
          // Build instruction data: discriminator + string_length (u32) + string_bytes + bool (u8)
          const instructionData = new Uint8Array(discriminator.length + 4 + sigLen + 1);
          let offset = 0;
          
          // Discriminator
          instructionData.set(discriminator, offset);
          offset += discriminator.length;
          
          // String length (little-endian u32)
          const lenView = new DataView(instructionData.buffer, offset, 4);
          lenView.setUint32(0, sigLen, true);
          offset += 4;
          
          // String bytes
          instructionData.set(sigBytes, offset);
          offset += sigLen;
          
          // Bool (success)
          instructionData[offset] = success ? 1 : 0;
          
          const keys = [
            { pubkey: nodePDA, isSigner: false, isWritable: true },
            { pubkey: poolPDA, isSigner: false, isWritable: true },
            { pubkey: userPubkey, isSigner: true, isWritable: false }
          ];
          
          const relayInstruction = new solanaWeb3.TransactionInstruction({
            keys,
            programId,
            data: instructionData
          });
          
          const transaction = new solanaWeb3.Transaction().add(relayInstruction);
          transaction.feePayer = userPubkey;
          transaction.recentBlockhash = (await connection.getLatestBlockhash()).blockhash;
          
          // Sign and send
          const signed = await wallet.signTransaction(transaction);
          const signature = await connection.sendRawTransaction(signed.serialize());
          
          // Don't wait for confirmation to avoid slowing down relay
          connection.confirmTransaction(signature, 'confirmed').then(() => {
            console.log('✅ Relay recorded on-chain:', signature);
          });
          
          // Update UI immediately
          setTotalRelays(prev => prev + 1);
          setSuccessfulRelays(prev => prev + 1);
          
          // Note: rewards are calculated on-chain, fetch from blockchain
          pushToast(`📡 Relay recorded on-chain!`, 'ok');
          
          // Refresh blockchain data to get updated rewards
          setTimeout(() => loadBlockchainData(), 2000);
          
        } catch (err) {
          console.error('Relay recording error:', err);
          // Don't show error toast to avoid spamming user
          // Just increment locally as fallback
          setTotalRelays(prev => prev + 1);
        }
      };
      
      // Uptime counter
      useEffect(() => {
        if (!nodeActive) return;
        const interval = setInterval(() => {
          setNodeUptime(prev => prev + 1);
        }, 1000);
        return () => clearInterval(interval);
      }, [nodeActive]);
      
      // Auto-refresh blockchain data
      useEffect(() => {
        if (!walletAddress) return;
        const interval = setInterval(() => {
          loadBlockchainData(walletAddress);
        }, 30000); // Refresh every 30s
        return () => clearInterval(interval);
      }, [walletAddress]);
      
      // Auto-refresh global nodes
      useEffect(() => {
        // Fetch immediately on mount
        fetchGlobalNodes();
        
        // Then fetch every 10 seconds
        const interval = setInterval(() => {
          fetchGlobalNodes();
        }, 10000); // Refresh every 10s
        
        return () => clearInterval(interval);
      }, []);
      
      // Auto-refresh global staking stats
      useEffect(() => {
        // Fetch immediately on mount
        fetchGlobalStats();
        
        // Then fetch every 15 seconds
        const interval = setInterval(() => {
          fetchGlobalStats();
        }, 15000); // Refresh every 15s
        
        return () => clearInterval(interval);
      }, []);
      
      // Initialize world map
      useEffect(() => {
        console.log('🗺️ Map initialization effect triggered');
        console.log('📦 Leaflet available:', typeof L);
        console.log('🗺️ Current worldMap state:', worldMap);
        
        if (typeof L === 'undefined') {
          console.error('❌ Leaflet (L) is not defined!');
          return;
        }
        
        // Initialize map once
        if (!worldMap) {
          const mapContainer = document.getElementById('world-map');
          console.log('📦 Map container element:', mapContainer);
          
          if (!mapContainer) {
            console.error('❌ Map container not found!');
            return;
          }
          
          try {
            console.log('🚀 Creating Leaflet map...');
            const map = L.map('world-map', {
              center: [20, 0],
              zoom: 2,
              minZoom: 2,
              maxZoom: 6,
              zoomControl: true,
              attributionControl: false
            });
            
            console.log('🎨 Adding tile layer...');
            // Dark theme tile layer
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
              maxZoom: 19
            }).addTo(map);
            
            setWorldMap(map);
            console.log('✅ World map initialized successfully!', map);
            
            // Force map to resize in case container wasn't ready
            setTimeout(() => {
              map.invalidateSize();
              console.log('🔄 Map size invalidated');
            }, 100);
          } catch (err) {
            console.error('❌ Error initializing map:', err);
          }
        }
      }, [worldMap]);
      
      // Update map markers when nodes change
      useEffect(() => {
        console.log('🗺️ Marker update effect triggered');
        console.log('🗺️ worldMap:', worldMap);
        console.log('📊 globalNodes:', globalNodes);
        
        if (!worldMap || !globalNodes) {
          console.log('⏭️ Skipping marker update - map or nodes not ready');
          return;
        }
        
        console.log(`🎯 Updating markers for ${globalNodes.length} nodes`);
        
        // Clear existing markers
        mapMarkers.forEach(marker => marker.remove());
        console.log(`🧹 Cleared ${mapMarkers.length} old markers`);
        
        // Region to coordinates mapping (expanded to cover all major timezones)
        const regionCoords = {
          // North America
          'America/New_York': [40.7128, -74.0060],
          'America/Los_Angeles': [34.0522, -118.2437],
          'America/Chicago': [41.8781, -87.6298],
          'America/Denver': [39.7392, -104.9903],
          'America/Phoenix': [33.4484, -112.0740],
          'America/Toronto': [43.6532, -79.3832],
          'America/Vancouver': [49.2827, -123.1207],
          'America/Montreal': [45.5017, -73.5673],
          'America/Sao_Paulo': [-23.5505, -46.6333],
          'America/Mexico_City': [19.4326, -99.1332],
          'America/Bogota': [4.7110, -74.0721],
          'America/Lima': [-12.0464, -77.0428],
          'America/Buenos_Aires': [-34.6037, -58.3816],
          'America/Santiago': [-33.4489, -70.6693],
          'America/Caracas': [10.4806, -66.9036],
          'America/Havana': [23.1136, -82.3666],
          'America/Panama': [8.9824, -79.5199],
          'America/Anchorage': [61.2181, -149.9003],
          'America/Juneau': [58.3019, -134.4197],
          'America/Boise': [43.6150, -116.2023],
          'America/Detroit': [42.3314, -83.0458],
          'America/Indianapolis': [39.7684, -86.1581],
          'America/Kentucky/Louisville': [38.2527, -85.7585],
          'America/Louisville': [38.2527, -85.7585],
          'America/New_Orleans': [29.9511, -90.0715],
          'America/Houston': [29.7604, -95.3698],
          'America/Dallas': [32.7767, -96.7970],
          'America/Miami': [25.7617, -80.1918],
          'America/Atlanta': [33.7490, -84.3880],
          'America/Seattle': [47.6062, -122.3321],
          'America/San_Francisco': [37.7749, -122.4194],
          'America/Las_Vegas': [36.1699, -115.1398],
          'America/Portland': [45.5152, -122.6784],
          'America/Winnipeg': [49.8951, -97.1384],
          'America/Edmonton': [53.5461, -113.4938],
          'America/Halifax': [44.6488, -63.5752],
          'America/St_Johns': [47.5615, -52.7126],
          
          // Europe
          'Europe/London': [51.5074, -0.1278],
          'Europe/Paris': [48.8566, 2.3522],
          'Europe/Berlin': [52.5200, 13.4050],
          'Europe/Amsterdam': [52.3676, 4.9041],
          'Europe/Madrid': [40.4168, -3.7038],
          'Europe/Rome': [41.9028, 12.4964],
          'Europe/Moscow': [55.7558, 37.6173],
          'Europe/Stockholm': [59.3293, 18.0686],
          'Europe/Oslo': [59.9139, 10.7522],
          'Europe/Copenhagen': [55.6761, 12.5683],
          'Europe/Helsinki': [60.1699, 24.9384],
          'Europe/Warsaw': [52.2297, 21.0122],
          'Europe/Prague': [50.0755, 14.4378],
          'Europe/Vienna': [48.2082, 16.3738],
          'Europe/Budapest': [47.4979, 19.0402],
          'Europe/Bucharest': [44.4268, 26.1025],
          'Europe/Athens': [37.9838, 23.7275],
          'Europe/Istanbul': [41.0082, 28.9784],
          'Europe/Dublin': [53.3498, -6.2603],
          'Europe/Lisbon': [38.7223, -9.1393],
          'Europe/Brussels': [50.8503, 4.3517],
          'Europe/Zurich': [47.3769, 8.5417],
          'Europe/Geneva': [46.2044, 6.1432],
          'Europe/Luxembourg': [49.6116, 6.1319],
          'Europe/Kiev': [50.4501, 30.5234],
          'Europe/Minsk': [53.9045, 27.5615],
          'Europe/Riga': [56.9496, 24.1052],
          'Europe/Tallinn': [59.4370, 24.7536],
          'Europe/Vilnius': [54.6872, 25.2797],
          'Europe/Sofia': [42.6977, 23.3219],
          'Europe/Belgrade': [44.7866, 20.4489],
          'Europe/Zagreb': [45.8150, 15.9819],
          
          // Asia
          'Asia/Tokyo': [35.6762, 139.6503],
          'Asia/Shanghai': [31.2304, 121.4737],
          'Asia/Hong_Kong': [22.3193, 114.1694],
          'Asia/Singapore': [1.3521, 103.8198],
          'Asia/Seoul': [37.5665, 126.9780],
          'Asia/Mumbai': [19.0760, 72.8777],
          'Asia/Dubai': [25.2048, 55.2708],
          'Asia/Bangkok': [13.7563, 100.5018],
          'Asia/Manila': [14.5995, 120.9842],
          'Asia/Jakarta': [-6.2088, 106.8456],
          'Asia/Kuala_Lumpur': [3.1390, 101.6869],
          'Asia/Taipei': [25.0330, 121.5654],
          'Asia/Hanoi': [21.0285, 105.8542],
          'Asia/Ho_Chi_Minh': [10.8231, 106.6297],
          'Asia/Delhi': [28.7041, 77.1025],
          'Asia/Kolkata': [22.5726, 88.3639],
          'Asia/Karachi': [24.8607, 67.0011],
          'Asia/Dhaka': [23.8103, 90.4125],
          'Asia/Colombo': [6.9271, 79.8612],
          'Asia/Kathmandu': [27.7172, 85.3240],
          'Asia/Tehran': [35.6892, 51.3890],
          'Asia/Baghdad': [33.3152, 44.3661],
          'Asia/Riyadh': [24.7136, 46.6753],
          'Asia/Kuwait': [29.3759, 47.9774],
          'Asia/Doha': [25.2854, 51.5310],
          'Asia/Muscat': [23.5880, 58.3829],
          'Asia/Jerusalem': [31.7683, 35.2137],
          'Asia/Beirut': [33.8938, 35.5018],
          'Asia/Amman': [31.9454, 35.9284],
          'Asia/Baku': [40.4093, 49.8671],
          'Asia/Yerevan': [40.1792, 44.4991],
          'Asia/Tbilisi': [41.7151, 44.8271],
          'Asia/Tashkent': [41.2995, 69.2401],
          'Asia/Almaty': [43.2220, 76.8512],
          'Asia/Bishkek': [42.8746, 74.5698],
          'Asia/Ulaanbaatar': [47.8864, 106.9057],
          'Asia/Pyongyang': [39.0392, 125.7625],
          
          // Australia & Pacific
          'Australia/Sydney': [-33.8688, 151.2093],
          'Australia/Melbourne': [-37.8136, 144.9631],
          'Australia/Brisbane': [-27.4698, 153.0251],
          'Australia/Perth': [-31.9505, 115.8605],
          'Australia/Adelaide': [-34.9285, 138.6007],
          'Australia/Hobart': [-42.8821, 147.3272],
          'Australia/Darwin': [-12.4634, 130.8456],
          'Pacific/Auckland': [-36.8485, 174.7633],
          'Pacific/Fiji': [-18.1416, 178.4419],
          'Pacific/Guam': [13.4443, 144.7937],
          'Pacific/Honolulu': [21.3099, -157.8581],
          'Pacific/Tahiti': [-17.6509, -149.4260],
          
          // Africa
          'Africa/Johannesburg': [-26.2041, 28.0473],
          'Africa/Cairo': [30.0444, 31.2357],
          'Africa/Lagos': [6.5244, 3.3792],
          'Africa/Nairobi': [-1.2864, 36.8172],
          'Africa/Casablanca': [33.5731, -7.5898],
          'Africa/Algiers': [36.7538, 3.0588],
          'Africa/Tunis': [36.8065, 10.1815],
          'Africa/Tripoli': [32.8872, 13.1913],
          'Africa/Khartoum': [15.5007, 32.5599],
          'Africa/Addis_Ababa': [9.0320, 38.7469],
          'Africa/Dar_es_Salaam': [-6.7924, 39.2083],
          'Africa/Kampala': [0.3476, 32.5825],
          'Africa/Lusaka': [-15.3875, 28.3228],
          'Africa/Harare': [-17.8252, 31.0335],
          'Africa/Maputo': [-25.9655, 32.5832],
          'Africa/Windhoek': [-22.5597, 17.0832],
          'Africa/Kinshasa': [-4.4419, 15.2663],
          'Africa/Accra': [5.6037, -0.1870],
          'Africa/Abidjan': [5.3600, -4.0083],
          'Africa/Dakar': [14.7167, -17.4677],
          
          // South America (additional)
          'America/Montevideo': [-34.9011, -56.1645],
          'America/Asuncion': [-25.2637, -57.5759],
          'America/La_Paz': [-16.5000, -68.1500],
          'America/Guayaquil': [-0.1807, -78.4678],
          'America/Fortaleza': [-3.7172, -38.5433],
          'America/Recife': [-8.0476, -34.8770],
          'America/Manaus': [-3.1190, -60.0217],
          'America/Rio_Branco': [-9.9750, -67.8243]
        };
        
        const newMarkers = [];
        
        console.log('🗺️ Creating markers for nodes:', globalNodes.map(n => `${n.id.slice(0,8)} @ ${n.location}`));
        
        globalNodes.forEach(node => {
          const coords = regionCoords[node.location];
          
          if (!coords) {
            console.warn(`⚠️ Unknown region "${node.location}" for node ${node.id.slice(0,8)}, using fallback coordinates`);
          }
          
          const finalCoords = coords || [
            (Math.random() - 0.5) * 140,
            (Math.random() - 0.5) * 340
          ];
          
          // Determine if this is the user's node
          const isUserNode = walletAddress && node.walletAddress === walletAddress;
          
          // Color coding: Green for your node, Blue for active, Orange for idle
          const markerColor = isUserNode ? '#10b981' : (node.status === 'active' ? '#3b82f6' : '#f59e0b');
          const markerClass = isUserNode ? 'pulsing-marker user-node' : 'pulsing-marker';
          
          // Create a properly sized pulsing marker
          const marker = L.circleMarker(finalCoords, {
            radius: 10,  // Nice visible size
            fillColor: markerColor,
            color: '#ffffff',
            weight: 3,  // White border
            opacity: 1,
            fillOpacity: 0.9,
            className: markerClass
          }).addTo(worldMap);
          
          // Add outer ring for pulsing effect
          const outerRing = L.circleMarker(finalCoords, {
            radius: 18,
            fillColor: 'transparent',
            color: markerColor,
            weight: 2,
            opacity: 0.5,
            fillOpacity: 0,
            className: 'marker-ring'
          }).addTo(worldMap);
          
          console.log(`✨ Created ${isUserNode ? 'YOUR' : ''} marker at [${finalCoords}] for node ${node.id.slice(0,8)}`);
          
          // Enhanced popup with full details
          marker.bindPopup(`
            <div style="font-family: system-ui; min-width: 240px; padding: 4px;">
              ${isUserNode ? '<div style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 6px 12px; border-radius: 8px; margin-bottom: 12px; text-align: center; font-weight: bold; font-size: 13px;">✨ YOUR NODE ✨</div>' : ''}
              
              <div style="font-weight: bold; color: ${markerColor}; margin-bottom: 10px; font-size: 14px;">
                🌐 Node ${node.id.slice(0, 16)}
              </div>
              
              <div style="display: grid; gap: 6px; font-size: 12px;">
                <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #334155;">
                  <span style="color: #94a3b8;">📍 Location</span>
                  <strong style="color: #e2e8f0;">${node.location.split('/').pop()}</strong>
                </div>
                
                <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #334155;">
                  <span style="color: #94a3b8;">⚡ Status</span>
                  <strong style="color: ${node.status === 'active' ? '#10b981' : '#f59e0b'};">${node.status.toUpperCase()}</strong>
                </div>
                
                <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #334155;">
                  <span style="color: #94a3b8;">🏆 Reputation</span>
                  <strong style="color: #e2e8f0;">${node.reputation.toLocaleString()}</strong>
                </div>
                
                <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #334155;">
                  <span style="color: #94a3b8;">📡 Relays</span>
                  <strong style="color: #3b82f6;">${node.relays.toLocaleString()}</strong>
                </div>
                
                <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #334155;">
                  <span style="color: #94a3b8;">⏱️ Uptime</span>
                  <strong style="color: #e2e8f0;">${node.uptime}</strong>
                </div>
                
                <div style="display: flex; justify-content: space-between; padding: 4px 0;">
                  <span style="color: #94a3b8;">💰 Wallet</span>
                  <code style="color: #a78bfa; font-size: 10px;">${node.walletAddress ? node.walletAddress.slice(0, 4) + '...' + node.walletAddress.slice(-4) : 'N/A'}</code>
                </div>
              </div>
              
              ${isUserNode ? '<div style="margin-top: 10px; padding: 8px; background: #1e293b; border-radius: 6px; text-align: center; color: #10b981; font-size: 11px;">🎉 This is your active node!</div>' : ''}
            </div>
          `);
          
          // Store both the marker and its ring so we can remove them later
          newMarkers.push(marker);
          newMarkers.push(outerRing);
        });
        
        setMapMarkers(newMarkers);
        console.log(`🗺️ Updated map with ${globalNodes.length} nodes (${newMarkers.length} total markers including rings)`);
      }, [globalNodes, worldMap]);
      
      // Auto-start node if it was running before refresh
      useEffect(() => {
        if (shouldAutoStartNode && walletAddress && stakedAmount >= 10000 && !nodeActive) {
          console.log('🚀 Auto-starting node...');
          setShouldAutoStartNode(false); // Reset flag
          
          // Small delay to ensure everything is loaded
          setTimeout(() => {
            toggleNode();
          }, 1500);
        }
      }, [shouldAutoStartNode, walletAddress, stakedAmount, nodeActive]);
      
      // Auto-connect wallet on page load
      useEffect(() => {
        const autoConnect = async () => {
          const wasConnected = localStorage.getItem('walletConnected');
          const savedAddress = localStorage.getItem('walletAddress');
          
          if (wasConnected === 'true' && savedAddress) {
            try {
              const provider = window.solana || window.phantom?.solana;
              
              if (provider && provider.isConnected) {
                // Wallet is still connected in Phantom
                const pubkey = provider.publicKey.toString();
                
                if (pubkey === savedAddress) {
                  setWallet(provider);
                  setWalletAddress(pubkey);
                  await loadBlockchainData(pubkey);
                  console.log('✅ Auto-reconnected wallet:', pubkey.slice(0, 8) + '...');
                  
                  // Auto-restart node if it was running
                  const wasNodeActive = localStorage.getItem('nodeWasActive');
                  if (wasNodeActive === 'true') {
                    console.log('🔄 Will auto-restart node after data loads...');
                    setShouldAutoStartNode(true);
                  }
                }
              } else if (provider) {
                // Wallet exists but not connected, try silent connect
                try {
                  await provider.connect({ onlyIfTrusted: true });
                  const pubkey = provider.publicKey.toString();
                  
                  setWallet(provider);
                  setWalletAddress(pubkey);
                  await loadBlockchainData(pubkey);
                  console.log('✅ Silent reconnect successful:', pubkey.slice(0, 8) + '...');
                  
                  // Auto-restart node if it was running
                  const wasNodeActive = localStorage.getItem('nodeWasActive');
                  if (wasNodeActive === 'true') {
                    console.log('🔄 Will auto-restart node after data loads...');
                    setShouldAutoStartNode(true);
                  }
                } catch (err) {
                  // Silent connect failed, user needs to manually connect
                  console.log('ℹ️ Wallet not auto-connected (user must approve)');
                  localStorage.removeItem('walletConnected');
                }
              }
            } catch (err) {
              console.error('Auto-connect failed:', err);
              localStorage.removeItem('walletConnected');
            }
          }
        };
        
        autoConnect();
      }, []);
      
      // Format uptime
      const formatUptime = (seconds) => {
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = seconds % 60;
        return `${h}h ${m}m ${s}s`;
      };
      
      // ========== ANONYMOUS RELAY FUNCTIONS ==========
      
      // Calculate relay fee based on privacy level
      const calculateRelayFee = (hops) => {
        const feePerHop = 5; // 5 $WHISTLE per hop
        return hops * feePerHop;
      };
      
      // Create and sign relay request (OFFLINE CAPABLE)
      const createRelayRequest = async () => {
        if (!wallet || !walletAddress) {
          pushToast('⚠️ Connect wallet first', 'err');
          setShowWalletModal(true);
          return;
        }
        
        // Validate inputs
        if (!relayRecipient || !solanaWeb3.PublicKey.isOnCurve(relayRecipient)) {
          pushToast('❌ Invalid recipient address', 'err');
          return;
        }
        
        if (!relayAmount || parseFloat(relayAmount) <= 0) {
          pushToast('❌ Invalid amount', 'err');
          return;
        }
        
        setCreatingRelay(true);
        
        try {
          const connection = new solanaWeb3.Connection(MAINNET_RPC, 'confirmed');
          const recipientPubkey = new solanaWeb3.PublicKey(relayRecipient);
          const userPubkey = new solanaWeb3.PublicKey(walletAddress);
          
          // Calculate relay fee
          const relayFee = calculateRelayFee(privacyLevel);
          const relayFeeTokens = relayFee * 1_000_000; // 6 decimals
          
          // Check if user has enough balance
          if (tokenBalance < relayFee) {
            pushToast(`❌ Insufficient balance. Need ${relayFee} $WHISTLE`, 'err');
            return;
          }
          
          console.log(`🔒 Creating anonymous relay:`, {
            recipient: relayRecipient,
            amount: relayAmount,
            token: relayToken,
            hops: privacyLevel,
            fee: relayFee
          });
          
          // Build the actual transaction to relay
          const transaction = new solanaWeb3.Transaction();
          
          if (relayToken === 'SOL') {
            // SOL transfer
            transaction.add(
              solanaWeb3.SystemProgram.transfer({
                fromPubkey: userPubkey,
                toPubkey: recipientPubkey,
                lamports: parseFloat(relayAmount) * solanaWeb3.LAMPORTS_PER_SOL
              })
            );
          } else {
            // Token transfer (simplified - would need actual token mint)
            pushToast('⚠️ Token transfers coming soon', 'info');
            return;
          }
          
          // Add memo with relay instructions
          const relayMemo = JSON.stringify({
            type: 'anonymous_relay',
            hops: privacyLevel,
            fee: relayFeeTokens,
            timestamp: Date.now()
          });
          
          transaction.add(
            new solanaWeb3.TransactionInstruction({
              keys: [],
              programId: new solanaWeb3.PublicKey('MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr'),
              data: Buffer.from(relayMemo)
            })
          );
          
          // Set recent blockhash (can work offline if blockhash is cached)
          const { blockhash } = await connection.getLatestBlockhash();
          transaction.recentBlockhash = blockhash;
          transaction.feePayer = userPubkey;
          
          // SIGN TRANSACTION (Works OFFLINE!)
          const signedTx = await wallet.signTransaction(transaction);
          
          console.log('✅ Transaction signed offline!', signedTx.signature);
          
          // Encrypt transaction for multi-hop relay
          const encryptedPayload = await encryptForRelay(signedTx, privacyLevel);
          
          // Create relay request object
          const relayRequest = {
            id: Date.now(),
            signature: signedTx.signature ? Buffer.from(signedTx.signature).toString('base64') : null,
            encryptedTx: encryptedPayload,
            hops: privacyLevel,
            fee: relayFee,
            created: new Date().toISOString(),
            status: 'pending'
          };
          
          // Add to history
          setRelayHistory(prev => [relayRequest, ...prev]);
          
          // If online and nodes available, submit to network
          if (globalNodes.length > 0) {
            await submitToRelayNetwork(relayRequest);
            pushToast(`✅ Relay request submitted (${privacyLevel} hops)`, 'ok');
          } else {
            // Generate QR code for offline transmission
            const qrData = JSON.stringify({
              tx: Buffer.from(signedTx.serialize()).toString('base64'),
              hops: privacyLevel,
              fee: relayFee
            });
            setQRCodeData(qrData);
            setShowQRCode(true);
            pushToast('📱 QR code generated - scan to relay', 'info');
          }
          
          // Clear form
          setRelayRecipient('');
          setRelayAmount('');
          
        } catch (err) {
          console.error('Relay creation error:', err);
          pushToast(`❌ Relay creation failed: ${err.message}`, 'err');
        } finally {
          setCreatingRelay(false);
        }
      };
      
      // Encrypt transaction for multi-hop relay (Onion-style)
      const encryptForRelay = async (signedTx, numHops) => {
        try {
          // Serialize transaction
          const txData = signedTx.serialize();
          const txBase64 = Buffer.from(txData).toString('base64');
          
          // Select relay nodes (highest reputation first)
          const selectedNodes = globalNodes
            .sort((a, b) => b.reputation - a.reputation)
            .slice(0, numHops);
          
          if (selectedNodes.length < numHops) {
            console.warn(`⚠️ Only ${selectedNodes.length} nodes available for ${numHops} hops`);
          }
          
          // For now, return a simplified encrypted payload
          // In production, this would use actual encryption per node
          const payload = {
            transaction: txBase64,
            hops: selectedNodes.map(n => ({
              nodeId: n.id,
              region: n.location
            })),
            encrypted: true, // Flag indicating encryption
            timestamp: Date.now()
          };
          
          return JSON.stringify(payload);
        } catch (err) {
          console.error('Encryption error:', err);
          return JSON.stringify({ transaction: Buffer.from(signedTx.serialize()).toString('base64') });
        }
      };
      
      // Submit relay request to node network
      const submitToRelayNetwork = async (relayRequest) => {
        try {
          if (!signalServer || signalServer.readyState !== WebSocket.OPEN) {
            throw new Error('Not connected to signaling server');
          }
          
          // Send relay request to network
          signalServer.send(JSON.stringify({
            type: 'relay-request',
            request: relayRequest
          }));
          
          console.log('📡 Relay request sent to network:', relayRequest.id);
          
          // Update history status
          setRelayHistory(prev => 
            prev.map(r => r.id === relayRequest.id ? {...r, status: 'in-progress'} : r)
          );
        } catch (err) {
          console.error('Submit error:', err);
          throw err;
        }
      };
      
      // Generate QR code for offline relay
      const generateQRCodeForRelay = () => {
        if (!relayRecipient || !relayAmount) {
          pushToast('❌ Fill in recipient and amount first', 'err');
          return;
        }
        
        // Create simplified relay data for QR
        const qrPayload = {
          to: relayRecipient,
          amount: relayAmount,
          token: relayToken,
          hops: privacyLevel,
          fee: calculateRelayFee(privacyLevel),
          timestamp: Date.now()
        };
        
        const qrData = JSON.stringify(qrPayload);
        setQRCodeData(qrData);
        setShowQRCode(true);
        
        pushToast('📱 QR Code generated! Scan with internet-connected device', 'ok');
      };
      
      // Disconnect wallet
      const disconnectWallet = () => {
        if (wallet) {
          wallet.disconnect();
        }
        
        // Clear localStorage
        localStorage.removeItem('walletConnected');
        localStorage.removeItem('walletAddress');
        localStorage.removeItem('nodeWasActive');
        
        setWallet(null);
        setWalletAddress(null);
        setTokenBalance(0);
        setStakedAmount(0);
        setReputation(0);
        setPendingRewards(0);
        pushToast('👋 Wallet disconnected', 'info');
      };
      
      return (
        <div className="space-y-6">
          {/* Header with Wallet Connection */}
          <div className="relative overflow-hidden rounded-3xl border border-slate-200/50 dark:border-slate-700/50 bg-gradient-to-br from-white via-blue-50/30 to-cyan-50/30 dark:from-slate-900 dark:via-blue-950/30 dark:to-cyan-950/30 p-6 shadow-2xl">
            <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
              <div className="flex-1">
                <h1 className="text-3xl md:text-4xl font-black text-slate-900 dark:text-white tracking-tight mb-2">
                  👻 GHOST WHISTLE EARN
                </h1>
                <p className="text-sm text-slate-600 dark:text-slate-400 mb-3">
                  World's first browser-based offline transaction network • Earn by staking & running nodes
                </p>
                <button
                  onClick={() => setStep('services')}
                  className="relative group px-6 py-3 rounded-xl bg-gradient-to-r from-slate-400/20 via-slate-300/30 to-slate-400/20 backdrop-blur-xl border border-slate-300/40 text-slate-100 text-sm font-bold shadow-2xl hover:shadow-slate-400/30 transition-all duration-300 inline-flex items-center gap-3 overflow-hidden"
                >
                  {/* Blade-like lightning effects */}
                  <div className="absolute inset-0 bg-gradient-to-r from-transparent via-slate-200/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500 animate-pulse"></div>
                  <div className="absolute -inset-[1px] rounded-xl bg-gradient-to-r from-slate-300/30 via-slate-200/50 to-slate-300/30 blur-sm opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                  
                  {/* Animated lightning streaks */}
                  <div className="absolute inset-0 overflow-hidden rounded-xl">
                    <div className="absolute -top-1 -left-1 w-2 h-2 bg-slate-200/60 rounded-full animate-ping"></div>
                    <div className="absolute -top-1 -right-1 w-1.5 h-1.5 bg-slate-300/60 rounded-full animate-ping" style={{animationDelay: '0.5s'}}></div>
                    <div className="absolute -bottom-1 -left-1 w-1 h-1 bg-slate-400/60 rounded-full animate-ping" style={{animationDelay: '1s'}}></div>
                    <div className="absolute -bottom-1 -right-1 w-1.5 h-1.5 bg-slate-200/60 rounded-full animate-ping" style={{animationDelay: '1.5s'}}></div>
                  </div>
                  
                  {/* Lightning bolt streaks on hover */}
                  <div className="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                    <div className="absolute top-0 left-1/4 w-px h-full bg-gradient-to-b from-transparent via-slate-200/80 to-transparent transform -skew-x-12 animate-pulse"></div>
                    <div className="absolute top-0 right-1/3 w-px h-full bg-gradient-to-b from-transparent via-slate-300/60 to-transparent transform skew-x-12 animate-pulse" style={{animationDelay: '0.3s'}}></div>
                    <div className="absolute top-0 left-2/3 w-px h-full bg-gradient-to-b from-transparent via-slate-200/70 to-transparent transform -skew-x-6 animate-pulse" style={{animationDelay: '0.6s'}}></div>
                  </div>
                  
                  {/* Content */}
                  <span className="relative z-10 flex items-center gap-3">
                    <svg className="w-5 h-5 text-slate-200 group-hover:text-white transition-colors duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9" />
                    </svg>
                    <span className="text-slate-200 group-hover:text-white transition-colors duration-300 font-bold tracking-wide">Explore Services</span>
                    
                    {/* Animated arrow */}
                    <div className="relative">
                      <svg className="w-4 h-4 text-slate-300 group-hover:text-slate-100 transition-all duration-300 group-hover:translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5l7 7-7 7" />
                      </svg>
                      {/* Lightning effect on arrow */}
                      <div className="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                        <div className="absolute inset-0 bg-gradient-to-r from-slate-200/40 to-transparent blur-sm"></div>
                      </div>
                    </div>
                  </span>
                  
                  {/* Hover glow effect */}
                  <div className="absolute inset-0 rounded-xl bg-gradient-to-r from-slate-300/10 via-slate-200/20 to-slate-300/10 opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                </button>
              </div>
              
              {!walletAddress ? (
                <button
                  onClick={() => setShowWalletModal(true)}
                  disabled={connecting}
                  className="px-6 py-3 rounded-xl bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-500 hover:to-teal-500 text-white font-bold shadow-lg hover:shadow-xl transition-all flex items-center gap-2 disabled:opacity-50"
                >
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                  </svg>
                  {connecting ? 'Connecting...' : 'Connect Wallet'}
                </button>
              ) : (
                <div className="flex items-center gap-3">
                  <div className="bg-white/80 dark:bg-slate-800/80 rounded-xl px-4 py-2 border border-slate-200 dark:border-slate-700">
                    <div className="text-[10px] text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-1">Balance</div>
                    <div className="text-lg font-black text-slate-900 dark:text-white">
                      {tokenBalance.toLocaleString()} $W
                    </div>
                  </div>
                  <button
                    onClick={disconnectWallet}
                    className="px-4 py-3 rounded-xl bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-300 font-bold transition-all"
                    title={walletAddress}
                  >
                    {walletAddress.slice(0, 4)}...{walletAddress.slice(-4)}
                  </button>
                </div>
              )}
            </div>
          </div>

          {/* GLOBAL STAKING STATS BANNER */}
          <div className="relative overflow-hidden rounded-2xl border border-emerald-500/20 bg-gradient-to-r from-emerald-950/40 via-cyan-950/40 to-blue-950/40 backdrop-blur-xl p-4 shadow-xl">
            <div className="absolute inset-0 bg-gradient-to-r from-emerald-500/5 via-cyan-500/5 to-blue-500/5"></div>
            <div className="absolute top-0 left-0 right-0 h-px bg-gradient-to-r from-transparent via-emerald-400/50 to-transparent"></div>
            
            <div className="relative z-10">
              <div className="flex items-center justify-between gap-4 mb-3">
                <div className="flex items-center gap-2">
                  <div className="w-2 h-2 bg-emerald-400 rounded-full animate-pulse"></div>
                  <h3 className="text-sm font-bold text-emerald-300 uppercase tracking-wider">Live Network Stats</h3>
                </div>
                <div className="flex items-center gap-1.5 px-2 py-1 rounded-lg bg-emerald-500/10 border border-emerald-500/30">
                  <div className="w-1.5 h-1.5 bg-emerald-400 rounded-full animate-ping"></div>
                  <span className="text-xs text-emerald-300 font-mono">LIVE</span>
                </div>
              </div>
              
              <div className="grid grid-cols-1 md:grid-cols-3 gap-3 md:gap-4">
                {/* Total Stakers */}
                <div className="bg-slate-900/40 rounded-xl p-3 md:p-4 border border-slate-700/30 hover:border-cyan-500/30 transition-all">
                  <div className="flex items-center gap-2 mb-1.5">
                    <svg className="w-4 h-4 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                    <span className="text-xs text-slate-400 uppercase tracking-wider">Total Stakers</span>
                  </div>
                  <div className="text-xl md:text-2xl font-black text-white">
                    {globalStats.totalStakers.toLocaleString()}
                  </div>
                  <div className="text-xs text-cyan-400 font-mono mt-1">PARTICIPANTS</div>
                </div>
                
                {/* Active Nodes */}
                <div className="bg-slate-900/40 rounded-xl p-3 md:p-4 border border-slate-700/30 hover:border-blue-500/30 transition-all">
                  <div className="flex items-center gap-2 mb-1.5">
                    <svg className="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9" />
                    </svg>
                    <span className="text-xs text-slate-400 uppercase tracking-wider">Active Nodes</span>
                  </div>
                  <div className="text-xl md:text-2xl font-black text-white">
                    {networkStats.totalNodes}
                  </div>
                  <div className="text-xs text-blue-400 font-mono mt-1">ONLINE NOW</div>
                </div>
                
                {/* Total Relays */}
                <div className="bg-slate-900/40 rounded-xl p-3 md:p-4 border border-slate-700/30 hover:border-purple-500/30 transition-all">
                  <div className="flex items-center gap-2 mb-1.5">
                    <svg className="w-4 h-4 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                    <span className="text-xs text-slate-400 uppercase tracking-wider">Total Relays</span>
                  </div>
                  <div className="text-xl md:text-2xl font-black text-white">
                    {networkStats.totalRelays.toLocaleString()}
                  </div>
                  <div className="text-xs text-purple-400 font-mono mt-1">PROCESSED</div>
                </div>
              </div>
            </div>
          </div>

          {/* UNIFIED MAP + TERMINAL INTERFACE - ALWAYS VISIBLE AT TOP */}
          <div className="relative overflow-hidden rounded-3xl border border-white/10 backdrop-blur-xl bg-gradient-to-br from-slate-950/90 via-slate-900/80 to-slate-950/90 shadow-2xl">
            {/* Glassmorphic effects */}
            <div className="absolute inset-0 bg-gradient-to-br from-cyan-500/5 via-blue-500/5 to-emerald-500/5 pointer-events-none"></div>
            <div className="absolute -inset-[1px] rounded-3xl bg-gradient-to-r from-cyan-500/20 via-blue-500/20 to-emerald-500/20 blur-xl opacity-40 animate-pulse"></div>
            
            {/* Top accent line */}
            <div className="absolute top-0 left-0 right-0 h-[2px] bg-gradient-to-r from-transparent via-cyan-400/60 to-transparent z-20"></div>
            
            <div className="relative z-10 flex gap-0 h-[600px]">
              {/* LEFT SIDE - INTERACTIVE MAP (WIDER) */}
              <div className="flex-1 flex flex-col p-6 pr-3">
                {/* Map Header */}
                <div className="flex items-center justify-between mb-4">
                  <div className="flex items-center gap-3">
                    <div className="w-3 h-3 bg-emerald-500 rounded-full animate-pulse shadow-lg shadow-emerald-500/50"></div>
                    <div>
                      <div className="text-sm font-bold text-white/90 uppercase tracking-wider">Live Global Network</div>
                      <div className="text-xs text-white/60 font-mono">Real-time node visualization</div>
                    </div>
                  </div>
                  <div className="px-3 py-1.5 rounded-lg bg-cyan-500/10 backdrop-blur-sm border border-cyan-500/20">
                    <span className="text-xs text-cyan-300 font-bold font-mono">{networkStats.totalNodes} ACTIVE</span>
                  </div>
                </div>

                {/* Interactive Map */}
                <div id="world-map" className="flex-1 rounded-xl border border-cyan-500/20 overflow-hidden shadow-2xl shadow-cyan-500/10"></div>
                
                {/* Map Legend */}
                <div className="flex items-center justify-center gap-6 mt-4 text-xs">
                  <div className="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-white/5 backdrop-blur-sm border border-blue-500/20">
                    <div className="w-2.5 h-2.5 rounded-full bg-blue-500 border-2 border-white/90 shadow-lg shadow-blue-500/50"></div>
                    <span className="text-white/80 font-bold">Active</span>
                  </div>
                  <div className="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-white/5 backdrop-blur-sm border border-orange-500/20">
                    <div className="w-2.5 h-2.5 rounded-full bg-orange-500 border-2 border-white/90 shadow-lg shadow-orange-500/50"></div>
                    <span className="text-white/80 font-bold">Idle</span>
                  </div>
                  <div className="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-white/5 backdrop-blur-sm border border-emerald-500/20">
                    <div className="w-2.5 h-2.5 rounded-full bg-emerald-500 border-2 border-white/90 animate-pulse shadow-lg shadow-emerald-500/50"></div>
                    <span className="text-white/80 font-bold">Your Node</span>
                  </div>
                </div>
              </div>

              {/* Vertical Divider with Glow */}
              <div className="relative w-px shrink-0">
                <div className="absolute inset-0 bg-gradient-to-b from-transparent via-cyan-500/40 to-transparent"></div>
                <div className="absolute inset-0 bg-gradient-to-b from-transparent via-cyan-400/20 to-transparent blur-sm"></div>
              </div>

              {/* RIGHT SIDE - MODERN TERMINAL (SAME HEIGHT) */}
              <div className="w-96 shrink-0 flex flex-col">
                {/* Modern Terminal Header */}
                <div className="relative bg-gradient-to-r from-slate-950 via-slate-900 to-slate-950 border-b border-cyan-500/20 px-5 py-3.5">
                  {/* Glowing accent line */}
                  <div className="absolute top-0 left-0 right-0 h-[2px] bg-gradient-to-r from-transparent via-cyan-400/50 to-transparent"></div>
                  
                  <div className="flex items-center justify-between mb-3">
                    <div className="flex items-center gap-3">
                      <div className="flex items-center gap-1.5">
                        <div className="w-2.5 h-2.5 rounded-full bg-red-500/80 shadow-lg shadow-red-500/50"></div>
                        <div className="w-2.5 h-2.5 rounded-full bg-yellow-500/80 shadow-lg shadow-yellow-500/50"></div>
                        <div className="w-2.5 h-2.5 rounded-full bg-emerald-500 animate-pulse shadow-lg shadow-emerald-500/50"></div>
                      </div>
                      <div className="h-4 w-px bg-white/10"></div>
                      <span className="text-[11px] font-bold text-white/50 uppercase tracking-wider">NODE MONITOR</span>
                    </div>
                    <button
                      onClick={fetchGlobalNodes}
                      className="px-3 py-1.5 text-[10px] bg-cyan-500/10 hover:bg-cyan-500/20 border border-cyan-500/30 hover:border-cyan-400/50 text-cyan-300 rounded-lg font-bold transition-all hover:shadow-lg hover:shadow-cyan-500/20"
                    >
                      <span className="mr-1">↻</span>SYNC
                    </button>
                  </div>
                  
                  <div className="flex items-center gap-2 text-[11px] font-mono">
                    <span className="text-cyan-400">❯</span>
                    <span className="text-emerald-400">ghost</span>
                    <span className="text-white/40">@</span>
                    <span className="text-blue-400">whistle-network</span>
                    <span className="text-white/40 mx-1">in</span>
                    <span className="text-purple-400">~/nodes</span>
                  </div>
                </div>

                {/* Modern Network Stats */}
                <div className="bg-gradient-to-br from-slate-950/90 to-slate-900/90 border-b border-white/5 px-5 py-4">
                  <div className="flex items-center justify-between mb-3">
                    <div className="flex items-center gap-2">
                      <div className="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-pulse shadow-lg shadow-emerald-500/50"></div>
                      <span className="text-[10px] font-bold text-emerald-400 uppercase tracking-widest">NETWORK STATUS</span>
                    </div>
                    <div className="px-2 py-1 bg-emerald-500/10 border border-emerald-500/30 rounded text-[9px] font-bold text-emerald-300">
                      OPERATIONAL
                    </div>
                  </div>
                  
                  <div className="grid grid-cols-3 gap-3">
                    <div className="relative group">
                      <div className="absolute inset-0 bg-gradient-to-br from-emerald-500/10 to-transparent rounded-lg opacity-0 group-hover:opacity-100 transition-opacity"></div>
                      <div className="relative bg-slate-900/50 backdrop-blur-sm border border-emerald-500/20 rounded-lg p-2.5 text-center hover:border-emerald-500/40 transition-all">
                        <div className="text-emerald-400 font-bold text-xl mb-0.5">{networkStats.totalNodes}</div>
                        <div className="text-white/40 text-[9px] uppercase tracking-wider font-bold">Nodes</div>
                      </div>
                    </div>
                    
                    <div className="relative group">
                      <div className="absolute inset-0 bg-gradient-to-br from-orange-500/10 to-transparent rounded-lg opacity-0 group-hover:opacity-100 transition-opacity"></div>
                      <div className="relative bg-slate-900/50 backdrop-blur-sm border border-orange-500/20 rounded-lg p-2.5 text-center hover:border-orange-500/40 transition-all">
                        <div className="text-orange-400 font-bold text-xl mb-0.5">{networkStats.totalRelays}</div>
                        <div className="text-white/40 text-[9px] uppercase tracking-wider font-bold">Relays</div>
                      </div>
                    </div>
                    
                    <div className="relative group">
                      <div className="absolute inset-0 bg-gradient-to-br from-cyan-500/10 to-transparent rounded-lg opacity-0 group-hover:opacity-100 transition-opacity"></div>
                      <div className="relative bg-slate-900/50 backdrop-blur-sm border border-cyan-500/20 rounded-lg p-2.5 text-center hover:border-cyan-500/40 transition-all">
                        <div className="text-cyan-400 font-bold text-xl mb-0.5">{networkStats.activeNow}</div>
                        <div className="text-white/40 text-[9px] uppercase tracking-wider font-bold">Online</div>
                      </div>
                    </div>
                  </div>
                </div>

                {/* Modern Node List - Scrollable (Flex to fill remaining space) */}
                <div className="flex-1 overflow-y-auto bg-gradient-to-b from-slate-950/40 to-slate-900/40 custom-scrollbar">
                  <div className="p-4 space-y-3">
                    {globalNodes.length > 0 ? globalNodes.map((node, idx) => (
                      <div key={node.id} className="group relative bg-gradient-to-br from-slate-900/60 to-slate-800/60 backdrop-blur-sm border border-white/5 rounded-xl p-4 hover:border-cyan-500/30 transition-all hover:shadow-lg hover:shadow-cyan-500/10">
                        {/* Hover glow effect */}
                        <div className="absolute inset-0 bg-gradient-to-br from-cyan-500/5 to-emerald-500/5 rounded-xl opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        
                        <div className="relative">
                          {/* Node Header */}
                          <div className="flex items-center justify-between mb-3">
                            <div className="flex items-center gap-2.5">
                              <div className={`relative w-2.5 h-2.5 rounded-full ${
                                node.status === 'active' 
                                  ? 'bg-emerald-500 shadow-lg shadow-emerald-500/50' 
                                  : 'bg-orange-500 shadow-lg shadow-orange-500/50'
                              }`}>
                                {node.status === 'active' && (
                                  <div className="absolute inset-0 rounded-full bg-emerald-500 animate-ping opacity-75"></div>
                                )}
                              </div>
                              <span className="text-[11px] font-bold text-cyan-400 tracking-wide">NODE_{String(idx + 1).padStart(3, '0')}</span>
                            </div>
                            <span className={`px-2.5 py-1 rounded-md text-[9px] font-bold tracking-wider ${
                              node.status === 'active' 
                                ? 'bg-emerald-500/15 text-emerald-300 border border-emerald-500/30 shadow-sm shadow-emerald-500/20' 
                                : 'bg-orange-500/15 text-orange-300 border border-orange-500/30'
                            }`}>
                              {node.status.toUpperCase()}
                            </span>
                          </div>
                          
                          {/* Node Details Grid */}
                          <div className="space-y-2 text-[10px]">
                            <div className="flex items-center justify-between py-1.5 border-b border-white/5">
                              <span className="text-white/40 font-medium">ID</span>
                              <span className="text-cyan-400 font-mono font-bold">{node.id}</span>
                            </div>
                            <div className="flex items-center justify-between py-1.5 border-b border-white/5">
                              <span className="text-white/40 font-medium">📍 Location</span>
                              <span className="text-white/90 font-bold">{node.location}</span>
                            </div>
                            <div className="flex items-center justify-between py-1.5 border-b border-white/5">
                              <span className="text-white/40 font-medium">🌐 Wallet</span>
                              <span className="text-blue-400 font-mono text-[9px] font-bold">{node.wallet?.slice(0, 6)}...{node.wallet?.slice(-4)}</span>
                            </div>
                            
                            {/* Metrics Row */}
                            <div className="grid grid-cols-3 gap-2 mt-3 pt-3 border-t border-white/10">
                              <div className="text-center">
                                <div className="text-white/40 text-[9px] mb-1">UPTIME</div>
                                <div className="text-cyan-300 font-bold text-[11px]">{node.uptime}</div>
                              </div>
                              <div className="text-center border-x border-white/5">
                                <div className="text-white/40 text-[9px] mb-1">RELAYS</div>
                                <div className="text-orange-300 font-bold text-[11px]">{node.relays}</div>
                              </div>
                              <div className="text-center">
                                <div className="text-white/40 text-[9px] mb-1">REP</div>
                                <div className="text-emerald-300 font-bold text-[11px]">{node.reputation}</div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    )) : (
                      <div className="flex items-center justify-center h-full">
                        <div className="text-center max-w-xs">
                          <div className="w-16 h-16 mx-auto mb-4 rounded-2xl bg-gradient-to-br from-cyan-500/10 to-emerald-500/10 border border-cyan-500/20 flex items-center justify-center">
                            <svg className="w-8 h-8 text-cyan-400/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="1.5" d="M5 12h14M12 5l7 7-7 7" />
                            </svg>
                          </div>
                          <div className="text-white/60 text-sm font-bold mb-2">No Active Nodes</div>
                          <div className="text-white/40 text-xs leading-relaxed">Waiting for nodes to connect to the network...</div>
                        </div>
                      </div>
                    )}
                  </div>
                </div>

                {/* Your Node Status - Modern Footer */}
                {walletAddress && stakedAmount >= 10000 && (
                  <div className="relative bg-gradient-to-r from-slate-950 via-slate-900 to-slate-950 border-t border-cyan-500/20 px-5 py-3.5">
                    {/* Bottom accent line */}
                    <div className="absolute bottom-0 left-0 right-0 h-[2px] bg-gradient-to-r from-transparent via-emerald-400/50 to-transparent"></div>
                    
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-3">
                        <div className="relative">
                          <div className={`w-3 h-3 rounded-full ${nodeActive ? 'bg-emerald-500 shadow-lg shadow-emerald-500/50' : 'bg-slate-600'}`}></div>
                          {nodeActive && (
                            <div className="absolute inset-0 rounded-full bg-emerald-500 animate-ping opacity-75"></div>
                          )}
                        </div>
                        <div>
                          <div className="text-[9px] text-white/40 uppercase tracking-wider mb-0.5">Your Node</div>
                          <div className="text-[11px] font-mono font-bold text-cyan-400">{walletAddress?.slice(0, 8)}...{walletAddress?.slice(-6)}</div>
                        </div>
                      </div>
                      {nodeActive && (
                        <div className="flex items-center gap-3 text-[10px]">
                          <div className="flex items-center gap-1.5">
                            <span className="text-white/40">Relays:</span>
                            <span className="text-orange-300 font-bold">{successfulRelays}</span>
                          </div>
                          <div className="w-px h-4 bg-white/10"></div>
                          <div className="flex items-center gap-1.5">
                            <span className="text-white/40">Rep:</span>
                            <span className="text-emerald-300 font-bold">{reputation}</span>
                          </div>
                        </div>
                      )}
                    </div>
                  </div>
                )}
              </div>
            </div>
          </div>

          {/* Main Dashboard - Only show when wallet connected */}
          {walletAddress ? (
            <>
              {/* Stats Grid */}
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div className="bg-gradient-to-br from-blue-50 to-cyan-50 dark:from-blue-950/50 dark:to-cyan-950/50 rounded-2xl p-4 border border-blue-200/50 dark:border-blue-800/50">
                  <div className="flex items-center gap-3 mb-2">
                    <div className="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-500 to-cyan-600 flex items-center justify-center">
                      <svg className="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                      </svg>
                    </div>
                    <div>
                      <div className="text-[10px] text-blue-600 dark:text-blue-400 font-bold uppercase tracking-wider">Staked</div>
                      <div className="text-xl font-black text-blue-900 dark:text-blue-300">{stakedAmount.toLocaleString()}</div>
                    </div>
                  </div>
                  <div className="text-[9px] text-slate-600 dark:text-slate-400">$WHISTLE locked</div>
                </div>

                <div className="bg-gradient-to-br from-emerald-50 to-teal-50 dark:from-emerald-950/50 dark:to-teal-950/50 rounded-2xl p-4 border border-emerald-200/50 dark:border-emerald-800/50">
                  <div className="flex items-center gap-3 mb-2">
                    <div className="w-10 h-10 rounded-lg bg-gradient-to-br from-emerald-500 to-teal-600 flex items-center justify-center">
                      <svg className="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                      </svg>
                    </div>
                    <div>
                      <div className="text-[10px] text-emerald-600 dark:text-emerald-400 font-bold uppercase tracking-wider">Reputation</div>
                      <div className="text-xl font-black text-emerald-900 dark:text-emerald-300">{reputation}</div>
                    </div>
                  </div>
                  <div className="text-[9px] text-slate-600 dark:text-slate-400">Network score</div>
                </div>

                <div className="bg-gradient-to-br from-orange-50 to-amber-50 dark:from-orange-950/50 dark:to-amber-950/50 rounded-2xl p-4 border border-orange-200/50 dark:border-orange-800/50">
                  <div className="flex items-center gap-3 mb-2">
                    <div className="w-10 h-10 rounded-lg bg-gradient-to-br from-orange-500 to-amber-600 flex items-center justify-center">
                      <svg className="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                      </svg>
                    </div>
                    <div>
                      <div className="text-[10px] text-orange-600 dark:text-orange-400 font-bold uppercase tracking-wider">Rewards</div>
                      <div className="text-xl font-black text-orange-900 dark:text-orange-300">{pendingRewards.toFixed(2)}</div>
                    </div>
                  </div>
                  <button
                    onClick={handleClaimRewards}
                    disabled={pendingRewards === 0 || loading}
                    className="text-[9px] font-bold text-orange-600 dark:text-orange-400 hover:text-orange-800 dark:hover:text-orange-300 disabled:opacity-40 disabled:cursor-not-allowed"
                  >
                    CLAIM NOW
                  </button>
                </div>

                <div className="bg-gradient-to-br from-cyan-50 to-sky-50 dark:from-cyan-950/50 dark:to-sky-950/50 rounded-2xl p-4 border border-cyan-200/50 dark:border-cyan-800/50">
                  <div className="flex items-center gap-3 mb-2">
                    <div className="w-10 h-10 rounded-lg bg-gradient-to-br from-cyan-500 to-sky-600 flex items-center justify-center">
                      <div className={`relative w-3 h-3 ${nodeActive ? 'bg-white' : 'bg-white/50'} rounded-full`}></div>
                    </div>
                    <div>
                      <div className="text-[10px] text-cyan-600 dark:text-cyan-400 font-bold uppercase tracking-wider">Node</div>
                      <div className="text-xl font-black text-cyan-900 dark:text-cyan-300">{nodeActive ? 'ACTIVE' : 'OFFLINE'}</div>
                    </div>
                  </div>
                  <div className="text-[9px] text-slate-600 dark:text-slate-400">{totalRelays} total relays</div>
                </div>
              </div>

              {/* Action Buttons */}
              <div className="grid md:grid-cols-3 gap-4">
                <button
                  onClick={() => setShowStakeModal(true)}
                  className="px-6 py-4 rounded-2xl bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-500 hover:to-cyan-500 text-white font-bold shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-2"
                >
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                  </svg>
                  STAKE $WHISTLE
                </button>

                <button
                  onClick={toggleNode}
                  disabled={stakedAmount < 10000}
                  className={`px-6 py-4 rounded-2xl font-bold shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-2 ${
                    stakedAmount < 10000
                      ? 'bg-slate-400 dark:bg-slate-700 text-white opacity-50 cursor-not-allowed'
                      : nodeActive
                        ? 'bg-gradient-to-r from-red-600 to-orange-600 hover:from-red-500 hover:to-orange-500 text-white'
                        : 'bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-500 hover:to-teal-500 text-white'
                  }`}
                >
                  {nodeActive ? (
                    <>
                      <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                        <rect x="6" y="6" width="12" height="12" rx="1"/>
                      </svg>
                      STOP NODE
                    </>
                  ) : (
                    <>
                      <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M8 5v14l11-7z"/>
                      </svg>
                      {stakedAmount >= 10000 ? 'START NODE' : 'LOCKED - STAKE FIRST'}
                    </>
                  )}
                </button>

                <button
                  onClick={handleUnstake}
                  disabled={loading || nodeActive || stakedAmount === 0 || pendingRewards > 0}
                  className="px-6 py-4 rounded-2xl bg-gradient-to-r from-red-600 to-orange-600 hover:from-red-500 hover:to-orange-500 text-white font-bold shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                  </svg>
                  {nodeActive ? 'STOP NODE FIRST' : pendingRewards > 0 ? 'CLAIM FIRST' : stakedAmount === 0 ? 'NO STAKE' : 'UNSTAKE ALL'}
                </button>
              </div>

              {/* MODERN NODE DASHBOARD - Only show when active */}
              {nodeActive && (
                <div className="relative overflow-hidden rounded-3xl border border-white/10 bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 p-8 shadow-2xl">
                  {/* Glassmorphic effects */}
                  <div className="absolute inset-0 bg-gradient-to-br from-emerald-500/5 via-cyan-500/5 to-blue-500/5 pointer-events-none"></div>
                  <div className="absolute -inset-[1px] rounded-3xl bg-gradient-to-r from-emerald-500/20 via-cyan-500/20 to-blue-500/20 blur-xl opacity-40 animate-pulse"></div>
                  
                  {/* Top accent line */}
                  <div className="absolute top-0 left-0 right-0 h-[2px] bg-gradient-to-r from-transparent via-emerald-400/60 to-transparent"></div>
                  
                  <div className="relative z-10 space-y-6">
                    {/* STATUS HERO */}
                    <div className="relative overflow-hidden rounded-2xl border border-emerald-500/20 bg-gradient-to-br from-emerald-950/40 to-teal-950/40 backdrop-blur-xl p-6">
                      <div className="absolute top-0 right-0 w-64 h-64 bg-emerald-500/10 rounded-full blur-3xl"></div>
                      <div className="relative z-10">
                        <div className="flex items-center justify-between mb-6">
                          <div className="flex items-center gap-4">
                            <div className="relative">
                              <div className="w-14 h-14 bg-emerald-500 rounded-2xl flex items-center justify-center shadow-lg shadow-emerald-500/50">
                                <svg className="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                              </div>
                              <div className="absolute -top-1 -right-1 w-4 h-4 bg-green-400 rounded-full animate-ping"></div>
                              <div className="absolute -top-1 -right-1 w-4 h-4 bg-green-500 rounded-full"></div>
                            </div>
                            <div>
                              <h3 className="text-2xl font-black text-white mb-1">NODE OPERATIONAL</h3>
                              <p className="text-sm text-emerald-300">Your privacy relay is active and earning</p>
                            </div>
                          </div>
                          <div className="text-right">
                            <div className="text-xs text-emerald-300 font-bold uppercase tracking-wider mb-1">Session Uptime</div>
                            <div className="text-3xl font-black text-white">{formatUptime(nodeUptime)}</div>
                          </div>
                        </div>
                        
                        {/* Node Region Display */}
                        {nodeRegion && (
                          <div className="flex items-center justify-center gap-2 text-emerald-200 mb-4 py-2 bg-emerald-500/10 rounded-lg">
                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                            <span className="text-sm font-bold">Broadcasting from: {nodeRegion}</span>
                            <span className="text-xs text-emerald-400 ml-2 font-mono">{walletAddress?.slice(0,4)}...{walletAddress?.slice(-4)}</span>
                          </div>
                        )}
                        
                        {/* Quick Metrics Grid */}
                        <div className="grid grid-cols-4 gap-3">
                          <div className="bg-slate-900/60 backdrop-blur-sm border border-white/10 rounded-xl p-3 text-center hover:border-cyan-500/30 transition-all">
                            <div className="text-xs text-white/50 mb-1">Node ID</div>
                            <div className="text-lg font-black text-cyan-400">{nearbyNodes.length + 1}</div>
                          </div>
                          <div className="bg-slate-900/60 backdrop-blur-sm border border-white/10 rounded-xl p-3 text-center hover:border-emerald-500/30 transition-all">
                            <div className="text-xs text-white/50 mb-1">Connected Peers</div>
                            <div className="text-lg font-black text-emerald-400">{nearbyNodes.length}</div>
                          </div>
                          <div className="bg-slate-900/60 backdrop-blur-sm border border-white/10 rounded-xl p-3 text-center hover:border-orange-500/30 transition-all">
                            <div className="text-xs text-white/50 mb-1">Total Relays</div>
                            <div className="text-lg font-black text-orange-400">{totalRelays}</div>
                          </div>
                          <div className="bg-slate-900/60 backdrop-blur-sm border border-white/10 rounded-xl p-3 text-center hover:border-purple-500/30 transition-all">
                            <div className="text-xs text-white/50 mb-1">Success Rate</div>
                            <div className="text-lg font-black text-purple-400">{totalRelays > 0 ? ((successfulRelays / totalRelays) * 100).toFixed(1) : 100}%</div>
                          </div>
                        </div>
                      </div>
                    </div>

                    {/* Detailed Node Statistics */}
                    <div className="bg-white/80 dark:bg-slate-900/80 rounded-2xl p-6 border border-slate-200/50 dark:border-slate-700/50">
                    <h3 className="text-lg font-black text-slate-900 dark:text-white mb-6 flex items-center gap-2">
                      <svg className="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                      </svg>
                      Node Performance Metrics
                    </h3>
                    
                    <div className="grid md:grid-cols-2 gap-6">
                      {/* Network Performance */}
                      <div className="space-y-4">
                        <h4 className="text-sm font-bold text-slate-700 dark:text-slate-300 uppercase tracking-wider">Network Performance</h4>
                        
                        <div className="space-y-3">
                          <div className="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800/50 rounded-lg">
                            <span className="text-sm text-slate-600 dark:text-slate-400">Relay Success Rate</span>
                            <span className="text-lg font-black text-emerald-600 dark:text-emerald-400">
                              {totalRelays > 0 ? ((successfulRelays / totalRelays) * 100).toFixed(1) : 100}%
                            </span>
                          </div>
                          
                          <div className="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800/50 rounded-lg">
                            <span className="text-sm text-slate-600 dark:text-slate-400">Successful Relays</span>
                            <span className="text-lg font-black text-green-600 dark:text-green-400">{successfulRelays}</span>
                          </div>
                          
                          <div className="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800/50 rounded-lg">
                            <span className="text-sm text-slate-600 dark:text-slate-400">Failed Relays</span>
                            <span className="text-lg font-black text-red-600 dark:text-red-400">{totalRelays - successfulRelays}</span>
                          </div>
                          
                          <div className="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800/50 rounded-lg">
                            <span className="text-sm text-slate-600 dark:text-slate-400">Average Per Hour</span>
                            <span className="text-lg font-black text-blue-600 dark:text-blue-400">
                              {nodeUptime > 0 ? ((totalRelays / (nodeUptime / 3600)) || 0).toFixed(1) : '0.0'}
                            </span>
                          </div>
                        </div>
                      </div>

                      {/* Node Status & Reputation */}
                      <div className="space-y-4">
                        <h4 className="text-sm font-bold text-slate-700 dark:text-slate-300 uppercase tracking-wider">Node Status & Reputation</h4>
                        
                        <div className="space-y-3">
                          <div className="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800/50 rounded-lg">
                            <span className="text-sm text-slate-600 dark:text-slate-400">Network Reputation</span>
                            <span className="text-lg font-black text-purple-600 dark:text-purple-400">{reputation}</span>
                          </div>
                          
                          <div className="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800/50 rounded-lg">
                            <span className="text-sm text-slate-600 dark:text-slate-400">Staked Amount</span>
                            <span className="text-lg font-black text-indigo-600 dark:text-indigo-400">{stakedAmount.toLocaleString()}</span>
                          </div>
                          
                          <div className="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800/50 rounded-lg">
                            <span className="text-sm text-slate-600 dark:text-slate-400">Pending Rewards</span>
                            <span className="text-lg font-black text-orange-600 dark:text-orange-400">{pendingRewards.toFixed(2)}</span>
                          </div>
                          
                          <div className="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800/50 rounded-lg">
                            <span className="text-sm text-slate-600 dark:text-slate-400">Network Position</span>
                            <span className="text-lg font-black text-cyan-600 dark:text-cyan-400">
                              #{networkStats.totalNodes > 0 ? Math.min(reputation || 1, networkStats.totalNodes) : 1}
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>

                    {/* Reward Rate Calculation */}
                    <div className="mt-6 p-4 bg-gradient-to-r from-amber-50 to-orange-50 dark:from-amber-950/30 dark:to-orange-950/30 rounded-xl border border-amber-200 dark:border-amber-800">
                      <div className="flex items-center justify-between">
                        <div>
                          <div className="text-xs text-amber-700 dark:text-amber-400 font-bold uppercase tracking-wider mb-1">Current Earning Rate</div>
                          <div className="text-2xl font-black text-amber-900 dark:text-amber-300">
                            {nodeUptime > 0 && totalRelays > 0 
                              ? ((pendingRewards / (nodeUptime / 3600)) || 0).toFixed(2)
                              : '0.00'} $WHISTLE/hr
                          </div>
                        </div>
                        <div className="text-right">
                          <div className="text-xs text-amber-700 dark:text-amber-400 font-bold uppercase tracking-wider mb-1">Est. 24h Earnings</div>
                          <div className="text-2xl font-black text-amber-900 dark:text-amber-300">
                            {nodeUptime > 0 && totalRelays > 0 
                              ? ((pendingRewards / (nodeUptime / 3600)) * 24 || 0).toFixed(2)
                              : '0.00'} $WHISTLE
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  {/* Connected Peers Network Map */}
                  {nearbyNodes.length > 0 && (
                    <div className="bg-white/80 dark:bg-slate-900/80 rounded-2xl p-6 border border-slate-200/50 dark:border-slate-700/50">
                      <h3 className="text-lg font-black text-slate-900 dark:text-white mb-4 flex items-center gap-2">
                        <svg className="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                        Connected Peers ({nearbyNodes.length})
                      </h3>
                      <div className="grid md:grid-cols-2 gap-3">
                        {nearbyNodes.map(node => (
                          <div key={node.id} className="flex items-center justify-between p-4 bg-slate-50 dark:bg-slate-800/50 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 transition-all">
                            <div className="flex items-center gap-3">
                              <div className={`relative w-3 h-3 rounded-full ${node.signal > 80 ? 'bg-emerald-500' : node.signal > 50 ? 'bg-orange-500' : 'bg-red-500'}`}>
                                <div className="absolute inset-0 rounded-full animate-ping opacity-75" style={{backgroundColor: node.signal > 80 ? '#10b981' : node.signal > 50 ? '#f97316' : '#ef4444'}}></div>
                              </div>
                              <div>
                                <div className="text-sm font-mono font-bold text-slate-900 dark:text-white">{node.name}</div>
                                <div className="text-[10px] text-slate-500 dark:text-slate-400">
                                  {node.region && <span className="mr-2">📍 {node.region.split('/').pop()}</span>}
                                  {node.relays || 0} relays
                                </div>
                              </div>
                            </div>
                            <div className="text-right">
                              <div className={`text-lg font-black ${node.signal > 80 ? 'text-emerald-600 dark:text-emerald-400' : node.signal > 50 ? 'text-orange-600 dark:text-orange-400' : 'text-red-600 dark:text-red-400'}`}>
                                {Math.floor(node.signal)}%
                              </div>
                              <div className="text-[10px] text-slate-500 dark:text-slate-400">signal</div>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                  {/* Network Health Indicator */}
                  <div className="bg-white/80 dark:bg-slate-900/80 rounded-2xl p-6 border border-slate-200/50 dark:border-slate-700/50">
                    <h3 className="text-lg font-black text-slate-900 dark:text-white mb-4 flex items-center gap-2">
                      <svg className="w-5 h-5 text-cyan-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                      </svg>
                      Network Health & Connectivity
                    </h3>
                    <div className="grid grid-cols-3 gap-4">
                      <div className="text-center p-4 bg-gradient-to-br from-emerald-50 to-teal-50 dark:from-emerald-950/30 dark:to-teal-950/30 rounded-xl">
                        <div className="text-3xl font-black text-emerald-600 dark:text-emerald-400">
                          {nearbyNodes.length > 0 ? 'STRONG' : 'SEARCHING'}
                        </div>
                        <div className="text-xs text-slate-600 dark:text-slate-400 mt-2">Connection Strength</div>
                      </div>
                      <div className="text-center p-4 bg-gradient-to-br from-blue-50 to-cyan-50 dark:from-blue-950/30 dark:to-cyan-950/30 rounded-xl">
                        <div className="text-3xl font-black text-blue-600 dark:text-blue-400">
                          {nearbyNodes.length > 0 ? Math.floor(nearbyNodes.reduce((sum, n) => sum + n.signal, 0) / nearbyNodes.length) : 0}%
                        </div>
                        <div className="text-xs text-slate-600 dark:text-slate-400 mt-2">Avg. Signal Quality</div>
                      </div>
                      <div className="text-center p-4 bg-gradient-to-br from-purple-50 to-pink-50 dark:from-purple-950/30 dark:to-pink-950/30 rounded-xl">
                        <div className="text-3xl font-black text-purple-600 dark:text-purple-400">
                          {totalRelays > 0 ? 'ACTIVE' : 'STANDBY'}
                        </div>
                        <div className="text-xs text-slate-600 dark:text-slate-400 mt-2">Relay Status</div>
                      </div>
                    </div>
                  </div>
                  </div>
                </div>
              )}

              {/* Info Section */}
              <div className="bg-gradient-to-r from-blue-50 to-cyan-50 dark:from-blue-950/30 dark:to-cyan-950/30 rounded-2xl p-6 border border-blue-200 dark:border-blue-800">
                <h3 className="text-lg font-black text-slate-900 dark:text-white mb-4">How It Works</h3>
                <div className="grid md:grid-cols-3 gap-4 text-sm text-slate-700 dark:text-slate-300">
                  <div>
                    <div className="font-bold mb-2">1. Stake $WHISTLE</div>
                    <p className="text-xs">Lock at least 10,000 $WHISTLE tokens to activate your node</p>
                  </div>
                  <div>
                    <div className="font-bold mb-2">2. Run Your Node</div>
                    <p className="text-xs">Keep your browser open to relay transactions through the mesh network</p>
                  </div>
                  <div>
                    <div className="font-bold mb-2">3. Earn Rewards</div>
                    <p className="text-xs">Get paid 8 $WHISTLE for each successful relay based on your reputation</p>
                  </div>
                </div>
              </div>

              {/* Unstake Section - removed per request */}

              {/* ANONYMOUS RELAY SERVICE - HIDDEN IN OFFLINE NETWORK */}
              <div className="hidden bg-gradient-to-br from-purple-50 via-indigo-50 to-blue-50 dark:from-purple-950/30 dark:via-indigo-950/30 dark:to-blue-950/30 rounded-3xl p-8 border border-purple-200 dark:border-purple-800">
                <div className="flex items-center justify-between mb-6">
                  <div>
                    <h2 className="text-2xl font-black text-slate-900 dark:text-white flex items-center gap-3">
                      <svg className="w-8 h-8 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                      </svg>
                      🔒 Anonymous Relay Service
                    </h2>
                    <p className="text-sm text-slate-600 dark:text-slate-400 mt-2">
                      Send transactions anonymously through privacy nodes • Works offline • Multi-hop encryption
                    </p>
                  </div>
                  <div className="px-4 py-2 bg-purple-100 dark:bg-purple-900/50 rounded-full">
                    <span className="text-xs font-bold text-purple-700 dark:text-purple-300 uppercase tracking-wider">Beta</span>
                  </div>
                </div>

                {/* Relay Credits Balance */}
                <div className="grid md:grid-cols-3 gap-4 mb-6">
                  <div className="bg-white dark:bg-slate-900 rounded-xl p-4 border border-purple-100 dark:border-purple-900">
                    <div className="text-xs text-slate-600 dark:text-slate-400 uppercase tracking-wider mb-1">Your Balance</div>
                    <div className="text-2xl font-black text-purple-600 dark:text-purple-400">{tokenBalance.toLocaleString()} $WHISTLE</div>
                  </div>
                  <div className="bg-white dark:bg-slate-900 rounded-xl p-4 border border-purple-100 dark:border-purple-900">
                    <div className="text-xs text-slate-600 dark:text-slate-400 uppercase tracking-wider mb-1">Available Relays</div>
                    <div className="text-2xl font-black text-indigo-600 dark:text-indigo-400">~{Math.floor(tokenBalance / 25)}</div>
                    <div className="text-[10px] text-slate-500 dark:text-slate-400">@ 25 $WHISTLE per relay</div>
                  </div>
                  <div className="bg-white dark:bg-slate-900 rounded-xl p-4 border border-purple-100 dark:border-purple-900">
                    <div className="text-xs text-slate-600 dark:text-slate-400 uppercase tracking-wider mb-1">Relays Completed</div>
                    <div className="text-2xl font-black text-blue-600 dark:text-blue-400">{totalRelays}</div>
                  </div>
                </div>

                {/* How It Works */}
                <div className="bg-white dark:bg-slate-900 rounded-xl p-6 mb-6 border border-purple-100 dark:border-purple-900">
                  <h3 className="text-lg font-black text-slate-900 dark:text-white mb-4 flex items-center gap-2">
                    <svg className="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    How Anonymous Relay Works
                  </h3>
                  <div className="grid md:grid-cols-4 gap-4 text-sm">
                    <div className="text-center">
                      <div className="w-12 h-12 rounded-full bg-purple-100 dark:bg-purple-900/50 flex items-center justify-center mx-auto mb-2">
                        <span className="text-xl font-bold text-purple-600 dark:text-purple-400">1</span>
                      </div>
                      <div className="font-bold text-slate-900 dark:text-white mb-1">Create & Sign</div>
                      <div className="text-xs text-slate-600 dark:text-slate-400">Sign transaction offline on your device</div>
                    </div>
                    <div className="text-center">
                      <div className="w-12 h-12 rounded-full bg-indigo-100 dark:bg-indigo-900/50 flex items-center justify-center mx-auto mb-2">
                        <span className="text-xl font-bold text-indigo-600 dark:text-indigo-400">2</span>
                      </div>
                      <div className="font-bold text-slate-900 dark:text-white mb-1">Multi-Hop Relay</div>
                      <div className="text-xs text-slate-600 dark:text-slate-400">3-5 privacy nodes relay your transaction</div>
                    </div>
                    <div className="text-center">
                      <div className="w-12 h-12 rounded-full bg-blue-100 dark:bg-blue-900/50 flex items-center justify-center mx-auto mb-2">
                        <span className="text-xl font-bold text-blue-600 dark:text-blue-400">3</span>
                      </div>
                      <div className="font-bold text-slate-900 dark:text-white mb-1">Broadcast</div>
                      <div className="text-xs text-slate-600 dark:text-slate-400">Final node submits to Solana</div>
                    </div>
                    <div className="text-center">
                      <div className="w-12 h-12 rounded-full bg-emerald-100 dark:bg-emerald-900/50 flex items-center justify-center mx-auto mb-2">
                        <span className="text-xl font-bold text-emerald-600 dark:text-emerald-400">4</span>
                      </div>
                      <div className="font-bold text-slate-900 dark:text-white mb-1">Nodes Earn</div>
                      <div className="text-xs text-slate-600 dark:text-slate-400">Relay fee split among nodes</div>
                    </div>
                  </div>
                </div>

                {/* Create Relay Request */}
                <div className="bg-gradient-to-br from-white to-purple-50 dark:from-slate-900 dark:to-purple-950/30 rounded-xl p-6 border border-purple-200 dark:border-purple-800">
                  <h3 className="text-lg font-black text-slate-900 dark:text-white mb-4">Create Anonymous Relay</h3>
                  
                  <div className="space-y-4">
                    {/* Recipient Address */}
                    <div>
                      <label className="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">
                        Send To (Solana Address)
                      </label>
                      <input
                        type="text"
                        placeholder="7NFF..."
                        value={relayRecipient}
                        onChange={(e) => setRelayRecipient(e.target.value)}
                        className="w-full px-4 py-3 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-white focus:ring-2 focus:ring-purple-500 outline-none"
                      />
                    </div>

                    {/* Amount */}
                    <div className="grid md:grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">
                          Amount
                        </label>
                        <input
                          type="number"
                          placeholder="0.5"
                          step="0.001"
                          value={relayAmount}
                          onChange={(e) => setRelayAmount(e.target.value)}
                          className="w-full px-4 py-3 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-white focus:ring-2 focus:ring-purple-500 outline-none"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">
                          Token
                        </label>
                        <select 
                          value={relayToken}
                          onChange={(e) => setRelayToken(e.target.value)}
                          className="w-full px-4 py-3 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-white focus:ring-2 focus:ring-purple-500 outline-none"
                        >
                          <option>SOL</option>
                          <option>$WHISTLE</option>
                          <option>USDC</option>
                        </select>
                      </div>
                    </div>

                    {/* Privacy Level */}
                    <div>
                      <label className="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-3">
                        Privacy Level (Number of Hops)
                      </label>
                      <div className="space-y-3">
                        <label className={`flex items-center justify-between p-4 rounded-lg border-2 cursor-pointer transition-all ${privacyLevel === 3 ? 'border-purple-400 dark:border-purple-600 bg-purple-50 dark:bg-purple-900/20' : 'border-slate-200 dark:border-slate-700 hover:border-purple-400 dark:hover:border-purple-600'}`}>
                          <div className="flex items-center gap-3">
                            <input 
                              type="radio" 
                              name="privacy" 
                              value="3" 
                              checked={privacyLevel === 3}
                              onChange={(e) => setPrivacyLevel(parseInt(e.target.value))}
                              className="w-4 h-4 text-purple-600" 
                            />
                            <div>
                              <div className="font-bold text-slate-900 dark:text-white">Standard (3 hops)</div>
                              <div className="text-xs text-slate-600 dark:text-slate-400">Good privacy • Fast</div>
                            </div>
                          </div>
                          <div className="text-sm font-bold text-purple-600 dark:text-purple-400">15 $WHISTLE</div>
                        </label>
                        <label className={`flex items-center justify-between p-4 rounded-lg border-2 cursor-pointer transition-all ${privacyLevel === 5 ? 'border-purple-400 dark:border-purple-600 bg-purple-50 dark:bg-purple-900/20' : 'border-slate-200 dark:border-slate-700 hover:border-purple-400 dark:hover:border-purple-600'}`}>
                          <div className="flex items-center gap-3">
                            <input 
                              type="radio" 
                              name="privacy" 
                              value="5" 
                              checked={privacyLevel === 5}
                              onChange={(e) => setPrivacyLevel(parseInt(e.target.value))}
                              className="w-4 h-4 text-purple-600" 
                            />
                            <div>
                              <div className="font-bold text-slate-900 dark:text-white">High (5 hops) ⭐ Recommended</div>
                              <div className="text-xs text-slate-600 dark:text-slate-400">Strong privacy • Balanced</div>
                            </div>
                          </div>
                          <div className="text-sm font-bold text-purple-600 dark:text-purple-400">25 $WHISTLE</div>
                        </label>
                        <label className={`flex items-center justify-between p-4 rounded-lg border-2 cursor-pointer transition-all ${privacyLevel === 7 ? 'border-purple-400 dark:border-purple-600 bg-purple-50 dark:bg-purple-900/20' : 'border-slate-200 dark:border-slate-700 hover:border-purple-400 dark:hover:border-purple-600'}`}>
                          <div className="flex items-center gap-3">
                            <input 
                              type="radio" 
                              name="privacy" 
                              value="7" 
                              checked={privacyLevel === 7}
                              onChange={(e) => setPrivacyLevel(parseInt(e.target.value))}
                              className="w-4 h-4 text-purple-600" 
                            />
                            <div>
                              <div className="font-bold text-slate-900 dark:text-white">Maximum (7 hops)</div>
                              <div className="text-xs text-slate-600 dark:text-slate-400">Extreme privacy • Slower</div>
                            </div>
                          </div>
                          <div className="text-sm font-bold text-purple-600 dark:text-purple-400">50 $WHISTLE</div>
                        </label>
                      </div>
                    </div>

                    {/* Offline Mode */}
                    <div className="bg-indigo-50 dark:bg-indigo-950/30 rounded-lg p-4 border border-indigo-200 dark:border-indigo-800">
                      <div className="flex items-start gap-3">
                        <svg className="w-6 h-6 text-indigo-600 dark:text-indigo-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0" />
                        </svg>
                        <div className="flex-1">
                          <div className="font-bold text-indigo-900 dark:text-indigo-300 mb-1">✅ Offline Mode Available</div>
                          <div className="text-sm text-indigo-700 dark:text-indigo-400 mb-2">
                            Sign transaction offline, then transmit via:
                          </div>
                          <div className="text-xs text-indigo-600 dark:text-indigo-400 space-y-1">
                            <div>• Nearby nodes (automatic if node detected)</div>
                            <div>• QR Code (scan with internet-connected device)</div>
                            <div>• Bluetooth/WiFi Direct</div>
                          </div>
                        </div>
                      </div>
                    </div>

                    {/* Buttons */}
                    <div className="grid md:grid-cols-2 gap-4 pt-2">
                      <button
                        onClick={createRelayRequest}
                        disabled={!walletAddress || creatingRelay}
                        className="px-6 py-4 rounded-xl bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-500 hover:to-indigo-500 text-white font-bold shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                      >
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
                        </svg>
                        {creatingRelay ? 'Creating...' : 'Sign & Create Relay'}
                      </button>
                      <button
                        onClick={generateQRCodeForRelay}
                        disabled={!walletAddress}
                        className="px-6 py-4 rounded-xl bg-white dark:bg-slate-800 border-2 border-purple-600 dark:border-purple-400 text-purple-600 dark:text-purple-400 font-bold hover:bg-purple-50 dark:hover:bg-purple-900/20 transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                      >
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" />
                        </svg>
                        Generate QR Code (Offline)
                      </button>
                    </div>
                  </div>
                </div>

                {/* Relay History */}
                <div className="mt-6 bg-white dark:bg-slate-900 rounded-xl p-6 border border-purple-100 dark:border-purple-900">
                  <h3 className="text-lg font-black text-slate-900 dark:text-white mb-4">Recent Relays</h3>
                  {relayHistory.length === 0 ? (
                    <div className="text-center py-8">
                      <svg className="w-16 h-16 text-slate-300 dark:text-slate-700 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                      </svg>
                      <div className="text-slate-500 dark:text-slate-400 font-bold mb-1">No Relays Yet</div>
                      <div className="text-sm text-slate-400 dark:text-slate-500">Create your first anonymous relay above</div>
                    </div>
                  ) : (
                    <div className="space-y-3">
                      {relayHistory.slice(0, 5).map((relay, idx) => (
                        <div key={relay.id} className={`flex items-center justify-between p-4 rounded-lg border ${
                          relay.status === 'pending' ? 'bg-blue-50 dark:bg-blue-950/30 border-blue-200 dark:border-blue-800' :
                          relay.status === 'in-progress' ? 'bg-orange-50 dark:bg-orange-950/30 border-orange-200 dark:border-orange-800' :
                          'bg-emerald-50 dark:bg-emerald-950/30 border-emerald-200 dark:border-emerald-800'
                        }`}>
                          <div className="flex items-center gap-3">
                            <div className={`w-10 h-10 rounded-full flex items-center justify-center ${
                              relay.status === 'pending' ? 'bg-blue-100 dark:bg-blue-900/50' :
                              relay.status === 'in-progress' ? 'bg-orange-100 dark:bg-orange-900/50' :
                              'bg-emerald-100 dark:bg-emerald-900/50'
                            }`}>
                              <svg className={`w-5 h-5 ${
                                relay.status === 'pending' ? 'text-blue-600 dark:text-blue-400' :
                                relay.status === 'in-progress' ? 'text-orange-600 dark:text-orange-400' :
                                'text-emerald-600 dark:text-emerald-400'
                              }`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                {relay.status === 'pending' && <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />}
                                {relay.status === 'in-progress' && <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />}
                                {relay.status !== 'pending' && relay.status !== 'in-progress' && <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7" />}
                              </svg>
                            </div>
                            <div>
                              <div className="font-bold text-slate-900 dark:text-white">
                                {relay.status === 'pending' ? 'Pending' : 
                                 relay.status === 'in-progress' ? 'In Progress' : 'Completed'}
                              </div>
                              <div className="text-sm text-slate-600 dark:text-slate-400">
                                {relay.hops} hops • {relay.fee} $WHISTLE • {new Date(relay.created).toLocaleTimeString()}
                              </div>
                            </div>
                          </div>
                          <div className={`text-sm font-bold ${
                            relay.status === 'pending' ? 'text-blue-600 dark:text-blue-400' :
                            relay.status === 'in-progress' ? 'text-orange-600 dark:text-orange-400' :
                            'text-emerald-600 dark:text-emerald-400'
                          }`}>
                            {relay.status === 'pending' ? '⏳ Waiting' :
                             relay.status === 'in-progress' ? '🔄 Relaying' :
                             '✅ Confirmed'}
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </div>

              {/* QR Code Modal */}
              {showQRCode && (
                <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4" onClick={() => setShowQRCode(false)}>
                  <div className="bg-white dark:bg-slate-900 rounded-3xl p-8 max-w-md w-full" onClick={(e) => e.stopPropagation()}>
                    <h2 className="text-2xl font-black text-slate-900 dark:text-white mb-4">🔒 Offline Relay QR Code</h2>
                    <p className="text-sm text-slate-600 dark:text-slate-400 mb-6">
                      Scan this QR code with an internet-connected device to relay your transaction
                    </p>
                    
                    <div className="bg-white p-6 rounded-xl mb-6">
                      <div className="aspect-square bg-slate-100 dark:bg-slate-800 rounded-lg flex items-center justify-center text-center p-4">
                        <div className="text-xs font-mono text-slate-600 dark:text-slate-400 break-all">
                          {qrCodeData.slice(0, 100)}...
                          <div className="mt-4 text-slate-500 text-xs">
                            📱 QR Code will be generated here
                            <div className="text-[10px] mt-2">(Add QRCode.js library for production)</div>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <div className="text-xs text-slate-500 dark:text-slate-400 mb-4">
                      Privacy: {privacyLevel} hops • Fee: {calculateRelayFee(privacyLevel)} $WHISTLE
                    </div>
                    
                    <button
                      onClick={() => setShowQRCode(false)}
                      className="w-full px-6 py-3 rounded-xl bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-300 font-bold transition-all"
                    >
                      Close
                    </button>
                  </div>
                </div>
              )}
            </>
          ) : (
            <div className="bg-white/80 dark:bg-slate-900/80 rounded-2xl p-12 border border-slate-200/50 dark:border-slate-700/50 text-center">
              <svg className="w-16 h-16 text-slate-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
              </svg>
              <h2 className="text-2xl font-black text-slate-900 dark:text-white mb-2">Connect Your Wallet</h2>
              <p className="text-slate-600 dark:text-slate-400 mb-6">
                Connect your Solana wallet to stake $WHISTLE and start earning by running a privacy node
              </p>
              <button
                onClick={() => setShowWalletModal(true)}
                className="px-8 py-4 rounded-xl bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-500 hover:to-teal-500 text-white font-bold shadow-lg hover:shadow-xl transition-all"
              >
                Connect Wallet
              </button>
            </div>
          )}

          {/* GLOBAL NODE NETWORK - removed per request */}

          {/* Wallet Connection Modal */}
          {showWalletModal && (
            <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4" onClick={() => setShowWalletModal(false)}>
              <div className="bg-white dark:bg-slate-900 rounded-3xl p-8 max-w-md w-full" onClick={(e) => e.stopPropagation()}>
                <h2 className="text-2xl font-black text-slate-900 dark:text-white mb-6">Connect Wallet</h2>
                <button
                  onClick={connectWallet}
                  disabled={connecting}
                  className="w-full px-6 py-4 rounded-xl bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-500 hover:to-indigo-500 text-white font-bold shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-3 disabled:opacity-50"
                >
                  {connecting ? 'Connecting...' : 'Phantom Wallet'}
                </button>
                <button
                  onClick={() => setShowWalletModal(false)}
                  className="w-full mt-4 px-6 py-3 rounded-xl bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-300 font-bold transition-all"
                >
                  Cancel
                </button>
              </div>
            </div>
          )}

          {/* Stake Modal */}
          {showStakeModal && (
            <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4" onClick={() => setShowStakeModal(false)}>
              <div className="rounded-2xl bg-white dark:bg-slate-900 max-w-lg w-full shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
                {/* Header */}
                <div className="bg-gradient-to-r from-blue-600 to-cyan-600 p-6">
                  <h2 className="text-2xl font-black text-white mb-1">STAKE $WHISTLE</h2>
                  <p className="text-blue-100 text-sm">Lock tokens to activate your node</p>
                </div>

                {/* Content */}
                <div className="p-6 space-y-5">
                  {/* Wallet Balance */}
                  <div className="bg-slate-100 dark:bg-slate-800 rounded-xl p-4">
                    <div className="text-xs text-slate-600 dark:text-slate-400 mb-1 uppercase tracking-wider">Wallet Balance</div>
                    <div className="text-2xl font-black text-slate-900 dark:text-white">{tokenBalance.toLocaleString()} $WHISTLE</div>
                    <div className="text-xs text-slate-500 dark:text-slate-500 mt-1">≈ ${(tokenBalance * 0.00013).toFixed(2)} USD</div>
                  </div>

                  {/* Amount Input */}
                  <div>
                    <label className="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Stake Amount</label>
                    <div className="relative">
                      <input
                        type="number"
                        value={stakeInput}
                        onChange={(e) => setStakeInput(e.target.value)}
                        placeholder="10,000 minimum"
                        className="w-full px-4 py-3 rounded-xl bg-white dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-700 text-slate-900 dark:text-white focus:border-blue-500 focus:outline-none transition-all font-bold"
                      />
                      <button
                        onClick={() => setStakeInput(tokenBalance.toString())}
                        className="absolute right-3 top-1/2 -translate-y-1/2 px-3 py-1 rounded-lg bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold transition-all"
                      >
                        MAX
                      </button>
                    </div>
                    <div className="flex gap-2 mt-2">
                      <button onClick={() => setStakeInput('10000')} className="px-3 py-1.5 rounded-lg bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-300 text-xs font-bold transition-all">10K</button>
                      <button onClick={() => setStakeInput('50000')} className="px-3 py-1.5 rounded-lg bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-300 text-xs font-bold transition-all">50K</button>
                      <button onClick={() => setStakeInput('100000')} className="px-3 py-1.5 rounded-lg bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-300 text-xs font-bold transition-all">100K</button>
                      <button onClick={() => setStakeInput(tokenBalance.toString())} className="px-3 py-1.5 rounded-lg bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold transition-all">MAX</button>
                    </div>
                  </div>

                  {/* Action Buttons */}
                  <div className="flex gap-3 pt-2">
                    <button
                      onClick={() => setShowStakeModal(false)}
                      className="flex-1 px-6 py-3 rounded-xl bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-300 font-bold transition-all"
                    >
                      Cancel
                    </button>
                    <button
                      onClick={handleStake}
                      disabled={loading}
                      className="flex-1 px-6 py-3 rounded-xl bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-500 hover:to-cyan-500 text-white font-bold transition-all shadow-lg disabled:opacity-50"
                    >
                      {loading ? 'Staking...' : 'Stake Now'}
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // Services Section - Smart Contract Features
    function Services({ setStep, pushToast }) {
      useEffect(() => {
        if (window.lucide) window.lucide.createIcons();
      }, []);

      const services = [
        {
          id: 'staking',
          title: 'STAKING_PROTOCOL',
          subtitle: 'Stake & Earn',
          description: 'Lock $WHISTLE tokens to participate in network consensus and earn passive rewards',
          icon: '◆',
          features: [
            { label: 'MIN_STAKE', value: '10,000 $W' },
            { label: 'REWARD_RATE', value: '8 $W/relay' },
            { label: 'REPUTATION', value: 'Dynamic' },
            { label: 'WITHDRAWAL', value: 'Anytime' }
          ],
          action: 'offline-network',
          buttonText: 'INIT_STAKE',
          color: 'cyan',
          gradient: 'from-cyan-600 to-blue-600'
        },
        {
          id: 'node-operation',
          title: 'NODE_NETWORK',
          subtitle: 'Run Privacy Node',
          description: 'Browser-based relay node to process anonymous transactions and earn network rewards',
          icon: '●',
          features: [
            { label: 'EARNINGS', value: '8 $W/relay' },
            { label: 'SETUP', value: 'Browser-only' },
            { label: 'REPUTATION', value: 'Auto-build' },
            { label: 'NETWORK', value: 'Global P2P' }
          ],
          action: 'offline-network',
          buttonText: 'DEPLOY_NODE',
          color: 'emerald',
          gradient: 'from-emerald-600 to-teal-600'
        },
        {
          id: 'anonymous-relay',
          title: 'ANONYMOUS_RELAY',
          subtitle: 'Private Transactions',
          description: 'Multi-hop encrypted routing for maximum transaction privacy with offline capabilities',
          icon: '▲',
          features: [
            { label: 'ENCRYPTION', value: '3-7 hops' },
            { label: 'OFFLINE', value: 'Supported' },
            { label: 'METHODS', value: 'QR/BT/WiFi' },
            { label: 'PRIVACY', value: 'Maximum' }
          ],
          action: 'anonymous-relay',
          buttonText: 'SEND_ANON',
          color: 'purple',
          gradient: 'from-purple-600 to-pink-600'
        },
        {
          id: 'earnings',
          title: 'EARNINGS_TRACKER',
          subtitle: 'Monitor & Claim',
          description: 'Real-time performance analytics and instant reward claiming from node operations',
          icon: '■',
          features: [
            { label: 'TRACKING', value: 'Real-time' },
            { label: 'CLAIMS', value: 'Instant' },
            { label: 'ANALYTICS', value: 'Advanced' },
            { label: 'BONUS', value: 'Reputation' }
          ],
          action: 'offline-network',
          buttonText: 'VIEW_STATS',
          color: 'orange',
          gradient: 'from-orange-600 to-red-600'
        },
        {
          id: 'data-transfer',
          title: 'DATA_TRANSFER',
          subtitle: 'File Relay Service',
          description: 'Secure encrypted file transfer through privacy nodes with end-to-end encryption',
          icon: '◇',
          features: [
            { label: 'ENCRYPTION', value: 'E2E AES-256' },
            { label: 'SIZE_LIMIT', value: 'Up to 100MB' },
            { label: 'NODES', value: 'Multi-hop' },
            { label: 'STATUS', value: 'Coming Soon' }
          ],
          action: null,
          buttonText: 'COMING_SOON',
          color: 'indigo',
          gradient: 'from-indigo-600 to-purple-600',
          comingSoon: true
        },
        {
          id: 'message-relay',
          title: 'MESSAGE_RELAY',
          subtitle: 'Anonymous Messaging',
          description: 'Private peer-to-peer messaging through relay nodes with no metadata tracking',
          icon: '◎',
          features: [
            { label: 'PRIVACY', value: 'No metadata' },
            { label: 'ENCRYPTION', value: 'PGP + Multi-hop' },
            { label: 'DELIVERY', value: 'Async/Real-time' },
            { label: 'STATUS', value: 'Coming Soon' }
          ],
          action: null,
          buttonText: 'COMING_SOON',
          color: 'rose',
          gradient: 'from-rose-600 to-pink-600',
          comingSoon: true
        }
      ];

      return (
        <div className="min-h-screen bg-slate-950 p-3 md:p-6">
          {/* Terminal Header */}
          <div className="relative overflow-hidden rounded-xl border border-cyan-500/20 bg-black/40 backdrop-blur-xl shadow-2xl mb-6 md:mb-8">
            {/* Terminal Top Bar */}
            <div className="flex items-center justify-between px-3 md:px-4 py-2 bg-gradient-to-r from-slate-900/80 to-slate-800/80 border-b border-cyan-500/20">
              <div className="flex items-center gap-2">
                <div className="flex gap-1.5">
                  <div className="w-2 h-2 md:w-3 md:h-3 rounded-full bg-red-500/80"></div>
                  <div className="w-2 h-2 md:w-3 md:h-3 rounded-full bg-yellow-500/80"></div>
                  <div className="w-2 h-2 md:w-3 md:h-3 rounded-full bg-green-500/80"></div>
                </div>
                <span className="ml-2 md:ml-3 text-[10px] md:text-xs font-mono text-slate-500">ghost@services:~$</span>
              </div>
              <div className="flex items-center gap-1 md:gap-2 px-2 md:px-3 py-1 rounded bg-emerald-500/10 border border-emerald-500/30">
                <div className="w-1 h-1 md:w-1.5 md:h-1.5 rounded-full bg-emerald-400 animate-pulse"></div>
                <span className="text-emerald-400 text-[10px] md:text-xs font-mono">MAINNET</span>
              </div>
            </div>
            
            {/* Terminal Content */}
            <div className="p-4 md:p-8">
              <div className="flex items-center gap-2 mb-3 md:mb-4">
                <span className="text-cyan-500 font-mono text-xs md:text-sm">$</span>
                <h1 className="text-lg md:text-3xl font-bold text-white font-mono">GHOST_WHISTLE_SERVICES.sh</h1>
                <div className="h-px flex-1 bg-gradient-to-r from-cyan-500/30 to-transparent"></div>
              </div>
              
              <p className="text-slate-400 font-mono text-sm mb-6 leading-relaxed">
                <span className="text-cyan-400">{'>'}</span> Decentralized privacy infrastructure
                <span className="mx-2 text-slate-700">|</span>
                <span className="text-purple-400">{'>'}</span> Solana smart contract powered
                <span className="mx-2 text-slate-700">|</span>
                <span className="text-emerald-400">{'>'}</span> On-chain verified protocol
              </p>
              
              {/* Status Bar */}
              <div className="grid grid-cols-3 gap-3">
                <div className="px-3 py-2 rounded bg-slate-900/50 border border-slate-700/50">
                  <div className="text-xs text-slate-500 font-mono mb-1">CONTRACT</div>
                  <div className="text-sm font-mono font-bold text-cyan-400">DEPLOYED</div>
                </div>
                <div className="px-3 py-2 rounded bg-slate-900/50 border border-slate-700/50">
                  <div className="text-xs text-slate-500 font-mono mb-1">NETWORK</div>
                  <div className="text-sm font-mono font-bold text-emerald-400">SOLANA</div>
                </div>
                <div className="px-3 py-2 rounded bg-slate-900/50 border border-slate-700/50">
                  <div className="text-xs text-slate-500 font-mono mb-1">STATUS</div>
                  <div className="text-sm font-mono font-bold text-purple-400">ACTIVE</div>
                </div>
              </div>
            </div>
          </div>

          {/* ECOSYSTEM OVERVIEW - WHY GHOST WHISTLE MATTERS */}
          <div className="relative overflow-hidden rounded-xl border border-gradient-to-r from-emerald-500/30 via-cyan-500/30 to-purple-500/30 bg-black/30 backdrop-blur-xl shadow-2xl mb-8">
            <div className="flex items-center justify-between px-4 py-2 bg-gradient-to-r from-slate-900/60 to-slate-800/60 border-b border-cyan-500/20">
              <div className="flex items-center gap-2">
                <span className="text-xl text-cyan-400">●</span>
                <span className="text-xs font-mono text-slate-500">ecosystem_overview.md</span>
              </div>
              <div className="px-2 py-0.5 rounded bg-cyan-500/10 border border-cyan-500/30">
                <span className="text-cyan-400 text-xs font-mono">INFO</span>
              </div>
            </div>
            
            <div className="p-8">
              <div className="flex items-center gap-2 mb-6">
                <span className="text-cyan-500 font-mono text-sm">$</span>
                <h2 className="text-2xl font-bold text-white font-mono">WHY_GHOST_WHISTLE_MATTERS</h2>
                <div className="h-px flex-1 bg-gradient-to-r from-cyan-500/30 to-transparent"></div>
              </div>
              
              <div className="grid md:grid-cols-3 gap-6 mb-6">
                {/* Sustainability Pillar */}
                <div className="relative group">
                  <div className="absolute inset-0 bg-gradient-to-br from-emerald-500/10 to-transparent rounded-xl opacity-0 group-hover:opacity-100 transition-opacity"></div>
                  <div className="relative bg-slate-900/40 backdrop-blur-sm border border-emerald-500/20 rounded-xl p-3 md:p-5 hover:border-emerald-500/40 transition-all">
                    <div className="w-10 h-10 md:w-12 md:h-12 rounded-lg bg-emerald-500/20 border border-emerald-500/30 flex items-center justify-center mb-3 md:mb-4">
                      <span className="text-xl md:text-2xl">💰</span>
                    </div>
                    <div className="text-emerald-400 font-mono text-sm font-bold mb-2">01. TRUE SUSTAINABILITY</div>
                    <p className="text-slate-400 text-xs font-mono leading-relaxed mb-3">
                      Not another token farm. Real work = Real earnings. Node operators earn 8 $WHISTLE per relay. Users pay for privacy. Circular economy.
                    </p>
                    <div className="flex items-center gap-2 text-[10px] font-mono text-emerald-500">
                      <span>{'>'}</span>
                      <span>No VC dumps</span>
                      <span className="text-slate-700">|</span>
                      <span>No inflation</span>
                    </div>
                  </div>
                </div>
                
                {/* Decentralization Pillar */}
                <div className="relative group">
                  <div className="absolute inset-0 bg-gradient-to-br from-cyan-500/10 to-transparent rounded-xl opacity-0 group-hover:opacity-100 transition-opacity"></div>
                  <div className="relative bg-slate-900/40 backdrop-blur-sm border border-cyan-500/20 rounded-xl p-3 md:p-5 hover:border-cyan-500/40 transition-all">
                    <div className="w-10 h-10 md:w-12 md:h-12 rounded-lg bg-cyan-500/20 border border-cyan-500/30 flex items-center justify-center mb-3 md:mb-4">
                      <span className="text-xl md:text-2xl">🌐</span>
                    </div>
                    <div className="text-cyan-400 font-mono text-sm font-bold mb-2">02. REAL DECENTRALIZATION</div>
                    <p className="text-slate-400 text-xs font-mono leading-relaxed mb-3">
                      Every browser = Full node. No apps required. P2P WebRTC mesh. Works offline via WiFi Direct & Bluetooth. Censorship-proof.
                    </p>
                    <div className="flex items-center gap-2 text-[10px] font-mono text-cyan-500">
                      <span>{'>'}</span>
                      <span>No servers</span>
                      <span className="text-slate-700">|</span>
                      <span>No middlemen</span>
                    </div>
                  </div>
                </div>
                
                {/* Privacy Pillar */}
                <div className="relative group">
                  <div className="absolute inset-0 bg-gradient-to-br from-purple-500/10 to-transparent rounded-xl opacity-0 group-hover:opacity-100 transition-opacity"></div>
                  <div className="relative bg-slate-900/40 backdrop-blur-sm border border-purple-500/20 rounded-xl p-3 md:p-5 hover:border-purple-500/40 transition-all">
                    <div className="w-10 h-10 md:w-12 md:h-12 rounded-lg bg-purple-500/20 border border-purple-500/30 flex items-center justify-center mb-3 md:mb-4">
                      <span className="text-xl md:text-2xl">🔐</span>
                    </div>
                    <div className="text-purple-400 font-mono text-sm font-bold mb-2">03. PRIVACY FIRST</div>
                    <p className="text-slate-400 text-xs font-mono leading-relaxed mb-3">
                      3-7 hop onion routing. E2E AES-256 encryption. Zero metadata. Zero IP logging. Like Tor meets Monero meets Solana.
                    </p>
                    <div className="flex items-center gap-2 text-[10px] font-mono text-purple-500">
                      <span>{'>'}</span>
                      <span>No tracking</span>
                      <span className="text-slate-700">|</span>
                      <span>Maximum privacy</span>
                    </div>
                  </div>
                </div>
              </div>
              
              {/* Real-World Impact Section */}
              <div className="bg-gradient-to-r from-slate-900/60 to-slate-800/60 border border-slate-700/50 rounded-xl p-6">
                <div className="flex items-center gap-3 mb-4">
                  <div className="w-10 h-10 rounded-lg bg-gradient-to-br from-orange-500/20 to-red-500/20 border border-orange-500/30 flex items-center justify-center">
                    <span className="text-2xl">🌍</span>
                  </div>
                  <div>
                    <div className="text-orange-400 font-mono text-sm font-bold">REAL-WORLD IMPACT</div>
                    <div className="text-slate-500 text-xs font-mono">Where this tech actually matters</div>
                  </div>
                </div>
                
                <div className="grid md:grid-cols-2 gap-4">
                  <div className="space-y-2">
                    <div className="flex items-center gap-2 text-xs font-mono">
                      <span className="text-orange-500">{'>'}</span>
                      <span className="text-slate-400">🛡️ <span className="text-orange-400 font-bold">Censorship Resistance:</span> Authoritarian regimes, firewalls, blocked exchanges</span>
                    </div>
                    <div className="flex items-center gap-2 text-xs font-mono">
                      <span className="text-red-500">{'>'}</span>
                      <span className="text-slate-400">🚨 <span className="text-red-400 font-bold">Disaster Relief:</span> Earthquakes, hurricanes, internet blackouts, war zones</span>
                    </div>
                    <div className="flex items-center gap-2 text-xs font-mono">
                      <span className="text-emerald-500">{'>'}</span>
                      <span className="text-slate-400">🏔️ <span className="text-emerald-400 font-bold">Rural Banking:</span> Poor connectivity, remote areas, underserved regions</span>
                    </div>
                  </div>
                  <div className="space-y-2">
                    <div className="flex items-center gap-2 text-xs font-mono">
                      <span className="text-purple-500">{'>'}</span>
                      <span className="text-slate-400">👤 <span className="text-purple-400 font-bold">Whistleblower Support:</span> Journalists, activists, dissidents, freedom fighters</span>
                    </div>
                    <div className="flex items-center gap-2 text-xs font-mono">
                      <span className="text-cyan-500">{'>'}</span>
                      <span className="text-slate-400">💸 <span className="text-cyan-400 font-bold">Private Transactions:</span> No surveillance, no tracking, no financial profiling</span>
                    </div>
                    <div className="flex items-center gap-2 text-xs font-mono">
                      <span className="text-blue-500">{'>'}</span>
                      <span className="text-slate-400">💰 <span className="text-blue-400 font-bold">Passive Income:</span> Earn while you sleep—your device, your earnings</span>
                    </div>
                  </div>
                </div>
              </div>
              
              {/* Bottom Stats Bar */}
              <div className="mt-6 pt-6 border-t border-slate-700/50">
                <div className="grid grid-cols-4 gap-3 text-center">
                  <div>
                    <div className="text-emerald-400 font-bold text-xl font-mono mb-1">8 $W</div>
                    <div className="text-slate-500 text-[9px] font-mono uppercase">Per Relay</div>
                  </div>
                  <div>
                    <div className="text-cyan-400 font-bold text-xl font-mono mb-1">3-7</div>
                    <div className="text-slate-500 text-[9px] font-mono uppercase">Hops</div>
                  </div>
                  <div>
                    <div className="text-purple-400 font-bold text-xl font-mono mb-1">E2E</div>
                    <div className="text-slate-500 text-[9px] font-mono uppercase">Encrypted</div>
                  </div>
                  <div>
                    <div className="text-orange-400 font-bold text-xl font-mono mb-1">24/7</div>
                    <div className="text-slate-500 text-[9px] font-mono uppercase">Earn</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          {/* Service Cards Grid */}
          <div className="grid md:grid-cols-2 gap-6">
            {services.map((service, idx) => (
              <div 
                key={service.id}
                className="relative group"
                style={{ animationDelay: `${idx * 100}ms` }}
              >
                {/* Terminal Window */}
                <div className={`rounded-xl border border-${service.color}-500/20 bg-black/30 backdrop-blur-xl shadow-2xl overflow-hidden transition-all duration-300 group-hover:border-${service.color}-500/40 group-hover:shadow-${service.color}-500/20`}>
                  {/* Terminal Top Bar */}
                  <div className={`flex items-center justify-between px-4 py-2 bg-gradient-to-r from-slate-900/60 to-slate-800/60 border-b border-${service.color}-500/10`}>
                    <div className="flex items-center gap-2">
                      <span className={`text-2xl font-mono text-${service.color}-400`}>{service.icon}</span>
                      <span className="text-xs font-mono text-slate-500">service_{service.id}.sh</span>
                    </div>
                    <div className={`px-2 py-0.5 rounded bg-${service.color}-500/10 border border-${service.color}-500/30`}>
                      <span className={`text-${service.color}-400 text-xs font-mono`}>{service.comingSoon ? 'SOON' : 'READY'}</span>
                    </div>
                  </div>
                  
                  {/* Service Content */}
                  <div className="p-4 md:p-6">
                    <div className="flex items-center gap-2 mb-2">
                      <span className={`text-${service.color}-500 font-mono text-xs md:text-sm`}>$</span>
                      <h3 className="text-base md:text-lg font-bold text-white font-mono">{service.title}</h3>
                    </div>
                    <p className={`text-[10px] md:text-xs text-${service.color}-400/70 font-mono mb-3 md:mb-4`}>{service.subtitle}</p>
                    
                    <p className="text-xs md:text-sm text-slate-400 font-mono mb-4 md:mb-6 leading-relaxed">
                      {service.description}
                    </p>
                    
                    {/* Feature Grid */}
                    <div className="grid grid-cols-2 gap-2 mb-4 md:mb-6">
                      {service.features.map((feature, idx) => (
                        <div key={idx} className="px-2 md:px-3 py-2 rounded bg-slate-900/40 border border-slate-700/40">
                          <div className="text-[9px] md:text-[10px] text-slate-500 font-mono mb-1">{feature.label}</div>
                          <div className={`text-[10px] md:text-xs font-mono font-bold text-${service.color}-400`}>{feature.value}</div>
                        </div>
                      ))}
                    </div>
                    
                    {/* Action Button */}
                    <button
                      onClick={() => service.action && setStep(service.action)}
                      disabled={service.comingSoon}
                      className={`w-full px-4 md:px-6 py-2.5 md:py-3 rounded-lg bg-gradient-to-r ${service.gradient} ${service.comingSoon ? 'opacity-60 cursor-not-allowed' : 'hover:scale-[1.02] group-hover:shadow-' + service.color + '-500/30'} text-white font-mono text-xs md:text-sm font-bold shadow-lg transition-all flex items-center justify-center gap-2 md:gap-3`}
                    >
                      <span className={`text-${service.color}-200`}>{'>'}</span>
                      <span>{service.buttonText}</span>
                      {service.comingSoon && <span className="text-[10px] md:text-xs ml-1 md:ml-2 px-1.5 md:px-2 py-0.5 md:py-1 bg-black/40 rounded">⏳</span>}
                      <span className={`text-${service.color}-200`}>{'<'}</span>
                    </button>
                  </div>
                </div>
              </div>
            ))}
          </div>

          {/* Smart Contract Info */}
          <div className="relative overflow-hidden rounded-xl border border-cyan-500/20 bg-black/30 backdrop-blur-xl shadow-2xl mt-8">
            {/* Terminal Header */}
            <div className="flex items-center justify-between px-4 py-2 bg-gradient-to-r from-slate-900/60 to-slate-800/60 border-b border-cyan-500/20">
              <div className="flex items-center gap-2">
                <span className="text-xl text-cyan-400">◉</span>
                <span className="text-xs font-mono text-slate-500">contract_info.sol</span>
              </div>
              <div className="px-2 py-0.5 rounded bg-cyan-500/10 border border-cyan-500/30">
                <span className="text-cyan-400 text-xs font-mono">VERIFIED</span>
              </div>
            </div>
            
            <div className="p-6">
              <div className="flex items-center gap-2 mb-6">
                <span className="text-cyan-500 font-mono text-sm">$</span>
                <h3 className="text-xl font-bold text-white font-mono">SMART_CONTRACT_FUNCTIONS</h3>
                <div className="h-px flex-1 bg-gradient-to-r from-cyan-500/30 to-transparent"></div>
              </div>
              
              <div className="grid md:grid-cols-2 gap-4 mb-6">
                <div className="p-4 rounded-lg bg-slate-900/50 border border-slate-700/50">
                  <div className="flex items-center gap-2 mb-3">
                    <span className="text-emerald-500 font-mono text-xs">$</span>
                    <h4 className="text-emerald-400 font-mono text-sm font-bold">CORE_FUNCTIONS</h4>
                  </div>
                  <ul className="space-y-2 text-xs font-mono">
                    <li className="flex items-center gap-2 text-slate-400">
                      <span className="text-emerald-500">{'>'}</span>
                      <code className="text-cyan-400">stake()</code>
                      <span className="text-slate-600">|</span>
                      <span>Lock tokens</span>
                    </li>
                    <li className="flex items-center gap-2 text-slate-400">
                      <span className="text-emerald-500">{'>'}</span>
                      <code className="text-cyan-400">record_relay()</code>
                      <span className="text-slate-600">|</span>
                      <span>Process TX</span>
                    </li>
                    <li className="flex items-center gap-2 text-slate-400">
                      <span className="text-emerald-500">{'>'}</span>
                      <code className="text-cyan-400">claim_rewards()</code>
                      <span className="text-slate-600">|</span>
                      <span>Withdraw</span>
                    </li>
                    <li className="flex items-center gap-2 text-slate-400">
                      <span className="text-emerald-500">{'>'}</span>
                      <code className="text-cyan-400">unstake()</code>
                      <span className="text-slate-600">|</span>
                      <span>Unlock</span>
                    </li>
                  </ul>
                </div>
                
                <div className="p-4 rounded-lg bg-slate-900/50 border border-slate-700/50">
                  <div className="flex items-center gap-2 mb-3">
                    <span className="text-purple-500 font-mono text-xs">$</span>
                    <h4 className="text-purple-400 font-mono text-sm font-bold">RELAY_FUNCTIONS</h4>
                  </div>
                  <ul className="space-y-2 text-xs font-mono">
                    <li className="flex items-center gap-2 text-slate-400">
                      <span className="text-purple-500">{'>'}</span>
                      <code className="text-purple-400">create_relay_request()</code>
                    </li>
                    <li className="flex items-center gap-2 text-slate-400">
                      <span className="text-purple-500">{'>'}</span>
                      <code className="text-purple-400">join_relay()</code>
                      <span className="text-slate-600">|</span>
                      <span>Join hop</span>
                    </li>
                    <li className="flex items-center gap-2 text-slate-400">
                      <span className="text-purple-500">{'>'}</span>
                      <code className="text-purple-400">complete_relay()</code>
                      <span className="text-slate-600">|</span>
                      <span>Finalize</span>
                    </li>
                    <li className="flex items-center gap-2 text-slate-400">
                      <span className="text-purple-500">{'>'}</span>
                      <code className="text-purple-400">claim_relay_payment()</code>
                    </li>
                  </ul>
                </div>
              </div>
              
              <div className="p-4 rounded-lg bg-slate-900/50 border border-slate-700/50">
                <div className="flex items-center justify-between flex-wrap gap-4">
                  <div>
                    <div className="flex items-center gap-2 mb-1">
                      <span className="text-cyan-500 font-mono text-xs">$</span>
                      <div className="text-xs text-slate-500 font-mono">PROGRAM_ID</div>
                    </div>
                    <div className="text-sm font-mono text-cyan-400 break-all">2uZWi6wC6CumhcCDCuNZcBaDSd7UJKf4BKreWdx1Pyaq</div>
                  </div>
                  <a 
                    href="https://explorer.solana.com/address/2uZWi6wC6CumhcCDCuNZcBaDSd7UJKf4BKreWdx1Pyaq?cluster=mainnet"
                    target="_blank"
                    rel="noopener noreferrer"
                    className="px-4 py-2 rounded-lg bg-gradient-to-r from-cyan-600 to-blue-600 hover:scale-[1.02] border border-cyan-500/30 text-white text-xs font-mono font-bold transition-all flex items-center gap-2"
                  >
                    <span>EXPLORER</span>
                    <span className="text-cyan-200">{'>'}</span>
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // Anonymous Relay Service - Terminal Theme
    function AnonymousRelayService({ setStep, pushToast }) {
      const [wallet, setWallet] = useState(null);
      const [walletAddress, setWalletAddress] = useState(null);
      const [connecting, setConnecting] = useState(false);
      const [tokenBalance, setTokenBalance] = useState(0);
      
      const [connectionMode, setConnectionMode] = useState('online');
      const [recipient, setRecipient] = useState('');
      const [amount, setAmount] = useState('');
      const [privacyLevel, setPrivacyLevel] = useState(5);
      const [relayHistory, setRelayHistory] = useState([]);
      const [creating, setCreating] = useState(false);
      const [qrCodeImage, setQrCodeImage] = useState('');
      const [showQRModal, setShowQRModal] = useState(false);

      useEffect(() => {
        autoConnectWallet();
      }, []);

      const autoConnectWallet = async () => {
        try {
          if (window.solana && window.solana.isPhantom) {
            const response = await window.solana.connect({ onlyIfTrusted: true });
            setWallet(window.solana);
            setWalletAddress(response.publicKey.toString());
            await loadTokenBalance(response.publicKey);
          }
        } catch (err) {
          console.log('Auto-connect failed:', err);
        }
      };

      const connectWallet = async () => {
        if (!window.solana) {
          pushToast({ msg: 'Please install Phantom wallet', tone: 'err' });
          return;
        }
        setConnecting(true);
        try {
          const resp = await window.solana.connect();
          setWallet(window.solana);
          setWalletAddress(resp.publicKey.toString());
          await loadTokenBalance(resp.publicKey);
          pushToast({ msg: 'Wallet connected!', tone: 'ok' });
        } catch (err) {
          pushToast({ msg: 'Connection failed: ' + err.message, tone: 'err' });
        } finally {
          setConnecting(false);
        }
      };

      const loadTokenBalance = async (publicKey) => {
        try {
          const connection = new solanaWeb3.Connection('https://api.mainnet-beta.solana.com');
          const TOKEN_MINT = new solanaWeb3.PublicKey('6Hb2xgEhyN9iVVH3cgSxYjfN774ExzgiCftwiWdjpump');
          const tokenAccounts = await connection.getParsedTokenAccountsByOwner(publicKey, { mint: TOKEN_MINT });
          if (tokenAccounts.value.length > 0) {
            const balance = tokenAccounts.value[0].account.data.parsed.info.tokenAmount.uiAmount;
            setTokenBalance(balance);
          }
        } catch (err) {
          console.error('Failed to load balance:', err);
        }
      };

      const generateQRCode = async (data) => {
        try {
          const qr = new QRCode(document.createElement('div'), {
            text: JSON.stringify(data),
            width: 512,
            height: 512,
            colorDark: '#000000',
            colorLight: '#ffffff',
            correctLevel: QRCode.CorrectLevel.H
          });
          const canvas = qr._el.querySelector('canvas');
          const imgData = canvas.toDataURL('image/png');
          setQrCodeImage(imgData);
          return imgData;
        } catch (err) {
          console.error('QR generation failed:', err);
          return null;
        }
      };

      const downloadQRCode = () => {
        if (!qrCodeImage) return;
        const link = document.createElement('a');
        link.href = qrCodeImage;
        link.download = `ghost-relay-${Date.now()}.png`;
        link.click();
      };

      const createRelayRequest = async () => {
        if (!walletAddress) {
          pushToast({ msg: 'Please connect wallet first', tone: 'err' });
          return;
        }
        if (!recipient || !amount) {
          pushToast({ msg: 'Please fill all fields', tone: 'err' });
          return;
        }
        
        setCreating(true);
        try {
          const relayData = {
            type: 'ghost_relay',
            requestId: Date.now(),
            sender: walletAddress,
            recipient: recipient,
            amount: amount,
            hops: privacyLevel,
            mode: connectionMode,
            timestamp: Date.now()
          };

          if (connectionMode === 'qr' || connectionMode === 'offline') {
            await generateQRCode(relayData);
            setShowQRModal(true);
          }

          setRelayHistory(prev => [{
            id: relayData.requestId,
            recipient: recipient,
            amount: amount,
            hops: privacyLevel,
            status: 'pending',
            timestamp: new Date().toLocaleTimeString()
          }, ...prev]);

          pushToast({ msg: 'Relay request created!', tone: 'ok' });
          
          setRecipient('');
          setAmount('');
        } catch (err) {
          pushToast({ msg: 'Failed to create relay: ' + err.message, tone: 'err' });
        } finally {
          setCreating(false);
        }
      };

      return (
        <div className="min-h-screen bg-slate-950 p-6">
          {/* Terminal Header */}
          <div className="relative overflow-hidden rounded-xl border border-purple-500/20 bg-black/40 backdrop-blur-xl shadow-2xl mb-8">
            <div className="flex items-center justify-between px-4 py-2 bg-gradient-to-r from-slate-900/80 to-slate-800/80 border-b border-purple-500/20">
              <div className="flex items-center gap-2">
                <div className="flex gap-1.5">
                  <div className="w-3 h-3 rounded-full bg-red-500/80"></div>
                  <div className="w-3 h-3 rounded-full bg-yellow-500/80"></div>
                  <div className="w-3 h-3 rounded-full bg-green-500/80"></div>
                </div>
                <span className="ml-3 text-xs font-mono text-slate-500">ghost@relay:~$</span>
              </div>
              <div className="flex items-center gap-3">
                {walletAddress ? (
                  <div className="flex items-center gap-2 px-3 py-1 rounded bg-emerald-500/10 border border-emerald-500/30">
                    <div className="w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse"></div>
                    <span className="text-emerald-400 text-xs font-mono">{walletAddress.slice(0,4)}...{walletAddress.slice(-4)}</span>
                  </div>
                ) : (
                  <button onClick={connectWallet} disabled={connecting} className="px-3 py-1 rounded bg-purple-500/10 border border-purple-500/30 text-purple-400 text-xs font-mono hover:bg-purple-500/20 transition-all">
                    {connecting ? 'CONNECTING...' : 'CONNECT_WALLET'}
                  </button>
                )}
              </div>
            </div>
            
            <div className="p-8">
              <div className="flex items-center gap-2 mb-4">
                <span className="text-purple-500 font-mono text-sm">$</span>
                <h1 className="text-3xl font-bold text-white font-mono">ANONYMOUS_RELAY.sh</h1>
                <div className="h-px flex-1 bg-gradient-to-r from-purple-500/30 to-transparent"></div>
              </div>
              
              <p className="text-slate-400 font-mono text-sm mb-6 leading-relaxed">
                <span className="text-purple-400">{'>'}</span> Multi-hop encrypted routing
                <span className="mx-2 text-slate-700">|</span>
                <span className="text-cyan-400">{'>'}</span> Maximum transaction privacy
                <span className="mx-2 text-slate-700">|</span>
                <span className="text-emerald-400">{'>'}</span> Offline capability
              </p>

              <div className="grid grid-cols-3 gap-3">
                <div className="px-3 py-2 rounded bg-slate-900/50 border border-slate-700/50">
                  <div className="text-xs text-slate-500 font-mono mb-1">BALANCE</div>
                  <div className="text-sm font-mono font-bold text-purple-400">{tokenBalance.toFixed(2)} $W</div>
                </div>
                <div className="px-3 py-2 rounded bg-slate-900/50 border border-slate-700/50">
                  <div className="text-xs text-slate-500 font-mono mb-1">MODE</div>
                  <div className="text-sm font-mono font-bold text-cyan-400 uppercase">{connectionMode}</div>
                </div>
                <div className="px-3 py-2 rounded bg-slate-900/50 border border-slate-700/50">
                  <div className="text-xs text-slate-500 font-mono mb-1">RELAYS</div>
                  <div className="text-sm font-mono font-bold text-emerald-400">{relayHistory.length}</div>
                </div>
              </div>
            </div>
          </div>

          {/* Connection Mode */}
          <div className="rounded-xl border border-purple-500/20 bg-black/30 backdrop-blur-xl shadow-2xl mb-6">
            <div className="flex items-center justify-between px-4 py-2 bg-gradient-to-r from-slate-900/60 to-slate-800/60 border-b border-purple-500/10">
              <div className="flex items-center gap-2">
                <span className="text-xl text-purple-400">◈</span>
                <span className="text-xs font-mono text-slate-500">connection_mode.cfg</span>
              </div>
              <div className="px-2 py-0.5 rounded bg-purple-500/10 border border-purple-500/30">
                <span className="text-purple-400 text-xs font-mono">CONFIG</span>
              </div>
            </div>
            
            <div className="p-6">
              <div className="flex items-center gap-2 mb-4">
                <span className="text-purple-500 font-mono text-sm">$</span>
                <h3 className="text-lg font-bold text-white font-mono">CONNECTION_MODE</h3>
              </div>
              
              <div className="grid grid-cols-2 md:grid-cols-5 gap-3">
                {['online', 'offline', 'bluetooth', 'wifi', 'qr'].map(mode => (
                  <button
                    key={mode}
                    onClick={() => setConnectionMode(mode)}
                    className={`px-4 py-3 rounded-lg border-2 font-mono text-sm font-bold transition-all ${
                      connectionMode === mode
                        ? 'border-purple-400 bg-purple-500/20 text-purple-300'
                        : 'border-slate-700 bg-slate-900/40 text-slate-400 hover:border-purple-500/50'
                    }`}
                  >
                    <div className="uppercase">{mode}</div>
                  </button>
                ))}
              </div>
            </div>
          </div>

          {/* Transaction Details */}
          <div className="rounded-xl border border-cyan-500/20 bg-black/30 backdrop-blur-xl shadow-2xl mb-6">
            <div className="flex items-center justify-between px-4 py-2 bg-gradient-to-r from-slate-900/60 to-slate-800/60 border-b border-cyan-500/10">
              <div className="flex items-center gap-2">
                <span className="text-xl text-cyan-400">▣</span>
                <span className="text-xs font-mono text-slate-500">transaction_data.json</span>
              </div>
              <div className="px-2 py-0.5 rounded bg-cyan-500/10 border border-cyan-500/30">
                <span className="text-cyan-400 text-xs font-mono">INPUT</span>
              </div>
            </div>
            
            <div className="p-6 space-y-4">
              <div>
                <label className="flex items-center gap-2 mb-2">
                  <span className="text-cyan-500 font-mono text-xs">$</span>
                  <span className="text-sm font-mono text-slate-400">RECIPIENT_ADDRESS</span>
                </label>
                <input
                  type="text"
                  value={recipient}
                  onChange={(e) => setRecipient(e.target.value)}
                  placeholder="Enter Solana address..."
                  className="w-full px-4 py-3 rounded-lg bg-slate-900/50 border border-slate-700 text-white font-mono text-sm focus:border-cyan-500/50 focus:outline-none transition-all"
                />
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="flex items-center gap-2 mb-2">
                    <span className="text-cyan-500 font-mono text-xs">$</span>
                    <span className="text-sm font-mono text-slate-400">AMOUNT</span>
                  </label>
                  <input
                    type="number"
                    value={amount}
                    onChange={(e) => setAmount(e.target.value)}
                    placeholder="0.00"
                    step="0.001"
                    className="w-full px-4 py-3 rounded-lg bg-slate-900/50 border border-slate-700 text-white font-mono text-sm focus:border-cyan-500/50 focus:outline-none transition-all"
                  />
                </div>
                <div>
                  <label className="flex items-center gap-2 mb-2">
                    <span className="text-cyan-500 font-mono text-xs">$</span>
                    <span className="text-sm font-mono text-slate-400">TOKEN</span>
                  </label>
                  <select className="w-full px-4 py-3 rounded-lg bg-slate-900/50 border border-slate-700 text-white font-mono text-sm focus:border-cyan-500/50 focus:outline-none transition-all">
                    <option>SOL</option>
                    <option>$WHISTLE</option>
                    <option>USDC</option>
                  </select>
                </div>
              </div>

              <div>
                <label className="flex items-center gap-2 mb-3">
                  <span className="text-cyan-500 font-mono text-xs">$</span>
                  <span className="text-sm font-mono text-slate-400">PRIVACY_LEVEL</span>
                  <span className="text-xs font-mono text-purple-400 ml-auto">{privacyLevel} HOPS</span>
                </label>
                <input
                  type="range"
                  min="3"
                  max="7"
                  step="1"
                  value={privacyLevel}
                  onChange={(e) => setPrivacyLevel(parseInt(e.target.value))}
                  className="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-purple-500"
                />
                <div className="flex justify-between text-xs font-mono text-slate-500 mt-1">
                  <span>LOW (3)</span>
                  <span>MEDIUM (5)</span>
                  <span>HIGH (7)</span>
                </div>
              </div>

              <button
                onClick={createRelayRequest}
                disabled={!walletAddress || creating || !recipient || !amount}
                className="w-full px-6 py-4 rounded-lg bg-gradient-to-r from-purple-600 to-pink-600 hover:scale-[1.02] text-white font-mono font-bold shadow-lg transition-all flex items-center justify-center gap-3 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                <span className="text-purple-200">{'>'}</span>
                <span>{creating ? 'CREATING_RELAY...' : 'CREATE_ANONYMOUS_RELAY'}</span>
                <span className="text-purple-200">{'<'}</span>
              </button>
            </div>
          </div>

          {/* Relay History */}
          <div className="rounded-xl border border-emerald-500/20 bg-black/30 backdrop-blur-xl shadow-2xl">
            <div className="flex items-center justify-between px-4 py-2 bg-gradient-to-r from-slate-900/60 to-slate-800/60 border-b border-emerald-500/10">
              <div className="flex items-center gap-2">
                <span className="text-xl text-emerald-400">◉</span>
                <span className="text-xs font-mono text-slate-500">relay_history.log</span>
              </div>
              <div className="px-2 py-0.5 rounded bg-emerald-500/10 border border-emerald-500/30">
                <span className="text-emerald-400 text-xs font-mono">HISTORY</span>
              </div>
            </div>
            
            <div className="p-6">
              <div className="flex items-center gap-2 mb-4">
                <span className="text-emerald-500 font-mono text-sm">$</span>
                <h3 className="text-lg font-bold text-white font-mono">RECENT_RELAYS</h3>
              </div>
              
              {relayHistory.length === 0 ? (
                <div className="text-center py-12">
                  <div className="text-slate-500 font-mono text-sm mb-2">NO_RELAY_HISTORY</div>
                  <div className="text-slate-600 font-mono text-xs">Create your first anonymous relay above</div>
                </div>
              ) : (
                <div className="space-y-2">
                  {relayHistory.map((relay) => (
                    <div key={relay.id} className="p-4 rounded-lg bg-slate-900/40 border border-slate-700/40 hover:border-emerald-500/30 transition-all">
                      <div className="flex items-center justify-between mb-2">
                        <div className="flex items-center gap-2">
                          <div className={`w-2 h-2 rounded-full ${relay.status === 'confirmed' ? 'bg-emerald-500' : 'bg-purple-500 animate-pulse'}`}></div>
                          <span className="text-white font-mono text-sm font-bold">RELAY #{relay.id}</span>
                        </div>
                        <span className="text-slate-400 font-mono text-xs">{relay.timestamp}</span>
                      </div>
                      <div className="grid grid-cols-3 gap-4 text-xs font-mono">
                        <div>
                          <span className="text-slate-500">TO:</span> <span className="text-cyan-400">{relay.recipient.slice(0,8)}...</span>
                        </div>
                        <div>
                          <span className="text-slate-500">AMOUNT:</span> <span className="text-emerald-400">{relay.amount}</span>
                        </div>
                        <div>
                          <span className="text-slate-500">HOPS:</span> <span className="text-purple-400">{relay.hops}</span>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>

          {/* QR Code Modal */}
          {showQRModal && (
            <div className="fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center z-50 p-4" onClick={() => setShowQRModal(false)}>
              <div className="rounded-xl border border-purple-500/30 bg-black/90 backdrop-blur-xl shadow-2xl max-w-lg w-full" onClick={(e) => e.stopPropagation()}>
                <div className="flex items-center justify-between px-4 py-2 bg-gradient-to-r from-slate-900/80 to-slate-800/80 border-b border-purple-500/20">
                  <div className="flex items-center gap-2">
                    <span className="text-xl text-purple-400">▣</span>
                    <span className="text-xs font-mono text-slate-500">qr_code.png</span>
                  </div>
                  <button onClick={() => setShowQRModal(false)} className="text-slate-400 hover:text-white transition-all">
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  </button>
                </div>
                
                <div className="p-6 text-center">
                  <div className="flex items-center gap-2 mb-4 justify-center">
                    <span className="text-purple-500 font-mono text-sm">$</span>
                    <h3 className="text-lg font-bold text-white font-mono">SCAN_QR_CODE</h3>
                  </div>
                  
                  {qrCodeImage && (
                    <div className="bg-white p-4 rounded-lg inline-block mb-4">
                      <img src={qrCodeImage} alt="QR Code" className="w-64 h-64" />
                    </div>
                  )}
                  
                  <button
                    onClick={downloadQRCode}
                    className="px-6 py-3 rounded-lg bg-gradient-to-r from-purple-600 to-pink-600 hover:scale-[1.02] text-white font-mono font-bold shadow-lg transition-all flex items-center justify-center gap-2 mx-auto"
                  >
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    DOWNLOAD_QR
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    function App() {
      const { toasts, push } = useToasts();
      const [step, setStep] = usePersistentState('uiStep', "home");
      const lastNavRef = React.useRef(0);
      const pendingNavRef = React.useRef(null);

      // Guarded setter to debounce rapid section changes
      const setStepGuarded = React.useCallback((next) => {
        const now = Date.now();
        const minGapMs = 250; // throttle interval
        if (now - lastNavRef.current < minGapMs) {
          // schedule the latest desired step after the gap
          pendingNavRef.current = next;
          clearTimeout(setStepGuarded._t);
          setStepGuarded._t = setTimeout(() => {
            lastNavRef.current = Date.now();
            const target = typeof pendingNavRef.current === 'function' ? pendingNavRef.current(step) : pendingNavRef.current;
            pendingNavRef.current = null;
            setStep(target);
          }, minGapMs - (now - lastNavRef.current));
          return;
        }
        lastNavRef.current = now;
        setStep(next);
      }, [step, setStep]);
      const [hashFromFlow, setHashFromFlow] = useState("");
      
      // Ensure step is always valid, default to 'home' if not
      const validSteps = ['home', 'webrtc', 'offline-network', 'services', 'anonymous-relay', 'privacy-tools', 'steganography', 'privacy-checkup', 'censorship-map', 'swap', 'solana-privacy', 'pump-portal', 'zolana'];
      const currentStep = validSteps.includes(step) ? step : 'home';
      
      return (
        <div className="relative min-h-screen text-white">
          {/* animated gradient blobs */}
          <div className="sky"></div>
          <div className="sky-dim"></div>
          <div className="pointer-events-none absolute inset-0 -z-10 overflow-hidden">
            <div className="cloud c1"></div>
            <div className="cloud c2"></div>
            <div className="cloud c3"></div>
            <div className="cloud c4"></div>
            <div className="cloud c5"></div>
            <div className="cloud c6"></div>
            <div className="cloud c7"></div>
            <div className="cloud c8"></div>
            <div className="cloud c9"></div>
          </div>
          <div className="max-w-6xl mx-auto p-6 sm:p-4 md:p-6">
            <SectionHeader />
            <div className="mt-5 flex gap-6">
              <Sidebar step={currentStep} setStep={setStepGuarded} />
              <main className="flex-1 min-w-0">
                <div className="mb-4 md:hidden">
                  <StepPills step={currentStep} setStep={setStepGuarded} />
                </div>
                <ErrorBoundary key={currentStep}>
                  {(() => {
                    switch(currentStep) {
                      case 'home': return <Home setStep={setStepGuarded} />;
                      case 'webrtc': return <WebRTCTransfer pushToast={push} onHashReady={setHashFromFlow} setVerifyHash={setHashFromFlow} />;
                      case 'offline-network': return <OfflineNetworkHub pushToast={push} />;
                      case 'services': return <Services setStep={setStepGuarded} pushToast={push} />;
                      case 'anonymous-relay': return <AnonymousRelayService setStep={setStepGuarded} pushToast={push} />;
                      case 'privacy-tools': return <PrivacyToolsHub setStep={setStepGuarded} />;
                      case 'steganography': return <UnifiedSteganography pushToast={push} />;
                      case 'privacy-checkup': return <PrivacyCheckup pushToast={push} />;
                      case 'censorship-map': return <CensorshipMap pushToast={push} />;
                      case 'swap': return <PrivacySwap />;
                      case 'solana-privacy': return <SolanaPrivacyToolkit pushToast={push} />;
                      case 'pump-portal': return <PumpPortalLaunch pushToast={push} />;
                      case 'zolana': return <ZolanaExchange pushToast={push} />;
                      default: return (
                        <div className="bg-yellow-500/10 border border-yellow-500/30 rounded-xl p-6">
                          <h2 className="text-white text-xl font-bold mb-2">Section Not Found</h2>
                          <p className="text-white/70">The section "{currentStep}" could not be loaded.</p>
                        </div>
                      );
                    }
                  })()}
                </ErrorBoundary>
              </main>
            </div>
          </div>

          {/* Toasts */}
          <div className="fixed top-20 right-4 space-y-3 z-50">
            {toasts.map((t) => (
              <div key={t.id} className={`toast-enter rounded-2xl border-2 px-6 py-4 text-base font-semibold backdrop-blur-xl shadow-2xl min-w-[320px] ${
                t.tone === "ok"
                  ? "bg-emerald-500/90 border-emerald-300/50 text-white shadow-emerald-500/50"
                  : t.tone === "err"
                  ? "bg-rose-500/90 border-rose-300/50 text-white shadow-rose-500/50"
                  : "bg-cyan-500/90 border-cyan-300/50 text-white shadow-cyan-500/50"
              }`}>
                <div className="flex items-center gap-3">
                  {t.tone === "ok" && (
                    <svg className="w-6 h-6 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m7 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                  )}
                  {t.tone === "err" && (
                    <svg className="w-6 h-6 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 9v2m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                  )}
                  {t.tone !== "ok" && t.tone !== "err" && (
                    <svg className="w-6 h-6 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 16h-1v-4h-1m1-4h.01M12 2a10 10 0 100 20 10 10 0 000-20z" />
                    </svg>
                  )}
                  <span className="flex-1">{t.msg}</span>
                </div>
              </div>
            ))}
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>
<script defer type='text/javascript' src='https://changenow.io/embeds/exchange-widget/v2/stepper-connector.js'></script>
</body>
</html>

<!-- OLD JUNK BELOW TO DELETE
                {nearbyNodes.length === 0 ? (
                  <div className="text-center py-16">
                    <svg className="w-12 h-12 text-slate-300 dark:text-slate-600 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0" />
                    </svg>
                    <p className="text-sm text-slate-600 dark:text-slate-400 font-medium">
                      {nodeActive ? 'Scanning network...' : 'Node offline'}
                    </p>
                  </div>
                ) : (
                  <div className="space-y-1">
                    {nearbyNodes.map((node, i) => (
                      <div key={node.id} className="group hover:bg-slate-100/50 dark:hover:bg-slate-800/50 rounded-lg p-3 transition-all">
                        <div className="flex items-center justify-between mb-2">
                          <div className="flex items-center gap-2">
                            <div className={`w-2 h-2 rounded-full ${node.signal >= 80 ? 'bg-emerald-500' : node.signal >= 50 ? 'bg-orange-500' : 'bg-red-500'}`}></div>
                            <span className="text-sm font-bold text-slate-900 dark:text-white font-mono">{node.name}</span>
                          </div>
                          <span className={`text-xs font-bold ${node.signal >= 80 ? 'text-emerald-600 dark:text-emerald-400' : node.signal >= 50 ? 'text-orange-600 dark:text-orange-400' : 'text-red-600 dark:text-red-400'}`}>
                            {node.signal}%
                          </span>
                        </div>
                        <div className="flex items-center justify-between text-[10px] text-slate-600 dark:text-slate-400 font-medium">
                          <span>{node.distance}</span>
                          <span>{node.uptime}</span>
                          <span>{node.relayed} relays</span>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            </div>
            
            {/* Transaction Queue - Minimalist */}
            <div className="backdrop-blur-sm bg-white/70 dark:bg-slate-900/70 rounded-2xl border border-slate-200/50 dark:border-slate-700/50 overflow-hidden shadow-xl">
              <div className="px-4 py-3 border-b border-slate-200 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-800/50">
                <h3 className="text-xs font-bold uppercase tracking-wider text-slate-700 dark:text-slate-300">Transaction Queue · {pendingTxs.length}</h3>
              </div>
              <div className="p-3">
                {pendingTxs.length === 0 ? (
                  <div className="text-center py-16">
                    <svg className="w-12 h-12 text-slate-300 dark:text-slate-600 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                    </svg>
                    <p className="text-sm text-slate-600 dark:text-slate-400 font-medium mb-4">No pending transactions</p>
                    <button 
                      onClick={() => setShowCreateTx(true)}
                      disabled={!nodeActive}
                      className="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 disabled:bg-slate-400 disabled:opacity-40 text-white text-xs font-bold transition-all"
                    >
                      + NEW
                    </button>
                  </div>
                ) : (
                  <div className="space-y-1">
                    {pendingTxs.map((tx) => (
                      <div key={tx.id} className="group hover:bg-slate-100/50 dark:hover:bg-slate-800/50 rounded-lg p-3 transition-all">
                        <div className="flex items-center justify-between mb-2">
                          <div className="flex items-center gap-2">
                            <div className={`w-2 h-2 rounded-full ${tx.status === 'confirmed' ? 'bg-emerald-500' : tx.status === 'relaying' ? 'bg-blue-500 animate-pulse' : 'bg-orange-500'}`}></div>
                            <span className="text-xs font-bold text-slate-900 dark:text-white font-mono">{tx.id}</span>
                          </div>
                          <span className="text-xs font-bold text-slate-900 dark:text-white">{tx.amount} SOL</span>
                        </div>
                        <div className="flex items-center justify-between text-[10px] text-slate-600 dark:text-slate-400 font-medium mb-1">
                          <span className="truncate max-w-[120px]">{tx.recipient}</span>
                          <span>{tx.hops} hops</span>
                          <span>{tx.created}</span>
                        </div>
                        {tx.memo && (
                          <div className="text-[10px] text-slate-500 dark:text-slate-500 italic mt-1 truncate">{tx.memo}</div>
                        )}
                      </div>
                    ))}
                  </div>
                )}
              </div>
            </div>
          </div>

          {/* Node Operators & Staking Protocol */}
          <div className="backdrop-blur-sm bg-white/70 dark:bg-slate-900/70 rounded-2xl border border-slate-200/50 dark:border-slate-700/50 overflow-hidden shadow-xl">
            <div className="px-4 py-3 border-b border-slate-200 dark:border-slate-700 bg-gradient-to-r from-blue-50 to-cyan-50 dark:from-blue-950/50 dark:to-cyan-950/50">
              <h3 className="text-xs font-bold uppercase tracking-wider text-slate-900 dark:text-white">Node Operators & Staking</h3>
              <p className="text-[10px] text-slate-600 dark:text-slate-400 mt-0.5">Earn $WHISTLE by running nodes and staking tokens</p>
            </div>
            
            <div className="p-4">
              {/* How It Works - 2 Column */}
              <div className="grid md:grid-cols-2 gap-4 mb-4">
                {/* Node Operators */}
                <div className="space-y-3">
                  <div className="flex items-start gap-3">
                    <div className="w-8 h-8 rounded-lg bg-gradient-to-br from-blue-500 to-cyan-600 flex items-center justify-center flex-shrink-0">
                      <span className="text-white text-sm font-black">1</span>
                    </div>
                    <div>
                      <h4 className="text-sm font-black text-slate-900 dark:text-white mb-1">RUN A NODE</h4>
                      <p className="text-xs text-slate-600 dark:text-slate-400 leading-relaxed">
                        Keep your device online with the WHISTLE app running. Your node will automatically relay encrypted transactions through the mesh network.
                      </p>
                    </div>
                  </div>
                  
                  <div className="flex items-start gap-3">
                    <div className="w-8 h-8 rounded-lg bg-gradient-to-br from-emerald-500 to-teal-600 flex items-center justify-center flex-shrink-0">
                      <span className="text-white text-sm font-black">2</span>
                    </div>
                    <div>
                      <h4 className="text-sm font-black text-slate-900 dark:text-white mb-1">RELAY MESSAGES</h4>
                      <p className="text-xs text-slate-600 dark:text-slate-400 leading-relaxed">
                        Each transaction you relay earns you $WHISTLE tokens. The more uptime and relays, the higher your rewards.
                      </p>
                    </div>
                  </div>
                  
                  <div className="flex items-start gap-3">
                    <div className="w-8 h-8 rounded-lg bg-gradient-to-br from-orange-500 to-amber-600 flex items-center justify-center flex-shrink-0">
                      <span className="text-white text-sm font-black">3</span>
                    </div>
                    <div>
                      <h4 className="text-sm font-black text-slate-900 dark:text-white mb-1">EARN REWARDS</h4>
                      <p className="text-xs text-slate-600 dark:text-slate-400 leading-relaxed">
                        Automatic payouts every 24h. Top node operators earn bonus multipliers for reliability and performance.
                      </p>
                    </div>
                  </div>
                </div>

                {/* Staking Protocol */}
                <div className="space-y-3">
                  <div className="bg-gradient-to-br from-blue-50 to-cyan-50 dark:from-blue-950/30 dark:to-cyan-950/30 rounded-xl p-4 border border-blue-200 dark:border-blue-800">
                    <h4 className="text-xs font-black text-blue-900 dark:text-blue-300 mb-2 uppercase tracking-wider">Base Staking APY</h4>
                    <div className="text-3xl font-black text-blue-600 dark:text-blue-400 mb-1">45%</div>
                    <p className="text-[10px] text-slate-600 dark:text-slate-400">Up to 60% APY with node boost</p>
                  </div>

                  <div className="space-y-2">
                    <div className="flex items-center justify-between py-2 border-b border-slate-200 dark:border-slate-700">
                      <span className="text-xs text-slate-600 dark:text-slate-400">Minimum Stake</span>
                      <span className="text-xs font-bold text-slate-900 dark:text-white">10,000 $WHISTLE</span>
                    </div>
                    <div className="flex items-center justify-between py-2 border-b border-slate-200 dark:border-slate-700">
                      <span className="text-xs text-slate-600 dark:text-slate-400">Lock Period</span>
                      <span className="text-xs font-bold text-slate-900 dark:text-white">30 / 90 / 180 days</span>
                    </div>
                    <div className="flex items-center justify-between py-2 border-b border-slate-200 dark:border-slate-700">
                      <span className="text-xs text-slate-600 dark:text-slate-400">Node Operator Boost</span>
                      <span className="text-xs font-bold text-emerald-600 dark:text-emerald-400">+15% APY</span>
                    </div>
                    <div className="flex items-center justify-between py-2 border-b border-slate-200 dark:border-slate-700">
                      <span className="text-xs text-slate-600 dark:text-slate-400">Reward per Relay</span>
                      <span className="text-xs font-bold text-orange-600 dark:text-orange-400">8 $WHISTLE</span>
                    </div>
                    <div className="flex items-center justify-between py-2">
                      <span className="text-xs text-slate-600 dark:text-slate-400">Rewards Claim</span>
                      <span className="text-xs font-bold text-slate-900 dark:text-white">Daily</span>
                    </div>
                  </div>
                </div>
              </div>

              {/* Requirements & Benefits */}
              <div className="grid md:grid-cols-3 gap-3">
                <div className="bg-slate-50 dark:bg-slate-800/50 rounded-xl p-3 border border-slate-200 dark:border-slate-700">
                  <h5 className="text-[10px] font-black uppercase tracking-wider text-slate-700 dark:text-slate-400 mb-2">Node Requirements</h5>
                  <ul className="space-y-1 text-xs text-slate-600 dark:text-slate-400">
                    <li className="flex items-center gap-2">
                      <div className="w-1 h-1 rounded-full bg-blue-500"></div>
                      <span>WiFi or Bluetooth enabled</span>
                    </li>
                    <li className="flex items-center gap-2">
                      <div className="w-1 h-1 rounded-full bg-blue-500"></div>
                      <span>Device stays online</span>
                    </li>
                    <li className="flex items-center gap-2">
                      <div className="w-1 h-1 rounded-full bg-blue-500"></div>
                      <span>WHISTLE app running</span>
                    </li>
                  </ul>
                </div>

                <div className="bg-slate-50 dark:bg-slate-800/50 rounded-xl p-3 border border-slate-200 dark:border-slate-700">
                  <h5 className="text-[10px] font-black uppercase tracking-wider text-slate-700 dark:text-slate-400 mb-2">Earning Factors</h5>
                  <ul className="space-y-1 text-xs text-slate-600 dark:text-slate-400">
                    <li className="flex items-center gap-2">
                      <div className="w-1 h-1 rounded-full bg-emerald-500"></div>
                      <span>Uptime percentage</span>
                    </li>
                    <li className="flex items-center gap-2">
                      <div className="w-1 h-1 rounded-full bg-emerald-500"></div>
                      <span>Messages relayed</span>
                    </li>
                    <li className="flex items-center gap-2">
                      <div className="w-1 h-1 rounded-full bg-emerald-500"></div>
                      <span>Network contribution</span>
                    </li>
                  </ul>
                </div>

                <div className="bg-slate-50 dark:bg-slate-800/50 rounded-xl p-3 border border-slate-200 dark:border-slate-700">
                  <h5 className="text-[10px] font-black uppercase tracking-wider text-slate-700 dark:text-slate-400 mb-2">Staker Benefits</h5>
                  <ul className="space-y-1 text-xs text-slate-600 dark:text-slate-400">
                    <li className="flex items-center gap-2">
                      <div className="w-1 h-1 rounded-full bg-orange-500"></div>
                      <span>Daily compound rewards</span>
                    </li>
                    <li className="flex items-center gap-2">
                      <div className="w-1 h-1 rounded-full bg-orange-500"></div>
                      <span>Node operator bonus</span>
                    </li>
                    <li className="flex items-center gap-2">
                      <div className="w-1 h-1 rounded-full bg-orange-500"></div>
                      <span>Governance rights</span>
                    </li>
                  </ul>
                </div>
              </div>

              {/* Tokenomics Info */}
              <div className="mt-4 bg-gradient-to-r from-slate-100 to-slate-50 dark:from-slate-800/50 dark:to-slate-900/50 rounded-xl p-3 border border-slate-200 dark:border-slate-700">
                <div className="grid grid-cols-2 md:grid-cols-4 gap-3 text-center">
                  <div>
                    <div className="text-[9px] text-slate-500 dark:text-slate-500 mb-1 uppercase tracking-wider">Total Supply</div>
                    <div className="text-sm font-black text-slate-900 dark:text-white">1B $WHISTLE</div>
                  </div>
                  <div>
                    <div className="text-[9px] text-slate-500 dark:text-slate-500 mb-1 uppercase tracking-wider">Market Cap</div>
                    <div className="text-sm font-black text-slate-900 dark:text-white">$130K</div>
                  </div>
                  <div>
                    <div className="text-[9px] text-slate-500 dark:text-slate-500 mb-1 uppercase tracking-wider">Token Price</div>
                    <div className="text-sm font-black text-slate-900 dark:text-white">$0.00013</div>
                  </div>
                  <div>
                    <div className="text-[9px] text-slate-500 dark:text-slate-500 mb-1 uppercase tracking-wider">Contract</div>
                    <div className="text-[10px] font-mono font-bold text-blue-600 dark:text-blue-400">6Hb...pump</div>
                  </div>
                </div>
              </div>

              {/* Reward Calculation Example */}
              <div className="mt-3 bg-gradient-to-r from-blue-50 to-cyan-50 dark:from-blue-950/30 dark:to-cyan-950/30 rounded-xl p-4 border border-blue-200 dark:border-blue-800">
                <h5 className="text-xs font-black text-slate-900 dark:text-white mb-3 uppercase tracking-wider">💰 Example Earnings Calculator</h5>
                
                {/* Scenario 1: Small Holder */}
                <div className="mb-4 pb-4 border-b border-slate-200 dark:border-slate-700">
                  <div className="text-[10px] font-bold text-slate-700 dark:text-slate-300 mb-2 uppercase tracking-wider">📊 Entry Level (100K $WHISTLE Staked = $13 USD)</div>
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <div>
                      <div className="text-[9px] text-slate-600 dark:text-slate-400 mb-1">Base Staking (45% APY)</div>
                      <div className="text-base font-black text-blue-600 dark:text-blue-400">123 $W/day</div>
                      <div className="text-[8px] text-slate-500 dark:text-slate-500">~$0.016/day</div>
                    </div>
                    <div>
                      <div className="text-[9px] text-slate-600 dark:text-slate-400 mb-1">Node Rewards (50 relays)</div>
                      <div className="text-base font-black text-emerald-600 dark:text-emerald-400">400 $W/day</div>
                      <div className="text-[8px] text-slate-500 dark:text-slate-500">~$0.052/day</div>
                    </div>
                    <div>
                      <div className="text-[9px] text-slate-600 dark:text-slate-400 mb-1">w/ Node Boost (60% APY)</div>
                      <div className="text-base font-black text-orange-600 dark:text-orange-400">564 $W/day</div>
                      <div className="text-[8px] text-slate-500 dark:text-slate-500">~$0.073/day</div>
                    </div>
                    <div>
                      <div className="text-[9px] text-slate-600 dark:text-slate-400 mb-1">Monthly Total</div>
                      <div className="text-base font-black text-slate-900 dark:text-white">~16.9K $W</div>
                      <div className="text-[8px] text-emerald-600 dark:text-emerald-400">~$2.20 (17% gain)</div>
                    </div>
                  </div>
                </div>

                {/* Scenario 2: Power User */}
                <div>
                  <div className="text-[10px] font-bold text-slate-700 dark:text-slate-300 mb-2 uppercase tracking-wider">🚀 Power User (500K $WHISTLE Staked = $65 USD)</div>
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <div>
                      <div className="text-[9px] text-slate-600 dark:text-slate-400 mb-1">Base Staking (45% APY)</div>
                      <div className="text-base font-black text-blue-600 dark:text-blue-400">616 $W/day</div>
                      <div className="text-[8px] text-slate-500 dark:text-slate-500">~$0.080/day</div>
                    </div>
                    <div>
                      <div className="text-[9px] text-slate-600 dark:text-slate-400 mb-1">Node Rewards (200 relays)</div>
                      <div className="text-base font-black text-emerald-600 dark:text-emerald-400">1,600 $W/day</div>
                      <div className="text-[8px] text-slate-500 dark:text-slate-500">~$0.208/day</div>
                    </div>
                    <div>
                      <div className="text-[9px] text-slate-600 dark:text-slate-400 mb-1">w/ Node Boost (60% APY)</div>
                      <div className="text-base font-black text-orange-600 dark:text-orange-400">2,422 $W/day</div>
                      <div className="text-[8px] text-slate-500 dark:text-slate-500">~$0.315/day</div>
                    </div>
                    <div>
                      <div className="text-[9px] text-slate-600 dark:text-slate-400 mb-1">Monthly Total</div>
                      <div className="text-base font-black text-slate-900 dark:text-white">~72.7K $W</div>
                      <div className="text-[8px] text-emerald-600 dark:text-emerald-400">~$9.45 (14.5% gain)</div>
                    </div>
                  </div>
                </div>

                <div className="mt-3 pt-3 border-t border-slate-200 dark:border-slate-700 text-center">
                  <p className="text-[9px] text-slate-600 dark:text-slate-500 italic">* Price assumes current $130K market cap. Actual earnings in USD will increase with market cap growth.</p>
                </div>
              </div>
            </div>
          </div>
          
          {/* Create Transaction Modal */}
          {showCreateTx && (
            <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4" onClick={() => setShowCreateTx(false)}>
              <div className="rounded-3xl border border-white/20 bg-slate-900/95 p-8 max-w-lg w-full shadow-2xl" onClick={(e) => e.stopPropagation()}>
                <h2 className="text-2xl font-bold text-white mb-6">Create Offline Transaction</h2>
                
                <div className="space-y-4">
                  <div>
                    <label className="block text-white/70 text-sm mb-2">Recipient Address</label>
                    <input
                      type="text"
                      value={txRecipient}
                      onChange={(e) => setTxRecipient(e.target.value)}
                      placeholder="Enter Solana wallet address..."
                      className="w-full px-4 py-3 rounded-xl bg-white/5 border border-white/10 text-white focus:border-cyan-400 focus:outline-none transition-all"
                    />
                  </div>
                  
                  <div>
                    <label className="block text-white/70 text-sm mb-2">Amount (SOL)</label>
                    <input
                      type="number"
                      step="0.001"
                      value={txAmount}
                      onChange={(e) => setTxAmount(e.target.value)}
                      placeholder="0.00"
                      className="w-full px-4 py-3 rounded-xl bg-white/5 border border-white/10 text-white focus:border-cyan-400 focus:outline-none transition-all"
                    />
                  </div>
                  
                  <div>
                    <label className="block text-white/70 text-sm mb-2">Memo (Optional)</label>
                    <input
                      type="text"
                      value={txMemo}
                      onChange={(e) => setTxMemo(e.target.value)}
                      placeholder="Add a note..."
                      className="w-full px-4 py-3 rounded-xl bg-white/5 border border-white/10 text-white focus:border-cyan-400 focus:outline-none transition-all"
                    />
                  </div>
                  
                  <div className="bg-cyan-500/10 border border-cyan-400/30 rounded-xl p-4">
                    <div className="flex items-start gap-3">
                      <svg className="w-5 h-5 text-cyan-400 shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                      </svg>
                      <div className="text-sm text-white/70">
                        Your transaction will be signed offline and broadcast through the mesh network. 
                        It may take several minutes to reach an internet-connected node.
                      </div>
                    </div>
                  </div>
                </div>
                
                <div className="flex gap-3 mt-6">
                  <button
                    onClick={createOfflineTx}
                    className="flex-1 px-6 py-3 rounded-xl bg-gradient-to-r from-cyan-500 to-cyan-600 hover:from-cyan-400 hover:to-cyan-500 text-white font-bold transition-all hover:scale-105 shadow-lg shadow-cyan-500/50"
                  >
                    Create & Broadcast
                  </button>
                  <button
                    onClick={() => setShowCreateTx(false)}
                    className="px-6 py-3 rounded-xl border-2 border-white/20 hover:border-white/30 bg-white/5 hover:bg-white/10 text-white font-bold transition-all"
                  >
                    Cancel
                  </button>
                </div>
              </div>
            </div>
          )}
          
          {/* Info Modal */}
          {showNodeInfo && (
            <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4" onClick={() => setShowNodeInfo(false)}>
              <div className="rounded-3xl border border-white/20 bg-slate-900/95 p-8 max-w-2xl w-full shadow-2xl max-h-[90vh] overflow-y-auto" onClick={(e) => e.stopPropagation()}>
                <h2 className="text-3xl font-bold text-white mb-6">How Offline Network Works</h2>
                
                <div className="space-y-6">
                  <div>
                    <h3 className="text-xl font-bold text-cyan-400 mb-3">🌐 Mesh Network Protocol</h3>
                    <p className="text-white/70 leading-relaxed">
                      Every device running WHISTLE becomes a relay node. Transactions hop from device to device 
                      using WiFi Direct and Bluetooth, creating a decentralized mesh network that works completely offline.
                    </p>
                  </div>
                  
                  <div>
                    <h3 className="text-xl font-bold text-purple-400 mb-3">💰 Earn $WHISTLE Rewards</h3>
                    <p className="text-white/70 leading-relaxed">
                      Every time you relay a transaction, you earn $WHISTLE tokens. The more you help the network, 
                      the more you earn. Rewards are automatically distributed when transactions confirm on-chain.
                    </p>
                  </div>
                  
                  <div>
                    <h3 className="text-xl font-bold text-emerald-400 mb-3">🔒 Privacy & Security</h3>
                    <p className="text-white/70 leading-relaxed">
                      All messages are end-to-end encrypted. Relay nodes can't read transaction contents. 
                      Your keys never leave your device. Transactions are signed offline and verified on-chain.
                    </p>
                  </div>
                  
                  <div>
                    <h3 className="text-xl font-bold text-yellow-400 mb-3">🚀 Use Cases</h3>
                    <ul className="text-white/70 space-y-2 list-disc list-inside">
                      <li>Send crypto during internet outages</li>
                      <li>Censorship-resistant transactions</li>
                      <li>Emergency disaster communications</li>
                      <li>Rural areas with poor connectivity</li>
                      <li>Privacy-focused offline payments</li>
                    </ul>
                  </div>
                  
                  <div className="bg-gradient-to-r from-cyan-500/20 to-purple-500/20 border border-cyan-400/30 rounded-xl p-6">
                    <div className="flex items-start gap-4">
                      <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-cyan-400 to-purple-400 flex items-center justify-center shrink-0">
                        <svg className="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                      </div>
                      <div>
                        <h4 className="text-white font-bold mb-2">Coming Soon: Mobile App</h4>
                        <p className="text-white/70 text-sm">
                          Native iOS & Android apps with true WiFi Direct and Bluetooth mesh capabilities. 
                          Join the waitlist to be the first to access global offline Solana transactions.
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
                
                <button
                  onClick={() => setShowNodeInfo(false)}
                  className="w-full mt-6 px-6 py-3 rounded-xl bg-gradient-to-r from-cyan-500 to-purple-600 hover:from-cyan-400 hover:to-purple-500 text-white font-bold transition-all hover:scale-105 shadow-lg"
                >
                  Got It!
                </button>
              </div>
            </div>
          )}

          {/* Stake Modal */}
          {showStakeModal && (
            <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4" onClick={() => setShowStakeModal(false)}>
              <div className="rounded-2xl bg-white dark:bg-slate-900 max-w-lg w-full shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
                {/* Header */}
                <div className="bg-gradient-to-r from-blue-600 to-cyan-600 p-6">
                  <h2 className="text-2xl font-black text-white mb-1">STAKE $WHISTLE</h2>
                  <p className="text-blue-100 text-sm">Lock tokens to activate your node</p>
                </div>

                {/* Content */}
                <div className="p-6 space-y-5">
                  {/* Wallet Balance */}
                  <div className="bg-slate-100 dark:bg-slate-800 rounded-xl p-4">
                    <div className="text-xs text-slate-600 dark:text-slate-400 mb-1 uppercase tracking-wider">Wallet Balance</div>
                    <div className="text-2xl font-black text-slate-900 dark:text-white">{tokenBalance.toLocaleString()} $WHISTLE</div>
                    <div className="text-xs text-slate-500 dark:text-slate-500 mt-1">≈ ${(tokenBalance * 0.00013).toFixed(2)} USD</div>
                  </div>

                  {/* Amount Input */}
                  <div>
                    <label className="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Stake Amount</label>
                    <div className="relative">
                      <input
                        type="number"
                        value={stakeInput}
                        onChange={(e) => setStakeInput(e.target.value)}
                        placeholder="10,000 minimum"
                        className="w-full px-4 py-3 rounded-xl bg-white dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-700 text-slate-900 dark:text-white focus:border-blue-500 focus:outline-none transition-all font-bold"
                      />
                      <button
                        onClick={() => setStakeInput(tokenBalance.toString())}
                        className="absolute right-3 top-1/2 -translate-y-1/2 px-3 py-1 rounded-lg bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold transition-all"
                      >
                        MAX
                      </button>
                    </div>
                    <div className="flex gap-2 mt-2">
                      <button onClick={() => setStakeInput('10000')} className="px-3 py-1.5 rounded-lg bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-300 text-xs font-bold transition-all">10K</button>
                      <button onClick={() => setStakeInput('50000')} className="px-3 py-1.5 rounded-lg bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-300 text-xs font-bold transition-all">50K</button>
                      <button onClick={() => setStakeInput('100000')} className="px-3 py-1.5 rounded-lg bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-300 text-xs font-bold transition-all">100K</button>
                      <button onClick={() => setStakeInput('250000')} className="px-3 py-1.5 rounded-lg bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-300 text-xs font-bold transition-all">250K</button>
                    </div>
                  </div>

                  {/* Lock Period */}
                  <div>
                    <label className="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-3">Lock Period</label>
                    <div className="grid grid-cols-3 gap-3">
                      <button
                        onClick={() => setLockPeriod(30)}
                        className={`py-3 px-4 rounded-xl border-2 transition-all font-bold ${
                          lockPeriod === 30
                            ? 'bg-blue-600 border-blue-600 text-white'
                            : 'bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-300 hover:border-blue-400'
                        }`}
                      >
                        <div className="text-xs mb-1">30 Days</div>
                        <div className="text-[10px] opacity-70">45% APY</div>
                      </button>
                      <button
                        onClick={() => setLockPeriod(90)}
                        className={`py-3 px-4 rounded-xl border-2 transition-all font-bold ${
                          lockPeriod === 90
                            ? 'bg-blue-600 border-blue-600 text-white'
                            : 'bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-300 hover:border-blue-400'
                        }`}
                      >
                        <div className="text-xs mb-1">90 Days</div>
                        <div className="text-[10px] opacity-70">52% APY</div>
                      </button>
                      <button
                        onClick={() => setLockPeriod(180)}
                        className={`py-3 px-4 rounded-xl border-2 transition-all font-bold ${
                          lockPeriod === 180
                            ? 'bg-blue-600 border-blue-600 text-white'
                            : 'bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-300 hover:border-blue-400'
                        }`}
                      >
                        <div className="text-xs mb-1">180 Days</div>
                        <div className="text-[10px] opacity-70">60% APY</div>
                      </button>
                    </div>
                  </div>

                  {/* Expected Returns */}
                  {stakeInput && parseFloat(stakeInput) >= 10000 && (
                    <div className="bg-gradient-to-r from-emerald-50 to-teal-50 dark:from-emerald-950/30 dark:to-teal-950/30 rounded-xl p-4 border border-emerald-200 dark:border-emerald-800">
                      <div className="text-xs font-bold text-emerald-900 dark:text-emerald-300 mb-3 uppercase tracking-wider">Expected Returns</div>
                      <div className="grid grid-cols-2 gap-4">
                        <div>
                          <div className="text-[10px] text-emerald-700 dark:text-emerald-400 mb-1">Daily Rewards</div>
                          <div className="text-lg font-black text-emerald-900 dark:text-emerald-300">
                            {(parseFloat(stakeInput) * (lockPeriod === 30 ? 0.45 : lockPeriod === 90 ? 0.52 : 0.60) / 365).toFixed(0)} $W
                          </div>
                        </div>
                        <div>
                          <div className="text-[10px] text-emerald-700 dark:text-emerald-400 mb-1">Total at Unlock</div>
                          <div className="text-lg font-black text-emerald-900 dark:text-emerald-300">
                            {(parseFloat(stakeInput) * (1 + (lockPeriod === 30 ? 0.45 : lockPeriod === 90 ? 0.52 : 0.60) * (lockPeriod / 365))).toFixed(0)} $W
                          </div>
                        </div>
                      </div>
                    </div>
                  )}

                  {/* Action Buttons */}
                  <div className="flex gap-3 pt-2">
                    <button
                      onClick={() => setShowStakeModal(false)}
                      className="flex-1 px-6 py-3 rounded-xl bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-300 font-bold transition-all"
                    >
                      Cancel
                    </button>
                    <button
                      onClick={handleStake}
                      className="flex-1 px-6 py-3 rounded-xl bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-500 hover:to-cyan-500 text-white font-bold transition-all shadow-lg hover:shadow-xl"
                    >
                      Stake Now
                    </button>
                  </div>

                  {/* Info Note */}
                  <div className="text-[10px] text-slate-600 dark:text-slate-500 text-center italic pt-2">
                    ⚠️ Tokens will be locked for {lockPeriod} days. Early withdrawal not available.
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    function App() {
      const { toasts, push } = useToasts();
      const [step, setStep] = usePersistentState('uiStep', "home");
      const lastNavRef = React.useRef(0);
      const pendingNavRef = React.useRef(null);

      // Guarded setter to debounce rapid section changes
      const setStepGuarded = React.useCallback((next) => {
        const now = Date.now();
        const minGapMs = 250; // throttle interval
        if (now - lastNavRef.current < minGapMs) {
          // schedule the latest desired step after the gap
          pendingNavRef.current = next;
          clearTimeout(setStepGuarded._t);
          setStepGuarded._t = setTimeout(() => {
            lastNavRef.current = Date.now();
            const target = typeof pendingNavRef.current === 'function' ? pendingNavRef.current(step) : pendingNavRef.current;
            pendingNavRef.current = null;
            setStep(target);
          }, minGapMs - (now - lastNavRef.current));
          return;
        }
        lastNavRef.current = now;
        setStep(next);
      }, [step, setStep]);
      const [hashFromFlow, setHashFromFlow] = useState("");
      
      // Ensure step is always valid, default to 'home' if not
      const validSteps = ['home', 'webrtc', 'offline-network', 'services', 'anonymous-relay', 'privacy-tools', 'steganography', 'privacy-checkup', 'censorship-map', 'swap', 'solana-privacy', 'pump-portal', 'zolana'];
      const currentStep = validSteps.includes(step) ? step : 'home';
      
      return (
        <div className="relative min-h-screen text-white">
          {/* animated gradient blobs */}
          <div className="sky"></div>
          <div className="sky-dim"></div>
          <div className="pointer-events-none absolute inset-0 -z-10 overflow-hidden">
            <div className="cloud c1"></div>
            <div className="cloud c2"></div>
            <div className="cloud c3"></div>
            <div className="cloud c4"></div>
            <div className="cloud c5"></div>
            <div className="cloud c6"></div>
            <div className="cloud c7"></div>
            <div className="cloud c8"></div>
            <div className="cloud c9"></div>
          </div>
          <div className="max-w-6xl mx-auto p-6 sm:p-4 md:p-6">
            <SectionHeader />
            <div className="mt-5 flex gap-6">
              <Sidebar step={currentStep} setStep={setStepGuarded} />
              <main className="flex-1 min-w-0">
                <div className="mb-4 md:hidden">
                  <StepPills step={currentStep} setStep={setStepGuarded} />
                </div>
                <ErrorBoundary key={currentStep}>
                  {(() => {
                    switch(currentStep) {
                      case 'home': return <Home setStep={setStepGuarded} />;
                      case 'webrtc': return <WebRTCTransfer pushToast={push} onHashReady={setHashFromFlow} setVerifyHash={setHashFromFlow} />;
                      case 'offline-network': return <OfflineNetworkHub pushToast={push} />;
                      case 'services': return <Services setStep={setStepGuarded} pushToast={push} />;
                      case 'anonymous-relay': return <AnonymousRelayService setStep={setStepGuarded} pushToast={push} />;
                      case 'privacy-tools': return <PrivacyToolsHub setStep={setStepGuarded} />;
                      case 'steganography': return <UnifiedSteganography pushToast={push} />;
                      case 'privacy-checkup': return <PrivacyCheckup pushToast={push} />;
                      case 'censorship-map': return <CensorshipMap pushToast={push} />;
                      case 'swap': return <PrivacySwap />;
                      case 'solana-privacy': return <SolanaPrivacyToolkit pushToast={push} />;
                      case 'pump-portal': return <PumpPortalLaunch pushToast={push} />;
                      case 'zolana': return <ZolanaExchange pushToast={push} />;
                      default: return (
                        <div className="bg-yellow-500/10 border border-yellow-500/30 rounded-xl p-6">
                          <h2 className="text-white text-xl font-bold mb-2">Section Not Found</h2>
                          <p className="text-white/70">The section "{currentStep}" could not be loaded.</p>
                        </div>
                      );
                    }
                  })()}
                </ErrorBoundary>
              </main>
            </div>
          </div>

          {/* Toasts */}
          <div className="fixed top-20 right-4 space-y-3 z-50">
            {toasts.map((t) => (
              <div key={t.id} className={`toast-enter rounded-2xl border-2 px-6 py-4 text-base font-semibold backdrop-blur-xl shadow-2xl min-w-[320px] ${
                t.tone === "ok"
                  ? "bg-emerald-500/90 border-emerald-300/50 text-white shadow-emerald-500/50"
                  : t.tone === "err"
                  ? "bg-rose-500/90 border-rose-300/50 text-white shadow-rose-500/50"
                  : "bg-cyan-500/90 border-cyan-300/50 text-white shadow-cyan-500/50"
              }`}>
                <div className="flex items-center gap-3">
                  {t.tone === "ok" && (
                    <svg className="w-6 h-6 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m7 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                  )}
                  {t.tone === "err" && (
                    <svg className="w-6 h-6 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 9v2m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                  )}
                  {t.tone !== "ok" && t.tone !== "err" && (
                    <svg className="w-6 h-6 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 16h-1v-4h-1m1-4h.01M12 2a10 10 0 100 20 10 10 0 000-20z" />
                    </svg>
                  )}
                  <span className="flex-1">{t.msg}</span>
                </div>
              </div>
            ))}
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>
<script defer type='text/javascript' src='https://changenow.io/embeds/exchange-widget/v2/stepper-connector.js'></script>
</body>
</html>