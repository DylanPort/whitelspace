<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Privacy Tools Lab - Full Stack</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    @keyframes spin-flip-zoom {
      0% { transform: rotate(0deg) rotateY(0deg) scale(1); }
      25% { transform: rotate(90deg) rotateY(180deg) scale(1.15); }
      50% { transform: rotate(180deg) rotateY(360deg) scale(1); }
      75% { transform: rotate(270deg) rotateY(540deg) scale(1.15); }
      100% { transform: rotate(360deg) rotateY(720deg) scale(1); }
    }
    @keyframes progress-slide {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    .scrollbar-thin::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    .scrollbar-thin::-webkit-scrollbar-track {
      background: rgba(15, 23, 42, 0.5);
    }
    .scrollbar-thin::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, rgba(6, 182, 212, 0.5), rgba(251, 191, 36, 0.5));
      border-radius: 3px;
    }
    .scrollbar-thin::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg, rgba(6, 182, 212, 0.8), rgba(251, 191, 36, 0.8));
    }
    /* Premium dark builder theme extras */
    .glass {
      background: rgba(2,6,23,0.65);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(100,116,139,0.35);
    }
    .panel-title {
      font-size: 10px;
      letter-spacing: .12em;
      color: #94a3b8;
      text-transform: uppercase;
    }
    .splitter-dot {
      width:6px;height:6px;border-radius:50%;
      background: radial-gradient(circle at 30% 30%, rgba(34,211,238,.9), rgba(251,191,36,.6));
      box-shadow:0 0 10px rgba(34,211,238,.4), 0 0 14px rgba(251,191,36,.25);
    }
    .noise::before{
      content:"";position:fixed;inset:0;pointer-events:none;opacity:.04;
      background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="160" height="160" viewBox="0 0 160 160"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="2" stitchTiles="stitch"/></filter><rect width="100%" height="100%" filter="url(%23n)"/></svg>');
    }
  </style>
</head>
<body class="bg-black">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // =====================================================
    // FILE TREE COMPONENT
    // =====================================================
    function FileTree({ files, activeFile, onFileSelect }) {
      const [expandedFolders, setExpandedFolders] = useState(new Set(['']));

      const buildTree = (files) => {
        const tree = {};
        files.forEach(file => {
          const parts = file.path.split('/');
          let current = tree;
          parts.forEach((part, idx) => {
            if (idx === parts.length - 1) {
              current[part] = file;
            } else {
              current[part] = current[part] || {};
              current = current[part];
            }
          });
        });
        return tree;
      };

      const toggleFolder = (path) => {
        const newExpanded = new Set(expandedFolders);
        if (newExpanded.has(path)) {
          newExpanded.delete(path);
        } else {
          newExpanded.add(path);
        }
        setExpandedFolders(newExpanded);
      };

      const getFileIcon = (filename) => {
        if (filename.endsWith('.html')) return 'üìÑ';
        if (filename.endsWith('.js')) return 'üìú';
        if (filename.endsWith('.json')) return '‚öôÔ∏è';
        if (filename.endsWith('.md')) return 'üìñ';
        if (filename.endsWith('.css')) return 'üé®';
        if (filename.endsWith('.env')) return 'üîê';
        return 'üìÉ';
      };

      const renderTree = (node, path = '', level = 0) => {
        return Object.entries(node).map(([key, value]) => {
          const isFile = value.path !== undefined;
          const fullPath = path ? `${path}/${key}` : key;
          
          if (isFile) {
            return (
              <div
                key={value.path}
                onClick={() => onFileSelect(value)}
                className={`
                  py-1.5 px-2 text-xs cursor-pointer transition-all flex items-center gap-2 rounded-md
                  ${activeFile?.path === value.path 
                    ? 'bg-gradient-to-r from-cyan-500/30 to-amber-500/30 text-white border-l-2 border-cyan-400' 
                    : 'hover:bg-slate-800 text-gray-400 hover:text-gray-200'}
                `}
                style={{ paddingLeft: `${(level + 1) * 12 + 8}px` }}
              >
                <span>{getFileIcon(key)}</span>
                <span className="font-mono">{key}</span>
                <span className="ml-auto text-[10px] text-gray-600">{value.size || 0}b</span>
              </div>
            );
          } else {
            const isExpanded = expandedFolders.has(fullPath);
            return (
              <div key={fullPath}>
                <div
                  onClick={() => toggleFolder(fullPath)}
                  className="py-1.5 px-2 text-xs cursor-pointer text-gray-500 hover:text-gray-300 hover:bg-slate-800/50 flex items-center gap-2 rounded-md transition-all"
                  style={{ paddingLeft: `${level * 12 + 8}px` }}
                >
                  <span className="transition-transform" style={{ transform: isExpanded ? 'rotate(90deg)' : 'rotate(0deg)' }}>‚ñ∂</span>
                  <span>üìÅ</span>
                  <span className="font-mono font-semibold">{key}/</span>
                </div>
                {isExpanded && (
                  <div>
                    {renderTree(value, fullPath, level + 1)}
                  </div>
                )}
              </div>
            );
          }
        });
      };

      const tree = buildTree(files);

      return (
        <div className="bg-slate-950 border-r border-slate-800 overflow-auto h-full">
          <div className="sticky top-0 bg-slate-900 px-3 py-2 border-b border-slate-800 flex items-center justify-between">
            <span className="text-xs text-gray-500 font-bold tracking-wider">FILES</span>
            <span className="text-[10px] text-gray-600">{files.length} files</span>
          </div>

          {/* Bottom console */}
          <div className={`${consoleOpen ? 'h-36' : 'h-0'} transition-all duration-300 overflow-hidden border-t border-slate-800 bg-slate-950/70`}> 
            <div className="px-4 py-2 text-[11px] text-gray-400 flex items-center justify-between">
              <span>Console</span>
              <button onClick={()=>setConsoleOpen(false)} className="text-gray-500 hover:text-gray-300">Close</button>
            </div>
            <div className="px-4 pb-3 text-[11px] text-gray-500 space-y-1 max-h-28 overflow-auto">
              <div>Tip: Approve each file to stream it into your workspace.</div>
              <div>{progress}</div>
            </div>
          </div>
          <div className="p-2">
            {renderTree(tree)}
          </div>
        </div>
      );
    }

    // =====================================================
    // FILE TABS COMPONENT
    // =====================================================
    function FileTabs({ files, activeFile, onFileSelect, onCloseFile }) {
      return (
        <div className="flex gap-1 bg-slate-900 px-2 py-1 border-b border-slate-700 overflow-x-auto scrollbar-thin">
          {files.map(file => (
            <div
              key={file.path}
              className={`
                group flex items-center gap-2 px-3 py-1.5 text-xs rounded-t transition-all cursor-pointer whitespace-nowrap
                ${activeFile?.path === file.path 
                  ? 'bg-slate-950 text-cyan-400 border-t border-l border-r border-slate-700 font-semibold' 
                  : 'text-gray-500 hover:text-gray-300 hover:bg-slate-800'}
              `}
              onClick={() => onFileSelect(file)}
            >
              <span className="font-mono">{file.path.split('/').pop()}</span>
              {onCloseFile && (
                <button
                  onClick={(e) => {
                    e.stopPropagation();
                    onCloseFile(file);
                  }}
                  className="opacity-0 group-hover:opacity-100 text-gray-600 hover:text-red-400 transition-all"
                >
                  √ó
                </button>
              )}
            </div>
          ))}
        </div>
      );
    }

    // =====================================================
    // CODE EDITOR COMPONENT
    // =====================================================
    function CodeEditor({ file, onEdit }) {
      if (!file) {
        return (
          <div className="flex-1 flex items-center justify-center text-gray-600">
            <div className="text-center">
              <div className="text-4xl mb-4">üìÇ</div>
              <div>Select a file to view</div>
            </div>
          </div>
        );
      }

      return (
        <div className="flex-1 flex flex-col bg-slate-950">
          <div className="sticky top-0 bg-slate-900 px-4 py-2 border-b border-slate-700 flex items-center justify-between">
            <span className="text-xs text-gray-400 font-mono">{file.path}</span>
            <span className="text-[10px] text-gray-600">{file.type || 'file'}</span>
          </div>
          <div className="flex-1 overflow-auto">
            <textarea
              value={file.content}
              onChange={(e) => onEdit(file.path, e.target.value)}
              className="w-full h-full p-4 bg-transparent text-xs text-gray-300 font-mono leading-relaxed resize-none focus:outline-none"
              spellCheck="false"
            />
          </div>
        </div>
      );
    }

    // =====================================================
    // LIVE PREVIEW COMPONENT
    // =====================================================
    function LivePreview({ file }) {
      if (!file || !file.path.endsWith('.html')) {
        return (
          <div className="flex items-center justify-center text-gray-600 bg-slate-900">
            <div className="text-center">
              <div className="text-4xl mb-4">üëÅÔ∏è</div>
              <div className="text-sm">Preview available for HTML files only</div>
            </div>
          </div>
        );
      }

      return (
        <div className="bg-white h-full">
          <div className="bg-slate-900 px-4 py-2 border-b border-slate-700">
            <span className="text-xs text-gray-400 font-mono">üëÅÔ∏è Live Preview</span>
          </div>
          <iframe
            srcDoc={file.content}
            title="Preview"
            className="w-full h-full"
            style={{ height: 'calc(100% - 37px)' }}
            sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-downloads allow-modals"
          />
        </div>
      );
    }

    // =====================================================
    // MAIN FULL-STACK LAB COMPONENT
    // =====================================================
    function FullStackPrivacyToolsLab() {
      // State
      const [description, setDescription] = useState('');
      const [category, setCategory] = useState('General');
      const [includeBackend, setIncludeBackend] = useState(true);
      const [creating, setCreating] = useState(false);
      const [progress, setProgress] = useState('');
      const [error, setError] = useState(null);

      // Project state - Initialize with placeholder to show workspace structure from start
      const [files, setFiles] = useState([
        { path: 'README.md', content: '# Your Privacy Tool Workspace\n\nüëà Chat with Whistle AI to describe your tool\n\n‚öôÔ∏è Click Generate to build it\n\nüìÅ Files will appear here as they\'re created', type: 'markdown', size: 150 }
      ]);
      const [activeFile, setActiveFile] = useState(null);
      const [projectStructure, setProjectStructure] = useState(null);
      const [openTabs, setOpenTabs] = useState([]);
      // Incremental build flow (Cursor-style)
      const [plannedFiles, setPlannedFiles] = useState([]); // array of file specs to build
      const [currentIndex, setCurrentIndex] = useState(-1); // index into plannedFiles
      const [awaitingApproval, setAwaitingApproval] = useState(false); // waiting for user confirmation
      const [autoContinue, setAutoContinue] = useState(false); // auto-approve remaining files
      // Resizable workspace widths (percentages)
      const [leftWidth, setLeftWidth] = useState(() => Number(localStorage.getItem('lab_leftWidth')) || 22);
      const [centerWidth, setCenterWidth] = useState(() => Number(localStorage.getItem('lab_centerWidth')) || 48);
      const rightWidth = Math.max(100 - leftWidth - centerWidth, 10);
      const workspaceRef = React.useRef(null);
      const [resizing, setResizing] = useState(null); // 'left' | 'right' | null
      const [showConfirmModal, setShowConfirmModal] = useState(false);
      const [showPlan, setShowPlan] = useState(false);
      const [resourceTab, setResourceTab] = useState('files'); // 'files' | 'plan'
      const [layoutMode, setLayoutMode] = useState('tabbed'); // 'tabbed' | 'split'
      const [centerTab, setCenterTab] = useState('editor'); // editor | preview
      const [consoleOpen, setConsoleOpen] = useState(false);

      // Chat state
      const [chatMessages, setChatMessages] = useState([
        { role: 'assistant', content: 'üëã Hi! I\'m **Whistle AI**, your privacy tool architect.\n\nüéØ I build **REAL working privacy tools** with actual code:\n‚úÖ Encryption tools (AES-256, RSA, PBKDF2)\n‚úÖ Backend APIs (Express routes, authentication)\n‚úÖ Crypto modules (key derivation, signing, hashing)\n‚úÖ Privacy utilities (metadata stripping, steganography)\n‚úÖ Full projects ready to integrate into Ghost Whistle\n\nüí° **Try these:**\n‚Ä¢ "Build a file encryptor with chunked AES-256 encryption"\n‚Ä¢ "Create a password manager with PBKDF2 key derivation"\n‚Ä¢ "Build an image metadata stripper with EXIF removal"\n‚Ä¢ "Make a steganography tool to hide messages in images"\n\nDescribe the privacy tool you want to build!' }
      ]);
      const [userInput, setUserInput] = useState('');

      const API_BASE = window.location.hostname === 'localhost'
        ? 'http://localhost:8888/.netlify/functions'
        : '/.netlify/functions';

      // Handle chat
      const handleChat = async () => {
        if (!userInput.trim()) return;

        const newMessages = [...chatMessages, { role: 'user', content: userInput }];
        setChatMessages(newMessages);
        setUserInput('');
        setDescription(newMessages.filter(m => m.role === 'user').map(m => m.content).join('\n'));

        // Call real AI chat
        try {
          const res = await fetch(`${API_BASE}/chat-with-ai`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              messages: newMessages.map(m => ({ role: m.role, content: m.content })),
              hasPreview: files.length > 0
            })
          });

          if (res.ok) {
            const data = await res.json();
            setChatMessages([...newMessages, {
              role: 'assistant',
              content: data.message || 'Great idea! Ready to build? Click ‚öôÔ∏è Generate.'
            }]);
          } else {
            // Fallback on error
            setChatMessages([...newMessages, {
              role: 'assistant',
              content: 'I understand. Ready to build? Click ‚öôÔ∏è Generate to create your full-stack privacy tool.'
            }]);
          }
        } catch (err) {
          console.error('Chat error:', err);
          setChatMessages([...newMessages, {
            role: 'assistant',
            content: 'Great idea! Ready to build? Click ‚öôÔ∏è Generate to create your full-stack privacy tool.'
          }]);
        }
      };

      // Generate one file (by index) and append/replace in workspace
      const generateFileAtIndex = async (index, projectPlan) => {
        const fileSpec = plannedFiles[index];
        if (!fileSpec) return false;
        setProgress(`‚úçÔ∏è Building ${fileSpec.path}... (${index + 1}/${plannedFiles.length})`);
        try {
          const fileRes = await fetch(`${API_BASE}/generate-single-file`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              fileSpec,
              projectContext: {
                projectName: (projectPlan?.projectName) || 'privacy-tool',
                description: (projectPlan?.description) || description,
                techStack: (projectPlan?.techStack) || ['JavaScript', 'Node.js']
              }
            })
          });
          if (!fileRes.ok) throw new Error(`Failed to generate ${fileSpec.path}`);
          const fileData = await fileRes.json();
          if (!(fileData?.success && fileData?.file)) throw new Error(`Invalid response for ${fileSpec.path}`);

          // If file already exists (regenerate), replace; else append
          setFiles(prev => {
            const exists = prev.findIndex(f => f.path === fileData.file.path);
            if (exists >= 0) {
              const copy = [...prev];
              copy[exists] = fileData.file;
              return copy;
            }
            return [...prev, fileData.file];
          });

          // Focus first file
          if (index === 0) {
            setActiveFile(fileData.file);
            setOpenTabs([fileData.file]);
          }
          return true;
        } catch (e) {
          console.error(e);
          setError(e.message);
          return false;
        }
      };

      // Generate project CURSOR-STYLE: Plan structure, then ask per file
      const handleGenerate = async () => {
        if (!description || description.length < 20) {
          setError('Description must be at least 20 characters');
          return;
        }

        setCreating(true);
        setError(null);
        setProgress('üß† Planning project structure...');
        
        // Ensure workspace is visible (keep placeholder if empty)
        setFiles(prev => (prev.length ? prev : [{ path: 'README.md', content: '# Preparing project...\n\nThe AI will propose a plan, then we\'ll build files step by step.', type: 'markdown', size: 0 }]));
        setActiveFile(null);
        setOpenTabs([]);
        setProjectStructure(null);

        try {
          // STEP 1: Generate project structure (quick, <5 seconds)
          setProgress('üìã AI is planning your project...');
          const structureRes = await fetch(`${API_BASE}/create-fullstack-tool`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              description,
              category,
              includeBackend,
              structureOnly: true // Just get the plan, don't generate files
            })
          });

          if (!structureRes.ok) {
            throw new Error(`Planning failed: ${structureRes.status}`);
          }

          const structureData = await structureRes.json();
          const projectPlan = structureData.tool || structureData;

          setProjectStructure(projectPlan);
          const filesToGenerate = projectPlan.files || [];

          console.log(`üìã Project plan: ${filesToGenerate.length} files to build`);

          // Prepare approval flow
          setPlannedFiles(filesToGenerate);
          setCurrentIndex(0);
          setAwaitingApproval(true);
          setProgress(`üü° Ready to generate: ${filesToGenerate[0]?.path} (1/${filesToGenerate.length}). Click Approve to continue`);

        } catch (err) {
          console.error('Generation error:', err);
          setError(`‚ùå ${err.message}`);
          setProgress('');
          setCreating(false);
        }
      };

      // File operations
      const handleFileSelect = (file) => {
        setActiveFile(file);
        if (!openTabs.find(f => f.path === file.path)) {
          setOpenTabs([...openTabs, file]);
        }
      };

      const handleCloseTab = (file) => {
        const newTabs = openTabs.filter(f => f.path !== file.path);
        setOpenTabs(newTabs);
        if (activeFile?.path === file.path && newTabs.length > 0) {
          setActiveFile(newTabs[0]);
        }
      };

      const handleFileEdit = (path, content) => {
        const updatedFiles = files.map(f =>
          f.path === path ? { ...f, content } : f
        );
        setFiles(updatedFiles);
        if (activeFile?.path === path) {
          setActiveFile({ ...activeFile, content });
        }
      };

      // Download project as ZIP
      const handleDownloadZip = async () => {
        if (files.length === 0) return;

        const zip = new JSZip();
        
        files.forEach(file => {
          zip.file(file.path, file.content);
        });

        const blob = await zip.generateAsync({ type: 'blob' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${projectStructure?.projectName || 'privacy-tool'}.zip`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      };

      // Auto-continue effect: when waiting and toggle is on, proceed
      useEffect(() => {
        if (autoContinue && awaitingApproval && plannedFiles.length > 0 && currentIndex >= 0 && currentIndex < plannedFiles.length) {
          (async () => {
            setAwaitingApproval(false);
            const ok = await generateFileAtIndex(currentIndex, projectStructure);
            if (ok) {
              const next = currentIndex + 1;
              if (next < plannedFiles.length) {
                setCurrentIndex(next);
                setAwaitingApproval(true);
                setProgress(`üü° Ready to generate: ${plannedFiles[next].path} (${next+1}/${plannedFiles.length})`);
              } else {
                setProgress('‚úÖ Project complete!');
                setCreating(false);
              }
            } else {
              setAwaitingApproval(true);
            }
          })();
        }
      }, [autoContinue, awaitingApproval, currentIndex]);

      // Actions reused by toolbar and modal
      const proceedCurrentFile = async () => {
        if (!(awaitingApproval && plannedFiles[currentIndex])) return;
        setAwaitingApproval(false);
        const ok = await generateFileAtIndex(currentIndex, projectStructure);
        if (ok) {
          const next = currentIndex + 1;
          if (next < plannedFiles.length) {
            setCurrentIndex(next);
            setAwaitingApproval(true);
            setProgress(`üü° Ready to generate: ${plannedFiles[next].path} (${next+1}/${plannedFiles.length})`);
          } else {
            setProgress('‚úÖ Project complete!');
            setCreating(false);
          }
        } else {
          setAwaitingApproval(true);
        }
      };

      const regenerateCurrentFile = async () => {
        if (!plannedFiles[currentIndex]) return;
        setAwaitingApproval(false);
        await generateFileAtIndex(currentIndex, projectStructure);
        setAwaitingApproval(true);
      };

      const skipCurrentFile = () => {
        const next = currentIndex + 1;
        if (next < plannedFiles.length) {
          setCurrentIndex(next);
          setProgress(`üü° Skipped. Ready: ${plannedFiles[next].path} (${next+1}/${plannedFiles.length})`);
        } else {
          setProgress('‚úÖ Project complete!');
          setCreating(false);
        }
      };

      // Persist widths
      useEffect(() => {
        localStorage.setItem('lab_leftWidth', String(leftWidth));
        localStorage.setItem('lab_centerWidth', String(centerWidth));
      }, [leftWidth, centerWidth]);

      // Show confirm modal when awaiting approval
      useEffect(() => {
        setShowConfirmModal(awaitingApproval);
      }, [awaitingApproval]);

      // Mouse move handlers for resizers
      useEffect(() => {
        const onMove = (e) => {
          if (!resizing || !workspaceRef.current) return;
          const rect = workspaceRef.current.getBoundingClientRect();
          const x = e.clientX - rect.left; // px from left inside workspace
          const pct = (x / rect.width) * 100; // percent across
          const minLeft = 14, maxLeft = 40;
          const minCenter = 26, maxCenter = 70;
          if (resizing === 'left') {
            const newLeft = Math.min(Math.max(pct, minLeft), maxLeft);
            // Keep center the same unless it squashes right too much
            const remaining = 100 - newLeft - centerWidth;
            if (remaining < 14) {
              const adjustCenter = centerWidth - (14 - remaining);
              setCenterWidth(Math.min(Math.max(adjustCenter, minCenter), maxCenter));
            }
            setLeftWidth(newLeft);
          } else if (resizing === 'right') {
            // Right handle sits at left + center
            let newCenter = Math.min(Math.max(pct - leftWidth, minCenter), maxCenter);
            const remaining = 100 - leftWidth - newCenter;
            if (remaining < 14) newCenter = 100 - leftWidth - 14;
            setCenterWidth(newCenter);
          }
        };
        const onUp = () => setResizing(null);
        window.addEventListener('mousemove', onMove);
        window.addEventListener('mouseup', onUp);
        return () => {
          window.removeEventListener('mousemove', onMove);
          window.removeEventListener('mouseup', onUp);
        };
      }, [resizing, leftWidth, centerWidth]);

      return (
        <div className="w-full min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 noise">
          {/* Header */}
          <div className="border-b border-slate-800 bg-slate-950/80 backdrop-blur-xl sticky top-0 z-50">
            <div className="max-w-[1920px] mx-auto px-8 py-4">
              <div className="flex items-center justify-between">
                <div>
                  <h1 className="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 via-amber-400 to-yellow-600 mb-1">
                    üõ†Ô∏è Whistle Builder
                  </h1>
                  <p className="text-gray-500 text-xs">Premium dark, professional website & tool builder</p>
                </div>
                <div className="flex items-center gap-3">
                  <button onClick={()=>setShowPlan(v=>!v)} className="px-3 py-2 rounded-lg bg-slate-800/60 hover:bg-slate-800 text-gray-300 text-sm border border-slate-700">{showPlan ? 'Hide Plan' : 'Show Plan'}</button>
                  <label className="hidden md:flex items-center gap-2 px-3 py-2 rounded-lg bg-slate-800/60 border border-slate-700 text-gray-300 text-sm">
                    <input type="checkbox" checked={autoContinue} onChange={(e)=>setAutoContinue(e.target.checked)} />
                    Auto-continue
                  </label>
                  {/* Layout Switch */}
                  <div className="hidden md:flex items-center gap-1 px-1 py-1 rounded-lg bg-slate-800/60 border border-slate-700">
                    <button onClick={()=>setLayoutMode('tabbed')} className={`px-3 py-1.5 text-xs rounded ${layoutMode==='tabbed'?'bg-slate-900 text-cyan-300 border border-slate-700':'text-gray-300 hover:text-gray-100'}`}>Tabbed</button>
                    <button onClick={()=>setLayoutMode('split')} className={`px-3 py-1.5 text-xs rounded ${layoutMode==='split'?'bg-slate-900 text-cyan-300 border border-slate-700':'text-gray-300 hover:text-gray-100'}`}>Split</button>
                  </div>
                  <button onClick={()=>setConsoleOpen(v=>!v)} className="px-3 py-2 rounded-lg bg-slate-800/60 hover:bg-slate-800 text-gray-300 text-sm border border-slate-700">{consoleOpen?'Hide Console':'Show Console'}</button>
                  <button onClick={handleDownloadZip} className="px-4 py-2 rounded-lg bg-green-600 hover:bg-green-700 text-white text-sm transition-all flex items-center gap-2">
                    <span>‚á©</span>
                    <span>Download ZIP</span>
                  </button>
                  <div className="px-3 py-2 rounded-lg bg-slate-800/50 border border-slate-700 text-gray-300 text-xs">
                    {files.length} files
                  </div>
                </div>
              </div>
            </div>
          </div>

          {/* Plan Drawer */}
          {showPlan && plannedFiles.length > 0 && (
            <div className="max-w-[1920px] mx-auto px-8">
              <div className="mt-3 mb-1 rounded-xl border border-slate-800 bg-slate-950/70">
                <div className="px-4 py-3 text-xs text-gray-400 flex items-center justify-between">
                  <span className="font-semibold text-gray-300">Project Plan</span>
                  <span className="text-gray-500">{currentIndex + 1}/{plannedFiles.length} ready</span>
                </div>
                <div className="max-h-48 overflow-auto divide-y divide-slate-800">
                  {plannedFiles.map((f, idx)=>{
                    const status = files.find(x=>x.path===f.path) ? 'done' : (idx===currentIndex && awaitingApproval ? 'awaiting' : 'pending');
                    return (
                      <div key={f.path} className="px-4 py-2 text-xs flex items-center gap-3">
                        <span className={`w-2 h-2 rounded-full ${status==='done'?'bg-emerald-400':status==='awaiting'?'bg-amber-400':'bg-slate-600'}`} />
                        <span className="font-mono text-gray-300">{f.path}</span>
                        <span className="ml-auto text-gray-500">{f.type || 'file'}</span>
                      </div>
                    );
                  })}
                </div>
              </div>
            </div>
          )}

          {/* Main Content */}
          <div className="flex" style={{ height: 'calc(100vh - 100px)' }}>
            
            {/* Left: Chat Panel */}
            <div className="w-96 bg-slate-900/30 backdrop-blur-md border-r border-slate-800 flex flex-col">
              <div className="flex-shrink-0 px-6 py-4 border-b border-slate-800/50 bg-slate-950/50">
                <div className="flex items-center gap-3">
                  <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-cyan-500/20 to-amber-500/20 border border-cyan-500/30 flex items-center justify-center">
                    <span className="text-xl">ü§ñ</span>
                  </div>
                  <div>
                    <h3 className="text-sm font-bold text-cyan-400">Whistle AI</h3>
                    <p className="text-[10px] text-gray-600">Full-Stack Developer</p>
                  </div>
                </div>
              </div>

              {/* Chat Messages */}
              <div className="flex-1 overflow-y-auto p-6 space-y-3">
                {chatMessages.map((msg, idx) => (
                  <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                    <div className={`max-w-[85%] px-4 py-2.5 rounded-xl ${
                      msg.role === 'user'
                        ? 'bg-gradient-to-r from-cyan-600/90 to-amber-600/90 text-white'
                        : 'bg-slate-800/60 border border-slate-700/50 text-gray-200'
                    }`}>
                      <div className="text-sm whitespace-pre-wrap">{msg.content}</div>
                    </div>
                  </div>
                ))}

                {creating && (
                  <div className="text-center py-4">
                    <div className="inline-block px-4 py-2 bg-slate-800/60 rounded-lg border border-cyan-500/30">
                      <div className="text-xs text-cyan-400">{progress}</div>
                    </div>
                  </div>
                )}

                {error && (
                  <div className="bg-red-900/20 border border-red-500/30 rounded-lg p-3 text-red-300 text-xs">
                    ‚ùå {error}
                  </div>
                )}
              </div>

              {/* Input */}
              <div className="flex-shrink-0 p-6 border-t border-slate-800/50 bg-slate-950/30 space-y-3">
                <div className="flex items-center gap-2 px-3 py-2 bg-slate-800/50 rounded-lg border border-slate-700/50">
                  <input
                    type="checkbox"
                    id="include-backend"
                    checked={includeBackend}
                    onChange={(e) => setIncludeBackend(e.target.checked)}
                    className="w-4 h-4 accent-cyan-500"
                  />
                  <label htmlFor="include-backend" className="text-xs text-gray-400 cursor-pointer">
                    Include Backend (APIs, routes, server)
                  </label>
                </div>

                <textarea
                  value={userInput}
                  onChange={(e) => setUserInput(e.target.value)}
                  onKeyDown={(e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                      e.preventDefault();
                      handleChat();
                    }
                  }}
                  placeholder="Describe your privacy tool..."
                  rows={3}
                  className="w-full px-4 py-3 rounded-xl bg-slate-800/50 border border-slate-700/50 text-white text-sm resize-none focus:border-cyan-500/50 focus:outline-none transition-all placeholder-gray-600"
                />

                <div className="flex gap-2">
                  <button
                    onClick={handleChat}
                    disabled={!userInput.trim()}
                    className="flex-1 py-2.5 rounded-lg bg-slate-800/50 hover:bg-slate-700/50 border border-slate-700/50 text-cyan-400 disabled:opacity-30 text-sm"
                  >
                    <span className="mr-1">‚ö°</span> Send
                  </button>
                  <button
                    onClick={handleGenerate}
                    disabled={creating || !description || description.length < 20}
                    className="flex-1 py-2.5 rounded-lg bg-gradient-to-r from-cyan-600 to-amber-600 hover:from-cyan-500 hover:to-amber-500 text-white disabled:opacity-30 text-sm"
                  >
                    {creating ? '‚è≥ Building...' : <><span className="mr-1">‚öôÔ∏è</span> Generate</>}
                  </button>
                </div>
              </div>
            </div>

            {/* Right: Code Editor (Resizable 3-panel) */}
            <div className="flex-1" ref={workspaceRef}>
              {files.length > 0 ? (
                <>
                  {/* TABBED layout */}
                  {layoutMode==='tabbed' ? (
                    <div className="grid h-full" style={{ gridTemplateColumns: `${leftWidth}% ${100 - leftWidth}%` }}>
                      {/* Resources Panel (Files | Plan) */}
                      <div className="min-w-[220px] overflow-hidden border-r border-slate-800 bg-slate-950/40">
                        <div className="flex items-center gap-2 px-3 py-2 border-b border-slate-800 bg-slate-900/60">
                          <button onClick={()=>setResourceTab('files')} className={`px-3 py-1.5 rounded text-xs ${resourceTab==='files'?'bg-slate-800 text-cyan-300 border border-slate-700':'text-gray-400 hover:text-gray-200'}`}>Files</button>
                          <button onClick={()=>setResourceTab('plan')} className={`px-3 py-1.5 rounded text-xs ${resourceTab==='plan'?'bg-slate-800 text-amber-300 border border-slate-700':'text-gray-400 hover:text-gray-200'}`}>Plan</button>
                        </div>
                        <div className="h-full overflow-auto">
                          {resourceTab==='files' ? (
                            <FileTree
                              files={files}
                              activeFile={activeFile}
                              onFileSelect={handleFileSelect}
                            />
                          ) : (
                            <div className="p-2">
                              {plannedFiles.length===0 && (
                                <div className="text-[11px] text-gray-500 px-2 py-3">Plan will appear here after Generate ‚Üí Planning</div>
                              )}
                              {plannedFiles.map((f, idx)=>{
                                const done = !!files.find(x=>x.path===f.path);
                                const isCurrent = idx===currentIndex && awaitingApproval;
                                return (
                                  <div key={f.path} className={`px-2 py-1.5 rounded text-xs cursor-default flex items-center gap-2 ${isCurrent?'bg-amber-500/10 border border-amber-500/30': done?'bg-emerald-500/10 border border-emerald-500/20':'hover:bg-slate-800'}`}>
                                    <span className={`w-1.5 h-1.5 rounded-full ${done?'bg-emerald-400':isCurrent?'bg-amber-400':'bg-slate-600'}`} />
                                    <span className="font-mono text-gray-300 truncate">{f.path}</span>
                                    <span className="ml-auto text-gray-500">{f.type||'file'}</span>
                                  </div>
                                );
                              })}
                            </div>
                          )}
                        </div>
                      </div>

                      {/* Canvas (Tabbed) */}
                      <div className="flex flex-col overflow-hidden relative">
                        {/* Aurora ribbon */}
                        <div className="pointer-events-none absolute inset-0 opacity-[.06] bg-gradient-to-br from-cyan-400 via-fuchsia-400 to-amber-400 blur-3xl" />

                        {/* Approval bar */}
                        {plannedFiles.length > 0 && currentIndex >= 0 && currentIndex < plannedFiles.length && (
                          <div className="flex items-center justify-between px-3 py-2 bg-slate-900/70 border-b border-slate-800 relative z-10">
                            <div className="text-xs text-gray-400 truncate">
                              <span className="text-cyan-300 font-mono">{plannedFiles[currentIndex]?.path}</span>
                              <span className="ml-2 text-gray-500">({currentIndex + 1}/{plannedFiles.length})</span>
                            </div>
                            <div className="flex items-center gap-2">
                              <button onClick={()=>setCenterTab('editor')} className={`px-3 py-1.5 text-xs rounded ${centerTab==='editor'?'bg-slate-800 text-cyan-300 border border-slate-700':'text-gray-400 hover:text-gray-200'}`}>Editor</button>
                              <button onClick={()=>setCenterTab('preview')} className={`px-3 py-1.5 text-xs rounded ${centerTab==='preview'?'bg-slate-800 text-amber-300 border border-slate-700':'text-gray-400 hover:text-gray-200'}`}>Preview</button>
                              <button disabled={!awaitingApproval} onClick={proceedCurrentFile} className="px-3 py-1.5 text-xs rounded bg-green-600 hover:bg-green-700 text-white disabled:opacity-40">Approve & Generate</button>
                            </div>
                          </div>
                        )}

                        {/* Tab content */}
                        <div className="flex-1 overflow-hidden bg-slate-950/30">
                          {centerTab==='editor' ? (
                            <CodeEditor file={activeFile} onEdit={handleFileEdit} />
                          ) : (
                            <LivePreview file={activeFile} />
                          )}
                        </div>
                      </div>
                    </div>
                  ) : (
                  /* SPLIT layout (original, but skinned) */
                    <div className="grid h-full" style={{ gridTemplateColumns: `${leftWidth}% ${centerWidth}% ${100 - leftWidth - centerWidth}%` }}>
                    {/* Resources Panel (Files | Plan) */}
                    <div className="min-w-[220px] overflow-hidden border-r border-slate-800 bg-slate-950/40">
                      <div className="flex items-center gap-2 px-3 py-2 border-b border-slate-800 bg-slate-900/60">
                        <button onClick={()=>setResourceTab('files')} className={`px-3 py-1.5 rounded text-xs ${resourceTab==='files'?'bg-slate-800 text-cyan-300 border border-slate-700':'text-gray-400 hover:text-gray-200'}`}>Files</button>
                        <button onClick={()=>setResourceTab('plan')} className={`px-3 py-1.5 rounded text-xs ${resourceTab==='plan'?'bg-slate-800 text-amber-300 border border-slate-700':'text-gray-400 hover:text-gray-200'}`}>Plan</button>
                      </div>
                      <div className="h-full overflow-auto">
                        {resourceTab==='files' ? (
                          <FileTree
                            files={files}
                            activeFile={activeFile}
                            onFileSelect={handleFileSelect}
                          />
                        ) : (
                          <div className="p-2">
                            {plannedFiles.length===0 && (
                              <div className="text-[11px] text-gray-500 px-2 py-3">Plan will appear here after Generate ‚Üí Planning</div>
                            )}
                            {plannedFiles.map((f, idx)=>{
                              const done = !!files.find(x=>x.path===f.path);
                              const isCurrent = idx===currentIndex && awaitingApproval;
                              return (
                                <div key={f.path} className={`px-2 py-1.5 rounded text-xs cursor-default flex items-center gap-2 ${isCurrent?'bg-amber-500/10 border border-amber-500/30': done?'bg-emerald-500/10 border border-emerald-500/20':'hover:bg-slate-800'}`}>
                                  <span className={`w-1.5 h-1.5 rounded-full ${done?'bg-emerald-400':isCurrent?'bg-amber-400':'bg-slate-600'}`} />
                                  <span className="font-mono text-gray-300 truncate">{f.path}</span>
                                  <span className="ml-auto text-gray-500">{f.type||'file'}</span>
                                </div>
                              );
                            })}
                          </div>
                        )}
                      </div>
                    </div>

                    {/* Editor Column */}
                    <div className="flex flex-col overflow-hidden">
                    {/* Approval bar */}
                    {plannedFiles.length > 0 && currentIndex >= 0 && currentIndex < plannedFiles.length && (
                      <div className="flex items-center justify-between px-3 py-2 bg-slate-900 border-b border-slate-800">
                        <div className="text-xs text-gray-400 truncate">
                          <span className="text-cyan-400 font-mono">{plannedFiles[currentIndex]?.path}</span>
                          <span className="ml-2 text-gray-500">({currentIndex + 1}/{plannedFiles.length})</span>
                          <span className="ml-3">{awaitingApproval ? 'Awaiting approval' : 'Generating...'}</span>
                        </div>
                        <div className="flex items-center gap-2">
                          <label className="flex items-center gap-1 text-[11px] text-gray-400">
                            <input type="checkbox" checked={autoContinue} onChange={(e)=>setAutoContinue(e.target.checked)} />
                            Auto-continue
                          </label>
                          <button disabled={!awaitingApproval} onClick={proceedCurrentFile} className="px-3 py-1.5 text-xs rounded bg-green-600 hover:bg-green-700 text-white disabled:opacity-40">Approve & Generate</button>
                          <button disabled={!awaitingApproval} onClick={regenerateCurrentFile} className="px-3 py-1.5 text-xs rounded bg-slate-800 border border-slate-700 text-gray-300 disabled:opacity-40">Regenerate</button>
                          <button disabled={!awaitingApproval} onClick={skipCurrentFile} className="px-3 py-1.5 text-xs rounded bg-red-600 hover:bg-red-700 text-white disabled:opacity-40">Skip</button>
                        </div>
                      </div>
                    )}
                    {/* Tabs */}
                    <FileTabs
                      files={openTabs}
                      activeFile={activeFile}
                      onFileSelect={handleFileSelect}
                      onCloseTab={handleCloseTab}
                    />

                    {/* Editor Panel */}
                      <div className="flex-1 overflow-hidden">
                        <div className="panel-title px-3 py-2 border-b border-slate-800 bg-slate-900/60">Editor</div>
                        <CodeEditor file={activeFile} onEdit={handleFileEdit} />
                      </div>
                    </div>

                    {/* Preview Column */}
                    <div className="border-l border-slate-800 overflow-hidden">
                      <div className="panel-title px-3 py-2 border-b border-slate-800 bg-slate-900/60 flex items-center gap-2"><span>üëÅÔ∏è</span><span>Preview</span></div>
                      <LivePreview file={activeFile} />
                    </div>
                    </div>
                  )}

                  {/* Resizers (only for split layout) */}
                  {layoutMode==='split' && (
                    <>
                      <div onMouseDown={()=>setResizing('left')} className="absolute top-0 bottom-0 flex items-center justify-center" style={{ left: `calc(${leftWidth}% - 6px)`, width: '12px', cursor: 'col-resize' }}>
                        <div className="splitter-dot" />
                      </div>
                      <div onMouseDown={()=>setResizing('right')} className="absolute top-0 bottom-0 flex items-center justify-center" style={{ left: `calc(${leftWidth + centerWidth}% - 6px)`, width: '12px', cursor: 'col-resize' }}>
                        <div className="splitter-dot" />
                      </div>
                    </>
                  )}
                </>
              ) : (
                <div className="flex-1 flex items-center justify-center bg-gradient-to-br from-slate-950 to-slate-900">
                  <div className="text-center max-w-2xl px-8">
                    {creating ? (
                      <>
                        <div className="relative w-32 h-32 mx-auto mb-8">
                          <img 
                            src="whistel_logo_top_right_2048.png" 
                            alt="Building..."
                            className="w-full h-full object-contain animate-pulse"
                            style={{
                              animation: 'spin-flip-zoom 2s ease-in-out infinite',
                              filter: 'drop-shadow(0 0 30px rgba(6, 182, 212, 0.6)) drop-shadow(0 0 50px rgba(251, 191, 36, 0.4))'
                            }}
                          />
                        </div>
                        <div className="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-amber-400 mb-4">
                          {progress || 'Whistle AI is building...'}
                        </div>
                        <div className="text-sm text-gray-500 mb-8">
                          Files will appear here as they're created
                        </div>
                        {/* Progress bar */}
                        <div className="w-full h-2 bg-slate-800 rounded-full overflow-hidden">
                          <div 
                            className="h-full bg-gradient-to-r from-cyan-500 to-amber-500 animate-pulse"
                            style={{
                              width: '100%',
                              animation: 'progress-slide 2s ease-in-out infinite'
                            }}
                          />
                        </div>
                      </>
                    ) : (
                      <>
                        <div className="text-6xl mb-4">üß™</div>
                        <div className="text-lg mb-2 text-gray-300">Your Full-Stack Workspace</div>
                        <div className="text-sm text-gray-500 mb-6">
                          Chat with Whistle AI to design your privacy tool, then click Generate to create a complete project with frontend and backend
                        </div>
                        <div className="inline-flex items-center gap-2 px-4 py-2 bg-slate-800/50 rounded-lg border border-slate-700">
                          <span className="text-xs text-gray-400">‚ú® Full-stack generation enabled</span>
                        </div>
                      </>
                    )}
                  </div>
                </div>
              )}
            </div>

            {/* Premium Confirmation Modal */}
            {showConfirmModal && plannedFiles[currentIndex] && (
              <div className="fixed inset-0 z-50 flex items-center justify-center">
                <div className="absolute inset-0 bg-black/70 backdrop-blur-sm" onClick={()=>setShowConfirmModal(false)} />
                <div className="relative w-full max-w-xl mx-4 rounded-2xl border border-slate-700 bg-gradient-to-br from-slate-950/95 via-slate-900/95 to-slate-950/95 shadow-2xl">
                  <div className="px-6 py-4 border-b border-slate-800 flex items-center justify-between">
                    <div className="text-sm font-semibold text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 to-amber-300">Approve Generation</div>
                    <button onClick={()=>setShowConfirmModal(false)} className="text-gray-400 hover:text-gray-200">‚úï</button>
                  </div>
                  <div className="px-6 py-5 space-y-4">
                    <div className="text-xs text-gray-400">Next file to generate</div>
                    <div className="flex items-center gap-2 text-sm">
                      <span className="px-2 py-1 rounded bg-slate-800 text-cyan-300 border border-slate-700 font-mono">{plannedFiles[currentIndex].path}</span>
                      <span className="text-gray-500">({currentIndex + 1}/{plannedFiles.length})</span>
                    </div>
                    <div className="text-xs text-gray-500">Type: {plannedFiles[currentIndex].type || 'file'} ¬∑ {plannedFiles[currentIndex].description || 'No description provided'}</div>
                    <div className="flex items-center justify-between pt-2">
                      <label className="flex items-center gap-2 text-xs text-gray-400">
                        <input type="checkbox" checked={autoContinue} onChange={(e)=>setAutoContinue(e.target.checked)} />
                        Auto-continue after this file
                      </label>
                      <div className="flex items-center gap-2">
                        <button onClick={skipCurrentFile} className="px-3 py-1.5 text-xs rounded bg-slate-800 border border-slate-700 text-gray-300">Skip</button>
                        <button onClick={regenerateCurrentFile} className="px-3 py-1.5 text-xs rounded bg-slate-800 border border-slate-700 text-gray-300">Regenerate</button>
                        <button onClick={()=>{ setShowConfirmModal(false); proceedCurrentFile(); }} className="px-4 py-1.5 text-xs rounded bg-gradient-to-r from-cyan-600 to-amber-600 hover:from-cyan-500 hover:to-amber-500 text-white">Approve & Generate</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            )}

          </div>
        </div>
      );
    }

    // Render
    ReactDOM.render(<FullStackPrivacyToolsLab />, document.getElementById('root'));
  </script>
</body>
</html>

