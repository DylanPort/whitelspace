<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Create Relay Pool Vault - Ghost Whistle</title>
  <script src="https://cdn.jsdelivr.net/npm/buffer@6.0.3/index.min.js"></script>
  <script>
    // Make Buffer globally available
    window.Buffer = window.Buffer || buffer.Buffer;
    console.log('Buffer loaded:', typeof Buffer, typeof Buffer.from);
  </script>
  <script src="https://unpkg.com/@solana/web3.js@1.87.6/lib/index.iife.min.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .container {
      background: white;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 {
      color: #667eea;
      margin-bottom: 10px;
    }
    .subtitle {
      color: #666;
      margin-bottom: 30px;
    }
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 15px 30px;
      font-size: 16px;
      font-weight: bold;
      border-radius: 10px;
      cursor: pointer;
      width: 100%;
      margin-top: 20px;
      transition: transform 0.2s;
    }
    button:hover {
      transform: translateY(-2px);
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    #status {
      margin-top: 20px;
      padding: 15px;
      border-radius: 10px;
      font-weight: bold;
    }
    .success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    .details {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 10px;
      margin-top: 20px;
      font-family: monospace;
      font-size: 12px;
      word-break: break-all;
    }
    .warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üí∞ Create Pool Vault</h1>
    <p class="subtitle">Associated Token Account for Pool</p>
    
    <div class="warning">
      <strong>‚ö†Ô∏è STEP 2:</strong> This creates the pool's token vault (ATA) to hold staked $WHISTLE.
      <br><br>
      <strong>Prerequisites:</strong>
      <br>‚úÖ Pool must be initialized first (run init-relay-pool.html)
      <br><br>
      <strong>Program ID:</strong> 2uZWi6wC6CumhcCDCuNZcBaDSd7UJKf4BKreWdx1Pyaq
      <br>
      <strong>Token:</strong> $WHISTLE (6Hb2xgEhyN9iVVH3cgSxYjfN774ExzgiCftwiWdjpump)
    </div>

    <button id="createButton">
      Create Pool Vault
    </button>

    <div id="status" style="display: none;"></div>
    <div id="details" class="details" style="display: none;"></div>
  </div>

  <script>
    const PROGRAM_ID = '2uZWi6wC6CumhcCDCuNZcBaDSd7UJKf4BKreWdx1Pyaq';
    const WHISTLE_MINT = '6Hb2xgEhyN9iVVH3cgSxYjfN774ExzgiCftwiWdjpump';
    const RPC_URL = 'https://rpc-mainnet.solanatracker.io/?api_key=25ef537d-3249-479c-96cb-40efc0ce3e09';
    const TOKEN_PROGRAM_ID = 'TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA';
    const ASSOCIATED_TOKEN_PROGRAM_ID = 'ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL';

    function showStatus(message, type) {
      const statusDiv = document.getElementById('status');
      statusDiv.textContent = message;
      statusDiv.className = type;
      statusDiv.style.display = 'block';
    }

    function showDetails(data) {
      const detailsDiv = document.getElementById('details');
      detailsDiv.textContent = JSON.stringify(data, null, 2);
      detailsDiv.style.display = 'block';
    }

    async function createVault() {
      const button = document.getElementById('createButton');
      button.disabled = true;
      
      try {
        showStatus('Connecting to Phantom wallet...', 'info');
        
        // Connect to Phantom
        if (!window.solana || !window.solana.isPhantom) {
          throw new Error('Phantom wallet not found! Please install Phantom.');
        }

        const provider = window.solana;
        await provider.connect();
        const walletPubkey = provider.publicKey;
        
        showStatus('Connected! Calculating addresses...', 'info');
        
        // Connect to Solana
        const connection = new solanaWeb3.Connection(RPC_URL, 'confirmed');
        
        // Derive Pool PDA
        const programId = new solanaWeb3.PublicKey(PROGRAM_ID);
        const poolSeed = new TextEncoder().encode('pool');
        const [poolPDA] = await solanaWeb3.PublicKey.findProgramAddress(
          [poolSeed],
          programId
        );
        
        console.log('Pool PDA:', poolPDA.toString());
        
        // Check if pool exists
        const poolAccount = await connection.getAccountInfo(poolPDA);
        if (!poolAccount) {
          throw new Error('Pool not initialized! Run init-relay-pool.html first.');
        }
        
        // Calculate ATA for pool
        const whistleMint = new solanaWeb3.PublicKey(WHISTLE_MINT);
        const tokenProgramId = new solanaWeb3.PublicKey(TOKEN_PROGRAM_ID);
        const associatedTokenProgramId = new solanaWeb3.PublicKey(ASSOCIATED_TOKEN_PROGRAM_ID);
        
        const [poolVaultPDA] = await solanaWeb3.PublicKey.findProgramAddress(
          [
            poolPDA.toBuffer(),
            tokenProgramId.toBuffer(),
            whistleMint.toBuffer()
          ],
          associatedTokenProgramId
        );
        
        console.log('Pool Vault PDA:', poolVaultPDA.toString());
        
        // Check if vault already exists
        const vaultAccount = await connection.getAccountInfo(poolVaultPDA);
        if (vaultAccount) {
          showStatus('‚úÖ Pool vault already exists!', 'success');
          showDetails({
            poolPDA: poolPDA.toString(),
            poolVault: poolVaultPDA.toString(),
            message: 'Vault is ready. You can now stake!',
            nextStep: 'Go to http://localhost:3000 and navigate to Ghost Whistle section to stake'
          });
          button.disabled = false;
          return;
        }
        
        showStatus('Building transaction...', 'info');
        
        // Create ATA instruction
        const createATAInstruction = new solanaWeb3.TransactionInstruction({
          keys: [
            { pubkey: walletPubkey, isSigner: true, isWritable: true },
            { pubkey: poolVaultPDA, isSigner: false, isWritable: true },
            { pubkey: poolPDA, isSigner: false, isWritable: false },
            { pubkey: whistleMint, isSigner: false, isWritable: false },
            { pubkey: solanaWeb3.SystemProgram.programId, isSigner: false, isWritable: false },
            { pubkey: tokenProgramId, isSigner: false, isWritable: false },
          ],
          programId: associatedTokenProgramId,
          data: new Uint8Array(0) // No data needed for create ATA
        });
        
        // Create transaction
        const transaction = new solanaWeb3.Transaction();
        transaction.add(createATAInstruction);
        
        // Get recent blockhash
        const { blockhash } = await connection.getLatestBlockhash();
        transaction.recentBlockhash = blockhash;
        transaction.feePayer = walletPubkey;
        
        showStatus('Please approve transaction in Phantom...', 'info');
        
        // Sign and send
        const signedTx = await provider.signTransaction(transaction);
        const signature = await connection.sendRawTransaction(signedTx.serialize());
        
        showStatus('Transaction sent! Confirming...', 'info');
        console.log('Transaction signature:', signature);
        
        // Confirm transaction
        await connection.confirmTransaction(signature, 'confirmed');
        
        showStatus('‚úÖ Pool vault created successfully!', 'success');
        showDetails({
          signature: signature,
          poolPDA: poolPDA.toString(),
          poolVault: poolVaultPDA.toString(),
          explorerUrl: `https://solscan.io/tx/${signature}`,
          nextStep: 'Pool is ready! Go to http://localhost:3000 ‚Üí Ghost Whistle section to stake and create relays!'
        });
        
      } catch (error) {
        console.error('Vault creation error:', error);
        showStatus(`‚ùå Error: ${error.message}`, 'error');
        showDetails({
          error: error.message,
          stack: error.stack
        });
        button.disabled = false;
      }
    }

    // Auto-load on page load and attach event listeners
    window.addEventListener('load', () => {
      console.log('‚úÖ Page loaded');
      console.log('Program ID:', PROGRAM_ID);
      console.log('$WHISTLE Mint:', WHISTLE_MINT);
      
      // Attach button event listener
      const createBtn = document.getElementById('createButton');
      if (createBtn) {
        console.log('‚úÖ Create button found');
        createBtn.addEventListener('click', createVault);
      } else {
        console.error('‚ùå Create button not found!');
      }
      
      console.log('üéØ Event listener attached!');
    });
  </script>
</body>
</html>

